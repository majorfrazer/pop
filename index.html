<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="PopDarts">
  <meta name="theme-color" content="#0a0a12">
  <title>PopDarts</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
    :root{
      --bg:#0a0a12;--card:#14141f;--elev:#1c1c2e;--border:rgba(255,255,255,.08);
      --text:#fff;--dim:#a0a0b8;--muted:#606078;
      --gold:#ffc107;--gold2:#ff9800;--green:#00e676;--red:#ff5252;--blue:#448aff;
      --st:env(safe-area-inset-top,0);--sb:env(safe-area-inset-bottom,0);
    }
    *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;user-select:none}
    html,body{font-family:'Inter',system-ui,sans-serif;background:var(--bg);color:var(--text);height:100%;overflow:hidden}
    
    /* Mobile Install Banner */
    .install-banner{position:fixed;bottom:80px;left:12px;right:12px;background:linear-gradient(135deg,#1a1a35,#252550);border:2px solid var(--gold);border-radius:16px;padding:16px;display:none;z-index:300;animation:slideUp .4s}
    .install-banner.show{display:block}
    @keyframes slideUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
    
    .screen{position:fixed;inset:0;display:none;flex-direction:column;background:var(--bg);z-index:10}
    .screen.active{display:flex}
    
    .hdr{display:flex;align-items:center;justify-content:space-between;padding:calc(12px + var(--st)) 16px 12px;background:var(--bg);border-bottom:1px solid var(--border)}
    .logo{font-size:20px;font-weight:900;color:var(--gold)}
    .sync-ind{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--dim)}
    .sync-dot{width:8px;height:8px;border-radius:50%;background:var(--green);animation:blink 1s infinite}
    @keyframes blink{50%{opacity:.3}}
    
    .content{flex:1;overflow-y:auto;padding:14px;padding-bottom:calc(90px + var(--sb))}
    
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin-bottom:12px}
    .card-title{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-bottom:12px}
    
    /* LIVE GAME BANNER - Big & Prominent */
    .live-banner{background:linear-gradient(135deg,#0a2818,#041810);border:2px solid var(--green);border-radius:20px;padding:20px;margin-bottom:16px;cursor:pointer;position:relative;overflow:hidden}
    .live-banner::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:conic-gradient(transparent,rgba(0,230,118,.1),transparent);animation:spin 4s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .live-inner{position:relative;z-index:1}
    .live-badge{display:inline-flex;align-items:center;gap:6px;background:var(--green);color:#000;padding:6px 14px;border-radius:20px;font-size:11px;font-weight:800;margin-bottom:12px}
    .live-dot{width:8px;height:8px;background:#000;border-radius:50%;animation:pulse 1s infinite}
    @keyframes pulse{50%{transform:scale(1.4);opacity:.5}}
    .live-match{font-size:18px;font-weight:800;margin-bottom:6px}
    .live-score{font-size:48px;font-weight:900;color:var(--gold)}
    .live-action{margin-top:12px;padding:12px 24px;background:var(--green);color:#000;font-size:14px;font-weight:800;border:none;border-radius:12px;cursor:pointer}
    
    /* Next Game Card */
    .next-card{background:linear-gradient(135deg,#15152a,#1f1f40);border:1px solid var(--border);border-radius:18px;padding:20px;margin-bottom:14px;text-align:center}
    .next-card.gf{border:2px solid var(--gold);box-shadow:0 0 30px rgba(255,193,7,.2)}
    .next-tag{font-size:11px;font-weight:800;letter-spacing:2px;color:var(--gold);margin-bottom:8px}
    .next-match{font-size:22px;font-weight:800}
    .next-vs{display:block;font-size:12px;color:var(--muted);margin:4px 0}
    .next-btn{margin-top:16px;padding:14px 32px;background:linear-gradient(135deg,var(--gold),var(--gold2));color:#000;font-size:16px;font-weight:800;border:none;border-radius:30px;cursor:pointer}
    
    /* Quick Actions */
    .actions{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:14px}
    .act{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;text-align:center;cursor:pointer}
    .act-icon{font-size:28px;margin-bottom:6px}
    .act-text{font-size:12px;font-weight:700}
    
    /* Stats Summary */
    .stats-row{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px}
    .stat-box{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px 8px;text-align:center}
    .stat-val{font-size:24px;font-weight:900;color:var(--gold)}
    .stat-label{font-size:9px;font-weight:600;text-transform:uppercase;color:var(--muted);margin-top:4px}
    
    /* Tabs */
    .tabs{display:flex;background:var(--card);border-radius:12px;padding:4px;margin-bottom:14px}
    .tab{flex:1;padding:12px;text-align:center;font-size:12px;font-weight:700;color:var(--muted);background:none;border:none;border-radius:10px;cursor:pointer}
    .tab.on{background:var(--gold);color:#000}
    
    /* Tables */
    .tbl{width:100%;border-collapse:collapse;font-size:12px}
    .tbl th{padding:10px 6px;text-align:center;font-size:9px;font-weight:700;text-transform:uppercase;color:var(--muted);background:rgba(255,255,255,.03)}
    .tbl th:first-child{text-align:left;padding-left:12px}
    .tbl td{padding:12px 6px;text-align:center;border-bottom:1px solid var(--border)}
    .tbl td:first-child{text-align:left;padding-left:12px;font-weight:600}
    .tbl .top td{background:rgba(255,193,7,.08)}
    .champ{color:var(--gold);font-weight:800}
    .plus{color:var(--green)}.minus{color:var(--red)}
    
    /* Draw */
    .draw-item{display:flex;align-items:center;gap:12px;padding:14px;background:var(--card);border:1px solid var(--border);border-radius:14px;margin-bottom:8px;cursor:pointer}
    .draw-item.done{opacity:.5}
    .draw-item.gf{border:2px solid var(--gold)}
    .draw-num{width:36px;height:36px;background:var(--elev);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:800}
    .draw-item.done .draw-num{background:var(--green);color:#000}
    .draw-info{flex:1}
    .draw-players{font-size:14px;font-weight:700}
    .draw-result{font-size:15px;font-weight:800;color:var(--gold)}
    
    /* Buttons */
    .btn{width:100%;padding:16px;border-radius:14px;border:none;font-family:inherit;font-size:16px;font-weight:700;cursor:pointer;margin-bottom:10px}
    .btn-gold{background:linear-gradient(135deg,var(--gold),var(--gold2));color:#000}
    .btn-gray{background:var(--elev);color:var(--text);border:1px solid var(--border)}
    .btn-red{background:rgba(255,82,82,.15);color:var(--red)}
    .btn-green{background:var(--green);color:#000}
    .btn:disabled{opacity:.4;cursor:not-allowed}
    
    /* Nav */
    .nav{position:fixed;bottom:0;left:0;right:0;background:rgba(10,10,18,.98);backdrop-filter:blur(20px);border-top:1px solid var(--border);display:flex;padding:10px 20px calc(10px + var(--sb));z-index:100}
    .nav-btn{flex:1;padding:10px;text-align:center;font-size:11px;font-weight:600;color:var(--muted);background:none;border:none;border-radius:12px;cursor:pointer}
    .nav-btn.on{color:var(--gold);background:rgba(255,193,7,.1)}
    .nav-icon{font-size:22px;display:block;margin-bottom:4px}
    
    /* Inputs */
    input,select{width:100%;padding:14px;background:var(--elev);border:1px solid var(--border);color:var(--text);border-radius:12px;font-family:inherit;font-size:15px;margin-bottom:8px}
    input:focus,select:focus{outline:none;border-color:var(--gold)}
    
    /* Player List */
    .player-item{display:flex;align-items:center;padding:12px 0;border-bottom:1px solid var(--border)}
    .player-avatar{width:40px;height:40px;background:linear-gradient(135deg,#a855f7,var(--blue));border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:16px;margin-right:14px}
    .player-info{flex:1}
    .player-name{font-weight:700;font-size:15px}
    .player-stats{font-size:12px;color:var(--muted)}
    .player-del{width:36px;height:36px;background:rgba(255,82,82,.15);border:none;border-radius:50%;color:var(--red);font-size:18px;cursor:pointer}
    
    /* Toast */
    .toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%);background:var(--elev);border:1px solid var(--border);padding:14px 28px;border-radius:14px;font-size:14px;font-weight:600;z-index:900;opacity:0;transition:all .3s;pointer-events:none}
    .toast.show{opacity:1}
    .toast.ok{border-left:4px solid var(--green)}
    .toast.err{border-left:4px solid var(--red)}
    
    /* ============ GAME SCREEN ============ */
    #screen-game{background:#000}
    .game-hdr{position:absolute;top:0;left:0;right:0;padding:calc(10px + var(--st)) 14px 10px;display:flex;justify-content:space-between;align-items:center;z-index:50;background:linear-gradient(180deg,rgba(0,0,0,.95) 0%,transparent 100%)}
    .game-menu{width:50px;height:50px;background:rgba(255,255,255,.1);border:none;border-radius:14px;color:#fff;font-size:24px;cursor:pointer}
    .game-info{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .game-badge{padding:8px 14px;background:rgba(0,0,0,.7);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.1);border-radius:20px;font-size:12px;font-weight:700}
    .game-badge.live{background:var(--green);color:#000;border:none}
    .game-badge.gf{background:var(--gold);color:#000;border:none}
    
    .game-arena{position:absolute;inset:0;display:flex;flex-direction:column}
    .player-zone{flex:1;position:relative;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;overflow:hidden}
    .player-zone.p1{padding-top:70px}
    .player-zone.p2{padding-bottom:calc(20px + var(--sb))}
    
    .progress-bar{position:absolute;top:0;bottom:0;left:0;width:0%;transition:width .5s cubic-bezier(.4,0,.2,1);z-index:1}
    
    .player-ui{position:relative;z-index:10;text-align:center;width:100%}
    .player-header{display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:10px}
    .player-dart{width:24px;height:40px;border-radius:12px}
    .player-name{font-size:18px;font-weight:800;text-transform:uppercase;letter-spacing:1px}
    
    .score-controls{display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:12px}
    .score-btn{width:70px;height:70px;border-radius:50%;border:3px solid rgba(255,255,255,.2);background:rgba(0,0,0,.5);color:#fff;font-size:36px;font-weight:300;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .15s;-webkit-tap-highlight-color:transparent}
    .score-btn:active{transform:scale(.9);background:rgba(255,255,255,.2)}
    .score-btn.minus{color:var(--red);border-color:rgba(255,82,82,.4)}
    .score-btn.plus{color:var(--green);border-color:rgba(0,230,118,.4)}
    .score-display{font-size:72px;font-weight:900;min-width:100px;text-shadow:0 4px 20px rgba(0,0,0,.5)}
    
    .quick-btns{display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
    .quick-btn{min-width:55px;height:44px;padding:0 12px;border-radius:12px;border:2px solid rgba(255,255,255,.15);background:rgba(0,0,0,.5);color:#fff;font-size:16px;font-weight:700;cursor:pointer;transition:all .15s}
    .quick-btn:active{transform:scale(.9);background:rgba(255,255,255,.15)}
    
    .game-divider{height:6px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.3),transparent);position:relative;z-index:20;flex-shrink:0}
    .reset-btn{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:50px;height:50px;background:var(--card);border:2px solid var(--border);border-radius:50%;color:var(--muted);font-size:22px;cursor:pointer;z-index:21}
    
    /* Landscape Compact */
    @media(orientation:landscape) and (max-height:500px){
      .player-zone.p1{padding-top:55px}
      .player-name{font-size:14px}
      .score-display{font-size:48px;min-width:70px}
      .score-btn{width:50px;height:50px;font-size:26px}
      .quick-btn{min-width:45px;height:36px;font-size:13px}
      .game-badge{padding:5px 10px;font-size:10px}
    }
    
    /* Game Menu */
    .game-menu-overlay{position:fixed;inset:0;background:rgba(0,0,0,.95);display:none;flex-direction:column;align-items:center;justify-content:center;z-index:400;gap:14px}
    .game-menu-overlay.on{display:flex}
    .game-menu-overlay h2{font-size:26px;margin-bottom:20px}
    .menu-btn{width:280px;padding:18px;border-radius:16px;border:none;font-size:17px;font-weight:700;cursor:pointer}
    .menu-btn.resume{background:var(--green);color:#000}
    .menu-btn.end{background:var(--red);color:#fff}
    
    /* Win Screen */
    .win-screen{position:fixed;inset:0;background:linear-gradient(135deg,#0a0a12,#15152a,#0a1520);display:none;flex-direction:column;align-items:center;justify-content:center;z-index:500;padding:24px}
    .win-screen.on{display:flex}
    .win-trophy{font-size:100px;animation:bounce .5s infinite alternate}
    @keyframes bounce{to{transform:translateY(-15px) scale(1.05)}}
    .win-label{font-size:16px;letter-spacing:4px;color:var(--gold);margin-top:16px}
    .win-name{font-size:38px;font-weight:900;margin-top:10px}
    .win-score{font-size:26px;color:var(--dim);margin-top:6px}
    .win-btns{display:flex;gap:14px;margin-top:28px;flex-wrap:wrap;justify-content:center}
    .win-btn{padding:16px 32px;border-radius:14px;border:none;font-size:16px;font-weight:700;cursor:pointer}
    .win-btn.primary{background:var(--green);color:#000}
    .win-btn.secondary{background:var(--gold);color:#000}
    .win-btn.tertiary{background:var(--elev);color:#fff}
    
    .confetti{position:fixed;width:12px;height:12px;top:-20px;animation:fall 3s linear forwards;z-index:501;border-radius:2px}
    @keyframes fall{to{transform:translateY(100vh) rotate(720deg)}}
    
    .empty{text-align:center;padding:40px 20px;color:var(--muted)}
    .empty-icon{font-size:48px;margin-bottom:12px;opacity:.5}
    
    /* ============ DESKTOP ============ */
    @media(min-width:1024px){
      .mobile-only{display:none!important}
      .desktop-layout{display:flex!important;height:100vh}
      
      .d-sidebar{width:320px;min-width:280px;max-width:400px;background:var(--card);border-right:1px solid var(--border);display:flex;flex-direction:column;resize:horizontal;overflow:auto}
      .d-sidebar:last-child{border-right:none;border-left:1px solid var(--border)}
      
      .d-header{padding:18px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
      .d-header h2{font-size:18px;font-weight:800}
      .d-body{flex:1;overflow-y:auto;padding:16px}
      .d-section{margin-bottom:20px}
      .d-section-title{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-bottom:12px}
      
      .d-main{flex:1;background:var(--bg);display:flex;flex-direction:column;min-width:0}
      .d-main-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
      .d-game-area{flex:1;display:flex;flex-direction:column;padding:20px;overflow:hidden}
      
      /* Desktop Game */
      .d-game-container{flex:1;background:#000;border-radius:20px;overflow:hidden;position:relative;display:flex;flex-direction:column}
      .d-game-container .game-hdr{position:relative;padding:20px 24px}
      .d-game-container .game-arena{position:relative;flex:1}
      .d-game-container .player-zone{padding:40px}
      .d-game-container .player-zone.p1{padding-top:20px}
      .d-game-container .player-zone.p2{padding-bottom:20px}
      .d-game-container .score-display{font-size:120px}
      .d-game-container .score-btn{width:90px;height:90px;font-size:48px;border-width:4px}
      .d-game-container .quick-btn{min-width:70px;height:55px;font-size:20px;border-width:3px}
      .d-game-container .player-name{font-size:26px}
      .d-game-container .player-dart{width:32px;height:52px}
      
      /* Desktop Draw */
      .d-draw-item{display:flex;align-items:center;gap:10px;padding:12px;background:var(--elev);border:1px solid var(--border);border-radius:12px;margin-bottom:8px;font-size:13px;cursor:pointer;transition:all .2s}
      .d-draw-item:hover{background:var(--card);border-color:var(--gold)}
      .d-draw-item.done{opacity:.5}
      .d-draw-item.gf{border-color:var(--gold)}
      .d-draw-num{width:32px;height:32px;background:var(--card);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:800}
      .d-draw-item.done .d-draw-num{background:var(--green);color:#000}
      .d-draw-info{flex:1;font-weight:600}
      .d-draw-score{font-weight:800;color:var(--gold)}
      
      /* Desktop Player */
      .d-player-item{display:flex;align-items:center;padding:10px 0;border-bottom:1px solid var(--border);font-size:13px}
      .d-player-item .name{flex:1;font-weight:600}
      .d-player-item .stats{color:var(--muted);margin-right:10px}
      .d-player-del{width:28px;height:28px;background:rgba(255,82,82,.15);border:none;border-radius:50%;color:var(--red);font-size:14px;cursor:pointer}
    }
    @media(max-width:1023px){.desktop-layout{display:none!important}}
  </style>
</head>
<body>

<!-- Install Banner -->
<div class="install-banner" id="install-banner">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
    <span style="font-size:16px;font-weight:800;color:var(--gold)">üì± Install PopDarts</span>
    <button onclick="hideInstall()" style="background:none;border:none;color:var(--muted);font-size:24px;cursor:pointer">√ó</button>
  </div>
  <p style="font-size:13px;color:var(--dim);margin-bottom:14px">Add to home screen for the best experience!</p>
  <button onclick="doInstall()" style="width:100%;padding:14px;background:var(--gold);color:#000;font-size:15px;font-weight:700;border:none;border-radius:12px;cursor:pointer">Install App</button>
</div>

<!-- ============ MOBILE ============ -->
<div class="mobile-only">
  <div id="screen-home" class="screen active">
    <div class="hdr">
      <div class="logo">üéØ PopDarts</div>
      <div class="sync-ind"><span class="sync-dot"></span><span id="sync-status">Live</span></div>
    </div>
    <div class="content">
      <div id="live-zone"></div>
      <div id="next-zone"></div>
      <div class="actions">
        <div class="act" onclick="quickMatch()"><div class="act-icon">üéÆ</div><div class="act-text">Quick Match</div></div>
        <div class="act" onclick="generateDraw()"><div class="act-icon">üé≤</div><div class="act-text">New Draw</div></div>
      </div>
      <div class="stats-row">
        <div class="stat-box"><div class="stat-val" id="m-players">0</div><div class="stat-label">Players</div></div>
        <div class="stat-box"><div class="stat-val" id="m-games">0/0</div><div class="stat-label">Games</div></div>
        <div class="stat-box"><div class="stat-val" id="m-target">21</div><div class="stat-label">Target</div></div>
      </div>
      <div class="tabs">
        <button class="tab on" onclick="showTab('draw',this)">Draw</button>
        <button class="tab" onclick="showTab('standings',this)">Standings</button>
        <button class="tab" onclick="showTab('alltime',this)">All-Time</button>
      </div>
      <div id="tab-draw"></div>
      <div id="tab-standings" style="display:none"></div>
      <div id="tab-alltime" style="display:none"></div>
    </div>
  </div>

  <div id="screen-settings" class="screen">
    <div class="hdr">
      <div class="logo" style="font-size:18px">‚öôÔ∏è Settings</div>
      <div class="sync-ind"><span class="sync-dot"></span>Live</div>
    </div>
    <div class="content">
      <div class="card">
        <div class="card-title">üë• Players</div>
        <div style="display:flex;gap:8px;margin-bottom:14px">
          <input type="text" id="m-player-input" placeholder="Add player...">
          <button class="btn btn-green" style="width:auto;padding:14px 20px;margin:0" onclick="addPlayer('m-player-input')">+</button>
        </div>
        <div id="m-player-list"></div>
      </div>
      <div class="card">
        <div class="card-title">üéØ Target Score</div>
        <select id="m-target-select" onchange="setTarget(this.value)">
          <option value="11">First to 11</option>
          <option value="15">First to 15</option>
          <option value="21" selected>First to 21</option>
          <option value="31">First to 31</option>
        </select>
      </div>
      <div class="card">
        <div class="card-title">üèÜ Championship</div>
        <button class="btn btn-gold" onclick="generateDraw()">Generate New Draw</button>
        <button class="btn btn-red" onclick="clearDraw()">Clear All Games</button>
      </div>
    </div>
  </div>

  <div id="screen-game" class="screen">
    <div class="game-hdr">
      <button class="game-menu" onclick="showGameMenu()">‚ò∞</button>
      <div class="game-info">
        <div class="game-badge" id="m-game-label">Game 1</div>
        <div class="game-badge live">üî¥ LIVE</div>
      </div>
    </div>
    <div class="game-arena">
      <div class="player-zone p1" id="m-zone1">
        <div class="progress-bar" id="m-bar1"></div>
        <div class="player-ui">
          <div class="player-header">
            <div class="player-dart" id="m-dart1"></div>
            <div class="player-name" id="m-name1">Player 1</div>
          </div>
          <div class="score-controls">
            <button class="score-btn minus" onclick="adjustScore(1,-1)">‚àí</button>
            <div class="score-display" id="m-score1">0</div>
            <button class="score-btn plus" onclick="adjustScore(1,1)">+</button>
          </div>
          <div class="quick-btns">
            <button class="quick-btn" onclick="adjustScore(1,2)">+2</button>
            <button class="quick-btn" onclick="adjustScore(1,3)">+3</button>
            <button class="quick-btn" onclick="adjustScore(1,4)">+4</button>
            <button class="quick-btn" onclick="adjustScore(1,5)">+5</button>
          </div>
        </div>
      </div>
      <div class="game-divider"><button class="reset-btn" onclick="resetGame()">‚Ü∫</button></div>
      <div class="player-zone p2" id="m-zone2">
        <div class="progress-bar" id="m-bar2"></div>
        <div class="player-ui">
          <div class="player-header">
            <div class="player-dart" id="m-dart2"></div>
            <div class="player-name" id="m-name2">Player 2</div>
          </div>
          <div class="score-controls">
            <button class="score-btn minus" onclick="adjustScore(2,-1)">‚àí</button>
            <div class="score-display" id="m-score2">0</div>
            <button class="score-btn plus" onclick="adjustScore(2,1)">+</button>
          </div>
          <div class="quick-btns">
            <button class="quick-btn" onclick="adjustScore(2,2)">+2</button>
            <button class="quick-btn" onclick="adjustScore(2,3)">+3</button>
            <button class="quick-btn" onclick="adjustScore(2,4)">+4</button>
            <button class="quick-btn" onclick="adjustScore(2,5)">+5</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <nav class="nav" id="main-nav">
    <button class="nav-btn on" data-screen="home"><span class="nav-icon">üè†</span>Home</button>
    <button class="nav-btn" data-screen="settings"><span class="nav-icon">‚öôÔ∏è</span>Settings</button>
  </nav>
</div>

<!-- ============ DESKTOP ============ -->
<div class="desktop-layout" style="display:none">
  <div class="d-sidebar">
    <div class="d-header">
      <h2>üéØ PopDarts</h2>
      <div class="sync-ind"><span class="sync-dot"></span>Live</div>
    </div>
    <div class="d-body">
      <div class="d-section">
        <div class="d-section-title">üë• Players</div>
        <div style="display:flex;gap:6px;margin-bottom:12px">
          <input type="text" id="d-player-input" placeholder="Add player..." style="padding:12px;font-size:13px">
          <button class="btn btn-green" style="width:auto;margin:0;padding:12px 16px" onclick="addPlayer('d-player-input')">+</button>
        </div>
        <div id="d-player-list"></div>
      </div>
      <div class="d-section">
        <div class="d-section-title">üìã Full Draw</div>
        <div id="d-draw"></div>
      </div>
      <div class="d-section">
        <button class="btn btn-gold" style="font-size:13px;padding:12px" onclick="generateDraw()">üé≤ Generate Draw</button>
        <button class="btn btn-gray" style="font-size:13px;padding:12px" onclick="clearDraw()">Clear Draw</button>
      </div>
    </div>
  </div>
  
  <div class="d-main">
    <div class="d-main-header">
      <h2>üèüÔ∏è Stadium</h2>
      <select id="d-target-select" onchange="setTarget(this.value)" style="width:auto;padding:10px 14px;font-size:13px">
        <option value="11">To 11</option>
        <option value="15">To 15</option>
        <option value="21" selected>To 21</option>
        <option value="31">To 31</option>
      </select>
    </div>
    <div class="d-game-area" id="d-game-area"></div>
  </div>
  
  <div class="d-sidebar">
    <div class="d-header"><h2>üìä Stats</h2></div>
    <div class="d-body">
      <div class="d-section">
        <div class="d-section-title">üèÜ Standings</div>
        <div id="d-standings"></div>
      </div>
      <div class="d-section">
        <div class="d-section-title">üìà All-Time Stats</div>
        <div id="d-alltime"></div>
      </div>
    </div>
  </div>
</div>

<!-- Overlays -->
<div class="game-menu-overlay" id="game-menu">
  <h2>‚è∏Ô∏è Game Paused</h2>
  <button class="menu-btn resume" onclick="hideGameMenu()">‚ñ∂Ô∏è Resume Game</button>
  <button class="menu-btn end" onclick="endGame()">üö™ End & Exit</button>
</div>

<div class="win-screen" id="win-screen">
  <div class="win-trophy">üèÜ</div>
  <div class="win-label">üéâ WINNER üéâ</div>
  <div class="win-name" id="win-name">Player</div>
  <div class="win-score" id="win-score">21 - 15</div>
  <div class="win-btns">
    <button class="win-btn primary" id="win-save-btn" onclick="saveAndExit()">üíæ Save & Exit</button>
    <button class="win-btn secondary" onclick="playRematch()">üîÑ Rematch</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ============================================================================
// POPDARTS v7.0 - CLOUD-CENTRIC ARCHITECTURE
// The game LIVES in the cloud. All devices are views into the same game.
// ============================================================================

const API = 'https://script.google.com/macros/s/AKfycbzmdLog_tuyJMAE9hCLvfrsVT67LtwvLUOrrESZhUj0pBcbO6eFeajzKocXWfgQ9_MNTA/exec';

const DARTS = [
  {id:'green',grad:'linear-gradient(180deg,#1a1a1a,#22c55e,#1a1a1a)',color:'#22c55e'},
  {id:'blue',grad:'linear-gradient(180deg,#1a1a1a,#3b82f6,#1a1a1a)',color:'#3b82f6'},
  {id:'purple',grad:'linear-gradient(180deg,#f0f0f0,#a855f7,#f0f0f0)',color:'#a855f7'},
  {id:'orange',grad:'linear-gradient(180deg,#f97316,#ea580c)',color:'#f97316'},
  {id:'cyan',grad:'linear-gradient(180deg,#06b6d4,#0891b2)',color:'#06b6d4'},
  {id:'pink',grad:'linear-gradient(180deg,#ec4899,#db2777)',color:'#ec4899'}
];

// ============================================================================
// STATE - Minimal, synced from cloud
// ============================================================================
let DATA = {
  players: [],
  draw: [],
  stats: [],
  target: 21,
  live: null  // The current live game from cloud
};

let syncInterval = null;
let isProcessing = false;  // Prevent double-clicks
let installPrompt = null;

// ============================================================================
// CLOUD SYNC - Fast polling for live updates
// ============================================================================
async function syncAll() {
  try {
    const [players, stats, draw, live] = await Promise.all([
      fetchAPI('players'),
      fetchAPI('stats'),
      fetchAPI('draw'),
      fetchAPI('liveGame')
    ]);
    
    if (players?.players) DATA.players = players.players.filter(p => p?.trim());
    if (stats?.stats) DATA.stats = stats.stats;
    if (draw) {
      DATA.draw = [];
      if (draw.games) {
        draw.games.forEach(g => {
          DATA.draw.push({
            num: g.gameNum, p1: g.player1, p2: g.player2,
            s1: g.score1, s2: g.score2, winner: g.winner,
            isGF: g.gameNum === 'GF'
          });
        });
      }
      if (draw.grandFinal && !DATA.draw.find(g => g.isGF)) {
        const gf = draw.grandFinal;
        DATA.draw.push({num:'GF', p1:gf.player1, p2:gf.player2, s1:gf.score1, s2:gf.score2, winner:gf.winner, isGF:true});
      }
      if (draw.targetScore) DATA.target = draw.targetScore;
    }
    
    // LIVE GAME - This is the key!
    const oldLive = DATA.live;
    DATA.live = (live?.active) ? live : null;
    
    // If live game state changed, update UI
    if (DATA.live) {
      updateGameDisplay();
      // Check for win
      if (DATA.live.score1 >= DATA.target || DATA.live.score2 >= DATA.target) {
        showWinner();
      }
    }
    
    render();
  } catch (e) {
    console.error('Sync error:', e);
  }
}

async function fetchAPI(action) {
  try {
    const r = await fetch(`${API}?action=${action}`);
    const j = await r.json();
    return j.success ? j.data : null;
  } catch (e) {
    return null;
  }
}

async function postAPI(action, data) {
  if (isProcessing) return null;
  isProcessing = true;
  
  try {
    const r = await fetch(API, {
      method: 'POST',
      headers: {'Content-Type': 'text/plain'},
      body: JSON.stringify({action, ...data})
    });
    const j = await r.json();
    return j;
  } catch (e) {
    console.error('API error:', e);
    return null;
  } finally {
    isProcessing = false;
  }
}

function startSync() {
  stopSync();
  syncAll();
  // Fast sync for live game updates
  syncInterval = setInterval(syncAll, 800);
}

function stopSync() {
  if (syncInterval) {
    clearInterval(syncInterval);
    syncInterval = null;
  }
}

// ============================================================================
// NAVIGATION
// ============================================================================
document.querySelectorAll('.nav-btn').forEach(btn => {
  btn.onclick = () => {
    const screen = btn.dataset.screen;
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById('screen-' + screen)?.classList.add('active');
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.toggle('on', b.dataset.screen === screen));
    if (screen === 'settings') renderPlayers();
  };
});

function showTab(tab, btn) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('on'));
  btn.classList.add('on');
  document.getElementById('tab-draw').style.display = tab === 'draw' ? 'block' : 'none';
  document.getElementById('tab-standings').style.display = tab === 'standings' ? 'block' : 'none';
  document.getElementById('tab-alltime').style.display = tab === 'alltime' ? 'block' : 'none';
}

function goToGame() {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('screen-game').classList.add('active');
  document.getElementById('main-nav').style.display = 'none';
}

function goHome() {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('screen-home').classList.add('active');
  document.getElementById('main-nav').style.display = 'flex';
}

// ============================================================================
// RENDER
// ============================================================================
function render() {
  // Stats summary
  const done = DATA.draw.filter(g => !g.isGF && g.winner).length;
  const total = DATA.draw.filter(g => !g.isGF).length;
  
  document.getElementById('m-players').textContent = DATA.players.length;
  document.getElementById('m-games').textContent = total ? `${done}/${total}` : '0';
  document.getElementById('m-target').textContent = DATA.target;
  
  renderLive();
  renderNext();
  renderDraw();
  renderStandings();
  renderAllTime();
  
  if (window.innerWidth >= 1024) renderDesktop();
}

function renderLive() {
  const el = document.getElementById('live-zone');
  
  if (DATA.live) {
    el.innerHTML = `
      <div class="live-banner" onclick="joinGame()">
        <div class="live-inner">
          <div class="live-badge"><span class="live-dot"></span>LIVE GAME</div>
          <div class="live-match">${DATA.live.player1} vs ${DATA.live.player2}</div>
          <div class="live-score">${DATA.live.score1} - ${DATA.live.score2}</div>
          <button class="live-action">Tap to Join & Score</button>
        </div>
      </div>`;
  } else {
    el.innerHTML = '';
  }
}

function renderNext() {
  const el = document.getElementById('next-zone');
  
  // Don't show if there's a live game
  if (DATA.live) {
    el.innerHTML = '';
    return;
  }
  
  const next = DATA.draw.find(g => !g.winner);
  if (!next) {
    if (DATA.draw.length) {
      el.innerHTML = '<div class="next-card"><div class="next-tag">üéâ COMPLETE</div><div class="next-match">All games finished!</div></div>';
    } else {
      el.innerHTML = '<div class="next-card"><div class="next-tag" style="color:var(--muted)">NO CHAMPIONSHIP</div><div class="next-match">' + (DATA.players.length < 2 ? 'Add 2+ players' : 'Generate a draw') + '</div></div>';
    }
    return;
  }
  
  el.innerHTML = `
    <div class="next-card ${next.isGF ? 'gf' : ''}">
      <div class="next-tag">${next.isGF ? 'üèÜ GRAND FINAL üèÜ' : 'NEXT GAME ' + next.num}</div>
      <div class="next-match">${next.p1}<span class="next-vs">vs</span>${next.p2}</div>
      <button class="next-btn" onclick="startGame(${DATA.draw.indexOf(next)})">‚ñ∂Ô∏è Start Game</button>
    </div>`;
}

function renderDraw() {
  const el = document.getElementById('tab-draw');
  if (!DATA.draw.length) {
    el.innerHTML = '<div class="empty"><div class="empty-icon">üìã</div>No games yet</div>';
    return;
  }
  
  el.innerHTML = DATA.draw.map((g, i) => `
    <div class="draw-item ${g.winner ? 'done' : ''} ${g.isGF ? 'gf' : ''}" ${g.winner ? '' : `onclick="startGame(${i})"`}>
      <div class="draw-num">${g.isGF ? 'üèÜ' : g.num}</div>
      <div class="draw-info">
        <div class="draw-players">${g.p1} vs ${g.p2}</div>
      </div>
      <div class="draw-result">${g.winner ? g.s1 + '-' + g.s2 : '‚Äî'}</div>
    </div>
  `).join('');
}

function renderStandings() {
  const el = document.getElementById('tab-standings');
  
  const map = {};
  DATA.players.forEach(p => map[p] = {name:p, w:0, l:0, diff:0});
  DATA.draw.forEach(g => {
    if (!g.winner) return;
    if (map[g.p1]) { map[g.p1].w += g.winner===g.p1?1:0; map[g.p1].l += g.winner===g.p1?0:1; map[g.p1].diff += (g.s1||0)-(g.s2||0); }
    if (map[g.p2]) { map[g.p2].w += g.winner===g.p2?1:0; map[g.p2].l += g.winner===g.p2?0:1; map[g.p2].diff += (g.s2||0)-(g.s1||0); }
  });
  
  const sorted = Object.values(map).sort((a,b) => b.w - a.w || b.diff - a.diff);
  
  if (!sorted.length) {
    el.innerHTML = '<div class="empty">No standings</div>';
    return;
  }
  
  el.innerHTML = `<table class="tbl"><thead><tr><th>Player</th><th>W</th><th>L</th><th>+/-</th></tr></thead><tbody>
    ${sorted.map((p, i) => `<tr class="${i===0?'top':''}"><td>${i===0?'üëë ':''}${p.name}</td><td>${p.w}</td><td>${p.l}</td><td class="${p.diff>0?'plus':p.diff<0?'minus':''}">${p.diff>0?'+':''}${p.diff}</td></tr>`).join('')}
  </tbody></table>`;
}

function renderAllTime() {
  const el = document.getElementById('tab-alltime');
  
  if (!DATA.stats.length) {
    el.innerHTML = '<div class="empty">No stats</div>';
    return;
  }
  
  const sorted = [...DATA.stats].sort((a,b) => (b.championships||0) - (a.championships||0) || (b.wins||0) - (a.wins||0));
  
  el.innerHTML = `<table class="tbl"><thead><tr><th>Player</th><th>GP</th><th>W</th><th>L</th><th>%</th><th>F</th><th>A</th><th>D</th><th>üèÜ</th></tr></thead><tbody>
    ${sorted.map(s => {
      const pct = s.gamesPlayed ? Math.round(s.wins/s.gamesPlayed*100) : 0;
      const diff = s.pointsDiff || 0;
      return `<tr><td>${s.name}</td><td>${s.gamesPlayed||0}</td><td>${s.wins||0}</td><td>${s.losses||0}</td><td>${pct}</td><td>${s.pointsFor||0}</td><td>${s.pointsAgainst||0}</td><td class="${diff>0?'plus':diff<0?'minus':''}">${diff>0?'+':''}${diff}</td><td class="${s.championships?'champ':''}">${s.championships||0}</td></tr>`;
    }).join('')}
  </tbody></table>`;
}

// ============================================================================
// DESKTOP RENDER
// ============================================================================
function renderDesktop() {
  renderDesktopPlayers();
  renderDesktopDraw();
  renderDesktopStandings();
  renderDesktopAllTime();
  renderDesktopGame();
}

function renderDesktopPlayers() {
  const el = document.getElementById('d-player-list');
  if (!DATA.players.length) {
    el.innerHTML = '<div style="color:var(--muted);font-size:12px;padding:10px 0">No players</div>';
    return;
  }
  
  el.innerHTML = DATA.players.map(p => {
    const stat = DATA.stats.find(s => s.name === p) || {};
    return `<div class="d-player-item"><span class="name">${stat.championships ? 'üèÜ ' : ''}${p}</span><span class="stats">${stat.wins||0}W</span><button class="d-player-del" onclick="deletePlayer('${p.replace(/'/g, "\\'")}')">√ó</button></div>`;
  }).join('');
}

function renderDesktopDraw() {
  const el = document.getElementById('d-draw');
  if (!DATA.draw.length) {
    el.innerHTML = '<div style="color:var(--muted);font-size:12px">No games</div>';
    return;
  }
  
  el.innerHTML = DATA.draw.map((g, i) => `
    <div class="d-draw-item ${g.winner?'done':''} ${g.isGF?'gf':''}" ${g.winner?'':`onclick="startGame(${i})"`}>
      <div class="d-draw-num">${g.isGF?'üèÜ':g.num}</div>
      <div class="d-draw-info">${g.p1} vs ${g.p2}</div>
      <div class="d-draw-score">${g.winner ? g.s1+'-'+g.s2 : '‚Äî'}</div>
    </div>
  `).join('');
}

function renderDesktopStandings() {
  const el = document.getElementById('d-standings');
  const map = {};
  DATA.players.forEach(p => map[p] = {name:p, w:0, l:0, diff:0});
  DATA.draw.forEach(g => {
    if (!g.winner) return;
    if (map[g.p1]) { map[g.p1].w += g.winner===g.p1?1:0; map[g.p1].l += g.winner===g.p1?0:1; map[g.p1].diff += (g.s1||0)-(g.s2||0); }
    if (map[g.p2]) { map[g.p2].w += g.winner===g.p2?1:0; map[g.p2].l += g.winner===g.p2?0:1; map[g.p2].diff += (g.s2||0)-(g.s1||0); }
  });
  const sorted = Object.values(map).sort((a,b) => b.w-a.w || b.diff-a.diff);
  
  if (!sorted.length) { el.innerHTML = '<div style="color:var(--muted);font-size:11px">No standings</div>'; return; }
  
  el.innerHTML = `<table class="tbl" style="font-size:11px"><thead><tr><th>Player</th><th>W</th><th>L</th><th>+/-</th></tr></thead><tbody>
    ${sorted.map((p,i) => `<tr class="${i===0?'top':''}"><td>${i===0?'üëë ':''}${p.name}</td><td>${p.w}</td><td>${p.l}</td><td class="${p.diff>0?'plus':p.diff<0?'minus':''}">${p.diff>0?'+':''}${p.diff}</td></tr>`).join('')}
  </tbody></table>`;
}

function renderDesktopAllTime() {
  const el = document.getElementById('d-alltime');
  if (!DATA.stats.length) { el.innerHTML = '<div style="color:var(--muted);font-size:11px">No stats</div>'; return; }
  
  const sorted = [...DATA.stats].sort((a,b) => (b.championships||0)-(a.championships||0) || (b.wins||0)-(a.wins||0));
  
  el.innerHTML = `<table class="tbl" style="font-size:10px"><thead><tr><th>Player</th><th>GP</th><th>W</th><th>L</th><th>%</th><th>F</th><th>A</th><th>D</th><th>üèÜ</th></tr></thead><tbody>
    ${sorted.map(s => {
      const pct = s.gamesPlayed ? Math.round(s.wins/s.gamesPlayed*100) : 0;
      const diff = s.pointsDiff || 0;
      return `<tr><td>${s.name}</td><td>${s.gamesPlayed||0}</td><td>${s.wins||0}</td><td>${s.losses||0}</td><td>${pct}</td><td>${s.pointsFor||0}</td><td>${s.pointsAgainst||0}</td><td class="${diff>0?'plus':diff<0?'minus':''}">${diff>0?'+':''}${diff}</td><td class="${s.championships?'champ':''}">${s.championships||0}</td></tr>`;
    }).join('')}
  </tbody></table>`;
}

function renderDesktopGame() {
  const el = document.getElementById('d-game-area');
  
  if (DATA.live) {
    const d1 = DARTS.find(d => d.id === DATA.live.color1) || DARTS[0];
    const d2 = DARTS.find(d => d.id === DATA.live.color2) || DARTS[1];
    const p1pct = Math.min(100, (DATA.live.score1 / DATA.target) * 100);
    const p2pct = Math.min(100, (DATA.live.score2 / DATA.target) * 100);
    
    el.innerHTML = `
      <div class="d-game-container">
        <div class="game-hdr">
          <button class="game-menu" onclick="showGameMenu()">‚ò∞</button>
          <div class="game-info">
            <div class="game-badge ${DATA.live.isGF?'gf':''}">${DATA.live.isGF?'üèÜ GRAND FINAL':DATA.live.isChamp?'Game '+DATA.live.gameId:'Quick Match'}</div>
            <div class="game-badge live">üî¥ LIVE</div>
          </div>
        </div>
        <div class="game-arena">
          <div class="player-zone p1">
            <div class="progress-bar" style="width:${p1pct}%;background:${d1.grad}"></div>
            <div class="player-ui">
              <div class="player-header"><div class="player-dart" style="background:${d1.grad}"></div><div class="player-name">${DATA.live.player1}</div></div>
              <div class="score-controls">
                <button class="score-btn minus" onclick="adjustScore(1,-1)">‚àí</button>
                <div class="score-display">${DATA.live.score1}</div>
                <button class="score-btn plus" onclick="adjustScore(1,1)">+</button>
              </div>
              <div class="quick-btns">
                <button class="quick-btn" onclick="adjustScore(1,2)">+2</button>
                <button class="quick-btn" onclick="adjustScore(1,3)">+3</button>
                <button class="quick-btn" onclick="adjustScore(1,4)">+4</button>
                <button class="quick-btn" onclick="adjustScore(1,5)">+5</button>
              </div>
            </div>
          </div>
          <div class="game-divider"><button class="reset-btn" onclick="resetGame()">‚Ü∫</button></div>
          <div class="player-zone p2">
            <div class="progress-bar" style="width:${p2pct}%;background:${d2.grad}"></div>
            <div class="player-ui">
              <div class="player-header"><div class="player-dart" style="background:${d2.grad}"></div><div class="player-name">${DATA.live.player2}</div></div>
              <div class="score-controls">
                <button class="score-btn minus" onclick="adjustScore(2,-1)">‚àí</button>
                <div class="score-display">${DATA.live.score2}</div>
                <button class="score-btn plus" onclick="adjustScore(2,1)">+</button>
              </div>
              <div class="quick-btns">
                <button class="quick-btn" onclick="adjustScore(2,2)">+2</button>
                <button class="quick-btn" onclick="adjustScore(2,3)">+3</button>
                <button class="quick-btn" onclick="adjustScore(2,4)">+4</button>
                <button class="quick-btn" onclick="adjustScore(2,5)">+5</button>
              </div>
            </div>
          </div>
        </div>
      </div>`;
    return;
  }
  
  // No live game - show next or status
  const next = DATA.draw.find(g => !g.winner);
  if (!next) {
    el.innerHTML = `<div style="flex:1;display:flex;align-items:center;justify-content:center"><div class="next-card" style="max-width:450px"><div class="next-tag">${DATA.draw.length?'üéâ COMPLETE':'NO CHAMPIONSHIP'}</div><div class="next-match">${DATA.draw.length?'All games done!':DATA.players.length<2?'Add 2+ players':'Generate a draw'}</div></div></div>`;
    return;
  }
  
  const idx = DATA.draw.indexOf(next);
  el.innerHTML = `<div style="flex:1;display:flex;align-items:center;justify-content:center"><div class="next-card ${next.isGF?'gf':''}" style="max-width:500px;padding:40px"><div class="next-tag" style="font-size:14px">${next.isGF?'üèÜ GRAND FINAL üèÜ':'NEXT GAME '+next.num}</div><div class="next-match" style="font-size:32px">${next.p1}<span class="next-vs" style="font-size:16px">vs</span>${next.p2}</div><button class="next-btn" onclick="startGame(${idx})" style="font-size:18px;padding:18px 40px">‚ñ∂Ô∏è Start Game</button></div></div>`;
}

// ============================================================================
// GAME ACTIONS - All changes go to cloud!
// ============================================================================
async function startGame(idx) {
  if (isProcessing) return;
  
  const game = DATA.draw[idx];
  if (!game || game.winner) return;
  
  // Pick random darts
  const d1 = DARTS[Math.floor(Math.random() * DARTS.length)];
  let d2;
  do { d2 = DARTS[Math.floor(Math.random() * DARTS.length)]; } while (d2.id === d1.id);
  
  // Create live game in cloud
  await postAPI('updateLiveGame', {
    active: true,
    gameId: game.num,
    player1: game.p1,
    player2: game.p2,
    score1: 0,
    score2: 0,
    color1: d1.id,
    color2: d2.id,
    target: DATA.target,
    isChamp: true,
    isGF: game.isGF
  });
  
  // Sync immediately
  await syncAll();
  
  // Show game screen on mobile
  if (window.innerWidth < 1024) {
    updateMobileGameUI();
    goToGame();
  }
}

function joinGame() {
  if (!DATA.live) return;
  updateMobileGameUI();
  goToGame();
}

async function quickMatch() {
  if (DATA.players.length < 2) {
    toast('Add 2+ players first', 'err');
    return;
  }
  
  // Pick 2 random players
  const shuffled = [...DATA.players].sort(() => Math.random() - 0.5);
  const p1 = shuffled[0];
  const p2 = shuffled[1];
  
  // Pick random darts
  const d1 = DARTS[Math.floor(Math.random() * DARTS.length)];
  let d2;
  do { d2 = DARTS[Math.floor(Math.random() * DARTS.length)]; } while (d2.id === d1.id);
  
  await postAPI('updateLiveGame', {
    active: true,
    gameId: 'quick',
    player1: p1,
    player2: p2,
    score1: 0,
    score2: 0,
    color1: d1.id,
    color2: d2.id,
    target: DATA.target,
    isChamp: false,
    isGF: false
  });
  
  await syncAll();
  
  if (window.innerWidth < 1024) {
    updateMobileGameUI();
    goToGame();
  }
}

function updateMobileGameUI() {
  if (!DATA.live) return;
  
  const d1 = DARTS.find(d => d.id === DATA.live.color1) || DARTS[0];
  const d2 = DARTS.find(d => d.id === DATA.live.color2) || DARTS[1];
  
  document.getElementById('m-name1').textContent = DATA.live.player1;
  document.getElementById('m-name2').textContent = DATA.live.player2;
  document.getElementById('m-dart1').style.background = d1.grad;
  document.getElementById('m-dart2').style.background = d2.grad;
  document.getElementById('m-game-label').textContent = DATA.live.isGF ? 'üèÜ GF' : DATA.live.isChamp ? 'Game ' + DATA.live.gameId : 'Quick';
  
  updateGameDisplay();
}

function updateGameDisplay() {
  if (!DATA.live) return;
  
  const d1 = DARTS.find(d => d.id === DATA.live.color1) || DARTS[0];
  const d2 = DARTS.find(d => d.id === DATA.live.color2) || DARTS[1];
  const p1pct = Math.min(100, (DATA.live.score1 / DATA.target) * 100);
  const p2pct = Math.min(100, (DATA.live.score2 / DATA.target) * 100);
  
  // Mobile
  const ms1 = document.getElementById('m-score1');
  const ms2 = document.getElementById('m-score2');
  const mb1 = document.getElementById('m-bar1');
  const mb2 = document.getElementById('m-bar2');
  
  if (ms1) ms1.textContent = DATA.live.score1;
  if (ms2) ms2.textContent = DATA.live.score2;
  if (mb1) { mb1.style.width = p1pct + '%'; mb1.style.background = d1.grad; }
  if (mb2) { mb2.style.width = p2pct + '%'; mb2.style.background = d2.grad; }
}

async function adjustScore(player, amount) {
  if (!DATA.live || isProcessing) return;
  
  const newS1 = player === 1 ? Math.max(0, DATA.live.score1 + amount) : DATA.live.score1;
  const newS2 = player === 2 ? Math.max(0, DATA.live.score2 + amount) : DATA.live.score2;
  
  // Update cloud immediately
  await postAPI('updateLiveGame', {
    active: true,
    gameId: DATA.live.gameId,
    player1: DATA.live.player1,
    player2: DATA.live.player2,
    score1: newS1,
    score2: newS2,
    color1: DATA.live.color1,
    color2: DATA.live.color2,
    target: DATA.target,
    isChamp: DATA.live.isChamp,
    isGF: DATA.live.isGF
  });
  
  // Optimistic update for responsiveness
  DATA.live.score1 = newS1;
  DATA.live.score2 = newS2;
  updateGameDisplay();
  
  // Check for win
  if (newS1 >= DATA.target || newS2 >= DATA.target) {
    showWinner();
  }
}

async function resetGame() {
  if (!DATA.live || !confirm('Reset scores to 0-0?')) return;
  
  await postAPI('updateLiveGame', {
    ...DATA.live,
    score1: 0,
    score2: 0
  });
  
  DATA.live.score1 = 0;
  DATA.live.score2 = 0;
  updateGameDisplay();
}

// ============================================================================
// GAME MENU & WIN
// ============================================================================
function showGameMenu() {
  document.getElementById('game-menu').classList.add('on');
}

function hideGameMenu() {
  document.getElementById('game-menu').classList.remove('on');
}

async function endGame() {
  hideGameMenu();
  await postAPI('clearLiveGame', {});
  DATA.live = null;
  goHome();
  render();
}

function showWinner() {
  if (!DATA.live) return;
  
  const winner = DATA.live.score1 >= DATA.target ? DATA.live.player1 : DATA.live.player2;
  
  document.getElementById('win-name').textContent = winner;
  document.getElementById('win-score').textContent = `${DATA.live.score1} - ${DATA.live.score2}`;
  document.getElementById('win-save-btn').style.display = DATA.live.isChamp ? 'inline-block' : 'none';
  document.getElementById('win-save-btn').textContent = DATA.live.isChamp ? 'üíæ Save & Exit' : 'üö™ Exit';
  document.getElementById('win-screen').classList.add('on');
  
  confetti();
}

async function saveAndExit() {
  if (!DATA.live) {
    document.getElementById('win-screen').classList.remove('on');
    goHome();
    return;
  }
  
  // Save game result if championship
  if (DATA.live.isChamp && DATA.live.gameId !== 'quick') {
    await postAPI('submitGame', {
      gameId: DATA.live.gameId,
      player1: DATA.live.player1,
      player2: DATA.live.player2,
      score1: DATA.live.score1,
      score2: DATA.live.score2
    });
    
    toast(DATA.live.isGF ? 'üèÜ Champion crowned!' : 'Game saved!', 'ok');
  }
  
  // Clear live game
  await postAPI('clearLiveGame', {});
  DATA.live = null;
  
  document.getElementById('win-screen').classList.remove('on');
  goHome();
  await syncAll();
}

async function playRematch() {
  if (!DATA.live) return;
  
  // Reset scores in cloud
  await postAPI('updateLiveGame', {
    ...DATA.live,
    score1: 0,
    score2: 0
  });
  
  document.getElementById('win-screen').classList.remove('on');
  await syncAll();
}

function confetti() {
  const colors = ['#ffc107', '#00e676', '#ff5252', '#448aff', '#a855f7'];
  for (let i = 0; i < 50; i++) {
    setTimeout(() => {
      const c = document.createElement('div');
      c.className = 'confetti';
      c.style.left = Math.random() * 100 + 'vw';
      c.style.background = colors[Math.floor(Math.random() * colors.length)];
      c.style.animationDuration = (2 + Math.random() * 2) + 's';
      document.body.appendChild(c);
      setTimeout(() => c.remove(), 4000);
    }, i * 30);
  }
}

// ============================================================================
// PLAYERS
// ============================================================================
function renderPlayers() {
  const el = document.getElementById('m-player-list');
  if (!DATA.players.length) {
    el.innerHTML = '<div style="text-align:center;color:var(--muted);padding:20px">No players yet</div>';
    return;
  }
  
  el.innerHTML = DATA.players.map(p => {
    const stat = DATA.stats.find(s => s.name === p) || {};
    return `<div class="player-item"><div class="player-avatar">${p[0].toUpperCase()}</div><div class="player-info"><div class="player-name">${stat.championships ? 'üèÜ ' : ''}${p}</div><div class="player-stats">${stat.gamesPlayed||0} GP ‚Ä¢ ${stat.wins||0} W</div></div><button class="player-del" onclick="deletePlayer('${p.replace(/'/g, "\\'")}')">√ó</button></div>`;
  }).join('');
}

async function addPlayer(inputId) {
  const inp = document.getElementById(inputId);
  const name = inp.value.trim();
  if (!name) return;
  
  if (DATA.players.some(p => p.toLowerCase() === name.toLowerCase())) {
    toast('Player already exists', 'err');
    return;
  }
  
  await postAPI('addPlayer', {playerName: name});
  inp.value = '';
  await syncAll();
  renderPlayers();
  toast('Player added!', 'ok');
}

async function deletePlayer(name) {
  if (!confirm(`Remove ${name}?\n\nTheir stats will be kept in All-Time.`)) return;
  await postAPI('deletePlayer', {playerName: name});
  await syncAll();
  renderPlayers();
  toast('Player removed', 'ok');
}

// ============================================================================
// DRAW
// ============================================================================
async function generateDraw() {
  if (DATA.players.length < 2) {
    toast('Need 2+ players', 'err');
    return;
  }
  if (DATA.draw.length && !confirm('Replace current draw?')) return;
  if (isProcessing) return;
  
  await postAPI('generateDraw', {});
  await syncAll();
  toast('Draw generated!', 'ok');
}

async function clearDraw() {
  if (!confirm('Clear all games?')) return;
  if (isProcessing) return;
  
  await postAPI('newEvent', {});
  await syncAll();
  toast('Draw cleared', 'ok');
}

function setTarget(val) {
  DATA.target = parseInt(val) || 21;
  document.getElementById('m-target-select').value = DATA.target;
  document.getElementById('d-target-select').value = DATA.target;
  render();
}

// ============================================================================
// PWA INSTALL
// ============================================================================
window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  installPrompt = e;
  setTimeout(() => {
    document.getElementById('install-banner').classList.add('show');
  }, 3000);
});

function hideInstall() {
  document.getElementById('install-banner').classList.remove('show');
}

function doInstall() {
  if (installPrompt) {
    installPrompt.prompt();
    installPrompt.userChoice.then(() => {
      installPrompt = null;
      hideInstall();
    });
  }
}

// iOS detection
if (/iPad|iPhone|iPod/.test(navigator.userAgent) && !window.navigator.standalone) {
  setTimeout(() => {
    document.getElementById('install-banner').classList.add('show');
  }, 5000);
}

// ============================================================================
// UTILS
// ============================================================================
function toast(msg, type) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = 'toast show ' + (type || 'ok');
  setTimeout(() => el.classList.remove('show'), 2500);
}

// Input enter key
document.getElementById('m-player-input')?.addEventListener('keypress', e => { if (e.key === 'Enter') addPlayer('m-player-input'); });
document.getElementById('d-player-input')?.addEventListener('keypress', e => { if (e.key === 'Enter') addPlayer('d-player-input'); });

// ============================================================================
// INIT
// ============================================================================
startSync();
console.log('[PopDarts] v7.0 - Cloud-Centric Architecture Ready!');
</script>
</body>
</html>
