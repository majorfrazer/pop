<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="PopDarts">
  <meta name="theme-color" content="#0a0a12">
  <title>PopDarts</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
    :root{
      --bg:#0a0a12;--card:#12121f;--elev:#1a1a2e;--border:rgba(255,255,255,.06);
      --text:#fff;--dim:#9898b0;--muted:#55556a;
      --gold:#ffc107;--gold2:#ff9800;--green:#00e676;--red:#ff5252;--blue:#448aff;--purple:#b388ff;--cyan:#18ffff;
      --glow-gold:rgba(255,193,7,.4);--glow-green:rgba(0,230,118,.4);
      --st:env(safe-area-inset-top,0);--sb:env(safe-area-inset-bottom,0);--sl:env(safe-area-inset-left,0);--sr:env(safe-area-inset-right,0);
    }
    *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;user-select:none}
    html,body{font-family:'Inter',system-ui,sans-serif;background:var(--bg);color:var(--text);height:100%;overflow:hidden}
    
    /* INSTALL BANNER */
    .install-banner{position:fixed;bottom:75px;left:12px;right:12px;background:linear-gradient(135deg,#1a1a35 0%,#252550 100%);border:2px solid var(--gold);border-radius:16px;padding:16px;display:none;z-index:300;box-shadow:0 8px 32px rgba(0,0,0,.6),0 0 20px var(--glow-gold)}
    .install-banner.show{display:block;animation:slideUp .4s}
    @keyframes slideUp{from{transform:translateY(100px);opacity:0}to{transform:translateY(0);opacity:1}}
    .install-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .install-title{font-size:15px;font-weight:800;color:var(--gold);display:flex;align-items:center;gap:8px}
    .install-close{background:none;border:none;color:var(--muted);font-size:22px;cursor:pointer;padding:4px}
    .install-text{font-size:12px;color:var(--dim);margin-bottom:12px;line-height:1.4}
    .install-btn{width:100%;padding:12px;background:linear-gradient(135deg,var(--gold),var(--gold2));color:#000;font-size:14px;font-weight:800;border:none;border-radius:10px;cursor:pointer}
    
    /* SCREENS */
    .screen{position:fixed;inset:0;display:none;flex-direction:column;background:var(--bg);z-index:10;overflow:hidden}
    .screen.active{display:flex}
    
    /* HEADER */
    .hdr{display:flex;align-items:center;justify-content:space-between;padding:calc(12px + var(--st)) 16px 12px;background:linear-gradient(180deg,var(--bg) 0%,transparent 100%);position:relative;z-index:20}
    .logo{font-size:22px;font-weight:900;background:linear-gradient(135deg,var(--gold),var(--gold2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;cursor:pointer;display:flex;align-items:center;gap:8px}
    .logo::before{content:'üéØ';-webkit-text-fill-color:initial}
    .sync-btn{display:flex;align-items:center;gap:6px;padding:8px 14px;background:var(--card);border:1px solid var(--border);border-radius:20px;font-size:12px;font-weight:600;color:var(--dim);cursor:pointer;transition:all .2s}
    .sync-btn:active{transform:scale(.95)}
    .sync-dot{width:8px;height:8px;border-radius:50%;background:var(--red);transition:background .3s}
    .sync-dot.ok{background:var(--green);box-shadow:0 0 8px var(--glow-green)}
    .sync-dot.busy{background:var(--gold);animation:pulse .5s infinite alternate}
    @keyframes pulse{to{opacity:.4}}
    
    /* CONTENT */
    .content{flex:1;overflow-y:auto;padding:0 14px 14px;padding-bottom:calc(85px + var(--sb))}
    
    /* CARDS */
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin-bottom:12px}
    .card-label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);margin-bottom:10px;display:flex;align-items:center;gap:6px}
    
    /* LIVE BANNER - THE STAR */
    .live-card{background:linear-gradient(135deg,#0a2818 0%,#041810 100%);border:2px solid var(--green);border-radius:18px;padding:18px;margin-bottom:14px;cursor:pointer;position:relative;overflow:hidden}
    .live-card::before{content:'';position:absolute;inset:-50%;background:conic-gradient(from 0deg,transparent,var(--green),transparent);animation:rotate 4s linear infinite;opacity:.1}
    @keyframes rotate{to{transform:rotate(360deg)}}
    .live-card::after{content:'';position:absolute;inset:2px;background:linear-gradient(135deg,#0a2818 0%,#041810 100%);border-radius:16px;z-index:0}
    .live-inner{position:relative;z-index:1}
    .live-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .live-badge{display:flex;align-items:center;gap:6px;font-size:11px;font-weight:800;letter-spacing:2px;color:var(--green);text-shadow:0 0 10px var(--glow-green)}
    .live-pulse{width:10px;height:10px;background:var(--green);border-radius:50%;animation:livePulse 1s infinite;box-shadow:0 0 10px var(--glow-green)}
    @keyframes livePulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.3);opacity:.6}}
    .live-join{padding:8px 16px;background:var(--green);color:#000;font-size:12px;font-weight:800;border:none;border-radius:8px;cursor:pointer;box-shadow:0 4px 15px var(--glow-green)}
    .live-players{font-size:16px;font-weight:700;margin-bottom:4px}
    .live-score{font-size:38px;font-weight:900;background:linear-gradient(135deg,var(--gold),var(--gold2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-shadow:none}
    
    /* PAUSED BANNER */
    .paused-card{background:linear-gradient(135deg,#101830,#0c1425);border:2px solid var(--blue);border-radius:16px;padding:14px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;cursor:pointer}
    .paused-info .label{font-size:10px;font-weight:700;color:var(--blue);letter-spacing:1px}
    .paused-info .players{font-size:14px;font-weight:700;margin-top:2px}
    .paused-info .score{font-size:12px;color:var(--dim)}
    .paused-btn{padding:8px 16px;background:var(--blue);color:#fff;font-size:12px;font-weight:700;border:none;border-radius:8px}
    
    /* HERO CARD */
    .hero{background:linear-gradient(135deg,#15152a 0%,#1f1f40 100%);border:1px solid var(--border);border-radius:20px;padding:22px 18px;margin-bottom:14px;text-align:center;position:relative;overflow:hidden}
    .hero::before{content:'üéØ';position:absolute;font-size:100px;opacity:.04;right:-20px;top:-20px}
    .hero-tag{font-size:11px;font-weight:800;letter-spacing:2px;color:var(--gold);margin-bottom:8px}
    .hero-match{font-size:22px;font-weight:800;line-height:1.3}
    .hero-vs{display:block;font-size:12px;color:var(--muted);margin:4px 0}
    .hero-btn{display:inline-flex;align-items:center;gap:8px;margin-top:14px;padding:14px 32px;background:linear-gradient(135deg,var(--gold),var(--gold2));color:#000;font-size:16px;font-weight:800;border:none;border-radius:30px;cursor:pointer;box-shadow:0 6px 20px var(--glow-gold)}
    .hero-btn:active{transform:scale(.97)}
    .hero.gf{border:2px solid var(--gold);box-shadow:0 0 30px var(--glow-gold)}
    .hero.gf .hero-tag{color:#fff;text-shadow:0 0 10px var(--glow-gold)}
    
    /* QUICK ACTIONS */
    .actions{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:14px}
    .act{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px 8px;text-align:center;cursor:pointer;transition:all .2s}
    .act:active{transform:scale(.95);background:var(--elev)}
    .act.gold{background:linear-gradient(135deg,var(--gold),var(--gold2));border:none;box-shadow:0 4px 15px var(--glow-gold)}
    .act-icon{font-size:26px;margin-bottom:4px}
    .act-text{font-size:11px;font-weight:700}
    .act.gold .act-text{color:#000}
    
    /* STATS ROW */
    .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px}
    .stat{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px 6px;text-align:center}
    .stat-val{font-size:22px;font-weight:900;background:linear-gradient(135deg,var(--gold),var(--gold2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .stat-name{font-size:8px;font-weight:600;text-transform:uppercase;color:var(--muted);margin-top:2px;letter-spacing:.5px}
    
    /* TABS */
    .tabs{display:flex;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:4px;margin-bottom:12px}
    .tab{flex:1;padding:10px 4px;text-align:center;font-size:11px;font-weight:700;color:var(--muted);background:none;border:none;border-radius:8px;cursor:pointer;transition:all .2s}
    .tab.on{background:linear-gradient(135deg,var(--gold),var(--gold2));color:#000}
    
    /* TABLES */
    .tbl{width:100%;border-collapse:collapse;font-size:11px}
    .tbl th{padding:8px 4px;text-align:center;font-size:8px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--muted);background:rgba(255,255,255,.02)}
    .tbl th:first-child{text-align:left;padding-left:10px;border-radius:8px 0 0 8px}
    .tbl th:last-child{border-radius:0 8px 8px 0}
    .tbl td{padding:10px 4px;text-align:center;border-bottom:1px solid var(--border)}
    .tbl td:first-child{text-align:left;padding-left:10px;font-weight:600}
    .tbl .top td{background:linear-gradient(90deg,rgba(255,193,7,.1),transparent)}
    .tbl .champ{color:var(--gold);font-weight:800}
    .plus{color:var(--green)}.minus{color:var(--red)}
    
    /* DRAW ROWS */
    .draw-row{display:flex;align-items:center;gap:10px;padding:12px;background:var(--card);border:1px solid var(--border);border-radius:12px;margin-bottom:6px;cursor:pointer;transition:all .2s}
    .draw-row:active{background:var(--elev);transform:scale(.99)}
    .draw-row.done{opacity:.5}
    .draw-row.gf{border:2px solid var(--gold);background:linear-gradient(135deg,rgba(255,193,7,.05),transparent)}
    .draw-num{width:32px;height:32px;background:var(--elev);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:800}
    .draw-row.done .draw-num{background:var(--green);color:#000}
    .draw-players{flex:1;font-size:13px;font-weight:600}
    .draw-players .winner{color:var(--green)}
    .draw-result{font-size:14px;font-weight:800;color:var(--gold);min-width:45px;text-align:center}
    .draw-undo{width:28px;height:28px;background:rgba(255,82,82,.15);border:none;border-radius:6px;color:var(--red);font-size:14px;cursor:pointer}
    
    /* BUTTONS */
    .btn{width:100%;padding:14px;border-radius:12px;border:none;font-family:inherit;font-size:15px;font-weight:700;cursor:pointer;margin-bottom:8px;transition:all .2s}
    .btn:active{transform:scale(.98)}
    .btn-gold{background:linear-gradient(135deg,var(--gold),var(--gold2));color:#000;box-shadow:0 4px 15px var(--glow-gold)}
    .btn-gray{background:var(--elev);color:var(--text);border:1px solid var(--border)}
    .btn-red{background:rgba(255,82,82,.15);color:var(--red)}
    .btn-green{background:var(--green);color:#000}
    
    /* NAV */
    .nav{position:fixed;bottom:0;left:0;right:0;background:rgba(10,10,18,.95);backdrop-filter:blur(20px);border-top:1px solid var(--border);display:flex;padding:8px 16px calc(8px + var(--sb));z-index:100}
    .nav-btn{flex:1;padding:8px 0;text-align:center;font-size:10px;font-weight:600;color:var(--muted);background:none;border:none;border-radius:10px;cursor:pointer;transition:all .2s}
    .nav-btn.on{color:var(--gold);background:rgba(255,193,7,.1)}
    .nav-icon{font-size:20px;display:block;margin-bottom:2px}
    
    /* INPUTS */
    input,select{width:100%;padding:12px 14px;background:var(--elev);border:1px solid var(--border);color:var(--text);border-radius:10px;font-family:inherit;font-size:14px;margin-bottom:6px}
    input:focus,select:focus{outline:none;border-color:var(--gold)}
    
    /* PLAYER LIST */
    .player-row{display:flex;align-items:center;padding:10px 0;border-bottom:1px solid var(--border)}
    .player-avatar{width:36px;height:36px;background:linear-gradient(135deg,var(--purple),var(--blue));border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;margin-right:12px}
    .player-info{flex:1}
    .player-info .name{font-weight:700;font-size:14px}
    .player-info .meta{font-size:11px;color:var(--muted)}
    .player-del{width:32px;height:32px;background:rgba(255,82,82,.15);border:none;border-radius:50%;color:var(--red);font-size:16px;cursor:pointer}
    
    /* TOAST */
    .toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%);background:var(--elev);border:1px solid var(--border);padding:12px 24px;border-radius:12px;font-size:13px;font-weight:600;z-index:800;opacity:0;transition:all .3s;pointer-events:none}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(-10px)}
    .toast.ok{border-left:4px solid var(--green)}
    .toast.err{border-left:4px solid var(--red)}
    
    /* DART PICKER */
    .dart-hdr{padding:calc(18px + var(--st)) 16px 18px;background:linear-gradient(180deg,var(--card) 0%,var(--bg) 100%);text-align:center;position:relative}
    .dart-back{position:absolute;left:14px;top:calc(18px + var(--st));width:40px;height:40px;background:var(--elev);border:1px solid var(--border);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;cursor:pointer;color:var(--text)}
    .dart-step{font-size:11px;font-weight:700;letter-spacing:2px;color:var(--gold)}
    .dart-name{font-size:24px;font-weight:800;margin-top:6px}
    .dart-sub{font-size:13px;color:var(--dim);margin-top:4px}
    .dart-grid{flex:1;display:grid;grid-template-columns:repeat(2,1fr);gap:12px;padding:16px;overflow-y:auto;align-content:start}
    .dart-opt{background:var(--card);border:3px solid var(--border);border-radius:18px;padding:14px 10px;display:flex;flex-direction:column;align-items:center;gap:8px;cursor:pointer;transition:all .2s}
    .dart-opt:active{transform:scale(.97)}
    .dart-opt.picked{border-color:var(--gold);box-shadow:0 0 25px var(--glow-gold)}
    .dart-opt.off{opacity:.2;pointer-events:none}
    .dart-shape{width:50px;height:80px;border-radius:25px}
    .dart-label{font-size:11px;font-weight:700;text-align:center}
    .dart-foot{padding:16px;padding-bottom:calc(16px + var(--sb));background:var(--bg)}
    
    /* ============ GAME SCREEN - THE MAIN EVENT ============ */
    #screen-game{background:#000}
    .game-hdr{position:absolute;top:0;left:0;right:0;padding:calc(8px + var(--st)) 12px 8px;padding-left:calc(12px + var(--sl));padding-right:calc(12px + var(--sr));display:flex;justify-content:space-between;align-items:center;z-index:50;background:linear-gradient(180deg,rgba(0,0,0,.95) 0%,transparent 100%)}
    .game-menu-btn{width:44px;height:44px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.1);border-radius:12px;color:#fff;font-size:22px;cursor:pointer;backdrop-filter:blur(10px)}
    .game-badges{display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end}
    .badge{padding:6px 12px;background:rgba(0,0,0,.6);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.1);border-radius:16px;font-size:11px;font-weight:700}
    .badge.target{color:var(--gold)}
    .badge.gf{background:linear-gradient(135deg,var(--gold),var(--gold2));color:#000;border:none}
    .badge.live{background:var(--green);color:#000;display:flex;align-items:center;gap:5px;animation:liveGlow 1.5s infinite alternate}
    @keyframes liveGlow{to{box-shadow:0 0 15px var(--glow-green)}}
    
    /* GAME ARENA - ALWAYS VERTICAL */
    .game-arena{position:absolute;inset:0;display:flex;flex-direction:column}
    .pzone{flex:1;position:relative;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:10px;padding-left:calc(10px + var(--sl));padding-right:calc(10px + var(--sr));overflow:hidden;min-height:0}
    .pzone.top{padding-top:60px}
    .pzone.bot{padding-bottom:calc(10px + var(--sb))}
    
    /* PROGRESS BAR */
    .pbar{position:absolute;top:0;bottom:0;left:0;width:0%;transition:width .5s cubic-bezier(.34,1.56,.64,1);z-index:1}
    
    /* PLAYER UI */
    .pui{position:relative;z-index:10;text-align:center;width:100%;display:flex;flex-direction:column;align-items:center;justify-content:center}
    .phead{display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:6px}
    .pdart{width:20px;height:34px;border-radius:10px;flex-shrink:0}
    .pname{font-size:14px;font-weight:800;text-transform:uppercase;letter-spacing:1px;text-shadow:0 2px 10px rgba(0,0,0,.5)}
    .score-row{display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:6px}
    .score-adj{width:50px;height:50px;border-radius:50%;border:2px solid rgba(255,255,255,.15);background:rgba(0,0,0,.4);color:#fff;font-size:28px;font-weight:300;display:flex;align-items:center;justify-content:center;cursor:pointer;backdrop-filter:blur(5px);transition:all .15s}
    .score-adj:active{transform:scale(.85);background:rgba(255,255,255,.15)}
    .score-adj.minus{color:var(--red);border-color:rgba(255,82,82,.3)}
    .score-adj.plus{color:var(--green);border-color:rgba(0,230,118,.3)}
    .score-big{font-size:52px;font-weight:900;line-height:1;min-width:70px;text-shadow:0 4px 20px rgba(0,0,0,.5)}
    .quick-row{display:flex;gap:5px;justify-content:center}
    .qbtn{width:40px;height:32px;border-radius:8px;border:1px solid rgba(255,255,255,.1);background:rgba(0,0,0,.4);color:#fff;font-size:12px;font-weight:700;cursor:pointer;backdrop-filter:blur(5px);transition:all .15s}
    .qbtn:active{transform:scale(.9);background:rgba(255,255,255,.1)}
    
    /* DIVIDER */
    .game-mid{height:4px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.2),transparent);position:relative;z-index:20;flex-shrink:0}
    .reset-btn{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:44px;height:44px;background:var(--card);border:2px solid var(--border);border-radius:50%;color:var(--muted);font-size:20px;cursor:pointer;z-index:21}
    
    /* LANDSCAPE ADJUSTMENTS - still vertical but compact */
    @media (orientation:landscape) and (max-height:500px){
      .pzone.top{padding-top:50px}
      .phead{margin-bottom:4px}
      .pname{font-size:12px}
      .score-row{margin-bottom:4px;gap:6px}
      .score-big{font-size:38px;min-width:55px}
      .score-adj{width:38px;height:38px;font-size:20px}
      .qbtn{width:32px;height:26px;font-size:10px}
      .quick-row{gap:4px}
      .badge{padding:4px 8px;font-size:9px}
      .game-menu-btn{width:36px;height:36px;font-size:18px}
    }
    
    /* MENUS & OVERLAYS */
    .gmenu{position:fixed;inset:0;background:rgba(0,0,0,.95);display:none;flex-direction:column;align-items:center;justify-content:center;z-index:400;padding:20px;gap:12px}
    .gmenu.on{display:flex}
    .gmenu h2{font-size:24px;margin-bottom:16px}
    .gmenu-btn{width:260px;padding:16px;border-radius:14px;border:none;font-size:16px;font-weight:700;cursor:pointer;font-family:inherit}
    .gmenu-btn.resume{background:var(--green);color:#000}
    .gmenu-btn.end{background:var(--red);color:#fff}
    .gmenu-btn.save{background:var(--elev);color:#fff;border:1px solid var(--border)}
    
    /* WIN SCREEN */
    .win{position:fixed;inset:0;background:linear-gradient(135deg,#0a0a12 0%,#15152a 50%,#0a1520 100%);display:none;flex-direction:column;align-items:center;justify-content:center;z-index:500;padding:20px}
    .win.on{display:flex}
    .win-trophy{font-size:90px;animation:bounce .6s infinite alternate}
    @keyframes bounce{to{transform:translateY(-15px) scale(1.05)}}
    .win-tag{font-size:14px;letter-spacing:4px;color:var(--gold);margin-top:14px;text-shadow:0 0 20px var(--glow-gold)}
    .win-name{font-size:36px;font-weight:900;margin-top:8px;text-align:center;background:linear-gradient(135deg,#fff,var(--gold));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .win-score{font-size:24px;color:var(--dim);margin-top:6px}
    .win-btns{display:flex;gap:12px;margin-top:24px;flex-wrap:wrap;justify-content:center}
    .win-btn{padding:14px 28px;border-radius:12px;border:none;font-size:15px;font-weight:700;cursor:pointer;font-family:inherit}
    .win-btn.save{background:var(--green);color:#000}
    .win-btn.again{background:linear-gradient(135deg,var(--gold),var(--gold2));color:#000}
    .win-btn.exit{background:var(--elev);color:#fff}
    .confetti{position:fixed;width:12px;height:12px;top:-20px;animation:fall 3s linear forwards;z-index:501;border-radius:3px}
    @keyframes fall{to{transform:translateY(100vh) rotate(720deg)}}
    
    /* HISTORY MODAL */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.95);display:none;flex-direction:column;z-index:450;padding:calc(18px + var(--st)) 14px calc(18px + var(--sb))}
    .modal.on{display:flex}
    .modal-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
    .modal-title{font-size:20px;font-weight:800}
    .modal-close{width:40px;height:40px;background:var(--elev);border:none;border-radius:10px;color:var(--text);font-size:20px;cursor:pointer}
    .modal-body{flex:1;overflow-y:auto}
    .history-item{padding:14px;background:var(--card);border:1px solid var(--border);border-radius:12px;margin-bottom:10px}
    .history-item .time{font-size:10px;color:var(--muted)}
    .history-item .action{font-size:14px;font-weight:700;margin-top:4px}
    .history-item .detail{font-size:12px;color:var(--dim);margin-top:4px}
    .history-item .undo-btn{margin-top:10px;padding:8px 16px;background:rgba(255,82,82,.15);border:none;border-radius:8px;color:var(--red);font-size:11px;font-weight:700;cursor:pointer}
    
    .empty{text-align:center;padding:30px;color:var(--muted);font-size:13px}
    .empty-icon{font-size:40px;margin-bottom:10px;opacity:.5}
    
    /* DEBUG */
    #debug{position:fixed;top:calc(10px + var(--st));left:10px;right:10px;background:rgba(0,0,0,.95);border:2px solid var(--gold);border-radius:12px;padding:12px;font-size:10px;max-height:50vh;overflow-y:auto;z-index:1000;display:none}
    #debug.show{display:block}
    #debug pre{white-space:pre-wrap;word-break:break-all;color:var(--green);font-family:'SF Mono',monospace;line-height:1.5}
    #debug .close-btn{position:sticky;top:0;background:var(--red);color:#fff;border:none;padding:6px 14px;border-radius:6px;font-size:11px;cursor:pointer;margin-bottom:8px}
    
    /* ============ DESKTOP - STADIUM VIEW ============ */
    @media(min-width:1024px){
      .mobile-view{display:none!important}
      .desktop-view{display:grid!important;grid-template-columns:300px 1fr 320px;height:100vh;background:var(--bg)}
      
      .d-panel{background:var(--card);border-right:1px solid var(--border);display:flex;flex-direction:column;height:100vh;overflow:hidden}
      .d-panel:last-child{border-right:none;border-left:1px solid var(--border)}
      .d-head{padding:16px 18px;border-bottom:1px solid var(--border);background:var(--bg);display:flex;align-items:center;justify-content:space-between}
      .d-head h2{font-size:16px;font-weight:800;display:flex;align-items:center;gap:8px}
      .d-body{flex:1;overflow-y:auto;padding:14px}
      .d-section{margin-bottom:18px}
      .d-section-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);margin-bottom:10px;display:flex;align-items:center;gap:6px}
      
      .d-center{background:linear-gradient(180deg,#0a0a12 0%,#0f0f1a 100%);display:flex;flex-direction:column;height:100vh;overflow:hidden}
      
      /* STADIUM GAME VIEW */
      .d-game-wrap{flex:1;margin:16px;background:linear-gradient(135deg,#000 0%,#0a0a15 100%);border-radius:20px;overflow:hidden;position:relative;display:flex;flex-direction:column;border:1px solid var(--border);box-shadow:0 10px 40px rgba(0,0,0,.5)}
      .d-game-wrap .game-hdr{position:relative;padding:16px 20px;background:linear-gradient(180deg,rgba(0,0,0,.8) 0%,transparent 100%)}
      .d-game-wrap .game-arena{position:relative;flex:1;display:flex;flex-direction:column}
      .d-game-wrap .pzone{padding:30px}
      .d-game-wrap .pzone.top{padding-top:20px}
      .d-game-wrap .pzone.bot{padding-bottom:20px}
      .d-game-wrap .score-big{font-size:90px}
      .d-game-wrap .score-adj{width:70px;height:70px;font-size:36px}
      .d-game-wrap .qbtn{width:55px;height:45px;font-size:16px}
      .d-game-wrap .pname{font-size:22px}
      .d-game-wrap .pdart{width:28px;height:45px;border-radius:14px}
      
      /* DRAW ROW DESKTOP */
      .d-draw-row{display:flex;align-items:center;gap:8px;padding:10px 12px;background:var(--elev);border:1px solid var(--border);border-radius:10px;margin-bottom:6px;font-size:12px;cursor:pointer;transition:all .2s}
      .d-draw-row:hover{background:var(--card);border-color:var(--gold)}
      .d-draw-row.done{opacity:.5}
      .d-draw-row.done:hover{opacity:.7}
      .d-draw-row.gf{border-color:var(--gold);background:linear-gradient(135deg,rgba(255,193,7,.08),transparent)}
      .d-draw-num{width:28px;height:28px;background:var(--card);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:800}
      .d-draw-row.done .d-draw-num{background:var(--green);color:#000}
      .d-draw-players{flex:1;font-weight:600}
      .d-draw-score{font-weight:800;color:var(--gold);min-width:40px;text-align:center}
      .d-draw-undo{width:24px;height:24px;background:rgba(255,82,82,.15);border:none;border-radius:5px;color:var(--red);font-size:12px;cursor:pointer}
    }
    @media(max-width:1023px){.desktop-view{display:none!important}}
  </style>
</head>
<body>

<!-- INSTALL BANNER -->
<div class="install-banner" id="install-banner">
  <div class="install-top">
    <div class="install-title">üì± Install PopDarts</div>
    <button class="install-close" onclick="hideInstall()">√ó</button>
  </div>
  <div class="install-text">Add to your home screen for instant access and the best experience!</div>
  <button class="install-btn" onclick="installApp()">‚¨áÔ∏è Install Now</button>
</div>

<!-- ============ MOBILE VIEW ============ -->
<div class="mobile-view">
  <div id="screen-home" class="screen active">
    <div class="hdr">
      <div class="logo" onclick="toggleDebug()">PopDarts</div>
      <button class="sync-btn" onclick="sync()"><span class="sync-dot" id="dot1"></span><span id="txt1">Sync</span></button>
    </div>
    <div class="content">
      <div id="live-zone"></div>
      <div id="paused-zone"></div>
      <div id="hero-zone"></div>
      <div class="actions">
        <div class="act gold" onclick="playNext()"><div class="act-icon">‚ñ∂Ô∏è</div><div class="act-text">Play</div></div>
        <div class="act" onclick="openCustom()"><div class="act-icon">üéÆ</div><div class="act-text">Quick</div></div>
        <div class="act" onclick="genDraw()"><div class="act-icon">üé≤</div><div class="act-text">Draw</div></div>
      </div>
      <div class="stats">
        <div class="stat"><div class="stat-val" id="s-players">0</div><div class="stat-name">Players</div></div>
        <div class="stat"><div class="stat-val" id="s-games">0/0</div><div class="stat-name">Games</div></div>
        <div class="stat"><div class="stat-val" id="s-target">21</div><div class="stat-name">Target</div></div>
      </div>
      <div class="tabs">
        <button class="tab on" onclick="switchTab('draw',this)">üìã Draw</button>
        <button class="tab" onclick="switchTab('stand',this)">üìä Standings</button>
        <button class="tab" onclick="switchTab('all',this)">üèÜ All-Time</button>
      </div>
      <div id="tab-draw"></div>
      <div id="tab-stand" style="display:none"></div>
      <div id="tab-all" style="display:none"></div>
    </div>
  </div>

  <div id="screen-settings" class="screen">
    <div class="hdr">
      <div class="logo" style="font-size:18px">‚öôÔ∏è Settings</div>
      <button class="sync-btn" onclick="sync()"><span class="sync-dot" id="dot2"></span><span id="txt2">Sync</span></button>
    </div>
    <div class="content">
      <div class="card">
        <div class="card-label">‚òÅÔ∏è Cloud Sync</div>
        <button class="btn btn-gray" onclick="sync()">üîÑ Sync Now</button>
        <div style="font-size:10px;color:var(--muted);margin-top:6px">Last: <span id="last-sync">Never</span></div>
      </div>
      <div class="card">
        <div class="card-label">üë• Players</div>
        <div style="display:flex;gap:6px;margin-bottom:10px">
          <input type="text" id="inp-player" placeholder="Player name...">
          <button class="btn btn-green" style="width:auto;padding:12px 18px" onclick="addPlayer()">+</button>
        </div>
        <div id="player-list"></div>
      </div>
      <div class="card">
        <div class="card-label">üèÜ Championship</div>
        <button class="btn btn-gold" onclick="genDraw()">üé≤ Generate Draw</button>
        <button class="btn btn-red" onclick="clearDraw()">Clear Draw</button>
      </div>
      <div class="card">
        <div class="card-label">üéØ Target Score</div>
        <select id="sel-target" onchange="setTarget()">
          <option value="11">First to 11</option>
          <option value="15">First to 15</option>
          <option value="21" selected>First to 21</option>
          <option value="31">First to 31</option>
        </select>
      </div>
      <div class="card">
        <div class="card-label">üìú History</div>
        <button class="btn btn-gray" onclick="openHistory()">View Game History</button>
      </div>
    </div>
  </div>

  <div id="screen-custom" class="screen">
    <div class="hdr">
      <button class="sync-btn" onclick="go('home')" style="padding:10px 14px">‚Üê Back</button>
      <div class="logo" style="font-size:16px">Quick Match</div>
      <div style="width:70px"></div>
    </div>
    <div class="content">
      <div class="card"><div class="card-label">Player 1</div><select id="sel-p1"></select></div>
      <div class="card"><div class="card-label">Player 2</div><select id="sel-p2"></select></div>
      <button class="btn btn-gold" onclick="startCustom()">üéÆ Start Match</button>
    </div>
  </div>

  <div id="screen-dart" class="screen">
    <div class="dart-hdr">
      <button class="dart-back" onclick="go('home')">‚Üê</button>
      <div class="dart-step" id="dart-step">STEP 1 OF 2</div>
      <div class="dart-name" id="dart-player">Player</div>
      <div class="dart-sub">Choose your dart</div>
    </div>
    <div class="dart-grid" id="dart-grid"></div>
    <div class="dart-foot">
      <button class="btn btn-green" id="dart-confirm" onclick="confirmDart()" disabled>Select Dart</button>
    </div>
  </div>

  <div id="screen-game" class="screen">
    <div class="game-hdr">
      <button class="game-menu-btn" onclick="openMenu()">‚ò∞</button>
      <div class="game-badges">
        <div class="badge" id="g-label">Game 1</div>
        <div class="badge live" id="g-live" style="display:none"><span style="width:6px;height:6px;background:#000;border-radius:50%"></span>LIVE</div>
        <div class="badge target">To: <span id="g-target">21</span></div>
      </div>
    </div>
    <div class="game-arena">
      <div class="pzone top">
        <div class="pbar" id="bar1"></div>
        <div class="pui">
          <div class="phead"><div class="pdart" id="dart1"></div><span class="pname" id="name1">P1</span></div>
          <div class="score-row">
            <button class="score-adj minus" onclick="adj(1,-1)">‚àí</button>
            <div class="score-big" id="sc1">0</div>
            <button class="score-adj plus" onclick="adj(1,1)">+</button>
          </div>
          <div class="quick-row">
            <button class="qbtn" onclick="adj(1,2)">+2</button>
            <button class="qbtn" onclick="adj(1,3)">+3</button>
            <button class="qbtn" onclick="adj(1,4)">+4</button>
            <button class="qbtn" onclick="adj(1,5)">+5</button>
          </div>
        </div>
      </div>
      <div class="game-mid"><button class="reset-btn" onclick="resetScores()">‚Ü∫</button></div>
      <div class="pzone bot">
        <div class="pbar" id="bar2"></div>
        <div class="pui">
          <div class="phead"><div class="pdart" id="dart2"></div><span class="pname" id="name2">P2</span></div>
          <div class="score-row">
            <button class="score-adj minus" onclick="adj(2,-1)">‚àí</button>
            <div class="score-big" id="sc2">0</div>
            <button class="score-adj plus" onclick="adj(2,1)">+</button>
          </div>
          <div class="quick-row">
            <button class="qbtn" onclick="adj(2,2)">+2</button>
            <button class="qbtn" onclick="adj(2,3)">+3</button>
            <button class="qbtn" onclick="adj(2,4)">+4</button>
            <button class="qbtn" onclick="adj(2,5)">+5</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <nav class="nav" id="nav">
    <button class="nav-btn on" data-s="home"><span class="nav-icon">üè†</span>Home</button>
    <button class="nav-btn" data-s="settings"><span class="nav-icon">‚öôÔ∏è</span>Settings</button>
  </nav>
</div>

<!-- ============ DESKTOP VIEW - STADIUM ============ -->
<div class="desktop-view" style="display:none">
  <div class="d-panel">
    <div class="d-head">
      <h2>üéØ PopDarts</h2>
      <button class="sync-btn" onclick="sync()" style="padding:6px 12px;font-size:11px"><span class="sync-dot" id="dot3"></span><span id="txt3">Sync</span></button>
    </div>
    <div class="d-body">
      <div class="d-section">
        <div class="d-section-title">üë• Players</div>
        <div style="display:flex;gap:6px;margin-bottom:10px">
          <input type="text" id="d-inp-player" placeholder="Add player..." style="padding:10px;font-size:13px">
          <button class="btn btn-green" style="width:auto;margin:0;padding:10px 14px;font-size:13px" onclick="addPlayerD()">+</button>
        </div>
        <div id="d-player-list"></div>
      </div>
      <div class="d-section">
        <div class="d-section-title">üìã Draw</div>
        <div id="d-draw" style="max-height:280px;overflow-y:auto"></div>
      </div>
      <div class="d-section">
        <button class="btn btn-gold" style="font-size:13px;padding:12px" onclick="genDraw()">üé≤ Generate Draw</button>
        <button class="btn btn-gray" style="font-size:13px;padding:12px" onclick="clearDraw()">Clear Draw</button>
        <button class="btn btn-gray" style="font-size:13px;padding:12px" onclick="openHistory()">üìú History</button>
      </div>
    </div>
  </div>
  
  <div class="d-center">
    <div class="d-head">
      <h2>üèüÔ∏è Stadium</h2>
      <select id="d-target" onchange="setTargetD()" style="width:auto;padding:8px 12px;font-size:13px">
        <option value="11">To 11</option>
        <option value="15">To 15</option>
        <option value="21" selected>To 21</option>
        <option value="31">To 31</option>
      </select>
    </div>
    <div id="d-game-area" style="flex:1;display:flex;flex-direction:column;overflow:hidden"></div>
  </div>
  
  <div class="d-panel">
    <div class="d-head"><h2>üìä Stats</h2></div>
    <div class="d-body">
      <div class="d-section">
        <div class="d-section-title">üèÜ Championship Standings</div>
        <div id="d-stand"></div>
      </div>
      <div class="d-section">
        <div class="d-section-title">üìà All-Time Stats</div>
        <div id="d-all"></div>
      </div>
    </div>
  </div>
</div>

<!-- OVERLAYS -->
<div class="gmenu" id="gmenu">
  <h2>‚è∏Ô∏è Game Paused</h2>
  <button class="gmenu-btn resume" onclick="closeMenu()">‚ñ∂Ô∏è Resume</button>
  <button class="gmenu-btn end" onclick="endGame()">‚ùå End Game</button>
  <button class="gmenu-btn save" onclick="pauseGame()">üíæ Save & Exit</button>
</div>

<div class="win" id="win">
  <div class="win-trophy">üèÜ</div>
  <div class="win-tag">üéâ WINNER üéâ</div>
  <div class="win-name" id="win-name">Player</div>
  <div class="win-score" id="win-score">21 - 15</div>
  <div class="win-btns">
    <button class="win-btn save" id="win-save" onclick="saveGame()">üíæ Save Result</button>
    <button class="win-btn again" onclick="rematch()">üîÑ Rematch</button>
    <button class="win-btn exit" onclick="exitWin()">‚úï Exit</button>
  </div>
</div>

<div class="modal" id="history-modal">
  <div class="modal-head">
    <div class="modal-title">üìú Game History</div>
    <button class="modal-close" onclick="closeHistory()">√ó</button>
  </div>
  <div class="modal-body" id="history-list"></div>
</div>

<div class="toast" id="toast"></div>
<div id="debug"><button class="close-btn" onclick="toggleDebug()">‚úï Close Debug</button><pre id="dbg"></pre></div>

<script>
const API='https://script.google.com/macros/s/AKfycbzmdLog_tuyJMAE9hCLvfrsVT67LtwvLUOrrESZhUj0pBcbO6eFeajzKocXWfgQ9_MNTA/exec';

const DARTS=[
  {id:'black-green',name:'Black/Green',grad:'linear-gradient(180deg,#1a1a1a 0%,#22c55e 50%,#1a1a1a 100%)',color:'#22c55e'},
  {id:'tropical',name:'Tropical',grad:'linear-gradient(180deg,#f97316 0%,#0891b2 50%,#ec4899 100%)',color:'#f97316'},
  {id:'black-blue',name:'Black/Blue',grad:'linear-gradient(180deg,#1a1a1a 0%,#3b82f6 50%,#1a1a1a 100%)',color:'#3b82f6'},
  {id:'white-purple',name:'White/Purple',grad:'linear-gradient(180deg,#f0f0f0 0%,#a855f7 50%,#f0f0f0 100%)',color:'#a855f7'},
  {id:'cyan',name:'Cyan Fire',grad:'linear-gradient(180deg,#06b6d4 0%,#0891b2 100%)',color:'#06b6d4'},
  {id:'white-teal',name:'White/Teal',grad:'linear-gradient(180deg,#f0f0f0 0%,#14b8a6 50%,#f0f0f0 100%)',color:'#14b8a6'},
  {id:'lime',name:'Lime Burst',grad:'linear-gradient(180deg,#84cc16 0%,#65a30d 100%)',color:'#84cc16'}
];

const KEY='pd64',HKEY='pd64h';
let D=load(KEY)||{players:[],draw:[],target:21,paused:null,alltime:[]};
let H=load(HKEY)||[];
let G={p1:null,p2:null,s1:0,s2:0,d1:null,d2:null,idx:-1,num:null,isChamp:false,isGF:false};
let liveTimer=null,deferredPrompt=null,desktopPlaying=false;

function load(k){try{return JSON.parse(localStorage.getItem(k))}catch(e){return null}}
function save(){localStorage.setItem(KEY,JSON.stringify(D))}
function saveH(){localStorage.setItem(HKEY,JSON.stringify(H))}

// DEBUG
let dbgLines=[];
function log(m){
  var t=new Date().toLocaleTimeString();
  dbgLines.push(t+' '+m);
  if(dbgLines.length>60)dbgLines.shift();
  var el=document.getElementById('dbg');
  if(el)el.textContent=dbgLines.join('\n');
  console.log('[PD]',m);
}
function toggleDebug(){document.getElementById('debug').classList.toggle('show')}

// PWA INSTALL
window.addEventListener('beforeinstallprompt',function(e){
  e.preventDefault();
  deferredPrompt=e;
  setTimeout(function(){document.getElementById('install-banner').classList.add('show')},2000);
});
function hideInstall(){document.getElementById('install-banner').classList.remove('show')}
function installApp(){
  if(deferredPrompt){
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then(function(){deferredPrompt=null;hideInstall()});
  }
}

// HISTORY
function addHistory(action,detail,undoData){
  H.unshift({time:new Date().toISOString(),action:action,detail:detail,undo:undoData});
  if(H.length>50)H.pop();
  saveH();
}
function openHistory(){
  var el=document.getElementById('history-list');
  if(!H.length){el.innerHTML='<div class="empty"><div class="empty-icon">üìú</div>No history yet</div>'}
  else{
    var html='';
    for(var i=0;i<H.length;i++){
      var h=H[i];
      html+='<div class="history-item"><div class="time">'+new Date(h.time).toLocaleString()+'</div><div class="action">'+h.action+'</div><div class="detail">'+h.detail+'</div>';
      if(h.undo)html+='<button class="undo-btn" onclick="undoHistory('+i+')">‚Ü© Undo This</button>';
      html+='</div>';
    }
    el.innerHTML=html;
  }
  document.getElementById('history-modal').classList.add('on');
}
function closeHistory(){document.getElementById('history-modal').classList.remove('on')}
function undoHistory(idx){
  var h=H[idx];
  if(!h||!h.undo)return;
  if(h.undo.type==='game'){
    var gameNum=h.undo.num;
    var g=null;
    for(var i=0;i<D.draw.length;i++){
      if(D.draw[i].num==gameNum){g=D.draw[i];break}
    }
    if(g){
      g.winner=null;g.s1=null;g.s2=null;
      if(h.undo.stats){
        for(var j=0;j<h.undo.stats.length;j++){
          var s=h.undo.stats[j];
          for(var k=0;k<D.alltime.length;k++){
            if(D.alltime[k].name===s.name){
              var at=D.alltime[k];
              at.gp=Math.max(0,at.gp-1);
              at.w=Math.max(0,at.w-s.w);
              at.l=Math.max(0,at.l-s.l);
              at.pf-=s.pf;
              at.pa-=s.pa;
              at.diff=at.pf-at.pa;
              break;
            }
          }
        }
      }
      save();
      H.splice(idx,1);
      saveH();
      toast('Undone!','ok');
      render();
      closeHistory();
    }
  }
}

// SYNC
async function sync(){
  setDot('busy');log('Syncing...');
  try{
    var pRes=await fetch(API+'?action=players').then(function(r){return r.json()}).catch(function(){return{success:false}});
    var sRes=await fetch(API+'?action=stats').then(function(r){return r.json()}).catch(function(){return{success:false}});
    var dRes=await fetch(API+'?action=draw').then(function(r){return r.json()}).catch(function(){return{success:false}});
    var lRes=await fetch(API+'?action=liveGame').then(function(r){return r.json()}).catch(function(){return{success:false}});
    
    if(pRes.success&&pRes.data&&pRes.data.players){
      D.players=pRes.data.players.filter(function(p){return p&&p.trim()});
      log('Players: '+D.players.length);
    }
    
    // STATS - Map correctly: GP, W, L, %, F, A, D, Champs
    if(sRes.success&&sRes.data&&sRes.data.stats){
      D.alltime=[];
      for(var i=0;i<sRes.data.stats.length;i++){
        var c=sRes.data.stats[i];
        D.alltime.push({
          name:c.name||'',
          gp:c.gamesPlayed||0,
          w:c.wins||0,
          l:c.losses||0,
          pf:c.pointsFor||0,
          pa:c.pointsAgainst||0,
          diff:c.pointsDiff||0,
          champs:c.championships||0
        });
      }
      log('Stats: '+D.alltime.length);
    }
    
    if(dRes.success&&dRes.data&&dRes.data.games){
      D.draw=[];
      for(var j=0;j<dRes.data.games.length;j++){
        var g=dRes.data.games[j];
        D.draw.push({
          num:g.gameNum,
          p1:g.player1,
          p2:g.player2,
          s1:g.score1,
          s2:g.score2,
          winner:g.winner||null,
          isGF:g.gameNum==='GF'
        });
      }
      if(dRes.data.grandFinal){
        var gf=dRes.data.grandFinal;
        var hasGF=false;
        for(var m=0;m<D.draw.length;m++){if(D.draw[m].isGF)hasGF=true}
        if(!hasGF){
          D.draw.push({num:'GF',p1:gf.player1,p2:gf.player2,s1:gf.score1,s2:gf.score2,winner:gf.winner,isGF:true});
        }
      }
      if(dRes.data.targetScore)D.target=dRes.data.targetScore;
      log('Draw: '+D.draw.length+' games');
    }
    
    D.live=(lRes.success&&lRes.data&&lRes.data.active)?lRes.data:null;
    if(D.live)log('Live: '+D.live.player1+' vs '+D.live.player2);
    
    save();
    setDot('ok');
    document.getElementById('last-sync').textContent=new Date().toLocaleTimeString();
    toast('Synced!','ok');
    render();
  }catch(e){
    log('Sync error: '+e.message);
    setDot('err');
    toast('Sync failed','err');
  }
}

function setDot(s){
  var dots=['dot1','dot2','dot3'];
  var txts=['txt1','txt2','txt3'];
  for(var i=0;i<dots.length;i++){
    var el=document.getElementById(dots[i]);
    if(el)el.className='sync-dot'+(s==='busy'?' busy':s==='ok'?' ok':'');
  }
  for(var j=0;j<txts.length;j++){
    var el2=document.getElementById(txts[j]);
    if(el2)el2.textContent=s==='busy'?'...':s==='ok'?'OK':'Err';
  }
}

async function apiPost(action,data){
  log('POST '+action);
  try{
    var body=JSON.stringify(Object.assign({action:action},data));
    var r=await fetch(API,{method:'POST',headers:{'Content-Type':'text/plain'},body:body});
    return await r.json();
  }catch(e){log('POST err: '+e.message);return{success:false}}
}

async function pushLive(){
  if(!G.p1)return;
  await apiPost('updateLiveGame',{
    active:true,
    gameId:G.num||'custom',
    player1:G.p1,
    player2:G.p2,
    score1:G.s1,
    score2:G.s2,
    color1:G.d1?G.d1.id:'',
    color2:G.d2?G.d2.id:'',
    target:D.target,
    isChamp:G.isChamp,
    isGF:G.isGF
  });
}
async function clearLive(){await apiPost('clearLiveGame',{});D.live=null}
async function pullLive(){
  try{
    var r=await fetch(API+'?action=liveGame');
    var j=await r.json();
    if(j.success&&j.data&&j.data.active){
      D.live=j.data;
      // Update local game if we're playing same game
      if(G.p1&&j.data.player1===G.p1&&j.data.player2===G.p2){
        if(j.data.score1!==G.s1||j.data.score2!==G.s2){
          G.s1=j.data.score1;
          G.s2=j.data.score2;
          updateGameUI();
          log('Live update: '+G.s1+'-'+G.s2);
        }
      }
      render();
    }
  }catch(e){}
}
function startLiveSync(){stopLiveSync();liveTimer=setInterval(pullLive,1500);log('Live sync ON')}
function stopLiveSync(){if(liveTimer){clearInterval(liveTimer);liveTimer=null;log('Live sync OFF')}}

// NAV
document.querySelectorAll('.nav-btn').forEach(function(b){b.onclick=function(){go(b.dataset.s)}});
function go(s){
  document.querySelectorAll('.screen').forEach(function(x){x.classList.remove('active')});
  var scr=document.getElementById('screen-'+s);
  if(scr)scr.classList.add('active');
  document.querySelectorAll('.nav-btn').forEach(function(b){b.classList.toggle('on',b.dataset.s===s)});
  var nav=document.getElementById('nav');
  nav.style.display=['game','dart','custom'].indexOf(s)>=0?'none':'flex';
  if(s==='home')render();
  if(s==='settings'){document.getElementById('sel-target').value=D.target;renderPlayers()}
}
function switchTab(t,btn){
  document.querySelectorAll('.tab').forEach(function(b){b.classList.remove('on')});
  btn.classList.add('on');
  document.getElementById('tab-draw').style.display=t==='draw'?'block':'none';
  document.getElementById('tab-stand').style.display=t==='stand'?'block':'none';
  document.getElementById('tab-all').style.display=t==='all'?'block':'none';
}

// RENDER
function render(){
  var st=calcStand();
  var done=0,total=0;
  for(var i=0;i<D.draw.length;i++){
    if(!D.draw[i].isGF){
      total++;
      if(D.draw[i].winner)done++;
    }
  }
  document.getElementById('s-players').textContent=D.players.length;
  document.getElementById('s-games').textContent=total?done+'/'+total:'0';
  document.getElementById('s-target').textContent=D.target;
  
  renderLive();
  renderPaused();
  renderHero();
  renderDraw();
  renderStand(st);
  renderAll();
  
  if(window.innerWidth>=1024)renderDesktop(st);
}

function renderLive(){
  var el=document.getElementById('live-zone');
  if(!D.live||!D.live.active){el.innerHTML='';return}
  el.innerHTML='<div class="live-card" onclick="joinLive()"><div class="live-inner"><div class="live-top"><div class="live-badge"><span class="live-pulse"></span>LIVE NOW</div><button class="live-join">Join Game</button></div><div class="live-players">'+D.live.player1+' vs '+D.live.player2+'</div><div class="live-score">'+D.live.score1+' - '+D.live.score2+'</div></div></div>';
}

function renderPaused(){
  var el=document.getElementById('paused-zone');
  if(!D.paused){el.innerHTML='';return}
  el.innerHTML='<div class="paused-card" onclick="resumePaused()"><div class="paused-info"><div class="label">‚è∏ PAUSED GAME</div><div class="players">'+D.paused.p1+' vs '+D.paused.p2+'</div><div class="score">'+D.paused.s1+' - '+D.paused.s2+'</div></div><button class="paused-btn">Resume</button></div>';
}

function renderHero(){
  var el=document.getElementById('hero-zone');
  var n=getNext();
  if(!D.draw.length){
    el.innerHTML='<div class="hero"><div class="hero-tag" style="color:var(--muted)">NO CHAMPIONSHIP</div><div class="hero-match">'+(D.players.length<2?'Add players first':'Tap Draw to start')+'</div></div>';
    return;
  }
  if(!n){
    el.innerHTML='<div class="hero"><div class="hero-tag">üéâ COMPLETE</div><div class="hero-match">All games finished!</div></div>';
    return;
  }
  var g=n.game;
  el.innerHTML='<div class="hero '+(g.isGF?'gf':'')+'"><div class="hero-tag">'+(g.isGF?'üèÜ GRAND FINAL üèÜ':'GAME '+g.num)+'</div><div class="hero-match">'+g.p1+'<span class="hero-vs">vs</span>'+g.p2+'</div><button class="hero-btn" onclick="playNext()">‚ñ∂Ô∏è Play Now</button></div>';
}

function renderDraw(){
  var el=document.getElementById('tab-draw');
  if(!D.draw.length){el.innerHTML='<div class="empty"><div class="empty-icon">üìã</div>No games yet</div>';return}
  var html='';
  for(var i=0;i<D.draw.length;i++){
    var g=D.draw[i];
    var clickAttr=g.winner?'':'onclick="playIdx('+i+')"';
    html+='<div class="draw-row '+(g.winner?'done':'')+' '+(g.isGF?'gf':'')+'" '+clickAttr+'>';
    html+='<div class="draw-num">'+(g.isGF?'üèÜ':g.num)+'</div>';
    html+='<div class="draw-players"><span class="'+(g.winner===g.p1?'winner':'')+'">'+g.p1+'</span> vs <span class="'+(g.winner===g.p2?'winner':'')+'">'+g.p2+'</span></div>';
    html+='<div class="draw-result">'+(g.winner?g.s1+'-'+g.s2:'‚Äî')+'</div>';
    if(g.winner)html+='<button class="draw-undo" onclick="event.stopPropagation();undoGame('+i+')">‚Ü©</button>';
    html+='</div>';
  }
  el.innerHTML=html;
}

// STANDINGS - Sort by Wins DESC, then Diff DESC
function renderStand(st){
  var el=document.getElementById('tab-stand');
  if(!st.length){el.innerHTML='<div class="empty"><div class="empty-icon">üìä</div>No standings</div>';return}
  var html='<table class="tbl"><thead><tr><th>Player</th><th>W</th><th>L</th><th>+/-</th></tr></thead><tbody>';
  for(var i=0;i<st.length;i++){
    var p=st[i];
    var diffClass=p.diff>0?'plus':p.diff<0?'minus':'';
    html+='<tr class="'+(i===0?'top':'')+'"><td>'+(i===0?'üëë ':'')+p.name+'</td><td>'+p.w+'</td><td>'+p.l+'</td><td class="'+diffClass+'">'+(p.diff>0?'+':'')+p.diff+'</td></tr>';
  }
  el.innerHTML=html+'</tbody></table>';
}

// ALL-TIME - Sort by CHAMPS DESC, then Wins DESC
function renderAll(){
  var el=document.getElementById('tab-all');
  // Sort by championships first, then wins
  var sorted=D.alltime.slice().sort(function(a,b){
    var champDiff=(b.champs||0)-(a.champs||0);
    if(champDiff!==0)return champDiff;
    return(b.w||0)-(a.w||0);
  });
  if(!sorted.length){el.innerHTML='<div class="empty"><div class="empty-icon">üèÜ</div>No stats yet</div>';return}
  var html='<table class="tbl"><thead><tr><th>Player</th><th>GP</th><th>W</th><th>L</th><th>%</th><th>F</th><th>A</th><th>D</th><th>üèÜ</th></tr></thead><tbody>';
  for(var i=0;i<sorted.length;i++){
    var s=sorted[i];
    var pct=s.gp?Math.round(s.w/s.gp*100):0;
    var diffClass=s.diff>0?'plus':s.diff<0?'minus':'';
    var champClass=s.champs>0?'champ':'';
    html+='<tr><td>'+s.name+'</td><td>'+s.gp+'</td><td>'+s.w+'</td><td>'+s.l+'</td><td>'+pct+'</td><td>'+s.pf+'</td><td>'+s.pa+'</td><td class="'+diffClass+'">'+(s.diff>0?'+':'')+s.diff+'</td><td class="'+champClass+'">'+(s.champs||0)+'</td></tr>';
  }
  el.innerHTML=html+'</tbody></table>';
}

// DESKTOP RENDER
function renderDesktop(st){
  // Players
  var playerEl=document.getElementById('d-player-list');
  if(D.players.length){
    var phtml='';
    for(var i=0;i<D.players.length;i++){
      phtml+='<div style="padding:8px 0;border-bottom:1px solid var(--border);font-size:13px;display:flex;justify-content:space-between;align-items:center"><span>'+D.players[i]+'</span></div>';
    }
    playerEl.innerHTML=phtml;
  }else{
    playerEl.innerHTML='<div style="color:var(--muted);font-size:12px;padding:10px 0">No players yet</div>';
  }
  
  // Draw
  var drawEl=document.getElementById('d-draw');
  if(D.draw.length){
    var dhtml='';
    for(var j=0;j<D.draw.length;j++){
      var g=D.draw[j];
      var clickAttr=g.winner?'':'onclick="playIdxDesktop('+j+')"';
      dhtml+='<div class="d-draw-row '+(g.winner?'done':'')+' '+(g.isGF?'gf':'')+'" '+clickAttr+'>';
      dhtml+='<div class="d-draw-num">'+(g.isGF?'üèÜ':g.num)+'</div>';
      dhtml+='<div class="d-draw-players">'+g.p1+' vs '+g.p2+'</div>';
      dhtml+='<div class="d-draw-score">'+(g.winner?g.s1+'-'+g.s2:'‚Äî')+'</div>';
      if(g.winner)dhtml+='<button class="d-draw-undo" onclick="event.stopPropagation();undoGame('+j+')">‚Ü©</button>';
      dhtml+='</div>';
    }
    drawEl.innerHTML=dhtml;
  }else{
    drawEl.innerHTML='<div style="color:var(--muted);font-size:12px;padding:10px 0">No draw yet</div>';
  }
  
  // Standings - sorted
  var standEl=document.getElementById('d-stand');
  if(st.length){
    var shtml='<table class="tbl" style="font-size:11px"><thead><tr><th>Player</th><th>W</th><th>L</th><th>+/-</th></tr></thead><tbody>';
    for(var k=0;k<st.length;k++){
      var p=st[k];
      shtml+='<tr class="'+(k===0?'top':'')+'"><td>'+(k===0?'üëë ':'')+p.name+'</td><td>'+p.w+'</td><td>'+p.l+'</td><td class="'+(p.diff>0?'plus':p.diff<0?'minus':'')+'">'+(p.diff>0?'+':'')+p.diff+'</td></tr>';
    }
    standEl.innerHTML=shtml+'</tbody></table>';
  }else{
    standEl.innerHTML='<div style="color:var(--muted);font-size:11px">No standings</div>';
  }
  
  // All-time - sorted by CHAMPS
  var allEl=document.getElementById('d-all');
  var sorted=D.alltime.slice().sort(function(a,b){
    var champDiff=(b.champs||0)-(a.champs||0);
    if(champDiff!==0)return champDiff;
    return(b.w||0)-(a.w||0);
  });
  if(sorted.length){
    var ahtml='<table class="tbl" style="font-size:10px"><thead><tr><th>Player</th><th>GP</th><th>W</th><th>%</th><th>üèÜ</th></tr></thead><tbody>';
    for(var m=0;m<sorted.length;m++){
      var s=sorted[m];
      var pct=s.gp?Math.round(s.w/s.gp*100):0;
      ahtml+='<tr><td>'+s.name+'</td><td>'+s.gp+'</td><td>'+s.w+'</td><td>'+pct+'%</td><td class="'+(s.champs?'champ':'')+'">'+(s.champs||0)+'</td></tr>';
    }
    allEl.innerHTML=ahtml+'</tbody></table>';
  }else{
    allEl.innerHTML='<div style="color:var(--muted);font-size:11px">No stats</div>';
  }
  
  // Game area
  renderDesktopGame();
}

function renderDesktopGame(){
  var el=document.getElementById('d-game-area');
  
  // If actively playing on desktop
  if(desktopPlaying&&G.p1){
    el.innerHTML=buildDesktopGameHTML();
    return;
  }
  
  // Show live game from cloud
  if(D.live&&D.live.active){
    el.innerHTML='<div class="live-card" onclick="joinLiveDesktop()" style="margin:16px"><div class="live-inner"><div class="live-top"><div class="live-badge"><span class="live-pulse"></span>LIVE NOW</div><button class="live-join">Join & Score</button></div><div class="live-players" style="font-size:22px">'+D.live.player1+' vs '+D.live.player2+'</div><div class="live-score" style="font-size:56px">'+D.live.score1+' - '+D.live.score2+'</div></div></div>'+buildDesktopWatchingHTML();
    return;
  }
  
  // Show next game hero
  var n=getNext();
  if(!n){
    el.innerHTML='<div style="flex:1;display:flex;align-items:center;justify-content:center"><div class="hero" style="max-width:400px;margin:20px"><div class="hero-tag">'+(D.draw.length?'üéâ COMPLETE':'NO CHAMPIONSHIP')+'</div><div class="hero-match">'+(D.draw.length?'All games done!':D.players.length<2?'Add 2+ players':'Click Generate Draw')+'</div></div></div>';
    return;
  }
  
  var g=n.game;
  el.innerHTML='<div style="flex:1;display:flex;align-items:center;justify-content:center"><div class="hero '+(g.isGF?'gf':'')+'" style="max-width:450px;margin:20px;padding:40px 30px"><div class="hero-tag" style="font-size:14px">'+(g.isGF?'üèÜ GRAND FINAL üèÜ':'NEXT GAME '+g.num)+'</div><div class="hero-match" style="font-size:32px">'+g.p1+'<span class="hero-vs" style="font-size:16px">vs</span>'+g.p2+'</div><button class="hero-btn" onclick="playIdxDesktop('+n.idx+')" style="font-size:18px;padding:16px 40px">‚ñ∂Ô∏è Play Game</button></div></div>';
}

function buildDesktopGameHTML(){
  var d1=G.d1||DARTS[0];
  var d2=G.d2||DARTS[2];
  var p1pct=Math.min(100,(G.s1/D.target)*100);
  var p2pct=Math.min(100,(G.s2/D.target)*100);
  
  return '<div class="d-game-wrap">'+
    '<div class="game-hdr"><button class="game-menu-btn" onclick="openMenu()">‚ò∞</button><div class="game-badges"><div class="badge '+(G.isGF?'gf':'')+'">'+(G.isGF?'üèÜ GRAND FINAL':G.isChamp?'Game '+G.num:'Quick Match')+'</div><div class="badge live" style="'+(G.isChamp?'':'display:none')+'"><span style="width:6px;height:6px;background:#000;border-radius:50%"></span>LIVE</div><div class="badge target">To: '+D.target+'</div></div></div>'+
    '<div class="game-arena">'+
      '<div class="pzone top"><div class="pbar" style="width:'+p1pct+'%;background:'+d1.grad+'"></div><div class="pui"><div class="phead"><div class="pdart" style="background:'+d1.grad+'"></div><span class="pname">'+G.p1+'</span></div><div class="score-row"><button class="score-adj minus" onclick="adj(1,-1)">‚àí</button><div class="score-big" id="dsc1">'+G.s1+'</div><button class="score-adj plus" onclick="adj(1,1)">+</button></div><div class="quick-row"><button class="qbtn" onclick="adj(1,2)">+2</button><button class="qbtn" onclick="adj(1,3)">+3</button><button class="qbtn" onclick="adj(1,4)">+4</button><button class="qbtn" onclick="adj(1,5)">+5</button></div></div></div>'+
      '<div class="game-mid"><button class="reset-btn" onclick="resetScores()">‚Ü∫</button></div>'+
      '<div class="pzone bot"><div class="pbar" style="width:'+p2pct+'%;background:'+d2.grad+'"></div><div class="pui"><div class="phead"><div class="pdart" style="background:'+d2.grad+'"></div><span class="pname">'+G.p2+'</span></div><div class="score-row"><button class="score-adj minus" onclick="adj(2,-1)">‚àí</button><div class="score-big" id="dsc2">'+G.s2+'</div><button class="score-adj plus" onclick="adj(2,1)">+</button></div><div class="quick-row"><button class="qbtn" onclick="adj(2,2)">+2</button><button class="qbtn" onclick="adj(2,3)">+3</button><button class="qbtn" onclick="adj(2,4)">+4</button><button class="qbtn" onclick="adj(2,5)">+5</button></div></div></div>'+
    '</div></div>';
}

function buildDesktopWatchingHTML(){
  if(!D.live||!D.live.active)return'';
  var d1=DARTS.find(function(d){return d.id===D.live.color1})||DARTS[0];
  var d2=DARTS.find(function(d){return d.id===D.live.color2})||DARTS[2];
  var p1pct=Math.min(100,(D.live.score1/D.target)*100);
  var p2pct=Math.min(100,(D.live.score2/D.target)*100);
  
  return '<div class="d-game-wrap" style="pointer-events:none;opacity:.9">'+
    '<div class="game-hdr"><div></div><div class="game-badges"><div class="badge '+(D.live.isGF?'gf':'')+'">'+(D.live.isGF?'üèÜ GF':D.live.isChamp?'Game '+D.live.gameId:'Match')+'</div><div class="badge live"><span style="width:6px;height:6px;background:#000;border-radius:50%"></span>WATCHING</div></div></div>'+
    '<div class="game-arena">'+
      '<div class="pzone top"><div class="pbar" style="width:'+p1pct+'%;background:'+d1.grad+'"></div><div class="pui"><div class="phead"><div class="pdart" style="background:'+d1.grad+'"></div><span class="pname">'+D.live.player1+'</span></div><div class="score-row"><div class="score-big">'+D.live.score1+'</div></div></div></div>'+
      '<div class="game-mid"></div>'+
      '<div class="pzone bot"><div class="pbar" style="width:'+p2pct+'%;background:'+d2.grad+'"></div><div class="pui"><div class="phead"><div class="pdart" style="background:'+d2.grad+'"></div><span class="pname">'+D.live.player2+'</span></div><div class="score-row"><div class="score-big">'+D.live.score2+'</div></div></div></div>'+
    '</div></div>';
}

function calcStand(){
  var map={};
  for(var i=0;i<D.players.length;i++){
    var p=D.players[i];
    map[p]={name:p,w:0,l:0,pf:0,pa:0,diff:0};
  }
  for(var j=0;j<D.draw.length;j++){
    var g=D.draw[j];
    if(!g.winner)continue;
    var a=map[g.p1];
    var b=map[g.p2];
    if(a){
      if(g.winner===g.p1)a.w++;else a.l++;
      a.pf+=(g.s1||0);a.pa+=(g.s2||0);a.diff+=(g.s1||0)-(g.s2||0);
    }
    if(b){
      if(g.winner===g.p2)b.w++;else b.l++;
      b.pf+=(g.s2||0);b.pa+=(g.s1||0);b.diff+=(g.s2||0)-(g.s1||0);
    }
  }
  var arr=[];
  for(var k in map)arr.push(map[k]);
  return arr.sort(function(a,b){return b.w-a.w||b.diff-a.diff});
}

function getNext(){
  for(var i=0;i<D.draw.length;i++){
    if(!D.draw[i].isGF&&!D.draw[i].winner)return{idx:i,game:D.draw[i]};
  }
  for(var j=0;j<D.draw.length;j++){
    if(D.draw[j].isGF&&!D.draw[j].winner)return{idx:j,game:D.draw[j]};
  }
  return null;
}

function undoGame(i){
  var g=D.draw[i];
  if(!g||!g.winner)return;
  if(!confirm('Undo '+g.p1+' vs '+g.p2+'?'))return;
  
  var names=[g.p1,g.p2];
  for(var j=0;j<names.length;j++){
    var name=names[j];
    for(var k=0;k<D.alltime.length;k++){
      if(D.alltime[k].name===name){
        var at=D.alltime[k];
        at.gp=Math.max(0,at.gp-1);
        var won=g.winner===name;
        at.w=Math.max(0,at.w-(won?1:0));
        at.l=Math.max(0,at.l-(won?0:1));
        var isP1=name===g.p1;
        at.pf-=isP1?g.s1:g.s2;
        at.pa-=isP1?g.s2:g.s1;
        at.diff=at.pf-at.pa;
        break;
      }
    }
  }
  g.winner=null;g.s1=null;g.s2=null;
  save();toast('Undone!','ok');render();
}

// CUSTOM MATCH
function openCustom(){
  if(D.players.length<2){toast('Add 2+ players','err');return}
  var opts='';
  for(var i=0;i<D.players.length;i++){
    opts+='<option value="'+D.players[i]+'">'+D.players[i]+'</option>';
  }
  document.getElementById('sel-p1').innerHTML=opts;
  document.getElementById('sel-p2').innerHTML=opts;
  if(D.players.length>1)document.getElementById('sel-p2').selectedIndex=1;
  go('custom');
}
function startCustom(){
  var p1=document.getElementById('sel-p1').value;
  var p2=document.getElementById('sel-p2').value;
  if(p1===p2){toast('Pick different players','err');return}
  G={p1:p1,p2:p2,s1:0,s2:0,d1:null,d2:null,idx:-1,num:null,isChamp:false,isGF:false};
  openDart(1,p1);
}

// DART PICKER
function openDart(step,name){
  G.step=step;G.pick=null;
  document.getElementById('dart-step').textContent='STEP '+step+' OF 2';
  document.getElementById('dart-player').textContent=name;
  document.getElementById('dart-confirm').disabled=true;
  
  var html='';
  for(var i=0;i<DARTS.length;i++){
    var d=DARTS[i];
    var off=step===2&&G.d1&&G.d1.id===d.id;
    html+='<div class="dart-opt '+(off?'off':'')+'" data-id="'+d.id+'" onclick="pickDart(\''+d.id+'\')"><div class="dart-shape" style="background:'+d.grad+'"></div><div class="dart-label">'+d.name+'</div></div>';
  }
  document.getElementById('dart-grid').innerHTML=html;
  go('dart');
}
function pickDart(id){
  G.pick=null;
  for(var i=0;i<DARTS.length;i++){
    if(DARTS[i].id===id){G.pick=DARTS[i];break}
  }
  document.querySelectorAll('.dart-opt').forEach(function(el){
    el.classList.toggle('picked',el.dataset.id===id);
  });
  document.getElementById('dart-confirm').disabled=false;
}
function confirmDart(){
  if(!G.pick)return;
  if(G.step===1){G.d1=G.pick;openDart(2,G.p2)}
  else{G.d2=G.pick;beginGame(false)}
}

// GAMEPLAY
function playNext(){
  var n=getNext();
  if(!n){toast(D.draw.length?'All done!':'Generate draw first','err');return}
  playIdx(n.idx);
}
function playIdx(i){
  var g=D.draw[i];
  if(!g||g.winner)return;
  G={p1:g.p1,p2:g.p2,s1:0,s2:0,d1:null,d2:null,idx:i,num:g.num,isChamp:true,isGF:g.isGF};
  openDart(1,g.p1);
}
function playIdxDesktop(i){
  var g=D.draw[i];
  if(!g||g.winner)return;
  G={p1:g.p1,p2:g.p2,s1:0,s2:0,d1:DARTS[0],d2:DARTS[2],idx:i,num:g.num,isChamp:true,isGF:g.isGF};
  desktopPlaying=true;
  if(G.isChamp){pushLive();startLiveSync()}
  render();
}
function joinLive(){
  if(!D.live||!D.live.active)return;
  var d1=DARTS.find(function(d){return d.id===D.live.color1})||DARTS[0];
  var d2=DARTS.find(function(d){return d.id===D.live.color2})||DARTS[2];
  G={p1:D.live.player1,p2:D.live.player2,s1:D.live.score1,s2:D.live.score2,d1:d1,d2:d2,idx:-1,num:D.live.gameId,isChamp:D.live.isChamp,isGF:D.live.isGF};
  setupGameUI();
  startLiveSync();
  go('game');
}
function joinLiveDesktop(){
  if(!D.live||!D.live.active)return;
  var d1=DARTS.find(function(d){return d.id===D.live.color1})||DARTS[0];
  var d2=DARTS.find(function(d){return d.id===D.live.color2})||DARTS[2];
  G={p1:D.live.player1,p2:D.live.player2,s1:D.live.score1,s2:D.live.score2,d1:d1,d2:d2,idx:-1,num:D.live.gameId,isChamp:D.live.isChamp,isGF:D.live.isGF};
  desktopPlaying=true;
  startLiveSync();
  render();
}
function beginGame(isDesktop){
  G.s1=0;G.s2=0;
  desktopPlaying=isDesktop;
  if(!isDesktop){
    setupGameUI();
    if(G.isChamp){
      pushLive();
      startLiveSync();
      document.getElementById('g-live').style.display='flex';
    }else{
      document.getElementById('g-live').style.display='none';
    }
    go('game');
  }else{
    if(G.isChamp){pushLive();startLiveSync()}
    render();
  }
}
function setupGameUI(){
  document.getElementById('name1').textContent=G.p1;
  document.getElementById('name2').textContent=G.p2;
  document.getElementById('dart1').style.background=G.d1.grad;
  document.getElementById('dart2').style.background=G.d2.grad;
  document.getElementById('g-target').textContent=D.target;
  
  var lbl=document.getElementById('g-label');
  if(G.isGF){lbl.textContent='üèÜ GRAND FINAL';lbl.className='badge gf'}
  else if(G.isChamp){lbl.textContent='Game '+G.num;lbl.className='badge'}
  else{lbl.textContent='Quick Match';lbl.className='badge'}
  
  updateGameUI();
}
function adj(p,amt){
  if(p===1){
    G.s1=Math.max(0,G.s1+amt);
    if(G.s1>=D.target){G.s1=D.target;updateGameUI();win(G.p1);return}
  }else{
    G.s2=Math.max(0,G.s2+amt);
    if(G.s2>=D.target){G.s2=D.target;updateGameUI();win(G.p2);return}
  }
  updateGameUI();
  if(G.isChamp)pushLive();
}
function updateGameUI(){
  // Mobile
  var sc1=document.getElementById('sc1');
  var sc2=document.getElementById('sc2');
  if(sc1)sc1.textContent=G.s1;
  if(sc2)sc2.textContent=G.s2;
  
  var p1pct=Math.min(100,(G.s1/D.target)*100);
  var p2pct=Math.min(100,(G.s2/D.target)*100);
  
  var bar1=document.getElementById('bar1');
  var bar2=document.getElementById('bar2');
  if(bar1&&G.d1){bar1.style.width=p1pct+'%';bar1.style.background=G.d1.grad}
  if(bar2&&G.d2){bar2.style.width=p2pct+'%';bar2.style.background=G.d2.grad}
  
  // Desktop
  var dsc1=document.getElementById('dsc1');
  var dsc2=document.getElementById('dsc2');
  if(dsc1)dsc1.textContent=G.s1;
  if(dsc2)dsc2.textContent=G.s2;
  
  // Re-render desktop if playing there
  if(desktopPlaying&&window.innerWidth>=1024){
    renderDesktopGame();
  }
}
function resetScores(){
  if(!confirm('Reset to 0-0?'))return;
  G.s1=0;G.s2=0;updateGameUI();
  if(G.isChamp)pushLive();
}

// MENU
function openMenu(){document.getElementById('gmenu').classList.add('on')}
function closeMenu(){document.getElementById('gmenu').classList.remove('on')}
function endGame(){
  if(!confirm('End without saving?'))return;
  closeMenu();stopLiveSync();clearLive();
  D.paused=null;desktopPlaying=false;save();
  if(window.innerWidth>=1024)render();
  else go('home');
  toast('Ended','ok');
}
function pauseGame(){
  closeMenu();stopLiveSync();
  D.paused={p1:G.p1,p2:G.p2,s1:G.s1,s2:G.s2,d1:G.d1,d2:G.d2,idx:G.idx,num:G.num,isChamp:G.isChamp,isGF:G.isGF};
  desktopPlaying=false;save();toast('Saved!','ok');
  if(window.innerWidth>=1024)render();
  else go('home');
}
function resumePaused(){
  if(!D.paused)return;
  var P=D.paused;
  G={p1:P.p1,p2:P.p2,s1:P.s1,s2:P.s2,d1:P.d1,d2:P.d2,idx:P.idx,num:P.num,isChamp:P.isChamp,isGF:P.isGF};
  D.paused=null;save();
  
  if(window.innerWidth>=1024){
    desktopPlaying=true;
    if(G.isChamp){pushLive();startLiveSync()}
    render();
  }else{
    setupGameUI();
    if(G.isChamp){pushLive();startLiveSync();document.getElementById('g-live').style.display='flex'}
    go('game');
  }
}

// WIN
function win(name){
  stopLiveSync();
  document.getElementById('win-name').textContent=name;
  document.getElementById('win-score').textContent=G.s1+' - '+G.s2;
  document.getElementById('win-save').style.display=G.isChamp?'inline-block':'none';
  document.getElementById('win').classList.add('on');
  confetti();
}
async function saveGame(){
  var winner=G.s1>=D.target?G.p1:G.p2;
  
  if(G.isChamp&&G.idx>=0){
    var g=D.draw[G.idx];
    g.winner=winner;g.s1=G.s1;g.s2=G.s2;
    
    // Update alltime stats
    var undoStats=[];
    var names=[G.p1,G.p2];
    for(var i=0;i<names.length;i++){
      var name=names[i];
      var at=null;
      for(var j=0;j<D.alltime.length;j++){
        if(D.alltime[j].name===name){at=D.alltime[j];break}
      }
      if(!at){at={name:name,gp:0,w:0,l:0,pf:0,pa:0,diff:0,champs:0};D.alltime.push(at)}
      
      var won=winner===name;
      var isP1=name===G.p1;
      var pf=isP1?G.s1:G.s2;
      var pa=isP1?G.s2:G.s1;
      
      undoStats.push({name:name,w:won?1:0,l:won?0:1,pf:pf,pa:pa});
      
      at.gp++;
      if(won)at.w++;else at.l++;
      at.pf+=pf;at.pa+=pa;at.diff=at.pf-at.pa;
    }
    
    addHistory('Game '+g.num+' completed',g.p1+' '+g.s1+'-'+g.s2+' '+g.p2+' (Winner: '+winner+')',{type:'game',num:g.num,stats:undoStats});
    
    await apiPost('submitGame',{gameId:g.num,player1:g.p1,player2:g.p2,score1:g.s1,score2:g.s2});
    
    if(G.isGF){
      for(var k=0;k<D.alltime.length;k++){
        if(D.alltime[k].name===winner){
          D.alltime[k].champs=(D.alltime[k].champs||0)+1;
          break;
        }
      }
      toast('üèÜ Champion crowned!','ok');
    }else{
      checkGF();
      toast('Saved!','ok');
    }
  }
  
  clearLive();D.paused=null;desktopPlaying=false;save();exitWin();
}
function checkGF(){
  var regGames=[];
  for(var i=0;i<D.draw.length;i++){
    if(!D.draw[i].isGF)regGames.push(D.draw[i]);
  }
  var left=[];
  for(var j=0;j<regGames.length;j++){
    if(!regGames[j].winner)left.push(regGames[j]);
  }
  var hasGF=false;
  for(var k=0;k<D.draw.length;k++){
    if(D.draw[k].isGF)hasGF=true;
  }
  if(left.length===0&&!hasGF&&regGames.length>0){
    var st=calcStand();
    if(st.length>=2){
      D.draw.push({num:'GF',p1:st[0].name,p2:st[1].name,s1:null,s2:null,winner:null,isGF:true});
      save();toast('üèÜ Grand Final ready!','ok');
    }
  }
}
function rematch(){
  document.getElementById('win').classList.remove('on');
  G.s1=0;G.s2=0;updateGameUI();
  if(G.isChamp){pushLive();startLiveSync()}
}
function exitWin(){
  document.getElementById('win').classList.remove('on');
  if(window.innerWidth>=1024)render();
  else go('home');
}
function confetti(){
  var cols=[G.d1?G.d1.color:'#ffc107',G.d2?G.d2.color:'#3b82f6','#00e676','#ff5252','#b388ff'];
  for(var i=0;i<45;i++){
    setTimeout(function(){
      var c=document.createElement('div');
      c.className='confetti';
      c.style.left=Math.random()*100+'vw';
      c.style.background=cols[Math.floor(Math.random()*cols.length)];
      c.style.animationDuration=(2+Math.random()*2)+'s';
      document.body.appendChild(c);
      setTimeout(function(){c.remove()},4000);
    },i*25);
  }
}

// SETTINGS
function renderPlayers(){
  var el=document.getElementById('player-list');
  if(!D.players.length){el.innerHTML='<div style="color:var(--muted);padding:16px;font-size:12px;text-align:center">No players yet</div>';return}
  var html='';
  for(var i=0;i<D.players.length;i++){
    var p=D.players[i];
    var at=null;
    for(var j=0;j<D.alltime.length;j++){
      if(D.alltime[j].name===p){at=D.alltime[j];break}
    }
    if(!at)at={gp:0,w:0,champs:0};
    html+='<div class="player-row"><div class="player-avatar">'+p[0].toUpperCase()+'</div><div class="player-info"><div class="name">'+(at.champs?'üèÜ ':'')+p+'</div><div class="meta">'+at.gp+' GP ‚Ä¢ '+at.w+' W</div></div><button class="player-del" onclick="delPlayer('+i+')">√ó</button></div>';
  }
  el.innerHTML=html;
}
async function addPlayer(){
  var inp=document.getElementById('inp-player');
  var name=inp.value.trim();
  if(!name)return;
  var exists=false;
  for(var i=0;i<D.players.length;i++){
    if(D.players[i].toLowerCase()===name.toLowerCase())exists=true;
  }
  if(exists){toast('Already exists!','err');return}
  D.players.push(name);save();
  await apiPost('addPlayer',{playerName:name});
  inp.value='';renderPlayers();render();toast('Added!','ok');
}
async function addPlayerD(){
  var inp=document.getElementById('d-inp-player');
  var name=inp.value.trim();
  if(!name)return;
  var exists=false;
  for(var i=0;i<D.players.length;i++){
    if(D.players[i].toLowerCase()===name.toLowerCase())exists=true;
  }
  if(exists){toast('Already exists!','err');return}
  D.players.push(name);save();
  await apiPost('addPlayer',{playerName:name});
  inp.value='';render();toast('Added!','ok');
}
function delPlayer(i){
  if(!confirm('Remove '+D.players[i]+'?'))return;
  D.players.splice(i,1);save();renderPlayers();render();
}
document.getElementById('inp-player').addEventListener('keypress',function(e){if(e.key==='Enter')addPlayer()});
var dInp=document.getElementById('d-inp-player');
if(dInp)dInp.addEventListener('keypress',function(e){if(e.key==='Enter')addPlayerD()});

async function genDraw(){
  if(D.players.length<2){toast('Need 2+ players','err');return}
  if(D.draw.length&&!confirm('Replace current draw?'))return;
  
  var pairs=[];
  for(var i=0;i<D.players.length;i++){
    for(var j=i+1;j<D.players.length;j++){
      pairs.push([D.players[i],D.players[j]]);
    }
  }
  // Shuffle
  for(var k=pairs.length-1;k>0;k--){
    var r=Math.floor(Math.random()*(k+1));
    var temp=pairs[k];pairs[k]=pairs[r];pairs[r]=temp;
  }
  
  D.draw=[];
  for(var m=0;m<pairs.length;m++){
    D.draw.push({num:m+1,p1:pairs[m][0],p2:pairs[m][1],s1:null,s2:null,winner:null,isGF:false});
  }
  D.paused=null;save();
  
  await apiPost('generateDraw',{});
  toast(pairs.length+' games generated!','ok');
  render();
  if(window.innerWidth<1024)go('home');
}
async function clearDraw(){
  if(!confirm('Clear all games?'))return;
  D.draw=[];D.paused=null;save();
  await apiPost('newEvent',{});
  toast('Draw cleared','ok');render();
}
function setTarget(){
  D.target=parseInt(document.getElementById('sel-target').value)||21;
  save();render();toast('Target: '+D.target,'ok');
}
function setTargetD(){
  D.target=parseInt(document.getElementById('d-target').value)||21;
  document.getElementById('sel-target').value=D.target;
  save();render();toast('Target: '+D.target,'ok');
}

function toast(m,t){
  var el=document.getElementById('toast');
  el.textContent=m;
  el.className='toast show '+(t||'ok');
  setTimeout(function(){el.classList.remove('show')},2500);
}

// PWA
if('serviceWorker' in navigator){
  window.addEventListener('load',function(){
    navigator.serviceWorker.register('sw.js').catch(function(){});
  });
}

// INIT
window.addEventListener('resize',function(){render()});
setInterval(function(){
  var homeActive=document.getElementById('screen-home');
  if((homeActive&&homeActive.classList.contains('active'))||window.innerWidth>=1024){
    sync();
  }
},15000);

render();
sync();
startLiveSync();
log('PopDarts v6.4 ready!');
</script>
</body>
</html>
