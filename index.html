<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="PopDarts">
  <meta name="theme-color" content="#0a0a12">
  <title>PopDarts</title>
  <link rel="manifest" href="manifest.json">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
    :root{
      --bg:#0a0a12;--card:#12121f;--elev:#1a1a2e;--border:rgba(255,255,255,.08);
      --text:#fff;--dim:#9898b0;--muted:#55556a;
      --gold:#ffc107;--gold2:#ff9800;--green:#00e676;--red:#ff5252;--blue:#448aff;
      --st:env(safe-area-inset-top,0);--sb:env(safe-area-inset-bottom,0);
    }
    *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;user-select:none}
    html,body{font-family:'Inter',system-ui,sans-serif;background:var(--bg);color:var(--text);height:100%;overflow:hidden}
    
    /* Install Banner */
    .install-banner{position:fixed;bottom:80px;left:12px;right:12px;background:linear-gradient(135deg,#1a1a35,#252550);border:2px solid var(--gold);border-radius:16px;padding:16px;display:none;z-index:300}
    .install-banner.show{display:block}
    
    /* Screens */
    .screen{position:fixed;inset:0;display:none;flex-direction:column;background:var(--bg);z-index:10}
    .screen.active{display:flex}
    
    /* Header */
    .hdr{display:flex;align-items:center;justify-content:space-between;padding:calc(12px + var(--st)) 16px 12px;background:var(--bg);border-bottom:1px solid var(--border)}
    .logo{font-size:20px;font-weight:900;color:var(--gold)}
    .sync-btn{display:flex;align-items:center;gap:6px;padding:8px 14px;background:var(--card);border:1px solid var(--border);border-radius:20px;font-size:12px;font-weight:600;color:var(--dim);cursor:pointer}
    .sync-dot{width:8px;height:8px;border-radius:50%;background:var(--red)}
    .sync-dot.ok{background:var(--green)}
    .sync-dot.busy{background:var(--gold);animation:pulse .5s infinite alternate}
    @keyframes pulse{to{opacity:.4}}
    
    /* Content */
    .content{flex:1;overflow-y:auto;padding:14px;padding-bottom:calc(90px + var(--sb))}
    
    /* Cards */
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin-bottom:12px}
    .card-label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);margin-bottom:10px}
    
    /* Live Banner */
    .live-card{background:linear-gradient(135deg,#0a2818,#041810);border:2px solid var(--green);border-radius:16px;padding:16px;margin-bottom:14px;cursor:pointer}
    .live-badge{display:flex;align-items:center;gap:6px;font-size:11px;font-weight:800;color:var(--green);margin-bottom:8px}
    .live-pulse{width:10px;height:10px;background:var(--green);border-radius:50%;animation:livePulse 1s infinite}
    @keyframes livePulse{50%{transform:scale(1.3);opacity:.6}}
    .live-players{font-size:16px;font-weight:700}
    .live-score{font-size:36px;font-weight:900;color:var(--gold)}
    
    /* Hero */
    .hero{background:linear-gradient(135deg,#15152a,#1f1f40);border:1px solid var(--border);border-radius:18px;padding:20px;margin-bottom:14px;text-align:center}
    .hero.gf{border:2px solid var(--gold)}
    .hero-tag{font-size:11px;font-weight:800;letter-spacing:2px;color:var(--gold);margin-bottom:6px}
    .hero-match{font-size:20px;font-weight:800}
    .hero-vs{display:block;font-size:12px;color:var(--muted);margin:4px 0}
    .hero-btn{margin-top:14px;padding:12px 28px;background:linear-gradient(135deg,var(--gold),var(--gold2));color:#000;font-size:15px;font-weight:800;border:none;border-radius:25px;cursor:pointer}
    
    /* Actions */
    .actions{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:14px}
    .act{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px 8px;text-align:center;cursor:pointer}
    .act.gold{background:linear-gradient(135deg,var(--gold),var(--gold2));border:none}
    .act-icon{font-size:24px;margin-bottom:4px}
    .act-text{font-size:11px;font-weight:700}
    .act.gold .act-text{color:#000}
    
    /* Stats Row */
    .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px}
    .stat{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px 6px;text-align:center}
    .stat-val{font-size:20px;font-weight:900;color:var(--gold)}
    .stat-name{font-size:8px;font-weight:600;text-transform:uppercase;color:var(--muted);margin-top:2px}
    
    /* Tabs */
    .tabs{display:flex;background:var(--card);border:1px solid var(--border);border-radius:10px;padding:3px;margin-bottom:12px}
    .tab{flex:1;padding:10px 4px;text-align:center;font-size:11px;font-weight:700;color:var(--muted);background:none;border:none;border-radius:8px;cursor:pointer}
    .tab.on{background:linear-gradient(135deg,var(--gold),var(--gold2));color:#000}
    
    /* Tables */
    .tbl{width:100%;border-collapse:collapse;font-size:11px}
    .tbl th{padding:8px 4px;text-align:center;font-size:8px;font-weight:700;text-transform:uppercase;color:var(--muted);background:rgba(255,255,255,.02)}
    .tbl th:first-child{text-align:left;padding-left:8px}
    .tbl td{padding:8px 4px;text-align:center;border-bottom:1px solid var(--border)}
    .tbl td:first-child{text-align:left;padding-left:8px;font-weight:600}
    .tbl .top td{background:rgba(255,193,7,.1)}
    .tbl .champ{color:var(--gold);font-weight:800}
    .plus{color:var(--green)}.minus{color:var(--red)}
    
    /* Draw Rows */
    .draw-row{display:flex;align-items:center;gap:10px;padding:12px;background:var(--card);border:1px solid var(--border);border-radius:12px;margin-bottom:6px;cursor:pointer}
    .draw-row.done{opacity:.5}
    .draw-row.gf{border:2px solid var(--gold)}
    .draw-num{width:30px;height:30px;background:var(--elev);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:800}
    .draw-row.done .draw-num{background:var(--green);color:#000}
    .draw-players{flex:1;font-size:12px;font-weight:600}
    .draw-result{font-size:13px;font-weight:800;color:var(--gold)}
    
    /* Buttons */
    .btn{width:100%;padding:14px;border-radius:12px;border:none;font-family:inherit;font-size:15px;font-weight:700;cursor:pointer;margin-bottom:8px}
    .btn-gold{background:linear-gradient(135deg,var(--gold),var(--gold2));color:#000}
    .btn-gray{background:var(--elev);color:var(--text);border:1px solid var(--border)}
    .btn-red{background:rgba(255,82,82,.15);color:var(--red)}
    .btn-green{background:var(--green);color:#000}
    
    /* Nav */
    .nav{position:fixed;bottom:0;left:0;right:0;background:rgba(10,10,18,.95);backdrop-filter:blur(20px);border-top:1px solid var(--border);display:flex;padding:8px 16px calc(8px + var(--sb));z-index:100}
    .nav-btn{flex:1;padding:8px 0;text-align:center;font-size:10px;font-weight:600;color:var(--muted);background:none;border:none;border-radius:10px;cursor:pointer}
    .nav-btn.on{color:var(--gold);background:rgba(255,193,7,.1)}
    .nav-icon{font-size:18px;display:block;margin-bottom:2px}
    
    /* Inputs */
    input,select{width:100%;padding:12px;background:var(--elev);border:1px solid var(--border);color:var(--text);border-radius:10px;font-family:inherit;font-size:14px;margin-bottom:6px}
    
    /* Player Row */
    .player-row{display:flex;align-items:center;padding:10px 0;border-bottom:1px solid var(--border)}
    .player-avatar{width:36px;height:36px;background:linear-gradient(135deg,#a855f7,var(--blue));border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;margin-right:12px}
    .player-info{flex:1}
    .player-info .name{font-weight:700;font-size:14px}
    .player-info .meta{font-size:11px;color:var(--muted)}
    
    /* Toast */
    .toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%);background:var(--elev);border:1px solid var(--border);padding:12px 24px;border-radius:12px;font-size:13px;font-weight:600;z-index:800;opacity:0;transition:all .3s}
    .toast.show{opacity:1}
    .toast.ok{border-left:4px solid var(--green)}
    .toast.err{border-left:4px solid var(--red)}
    
    /* Dart Picker */
    .dart-hdr{padding:calc(18px + var(--st)) 16px 18px;background:var(--card);text-align:center;position:relative}
    .dart-back{position:absolute;left:14px;top:calc(18px + var(--st));width:40px;height:40px;background:var(--elev);border:1px solid var(--border);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;cursor:pointer;color:var(--text)}
    .dart-step{font-size:11px;font-weight:700;letter-spacing:2px;color:var(--gold)}
    .dart-name{font-size:22px;font-weight:800;margin-top:6px}
    .dart-grid{flex:1;display:grid;grid-template-columns:repeat(2,1fr);gap:12px;padding:16px;overflow-y:auto;align-content:start}
    .dart-opt{background:var(--card);border:3px solid var(--border);border-radius:16px;padding:12px;display:flex;flex-direction:column;align-items:center;gap:8px;cursor:pointer}
    .dart-opt.picked{border-color:var(--gold)}
    .dart-opt.off{opacity:.2;pointer-events:none}
    .dart-shape{width:45px;height:75px;border-radius:22px}
    .dart-label{font-size:11px;font-weight:700}
    .dart-foot{padding:16px;padding-bottom:calc(16px + var(--sb))}
    
    /* Game Screen */
    #screen-game{background:#000}
    .game-hdr{position:absolute;top:0;left:0;right:0;padding:calc(8px + var(--st)) 12px 8px;display:flex;justify-content:space-between;align-items:center;z-index:50;background:linear-gradient(180deg,rgba(0,0,0,.9),transparent)}
    .game-menu-btn{width:44px;height:44px;background:rgba(255,255,255,.1);border:none;border-radius:12px;color:#fff;font-size:22px;cursor:pointer}
    .game-badges{display:flex;gap:6px}
    .badge{padding:6px 12px;background:rgba(0,0,0,.6);border-radius:14px;font-size:11px;font-weight:700}
    .badge.target{color:var(--gold)}
    .badge.gf{background:linear-gradient(135deg,var(--gold),var(--gold2));color:#000}
    .badge.live{background:var(--green);color:#000}
    
    /* Game Arena - Always Vertical */
    .game-arena{position:absolute;inset:0;display:flex;flex-direction:column}
    .pzone{flex:1;position:relative;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:12px;overflow:hidden}
    .pzone.top{padding-top:60px}
    .pzone.bot{padding-bottom:calc(12px + var(--sb))}
    .pbar{position:absolute;top:0;bottom:0;left:0;width:0%;transition:width .4s;z-index:1}
    .pui{position:relative;z-index:10;text-align:center;width:100%}
    .phead{display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:6px}
    .pdart{width:20px;height:32px;border-radius:10px}
    .pname{font-size:14px;font-weight:800;text-transform:uppercase}
    .score-row{display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:6px}
    .score-adj{width:48px;height:48px;border-radius:50%;border:2px solid rgba(255,255,255,.15);background:rgba(0,0,0,.4);color:#fff;font-size:26px;display:flex;align-items:center;justify-content:center;cursor:pointer}
    .score-adj.minus{color:var(--red);border-color:rgba(255,82,82,.3)}
    .score-adj.plus{color:var(--green);border-color:rgba(0,230,118,.3)}
    .score-big{font-size:52px;font-weight:900;min-width:70px}
    .quick-row{display:flex;gap:5px;justify-content:center}
    .qbtn{width:38px;height:30px;border-radius:8px;border:1px solid rgba(255,255,255,.1);background:rgba(0,0,0,.4);color:#fff;font-size:12px;font-weight:700;cursor:pointer}
    .game-mid{height:4px;background:rgba(255,255,255,.1);position:relative;z-index:20}
    .reset-btn{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:44px;height:44px;background:var(--card);border:2px solid var(--border);border-radius:50%;color:var(--muted);font-size:20px;cursor:pointer;z-index:21}
    
    /* Landscape adjustments */
    @media(orientation:landscape) and (max-height:500px){
      .pzone.top{padding-top:50px}
      .score-big{font-size:38px}
      .score-adj{width:38px;height:38px;font-size:20px}
      .qbtn{width:32px;height:26px;font-size:10px}
      .pname{font-size:12px}
    }
    
    /* Game Menu */
    .gmenu{position:fixed;inset:0;background:rgba(0,0,0,.95);display:none;flex-direction:column;align-items:center;justify-content:center;z-index:400;gap:12px}
    .gmenu.on{display:flex}
    .gmenu h2{font-size:22px;margin-bottom:16px}
    .gmenu-btn{width:240px;padding:14px;border-radius:12px;border:none;font-size:15px;font-weight:700;cursor:pointer}
    .gmenu-btn.resume{background:var(--green);color:#000}
    .gmenu-btn.end{background:var(--red);color:#fff}
    .gmenu-btn.save{background:var(--elev);color:#fff;border:1px solid var(--border)}
    
    /* Win Screen */
    .win{position:fixed;inset:0;background:linear-gradient(135deg,#0a0a12,#15152a);display:none;flex-direction:column;align-items:center;justify-content:center;z-index:500;padding:20px}
    .win.on{display:flex}
    .win-trophy{font-size:80px;animation:bounce .6s infinite alternate}
    @keyframes bounce{to{transform:translateY(-12px) scale(1.05)}}
    .win-tag{font-size:14px;letter-spacing:3px;color:var(--gold);margin-top:12px}
    .win-name{font-size:32px;font-weight:900;margin-top:8px}
    .win-score{font-size:22px;color:var(--dim);margin-top:4px}
    .win-btns{display:flex;gap:12px;margin-top:20px;flex-wrap:wrap;justify-content:center}
    .win-btn{padding:12px 24px;border-radius:12px;border:none;font-size:14px;font-weight:700;cursor:pointer}
    .win-btn.save{background:var(--green);color:#000}
    .win-btn.again{background:var(--gold);color:#000}
    .win-btn.exit{background:var(--elev);color:#fff}
    .confetti{position:fixed;width:10px;height:10px;top:-20px;animation:fall 3s linear forwards;z-index:501}
    @keyframes fall{to{transform:translateY(100vh) rotate(720deg)}}
    
    .empty{text-align:center;padding:30px;color:var(--muted)}
    
    /* Desktop */
    @media(min-width:1024px){
      .mobile-view{display:none!important}
      .desktop-view{display:grid!important;grid-template-columns:300px 1fr 320px;height:100vh}
      .d-panel{background:var(--card);border-right:1px solid var(--border);display:flex;flex-direction:column;height:100vh}
      .d-panel:last-child{border-right:none;border-left:1px solid var(--border)}
      .d-head{padding:16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
      .d-head h2{font-size:16px;font-weight:800}
      .d-body{flex:1;overflow-y:auto;padding:14px}
      .d-section{margin-bottom:18px}
      .d-section-title{font-size:10px;font-weight:700;text-transform:uppercase;color:var(--muted);margin-bottom:10px}
      .d-center{background:var(--bg);display:flex;flex-direction:column;height:100vh}
      .d-game-wrap{flex:1;margin:16px;background:#000;border-radius:16px;overflow:hidden;position:relative;display:flex;flex-direction:column}
      .d-game-wrap .game-hdr{position:relative;padding:16px 20px}
      .d-game-wrap .game-arena{position:relative;flex:1}
      .d-game-wrap .pzone{padding:30px}
      .d-game-wrap .pzone.top{padding-top:20px}
      .d-game-wrap .pzone.bot{padding-bottom:20px}
      .d-game-wrap .score-big{font-size:80px}
      .d-game-wrap .score-adj{width:65px;height:65px;font-size:32px}
      .d-game-wrap .qbtn{width:50px;height:40px;font-size:14px}
      .d-game-wrap .pname{font-size:20px}
      .d-game-wrap .pdart{width:26px;height:42px}
      .d-draw-row{display:flex;align-items:center;gap:8px;padding:10px;background:var(--elev);border:1px solid var(--border);border-radius:10px;margin-bottom:6px;font-size:12px;cursor:pointer}
      .d-draw-row.done{opacity:.5}
      .d-draw-row.gf{border-color:var(--gold)}
      .d-draw-num{width:26px;height:26px;background:var(--card);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:800}
      .d-draw-row.done .d-draw-num{background:var(--green);color:#000}
      .d-draw-players{flex:1;font-weight:600}
      .d-draw-score{font-weight:800;color:var(--gold)}
    }
    @media(max-width:1023px){.desktop-view{display:none!important}}
  </style>
</head>
<body>

<!-- Install Banner -->
<div class="install-banner" id="install-banner">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
    <div style="font-size:15px;font-weight:800;color:var(--gold)">üì± Install PopDarts</div>
    <button onclick="hideInstall()" style="background:none;border:none;color:var(--muted);font-size:20px;cursor:pointer">√ó</button>
  </div>
  <div style="font-size:12px;color:var(--dim);margin-bottom:12px">Add to home screen for the best experience!</div>
  <button onclick="installApp()" style="width:100%;padding:12px;background:var(--gold);color:#000;font-size:14px;font-weight:700;border:none;border-radius:10px;cursor:pointer">Install Now</button>
</div>

<!-- MOBILE VIEW -->
<div class="mobile-view">
  <div id="screen-home" class="screen active">
    <div class="hdr">
      <div class="logo">üéØ PopDarts</div>
      <button class="sync-btn" onclick="sync()"><span class="sync-dot" id="dot1"></span><span id="txt1">Sync</span></button>
    </div>
    <div class="content">
      <div id="live-zone"></div>
      <div id="hero-zone"></div>
      <div class="actions">
        <div class="act gold" onclick="playNext()"><div class="act-icon">‚ñ∂Ô∏è</div><div class="act-text">Play</div></div>
        <div class="act" onclick="openCustom()"><div class="act-icon">üéÆ</div><div class="act-text">Quick</div></div>
        <div class="act" onclick="genDraw()"><div class="act-icon">üé≤</div><div class="act-text">Draw</div></div>
      </div>
      <div class="stats">
        <div class="stat"><div class="stat-val" id="s-players">0</div><div class="stat-name">Players</div></div>
        <div class="stat"><div class="stat-val" id="s-games">0/0</div><div class="stat-name">Games</div></div>
        <div class="stat"><div class="stat-val" id="s-target">21</div><div class="stat-name">Target</div></div>
      </div>
      <div class="tabs">
        <button class="tab on" onclick="switchTab('draw',this)">üìã Draw</button>
        <button class="tab" onclick="switchTab('stand',this)">üìä Standings</button>
        <button class="tab" onclick="switchTab('all',this)">üèÜ All-Time</button>
      </div>
      <div id="tab-draw"></div>
      <div id="tab-stand" style="display:none"></div>
      <div id="tab-all" style="display:none"></div>
    </div>
  </div>

  <div id="screen-settings" class="screen">
    <div class="hdr">
      <div class="logo" style="font-size:18px">‚öôÔ∏è Settings</div>
      <button class="sync-btn" onclick="sync()"><span class="sync-dot" id="dot2"></span><span id="txt2">Sync</span></button>
    </div>
    <div class="content">
      <div class="card">
        <div class="card-label">‚òÅÔ∏è Cloud Sync</div>
        <button class="btn btn-gray" onclick="sync()">üîÑ Sync Now</button>
        <div style="font-size:10px;color:var(--muted);margin-top:6px">Last: <span id="last-sync">Never</span></div>
      </div>
      <div class="card">
        <div class="card-label">üë• Players (from cloud)</div>
        <div style="display:flex;gap:6px;margin-bottom:10px">
          <input type="text" id="inp-player" placeholder="Player name...">
          <button class="btn btn-green" style="width:auto;padding:12px 18px" onclick="addPlayer()">+</button>
        </div>
        <div id="player-list"></div>
      </div>
      <div class="card">
        <div class="card-label">üèÜ Championship</div>
        <button class="btn btn-gold" onclick="genDraw()">üé≤ Generate Draw</button>
        <button class="btn btn-red" onclick="clearDraw()">Clear Draw</button>
      </div>
      <div class="card">
        <div class="card-label">üéØ Target Score</div>
        <select id="sel-target" onchange="setTarget()">
          <option value="11">First to 11</option>
          <option value="15">First to 15</option>
          <option value="21" selected>First to 21</option>
          <option value="31">First to 31</option>
        </select>
      </div>
    </div>
  </div>

  <div id="screen-custom" class="screen">
    <div class="hdr">
      <button class="sync-btn" onclick="go('home')" style="padding:10px 14px">‚Üê Back</button>
      <div class="logo" style="font-size:16px">Quick Match</div>
      <div style="width:70px"></div>
    </div>
    <div class="content">
      <div class="card"><div class="card-label">Player 1</div><select id="sel-p1"></select></div>
      <div class="card"><div class="card-label">Player 2</div><select id="sel-p2"></select></div>
      <button class="btn btn-gold" onclick="startCustom()">üéÆ Start Match</button>
    </div>
  </div>

  <div id="screen-dart" class="screen">
    <div class="dart-hdr">
      <button class="dart-back" onclick="go('home')">‚Üê</button>
      <div class="dart-step" id="dart-step">STEP 1 OF 2</div>
      <div class="dart-name" id="dart-player">Player</div>
    </div>
    <div class="dart-grid" id="dart-grid"></div>
    <div class="dart-foot">
      <button class="btn btn-green" id="dart-confirm" onclick="confirmDart()" disabled>Select Dart</button>
    </div>
  </div>

  <div id="screen-game" class="screen">
    <div class="game-hdr">
      <button class="game-menu-btn" onclick="openMenu()">‚ò∞</button>
      <div class="game-badges">
        <div class="badge" id="g-label">Game 1</div>
        <div class="badge live" id="g-live" style="display:none">üî¥ LIVE</div>
        <div class="badge target">To: <span id="g-target">21</span></div>
      </div>
    </div>
    <div class="game-arena">
      <div class="pzone top">
        <div class="pbar" id="bar1"></div>
        <div class="pui">
          <div class="phead"><div class="pdart" id="dart1"></div><span class="pname" id="name1">P1</span></div>
          <div class="score-row">
            <button class="score-adj minus" onclick="adj(1,-1)">‚àí</button>
            <div class="score-big" id="sc1">0</div>
            <button class="score-adj plus" onclick="adj(1,1)">+</button>
          </div>
          <div class="quick-row">
            <button class="qbtn" onclick="adj(1,2)">+2</button>
            <button class="qbtn" onclick="adj(1,3)">+3</button>
            <button class="qbtn" onclick="adj(1,4)">+4</button>
            <button class="qbtn" onclick="adj(1,5)">+5</button>
          </div>
        </div>
      </div>
      <div class="game-mid"><button class="reset-btn" onclick="resetScores()">‚Ü∫</button></div>
      <div class="pzone bot">
        <div class="pbar" id="bar2"></div>
        <div class="pui">
          <div class="phead"><div class="pdart" id="dart2"></div><span class="pname" id="name2">P2</span></div>
          <div class="score-row">
            <button class="score-adj minus" onclick="adj(2,-1)">‚àí</button>
            <div class="score-big" id="sc2">0</div>
            <button class="score-adj plus" onclick="adj(2,1)">+</button>
          </div>
          <div class="quick-row">
            <button class="qbtn" onclick="adj(2,2)">+2</button>
            <button class="qbtn" onclick="adj(2,3)">+3</button>
            <button class="qbtn" onclick="adj(2,4)">+4</button>
            <button class="qbtn" onclick="adj(2,5)">+5</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <nav class="nav" id="nav">
    <button class="nav-btn on" data-s="home"><span class="nav-icon">üè†</span>Home</button>
    <button class="nav-btn" data-s="settings"><span class="nav-icon">‚öôÔ∏è</span>Settings</button>
  </nav>
</div>

<!-- DESKTOP VIEW -->
<div class="desktop-view" style="display:none">
  <div class="d-panel">
    <div class="d-head">
      <h2>üéØ PopDarts</h2>
      <button class="sync-btn" onclick="sync()" style="padding:6px 12px;font-size:11px"><span class="sync-dot" id="dot3"></span><span id="txt3">Sync</span></button>
    </div>
    <div class="d-body">
      <div class="d-section">
        <div class="d-section-title">üë• Players</div>
        <div style="display:flex;gap:6px;margin-bottom:10px">
          <input type="text" id="d-inp-player" placeholder="Add player..." style="padding:10px;font-size:12px">
          <button class="btn btn-green" style="width:auto;margin:0;padding:10px 14px" onclick="addPlayerD()">+</button>
        </div>
        <div id="d-player-list"></div>
      </div>
      <div class="d-section">
        <div class="d-section-title">üìã Draw</div>
        <div id="d-draw" style="max-height:250px;overflow-y:auto"></div>
      </div>
      <div class="d-section">
        <button class="btn btn-gold" style="font-size:12px;padding:10px" onclick="genDraw()">üé≤ Generate Draw</button>
        <button class="btn btn-gray" style="font-size:12px;padding:10px" onclick="clearDraw()">Clear Draw</button>
      </div>
    </div>
  </div>
  
  <div class="d-center">
    <div class="d-head">
      <h2>üèüÔ∏è Stadium</h2>
      <select id="d-target" onchange="setTargetD()" style="width:auto;padding:8px 12px;font-size:12px">
        <option value="11">To 11</option>
        <option value="15">To 15</option>
        <option value="21" selected>To 21</option>
        <option value="31">To 31</option>
      </select>
    </div>
    <div id="d-game-area" style="flex:1;display:flex;flex-direction:column"></div>
  </div>
  
  <div class="d-panel">
    <div class="d-head"><h2>üìä Stats</h2></div>
    <div class="d-body">
      <div class="d-section">
        <div class="d-section-title">üèÜ Standings</div>
        <div id="d-stand"></div>
      </div>
      <div class="d-section">
        <div class="d-section-title">üìà All-Time</div>
        <div id="d-all"></div>
      </div>
    </div>
  </div>
</div>

<!-- Overlays -->
<div class="gmenu" id="gmenu">
  <h2>‚è∏Ô∏è Paused</h2>
  <button class="gmenu-btn resume" onclick="closeMenu()">‚ñ∂Ô∏è Resume</button>
  <button class="gmenu-btn end" onclick="endGame()">‚ùå End Game</button>
</div>

<div class="win" id="win">
  <div class="win-trophy">üèÜ</div>
  <div class="win-tag">üéâ WINNER üéâ</div>
  <div class="win-name" id="win-name">Player</div>
  <div class="win-score" id="win-score">21 - 15</div>
  <div class="win-btns">
    <button class="win-btn save" id="win-save" onclick="saveGame()">üíæ Save Result</button>
    <button class="win-btn again" onclick="rematch()">üîÑ Rematch</button>
    <button class="win-btn exit" onclick="exitWin()">‚úï Exit</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ============================================================================
// POPDARTS v6.5 - CLOUD-FIRST ARCHITECTURE
// The cloud (Google Sheets) is the SINGLE SOURCE OF TRUTH
// ============================================================================

const API = 'https://script.google.com/macros/s/AKfycbzmdLog_tuyJMAE9hCLvfrsVT67LtwvLUOrrESZhUj0pBcbO6eFeajzKocXWfgQ9_MNTA/exec';

const DARTS = [
  {id:'black-green',name:'Black/Green',grad:'linear-gradient(180deg,#1a1a1a,#22c55e,#1a1a1a)',color:'#22c55e'},
  {id:'tropical',name:'Tropical',grad:'linear-gradient(180deg,#f97316,#0891b2,#ec4899)',color:'#f97316'},
  {id:'black-blue',name:'Black/Blue',grad:'linear-gradient(180deg,#1a1a1a,#3b82f6,#1a1a1a)',color:'#3b82f6'},
  {id:'white-purple',name:'White/Purple',grad:'linear-gradient(180deg,#f0f0f0,#a855f7,#f0f0f0)',color:'#a855f7'},
  {id:'cyan',name:'Cyan',grad:'linear-gradient(180deg,#06b6d4,#0891b2)',color:'#06b6d4'},
  {id:'white-teal',name:'White/Teal',grad:'linear-gradient(180deg,#f0f0f0,#14b8a6,#f0f0f0)',color:'#14b8a6'},
  {id:'lime',name:'Lime',grad:'linear-gradient(180deg,#84cc16,#65a30d)',color:'#84cc16'}
];

// ============================================================================
// STATE - All data comes from cloud, minimal local state
// ============================================================================
let CLOUD = {
  players: [],
  draw: [],
  stats: [],      // EXACT copy from spreadsheet
  target: 21,
  live: null
};

let GAME = {
  p1: null, p2: null,
  s1: 0, s2: 0,
  d1: null, d2: null,
  idx: -1, num: null,
  isChamp: false, isGF: false
};

let liveTimer = null;
let desktopPlaying = false;
let deferredPrompt = null;

// ============================================================================
// PWA INSTALL
// ============================================================================
window.addEventListener('beforeinstallprompt', function(e) {
  e.preventDefault();
  deferredPrompt = e;
  setTimeout(function() {
    document.getElementById('install-banner').classList.add('show');
  }, 2000);
});

function hideInstall() {
  document.getElementById('install-banner').classList.remove('show');
}

function installApp() {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then(function() {
      deferredPrompt = null;
      hideInstall();
    });
  }
}

// ============================================================================
// SYNC - Pull everything from cloud
// ============================================================================
async function sync() {
  setDot('busy');
  console.log('[SYNC] Starting...');
  
  try {
    // Fetch all data from cloud in parallel
    const [playersRes, statsRes, drawRes, liveRes] = await Promise.all([
      fetch(API + '?action=players').then(r => r.json()).catch(() => ({success: false})),
      fetch(API + '?action=stats').then(r => r.json()).catch(() => ({success: false})),
      fetch(API + '?action=draw').then(r => r.json()).catch(() => ({success: false})),
      fetch(API + '?action=liveGame').then(r => r.json()).catch(() => ({success: false}))
    ]);
    
    // PLAYERS - Direct from cloud
    if (playersRes.success && playersRes.data && playersRes.data.players) {
      CLOUD.players = playersRes.data.players.filter(p => p && p.trim());
      console.log('[SYNC] Players:', CLOUD.players.length);
    }
    
    // STATS - EXACT copy from spreadsheet, no manipulation!
    if (statsRes.success && statsRes.data && statsRes.data.stats) {
      CLOUD.stats = statsRes.data.stats;
      console.log('[SYNC] Stats:', CLOUD.stats.length);
    }
    
    // DRAW - Direct from cloud
    if (drawRes.success && drawRes.data) {
      CLOUD.draw = [];
      if (drawRes.data.games) {
        for (let i = 0; i < drawRes.data.games.length; i++) {
          const g = drawRes.data.games[i];
          CLOUD.draw.push({
            num: g.gameNum,
            p1: g.player1,
            p2: g.player2,
            s1: g.score1,
            s2: g.score2,
            winner: g.winner || null,
            isGF: g.gameNum === 'GF'
          });
        }
      }
      if (drawRes.data.grandFinal && !CLOUD.draw.find(g => g.isGF)) {
        const gf = drawRes.data.grandFinal;
        CLOUD.draw.push({
          num: 'GF', p1: gf.player1, p2: gf.player2,
          s1: gf.score1, s2: gf.score2, winner: gf.winner, isGF: true
        });
      }
      if (drawRes.data.targetScore) {
        CLOUD.target = drawRes.data.targetScore;
      }
      console.log('[SYNC] Draw:', CLOUD.draw.length, 'games');
    }
    
    // LIVE GAME
    if (liveRes.success && liveRes.data && liveRes.data.active) {
      CLOUD.live = liveRes.data;
      console.log('[SYNC] Live:', CLOUD.live.player1, 'vs', CLOUD.live.player2);
    } else {
      CLOUD.live = null;
    }
    
    setDot('ok');
    document.getElementById('last-sync').textContent = new Date().toLocaleTimeString();
    toast('Synced!', 'ok');
    render();
    
  } catch (e) {
    console.error('[SYNC] Error:', e);
    setDot('err');
    toast('Sync failed', 'err');
  }
}

function setDot(s) {
  const dots = ['dot1', 'dot2', 'dot3'];
  const txts = ['txt1', 'txt2', 'txt3'];
  dots.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.className = 'sync-dot' + (s === 'busy' ? ' busy' : s === 'ok' ? ' ok' : '');
  });
  txts.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.textContent = s === 'busy' ? '...' : s === 'ok' ? 'OK' : 'Err';
  });
}

async function apiPost(action, data) {
  console.log('[API] POST:', action);
  try {
    const body = JSON.stringify(Object.assign({action: action}, data));
    const r = await fetch(API, {
      method: 'POST',
      headers: {'Content-Type': 'text/plain'},
      body: body
    });
    const j = await r.json();
    console.log('[API] Response:', j.success ? 'OK' : 'FAIL');
    return j;
  } catch (e) {
    console.error('[API] Error:', e);
    return {success: false};
  }
}

// ============================================================================
// LIVE GAME SYNC
// ============================================================================
async function pushLive() {
  if (!GAME.p1) return;
  await apiPost('updateLiveGame', {
    active: true,
    gameId: GAME.num || 'custom',
    player1: GAME.p1,
    player2: GAME.p2,
    score1: GAME.s1,
    score2: GAME.s2,
    color1: GAME.d1 ? GAME.d1.id : '',
    color2: GAME.d2 ? GAME.d2.id : '',
    target: CLOUD.target,
    isChamp: GAME.isChamp,
    isGF: GAME.isGF
  });
}

async function clearLive() {
  await apiPost('clearLiveGame', {});
  CLOUD.live = null;
}

async function pullLive() {
  try {
    const r = await fetch(API + '?action=liveGame');
    const j = await r.json();
    if (j.success && j.data && j.data.active) {
      CLOUD.live = j.data;
      
      // If we're in a game, sync scores from cloud
      if (GAME.p1 && j.data.player1 === GAME.p1 && j.data.player2 === GAME.p2) {
        if (j.data.score1 !== GAME.s1 || j.data.score2 !== GAME.s2) {
          GAME.s1 = j.data.score1;
          GAME.s2 = j.data.score2;
          updateGameUI();
          console.log('[LIVE] Score update:', GAME.s1, '-', GAME.s2);
        }
      }
      
      render();
    } else {
      CLOUD.live = null;
    }
  } catch (e) {
    console.error('[LIVE] Pull error:', e);
  }
}

function startLiveSync() {
  stopLiveSync();
  liveTimer = setInterval(pullLive, 1500);
  console.log('[LIVE] Sync started');
}

function stopLiveSync() {
  if (liveTimer) {
    clearInterval(liveTimer);
    liveTimer = null;
    console.log('[LIVE] Sync stopped');
  }
}

// ============================================================================
// NAVIGATION
// ============================================================================
document.querySelectorAll('.nav-btn').forEach(b => {
  b.onclick = () => go(b.dataset.s);
});

function go(s) {
  document.querySelectorAll('.screen').forEach(x => x.classList.remove('active'));
  const scr = document.getElementById('screen-' + s);
  if (scr) scr.classList.add('active');
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.toggle('on', b.dataset.s === s));
  document.getElementById('nav').style.display = ['game', 'dart', 'custom'].includes(s) ? 'none' : 'flex';
  if (s === 'home') render();
  if (s === 'settings') {
    document.getElementById('sel-target').value = CLOUD.target;
    renderPlayers();
  }
}

function switchTab(t, btn) {
  document.querySelectorAll('.tab').forEach(b => b.classList.remove('on'));
  btn.classList.add('on');
  document.getElementById('tab-draw').style.display = t === 'draw' ? 'block' : 'none';
  document.getElementById('tab-stand').style.display = t === 'stand' ? 'block' : 'none';
  document.getElementById('tab-all').style.display = t === 'all' ? 'block' : 'none';
}

// ============================================================================
// RENDER - Display data from CLOUD
// ============================================================================
function render() {
  // Count games
  let done = 0, total = 0;
  for (let i = 0; i < CLOUD.draw.length; i++) {
    if (!CLOUD.draw[i].isGF) {
      total++;
      if (CLOUD.draw[i].winner) done++;
    }
  }
  
  document.getElementById('s-players').textContent = CLOUD.players.length;
  document.getElementById('s-games').textContent = total ? done + '/' + total : '0';
  document.getElementById('s-target').textContent = CLOUD.target;
  
  renderLive();
  renderHero();
  renderDraw();
  renderStand();
  renderAll();
  
  if (window.innerWidth >= 1024) renderDesktop();
}

function renderLive() {
  const el = document.getElementById('live-zone');
  if (!CLOUD.live || !CLOUD.live.active) {
    el.innerHTML = '';
    return;
  }
  el.innerHTML = '<div class="live-card" onclick="joinLive()"><div class="live-badge"><span class="live-pulse"></span>LIVE NOW</div><div class="live-players">' + CLOUD.live.player1 + ' vs ' + CLOUD.live.player2 + '</div><div class="live-score">' + CLOUD.live.score1 + ' - ' + CLOUD.live.score2 + '</div></div>';
}

function renderHero() {
  const el = document.getElementById('hero-zone');
  const n = getNext();
  
  if (!CLOUD.draw.length) {
    el.innerHTML = '<div class="hero"><div class="hero-tag" style="color:var(--muted)">NO CHAMPIONSHIP</div><div class="hero-match">' + (CLOUD.players.length < 2 ? 'Add players first' : 'Tap Draw to start') + '</div></div>';
    return;
  }
  if (!n) {
    el.innerHTML = '<div class="hero"><div class="hero-tag">üéâ COMPLETE</div><div class="hero-match">All games finished!</div></div>';
    return;
  }
  
  const g = n.game;
  el.innerHTML = '<div class="hero ' + (g.isGF ? 'gf' : '') + '"><div class="hero-tag">' + (g.isGF ? 'üèÜ GRAND FINAL üèÜ' : 'GAME ' + g.num) + '</div><div class="hero-match">' + g.p1 + '<span class="hero-vs">vs</span>' + g.p2 + '</div><button class="hero-btn" onclick="playNext()">‚ñ∂Ô∏è Play Now</button></div>';
}

function renderDraw() {
  const el = document.getElementById('tab-draw');
  if (!CLOUD.draw.length) {
    el.innerHTML = '<div class="empty">No games yet</div>';
    return;
  }
  
  let html = '';
  for (let i = 0; i < CLOUD.draw.length; i++) {
    const g = CLOUD.draw[i];
    const clickAttr = g.winner ? '' : 'onclick="playIdx(' + i + ')"';
    html += '<div class="draw-row ' + (g.winner ? 'done' : '') + ' ' + (g.isGF ? 'gf' : '') + '" ' + clickAttr + '>';
    html += '<div class="draw-num">' + (g.isGF ? 'üèÜ' : g.num) + '</div>';
    html += '<div class="draw-players">' + g.p1 + ' vs ' + g.p2 + '</div>';
    html += '<div class="draw-result">' + (g.winner ? g.s1 + '-' + g.s2 : '‚Äî') + '</div>';
    html += '</div>';
  }
  el.innerHTML = html;
}

// STANDINGS - Calculate from draw results
function renderStand() {
  const el = document.getElementById('tab-stand');
  
  // Build standings from draw
  const map = {};
  CLOUD.players.forEach(p => {
    map[p] = {name: p, w: 0, l: 0, pf: 0, pa: 0, diff: 0};
  });
  
  CLOUD.draw.forEach(g => {
    if (!g.winner) return;
    const a = map[g.p1];
    const b = map[g.p2];
    if (a) {
      if (g.winner === g.p1) a.w++; else a.l++;
      a.pf += (g.s1 || 0);
      a.pa += (g.s2 || 0);
      a.diff = a.pf - a.pa;
    }
    if (b) {
      if (g.winner === g.p2) b.w++; else b.l++;
      b.pf += (g.s2 || 0);
      b.pa += (g.s1 || 0);
      b.diff = b.pf - b.pa;
    }
  });
  
  const arr = Object.values(map).sort((a, b) => b.w - a.w || b.diff - a.diff);
  
  if (!arr.length) {
    el.innerHTML = '<div class="empty">No standings</div>';
    return;
  }
  
  let html = '<table class="tbl"><thead><tr><th>Player</th><th>W</th><th>L</th><th>+/-</th></tr></thead><tbody>';
  arr.forEach((p, i) => {
    const diffClass = p.diff > 0 ? 'plus' : p.diff < 0 ? 'minus' : '';
    html += '<tr class="' + (i === 0 ? 'top' : '') + '"><td>' + (i === 0 ? 'üëë ' : '') + p.name + '</td><td>' + p.w + '</td><td>' + p.l + '</td><td class="' + diffClass + '">' + (p.diff > 0 ? '+' : '') + p.diff + '</td></tr>';
  });
  el.innerHTML = html + '</tbody></table>';
}

// ALL-TIME STATS - EXACT copy from spreadsheet, sorted by CHAMPS then WINS
function renderAll() {
  const el = document.getElementById('tab-all');
  
  if (!CLOUD.stats.length) {
    el.innerHTML = '<div class="empty">No stats yet</div>';
    return;
  }
  
  // Sort: Championships DESC, then Wins DESC
  const sorted = [...CLOUD.stats].sort((a, b) => {
    const champDiff = (b.championships || 0) - (a.championships || 0);
    if (champDiff !== 0) return champDiff;
    return (b.wins || 0) - (a.wins || 0);
  });
  
  let html = '<table class="tbl"><thead><tr><th>Player</th><th>GP</th><th>W</th><th>L</th><th>%</th><th>F</th><th>A</th><th>D</th><th>üèÜ</th></tr></thead><tbody>';
  
  sorted.forEach(s => {
    const gp = s.gamesPlayed || 0;
    const w = s.wins || 0;
    const l = s.losses || 0;
    const pf = s.pointsFor || 0;
    const pa = s.pointsAgainst || 0;
    const diff = s.pointsDiff || 0;
    const champs = s.championships || 0;
    const pct = gp ? Math.round(w / gp * 100) : 0;
    const diffClass = diff > 0 ? 'plus' : diff < 0 ? 'minus' : '';
    
    html += '<tr><td>' + s.name + '</td><td>' + gp + '</td><td>' + w + '</td><td>' + l + '</td><td>' + pct + '</td><td>' + pf + '</td><td>' + pa + '</td><td class="' + diffClass + '">' + (diff > 0 ? '+' : '') + diff + '</td><td class="' + (champs ? 'champ' : '') + '">' + champs + '</td></tr>';
  });
  
  el.innerHTML = html + '</tbody></table>';
}

function getNext() {
  for (let i = 0; i < CLOUD.draw.length; i++) {
    if (!CLOUD.draw[i].isGF && !CLOUD.draw[i].winner) return {idx: i, game: CLOUD.draw[i]};
  }
  for (let i = 0; i < CLOUD.draw.length; i++) {
    if (CLOUD.draw[i].isGF && !CLOUD.draw[i].winner) return {idx: i, game: CLOUD.draw[i]};
  }
  return null;
}

// ============================================================================
// DESKTOP RENDER
// ============================================================================
function renderDesktop() {
  // Players
  const playerEl = document.getElementById('d-player-list');
  if (CLOUD.players.length) {
    let html = '';
    CLOUD.players.forEach(p => {
      html += '<div style="padding:8px 0;border-bottom:1px solid var(--border);font-size:12px">' + p + '</div>';
    });
    playerEl.innerHTML = html;
  } else {
    playerEl.innerHTML = '<div style="color:var(--muted);font-size:11px">No players</div>';
  }
  
  // Draw
  const drawEl = document.getElementById('d-draw');
  if (CLOUD.draw.length) {
    let html = '';
    CLOUD.draw.forEach((g, i) => {
      const clickAttr = g.winner ? '' : 'onclick="playIdxDesktop(' + i + ')"';
      html += '<div class="d-draw-row ' + (g.winner ? 'done' : '') + ' ' + (g.isGF ? 'gf' : '') + '" ' + clickAttr + '>';
      html += '<div class="d-draw-num">' + (g.isGF ? 'üèÜ' : g.num) + '</div>';
      html += '<div class="d-draw-players">' + g.p1 + ' vs ' + g.p2 + '</div>';
      html += '<div class="d-draw-score">' + (g.winner ? g.s1 + '-' + g.s2 : '‚Äî') + '</div>';
      html += '</div>';
    });
    drawEl.innerHTML = html;
  } else {
    drawEl.innerHTML = '<div style="color:var(--muted);font-size:11px">No draw</div>';
  }
  
  // Standings
  const standEl = document.getElementById('d-stand');
  const standMap = {};
  CLOUD.players.forEach(p => standMap[p] = {name: p, w: 0, l: 0, diff: 0});
  CLOUD.draw.forEach(g => {
    if (!g.winner) return;
    if (standMap[g.p1]) {
      if (g.winner === g.p1) standMap[g.p1].w++; else standMap[g.p1].l++;
      standMap[g.p1].diff += (g.s1 || 0) - (g.s2 || 0);
    }
    if (standMap[g.p2]) {
      if (g.winner === g.p2) standMap[g.p2].w++; else standMap[g.p2].l++;
      standMap[g.p2].diff += (g.s2 || 0) - (g.s1 || 0);
    }
  });
  const standArr = Object.values(standMap).sort((a, b) => b.w - a.w || b.diff - a.diff);
  
  if (standArr.length) {
    let html = '<table class="tbl" style="font-size:10px"><thead><tr><th>Player</th><th>W</th><th>L</th><th>+/-</th></tr></thead><tbody>';
    standArr.forEach((p, i) => {
      html += '<tr class="' + (i === 0 ? 'top' : '') + '"><td>' + (i === 0 ? 'üëë ' : '') + p.name + '</td><td>' + p.w + '</td><td>' + p.l + '</td><td class="' + (p.diff > 0 ? 'plus' : p.diff < 0 ? 'minus' : '') + '">' + (p.diff > 0 ? '+' : '') + p.diff + '</td></tr>';
    });
    standEl.innerHTML = html + '</tbody></table>';
  } else {
    standEl.innerHTML = '<div style="color:var(--muted);font-size:11px">No standings</div>';
  }
  
  // All-time - sorted by CHAMPS
  const allEl = document.getElementById('d-all');
  const sorted = [...CLOUD.stats].sort((a, b) => (b.championships || 0) - (a.championships || 0) || (b.wins || 0) - (a.wins || 0));
  
  if (sorted.length) {
    let html = '<table class="tbl" style="font-size:9px"><thead><tr><th>Player</th><th>GP</th><th>W</th><th>%</th><th>üèÜ</th></tr></thead><tbody>';
    sorted.forEach(s => {
      const pct = s.gamesPlayed ? Math.round(s.wins / s.gamesPlayed * 100) : 0;
      html += '<tr><td>' + s.name + '</td><td>' + (s.gamesPlayed || 0) + '</td><td>' + (s.wins || 0) + '</td><td>' + pct + '%</td><td class="' + (s.championships ? 'champ' : '') + '">' + (s.championships || 0) + '</td></tr>';
    });
    allEl.innerHTML = html + '</tbody></table>';
  } else {
    allEl.innerHTML = '<div style="color:var(--muted);font-size:10px">No stats</div>';
  }
  
  // Game area
  renderDesktopGame();
}

function renderDesktopGame() {
  const el = document.getElementById('d-game-area');
  
  // If playing on desktop
  if (desktopPlaying && GAME.p1) {
    el.innerHTML = buildDesktopGameHTML();
    return;
  }
  
  // If there's a live game
  if (CLOUD.live && CLOUD.live.active) {
    const d1 = DARTS.find(d => d.id === CLOUD.live.color1) || DARTS[0];
    const d2 = DARTS.find(d => d.id === CLOUD.live.color2) || DARTS[2];
    const p1pct = Math.min(100, (CLOUD.live.score1 / CLOUD.target) * 100);
    const p2pct = Math.min(100, (CLOUD.live.score2 / CLOUD.target) * 100);
    
    el.innerHTML = '<div class="live-card" onclick="joinLiveDesktop()" style="margin:16px"><div class="live-badge"><span class="live-pulse"></span>LIVE - Click to Join & Score</div><div class="live-players" style="font-size:20px">' + CLOUD.live.player1 + ' vs ' + CLOUD.live.player2 + '</div><div class="live-score" style="font-size:50px">' + CLOUD.live.score1 + ' - ' + CLOUD.live.score2 + '</div></div>' +
      '<div class="d-game-wrap" style="pointer-events:none;opacity:.8"><div class="game-hdr"><div></div><div class="game-badges"><div class="badge live">WATCHING</div></div></div><div class="game-arena"><div class="pzone top"><div class="pbar" style="width:' + p1pct + '%;background:' + d1.grad + '"></div><div class="pui"><div class="phead"><div class="pdart" style="background:' + d1.grad + '"></div><span class="pname">' + CLOUD.live.player1 + '</span></div><div class="score-row"><div class="score-big">' + CLOUD.live.score1 + '</div></div></div></div><div class="game-mid"></div><div class="pzone bot"><div class="pbar" style="width:' + p2pct + '%;background:' + d2.grad + '"></div><div class="pui"><div class="phead"><div class="pdart" style="background:' + d2.grad + '"></div><span class="pname">' + CLOUD.live.player2 + '</span></div><div class="score-row"><div class="score-big">' + CLOUD.live.score2 + '</div></div></div></div></div></div>';
    return;
  }
  
  // Show next game hero
  const n = getNext();
  if (!n) {
    el.innerHTML = '<div style="flex:1;display:flex;align-items:center;justify-content:center"><div class="hero" style="max-width:400px"><div class="hero-tag">' + (CLOUD.draw.length ? 'üéâ COMPLETE' : 'NO CHAMPIONSHIP') + '</div><div class="hero-match">' + (CLOUD.draw.length ? 'All games done!' : CLOUD.players.length < 2 ? 'Add 2+ players' : 'Click Generate Draw') + '</div></div></div>';
    return;
  }
  
  const g = n.game;
  el.innerHTML = '<div style="flex:1;display:flex;align-items:center;justify-content:center"><div class="hero ' + (g.isGF ? 'gf' : '') + '" style="max-width:420px;padding:30px"><div class="hero-tag" style="font-size:13px">' + (g.isGF ? 'üèÜ GRAND FINAL üèÜ' : 'NEXT GAME ' + g.num) + '</div><div class="hero-match" style="font-size:28px">' + g.p1 + '<span class="hero-vs" style="font-size:14px">vs</span>' + g.p2 + '</div><button class="hero-btn" onclick="playIdxDesktop(' + n.idx + ')" style="font-size:16px;padding:14px 36px">‚ñ∂Ô∏è Play Game</button></div></div>';
}

function buildDesktopGameHTML() {
  const d1 = GAME.d1 || DARTS[0];
  const d2 = GAME.d2 || DARTS[2];
  const p1pct = Math.min(100, (GAME.s1 / CLOUD.target) * 100);
  const p2pct = Math.min(100, (GAME.s2 / CLOUD.target) * 100);
  
  return '<div class="d-game-wrap"><div class="game-hdr"><button class="game-menu-btn" onclick="openMenu()">‚ò∞</button><div class="game-badges"><div class="badge ' + (GAME.isGF ? 'gf' : '') + '">' + (GAME.isGF ? 'üèÜ GRAND FINAL' : GAME.isChamp ? 'Game ' + GAME.num : 'Quick Match') + '</div>' + (GAME.isChamp ? '<div class="badge live">üî¥ LIVE</div>' : '') + '<div class="badge target">To: ' + CLOUD.target + '</div></div></div><div class="game-arena"><div class="pzone top"><div class="pbar" style="width:' + p1pct + '%;background:' + d1.grad + '"></div><div class="pui"><div class="phead"><div class="pdart" style="background:' + d1.grad + '"></div><span class="pname">' + GAME.p1 + '</span></div><div class="score-row"><button class="score-adj minus" onclick="adj(1,-1)">‚àí</button><div class="score-big">' + GAME.s1 + '</div><button class="score-adj plus" onclick="adj(1,1)">+</button></div><div class="quick-row"><button class="qbtn" onclick="adj(1,2)">+2</button><button class="qbtn" onclick="adj(1,3)">+3</button><button class="qbtn" onclick="adj(1,4)">+4</button><button class="qbtn" onclick="adj(1,5)">+5</button></div></div></div><div class="game-mid"><button class="reset-btn" onclick="resetScores()">‚Ü∫</button></div><div class="pzone bot"><div class="pbar" style="width:' + p2pct + '%;background:' + d2.grad + '"></div><div class="pui"><div class="phead"><div class="pdart" style="background:' + d2.grad + '"></div><span class="pname">' + GAME.p2 + '</span></div><div class="score-row"><button class="score-adj minus" onclick="adj(2,-1)">‚àí</button><div class="score-big">' + GAME.s2 + '</div><button class="score-adj plus" onclick="adj(2,1)">+</button></div><div class="quick-row"><button class="qbtn" onclick="adj(2,2)">+2</button><button class="qbtn" onclick="adj(2,3)">+3</button><button class="qbtn" onclick="adj(2,4)">+4</button><button class="qbtn" onclick="adj(2,5)">+5</button></div></div></div></div></div>';
}

// ============================================================================
// CUSTOM MATCH
// ============================================================================
function openCustom() {
  if (CLOUD.players.length < 2) {
    toast('Add 2+ players', 'err');
    return;
  }
  let opts = '';
  CLOUD.players.forEach(p => {
    opts += '<option value="' + p + '">' + p + '</option>';
  });
  document.getElementById('sel-p1').innerHTML = opts;
  document.getElementById('sel-p2').innerHTML = opts;
  if (CLOUD.players.length > 1) document.getElementById('sel-p2').selectedIndex = 1;
  go('custom');
}

function startCustom() {
  const p1 = document.getElementById('sel-p1').value;
  const p2 = document.getElementById('sel-p2').value;
  if (p1 === p2) {
    toast('Pick different players', 'err');
    return;
  }
  GAME = {p1: p1, p2: p2, s1: 0, s2: 0, d1: null, d2: null, idx: -1, num: null, isChamp: false, isGF: false};
  openDart(1, p1);
}

// ============================================================================
// DART PICKER
// ============================================================================
function openDart(step, name) {
  GAME.step = step;
  GAME.pick = null;
  document.getElementById('dart-step').textContent = 'STEP ' + step + ' OF 2';
  document.getElementById('dart-player').textContent = name;
  document.getElementById('dart-confirm').disabled = true;
  
  let html = '';
  DARTS.forEach(d => {
    const off = step === 2 && GAME.d1 && GAME.d1.id === d.id;
    html += '<div class="dart-opt ' + (off ? 'off' : '') + '" data-id="' + d.id + '" onclick="pickDart(\'' + d.id + '\')"><div class="dart-shape" style="background:' + d.grad + '"></div><div class="dart-label">' + d.name + '</div></div>';
  });
  document.getElementById('dart-grid').innerHTML = html;
  go('dart');
}

function pickDart(id) {
  GAME.pick = DARTS.find(d => d.id === id);
  document.querySelectorAll('.dart-opt').forEach(el => {
    el.classList.toggle('picked', el.dataset.id === id);
  });
  document.getElementById('dart-confirm').disabled = false;
}

function confirmDart() {
  if (!GAME.pick) return;
  if (GAME.step === 1) {
    GAME.d1 = GAME.pick;
    openDart(2, GAME.p2);
  } else {
    GAME.d2 = GAME.pick;
    beginGame(false);
  }
}

// ============================================================================
// GAMEPLAY
// ============================================================================
function playNext() {
  const n = getNext();
  if (!n) {
    toast(CLOUD.draw.length ? 'All done!' : 'Generate draw first', 'err');
    return;
  }
  playIdx(n.idx);
}

function playIdx(i) {
  const g = CLOUD.draw[i];
  if (!g || g.winner) return;
  GAME = {p1: g.p1, p2: g.p2, s1: 0, s2: 0, d1: null, d2: null, idx: i, num: g.num, isChamp: true, isGF: g.isGF};
  openDart(1, g.p1);
}

function playIdxDesktop(i) {
  const g = CLOUD.draw[i];
  if (!g || g.winner) return;
  GAME = {p1: g.p1, p2: g.p2, s1: 0, s2: 0, d1: DARTS[0], d2: DARTS[2], idx: i, num: g.num, isChamp: true, isGF: g.isGF};
  desktopPlaying = true;
  if (GAME.isChamp) {
    pushLive();
    startLiveSync();
  }
  render();
}

function joinLive() {
  if (!CLOUD.live || !CLOUD.live.active) return;
  GAME = {
    p1: CLOUD.live.player1,
    p2: CLOUD.live.player2,
    s1: CLOUD.live.score1,
    s2: CLOUD.live.score2,
    d1: DARTS.find(d => d.id === CLOUD.live.color1) || DARTS[0],
    d2: DARTS.find(d => d.id === CLOUD.live.color2) || DARTS[2],
    idx: -1,
    num: CLOUD.live.gameId,
    isChamp: CLOUD.live.isChamp,
    isGF: CLOUD.live.isGF
  };
  setupGameUI();
  startLiveSync();
  go('game');
}

function joinLiveDesktop() {
  if (!CLOUD.live || !CLOUD.live.active) return;
  GAME = {
    p1: CLOUD.live.player1,
    p2: CLOUD.live.player2,
    s1: CLOUD.live.score1,
    s2: CLOUD.live.score2,
    d1: DARTS.find(d => d.id === CLOUD.live.color1) || DARTS[0],
    d2: DARTS.find(d => d.id === CLOUD.live.color2) || DARTS[2],
    idx: -1,
    num: CLOUD.live.gameId,
    isChamp: CLOUD.live.isChamp,
    isGF: CLOUD.live.isGF
  };
  desktopPlaying = true;
  startLiveSync();
  render();
}

function beginGame(isDesktop) {
  GAME.s1 = 0;
  GAME.s2 = 0;
  desktopPlaying = isDesktop;
  
  if (!isDesktop) {
    setupGameUI();
    if (GAME.isChamp) {
      pushLive();
      startLiveSync();
      document.getElementById('g-live').style.display = 'flex';
    } else {
      document.getElementById('g-live').style.display = 'none';
    }
    go('game');
  } else {
    if (GAME.isChamp) {
      pushLive();
      startLiveSync();
    }
    render();
  }
}

function setupGameUI() {
  document.getElementById('name1').textContent = GAME.p1;
  document.getElementById('name2').textContent = GAME.p2;
  document.getElementById('dart1').style.background = GAME.d1.grad;
  document.getElementById('dart2').style.background = GAME.d2.grad;
  document.getElementById('g-target').textContent = CLOUD.target;
  
  const lbl = document.getElementById('g-label');
  if (GAME.isGF) {
    lbl.textContent = 'üèÜ GRAND FINAL';
    lbl.className = 'badge gf';
  } else if (GAME.isChamp) {
    lbl.textContent = 'Game ' + GAME.num;
    lbl.className = 'badge';
  } else {
    lbl.textContent = 'Quick Match';
    lbl.className = 'badge';
  }
  
  updateGameUI();
}

function adj(p, amt) {
  if (p === 1) {
    GAME.s1 = Math.max(0, GAME.s1 + amt);
    if (GAME.s1 >= CLOUD.target) {
      GAME.s1 = CLOUD.target;
      updateGameUI();
      win(GAME.p1);
      return;
    }
  } else {
    GAME.s2 = Math.max(0, GAME.s2 + amt);
    if (GAME.s2 >= CLOUD.target) {
      GAME.s2 = CLOUD.target;
      updateGameUI();
      win(GAME.p2);
      return;
    }
  }
  updateGameUI();
  if (GAME.isChamp) pushLive();
}

function updateGameUI() {
  // Mobile
  const sc1 = document.getElementById('sc1');
  const sc2 = document.getElementById('sc2');
  if (sc1) sc1.textContent = GAME.s1;
  if (sc2) sc2.textContent = GAME.s2;
  
  const p1pct = Math.min(100, (GAME.s1 / CLOUD.target) * 100);
  const p2pct = Math.min(100, (GAME.s2 / CLOUD.target) * 100);
  
  const bar1 = document.getElementById('bar1');
  const bar2 = document.getElementById('bar2');
  if (bar1 && GAME.d1) {
    bar1.style.width = p1pct + '%';
    bar1.style.background = GAME.d1.grad;
  }
  if (bar2 && GAME.d2) {
    bar2.style.width = p2pct + '%';
    bar2.style.background = GAME.d2.grad;
  }
  
  // Re-render desktop if playing
  if (desktopPlaying && window.innerWidth >= 1024) {
    renderDesktopGame();
  }
}

function resetScores() {
  if (!confirm('Reset to 0-0?')) return;
  GAME.s1 = 0;
  GAME.s2 = 0;
  updateGameUI();
  if (GAME.isChamp) pushLive();
}

// ============================================================================
// MENU
// ============================================================================
function openMenu() {
  document.getElementById('gmenu').classList.add('on');
}

function closeMenu() {
  document.getElementById('gmenu').classList.remove('on');
}

function endGame() {
  if (!confirm('End without saving?')) return;
  closeMenu();
  stopLiveSync();
  clearLive();
  desktopPlaying = false;
  if (window.innerWidth >= 1024) render();
  else go('home');
  toast('Ended', 'ok');
}

// ============================================================================
// WIN
// ============================================================================
function win(name) {
  stopLiveSync();
  document.getElementById('win-name').textContent = name;
  document.getElementById('win-score').textContent = GAME.s1 + ' - ' + GAME.s2;
  document.getElementById('win-save').style.display = GAME.isChamp ? 'inline-block' : 'none';
  document.getElementById('win').classList.add('on');
  confetti();
}

async function saveGame() {
  const winner = GAME.s1 >= CLOUD.target ? GAME.p1 : GAME.p2;
  
  if (GAME.isChamp && GAME.idx >= 0) {
    // Submit to cloud - the cloud will update stats!
    await apiPost('submitGame', {
      gameId: CLOUD.draw[GAME.idx].num,
      player1: GAME.p1,
      player2: GAME.p2,
      score1: GAME.s1,
      score2: GAME.s2
    });
    
    if (GAME.isGF) {
      toast('üèÜ Champion crowned!', 'ok');
    } else {
      toast('Saved!', 'ok');
    }
    
    // Sync to get updated stats from cloud
    await sync();
  }
  
  clearLive();
  desktopPlaying = false;
  exitWin();
}

function rematch() {
  document.getElementById('win').classList.remove('on');
  GAME.s1 = 0;
  GAME.s2 = 0;
  updateGameUI();
  if (GAME.isChamp) {
    pushLive();
    startLiveSync();
  }
}

function exitWin() {
  document.getElementById('win').classList.remove('on');
  if (window.innerWidth >= 1024) render();
  else go('home');
}

function confetti() {
  const cols = [GAME.d1 ? GAME.d1.color : '#ffc107', GAME.d2 ? GAME.d2.color : '#3b82f6', '#00e676', '#ff5252'];
  for (let i = 0; i < 40; i++) {
    setTimeout(() => {
      const c = document.createElement('div');
      c.className = 'confetti';
      c.style.left = Math.random() * 100 + 'vw';
      c.style.background = cols[Math.floor(Math.random() * cols.length)];
      c.style.animationDuration = (2 + Math.random() * 2) + 's';
      document.body.appendChild(c);
      setTimeout(() => c.remove(), 4000);
    }, i * 25);
  }
}

// ============================================================================
// SETTINGS - Players from cloud
// ============================================================================
function renderPlayers() {
  const el = document.getElementById('player-list');
  if (!CLOUD.players.length) {
    el.innerHTML = '<div style="color:var(--muted);padding:16px;text-align:center">No players yet</div>';
    return;
  }
  
  let html = '';
  CLOUD.players.forEach((p, i) => {
    // Find stats for this player
    const stat = CLOUD.stats.find(s => s.name === p) || {};
    html += '<div class="player-row"><div class="player-avatar">' + p[0].toUpperCase() + '</div><div class="player-info"><div class="name">' + (stat.championships ? 'üèÜ ' : '') + p + '</div><div class="meta">' + (stat.gamesPlayed || 0) + ' GP ‚Ä¢ ' + (stat.wins || 0) + ' W</div></div><button onclick="deletePlayer(\'' + p.replace(/'/g, "\\'") + '\')" style="width:32px;height:32px;background:rgba(255,82,82,.15);border:none;border-radius:50%;color:var(--red);font-size:16px;cursor:pointer">√ó</button></div>';
  });
  el.innerHTML = html;
}

async function deletePlayer(name) {
  if (!confirm('Remove ' + name + ' from active players?\n\nTheir stats will be kept in All-Time.')) return;
  
  // Call cloud to delete
  const result = await apiPost('deletePlayer', {playerName: name});
  
  if (result.success) {
    toast('Removed ' + name, 'ok');
    await sync();
    renderPlayers();
  } else {
    toast('Failed to remove', 'err');
  }
}

async function addPlayer() {
  const inp = document.getElementById('inp-player');
  const name = inp.value.trim();
  if (!name) return;
  
  // Check if exists
  if (CLOUD.players.some(p => p.toLowerCase() === name.toLowerCase())) {
    toast('Already exists!', 'err');
    return;
  }
  
  // Add to cloud
  await apiPost('addPlayer', {playerName: name});
  inp.value = '';
  
  // Sync to get updated list
  await sync();
  renderPlayers();
  toast('Added!', 'ok');
}

async function addPlayerD() {
  const inp = document.getElementById('d-inp-player');
  const name = inp.value.trim();
  if (!name) return;
  
  if (CLOUD.players.some(p => p.toLowerCase() === name.toLowerCase())) {
    toast('Already exists!', 'err');
    return;
  }
  
  await apiPost('addPlayer', {playerName: name});
  inp.value = '';
  await sync();
  toast('Added!', 'ok');
}

document.getElementById('inp-player').addEventListener('keypress', e => {
  if (e.key === 'Enter') addPlayer();
});

const dInp = document.getElementById('d-inp-player');
if (dInp) dInp.addEventListener('keypress', e => {
  if (e.key === 'Enter') addPlayerD();
});

async function genDraw() {
  if (CLOUD.players.length < 2) {
    toast('Need 2+ players', 'err');
    return;
  }
  if (CLOUD.draw.length && !confirm('Replace current draw?')) return;
  
  await apiPost('generateDraw', {});
  await sync();
  toast('Draw generated!', 'ok');
  if (window.innerWidth < 1024) go('home');
}

async function clearDraw() {
  if (!confirm('Clear all games?')) return;
  await apiPost('newEvent', {});
  await sync();
  toast('Draw cleared', 'ok');
}

function setTarget() {
  CLOUD.target = parseInt(document.getElementById('sel-target').value) || 21;
  render();
  toast('Target: ' + CLOUD.target, 'ok');
}

function setTargetD() {
  CLOUD.target = parseInt(document.getElementById('d-target').value) || 21;
  document.getElementById('sel-target').value = CLOUD.target;
  render();
  toast('Target: ' + CLOUD.target, 'ok');
}

function toast(m, t) {
  const el = document.getElementById('toast');
  el.textContent = m;
  el.className = 'toast show ' + (t || 'ok');
  setTimeout(() => el.classList.remove('show'), 2500);
}

// ============================================================================
// INIT
// ============================================================================
window.addEventListener('resize', () => render());

// Auto-sync every 15 seconds when on home or desktop
setInterval(() => {
  const homeEl = document.getElementById('screen-home');
  if ((homeEl && homeEl.classList.contains('active')) || window.innerWidth >= 1024) {
    sync();
  }
}, 15000);

// Initial sync and render
render();
sync();
startLiveSync();
console.log('[POPDARTS] v6.5 Cloud-First Ready!');
</script>
</body>
</html>
