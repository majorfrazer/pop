<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>PopDarts</title>
  <meta name="theme-color" content="#0a0a12">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="PopDarts">
  <link rel="manifest" href="./manifest.json">
  <link rel="apple-touch-icon" href="./icon-192.png">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
    
    :root {
      /* Core Colors */
      --bg-primary: #0a0a12;
      --bg-secondary: #12121e;
      --bg-card: #1a1a2a;
      --bg-elevated: #222236;
      
      /* Text Colors */
      --text-primary: #ffffff;
      --text-secondary: #a0a0b8;
      --text-muted: #606078;
      
      /* Accent Colors */
      --accent-gold: #f5a623;
      --accent-green: #00d68f;
      --accent-red: #ff4757;
      --accent-blue: #3b82f6;
      --accent-purple: #a855f7;
      
      /* Borders */
      --border-subtle: rgba(255,255,255,0.06);
      --border-medium: rgba(255,255,255,0.12);
      
      /* Safe Areas */
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
      --safe-left: env(safe-area-inset-left);
      --safe-right: env(safe-area-inset-right);
      
      /* Spacing */
      --space-xs: 4px;
      --space-sm: 8px;
      --space-md: 16px;
      --space-lg: 24px;
      --space-xl: 32px;
      --space-2xl: 48px;
      
      /* Border Radius */
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;
      --radius-full: 9999px;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      user-select: none;
      margin: 0;
      padding: 0;
    }

    html, body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      min-height: 100dvh;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
    }

    /* ========================================
       RESPONSIVE CONTAINER
       ======================================== */
    .app-container {
      min-height: 100vh;
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
    }

    /* Desktop/Tablet: Center with max-width */
    @media (min-width: 768px) {
      .app-container {
        max-width: 480px;
        margin: 0 auto;
        border-left: 1px solid var(--border-subtle);
        border-right: 1px solid var(--border-subtle);
      }
    }

    /* ========================================
       SCREENS
       ======================================== */
    .screen {
      position: fixed;
      inset: 0;
      display: none;
      flex-direction: column;
      background: var(--bg-primary);
      z-index: 10;
    }
    .screen.active { display: flex; }

    @media (min-width: 768px) {
      .screen {
        left: 50%;
        transform: translateX(-50%);
        max-width: 480px;
        border-left: 1px solid var(--border-subtle);
        border-right: 1px solid var(--border-subtle);
      }
    }

    /* ========================================
       HEADER
       ======================================== */
    .header {
      padding: max(var(--space-md), var(--safe-top)) var(--space-lg) var(--space-md);
      background: linear-gradient(180deg, var(--bg-primary) 0%, rgba(10,10,18,0.95) 100%);
      backdrop-filter: blur(20px);
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border-subtle);
      position: sticky;
      top: 0;
      z-index: 50;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }
    .logo-mark {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--accent-gold) 0%, #ff6b35 100%);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
    }
    .logo-text {
      font-size: 24px;
      font-weight: 800;
      letter-spacing: -0.5px;
    }

    .sync-btn {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      padding: var(--space-sm) var(--space-md);
      background: var(--bg-card);
      border: 1px solid var(--border-medium);
      border-radius: var(--radius-full);
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
    }
    .sync-btn:active { transform: scale(0.95); background: var(--bg-elevated); }
    .sync-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent-red);
      transition: background 0.3s;
    }
    .sync-dot.ok { background: var(--accent-green); }
    .sync-dot.busy { background: var(--accent-gold); animation: pulse 0.6s infinite alternate; }
    @keyframes pulse { to { opacity: 0.4; } }

    /* ========================================
       CONTENT AREA
       ======================================== */
    .content {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: var(--space-lg);
      padding-bottom: calc(90px + var(--safe-bottom));
    }

    /* ========================================
       CARDS
       ======================================== */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-xl);
      padding: var(--space-lg);
      margin-bottom: var(--space-md);
    }
    .card-header {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: var(--text-muted);
      margin-bottom: var(--space-md);
    }

    /* ========================================
       HERO CARD - Next Game
       ======================================== */
    .hero-card {
      background: linear-gradient(135deg, #1a1a2e 0%, #252545 100%);
      border: 1px solid var(--border-medium);
      border-radius: var(--radius-xl);
      padding: var(--space-xl);
      margin-bottom: var(--space-lg);
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    .hero-card::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(245,166,35,0.08) 0%, transparent 50%);
      pointer-events: none;
    }
    .hero-label {
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 2px;
      color: var(--accent-gold);
      margin-bottom: var(--space-sm);
    }
    .hero-matchup {
      font-size: 26px;
      font-weight: 800;
      line-height: 1.3;
      margin-bottom: var(--space-lg);
    }
    .hero-vs {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-muted);
      margin: var(--space-xs) 0;
    }
    .hero-cta {
      display: inline-flex;
      align-items: center;
      gap: var(--space-sm);
      padding: var(--space-md) var(--space-xl);
      background: var(--accent-gold);
      color: #000;
      font-size: 16px;
      font-weight: 700;
      border-radius: var(--radius-full);
      border: none;
      cursor: pointer;
      transition: all 0.2s;
    }
    .hero-cta:active { transform: scale(0.97); }
    .hero-card.gf { border-color: #ffd700; }
    .hero-card.gf .hero-label { color: #ffd700; }
    .hero-card.empty { background: var(--bg-card); }
    .hero-card.empty .hero-label { color: var(--text-muted); }

    /* Live Game Banner */
    .live-banner {
      background: linear-gradient(135deg, #0d3320 0%, #0a2818 100%);
      border: 2px solid var(--accent-green);
      border-radius: var(--radius-xl);
      padding: var(--space-lg);
      margin-bottom: var(--space-md);
      cursor: pointer;
      transition: all 0.2s;
    }
    .live-banner:active { transform: scale(0.98); }
    .live-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-sm);
    }
    .live-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 1px;
      color: var(--accent-green);
    }
    .live-pulse {
      width: 8px;
      height: 8px;
      background: var(--accent-green);
      border-radius: 50%;
      animation: pulse 1s infinite;
    }
    .live-join {
      padding: var(--space-sm) var(--space-md);
      background: var(--accent-green);
      color: #000;
      font-size: 12px;
      font-weight: 700;
      border: none;
      border-radius: var(--radius-md);
    }
    .live-match { font-size: 18px; font-weight: 700; }
    .live-score { font-size: 32px; font-weight: 900; color: var(--accent-gold); }

    /* Paused Banner */
    .paused-banner {
      background: linear-gradient(135deg, #1a2540 0%, #152035 100%);
      border: 2px solid var(--accent-blue);
      border-radius: var(--radius-xl);
      padding: var(--space-lg);
      margin-bottom: var(--space-md);
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
    }
    .paused-banner:active { transform: scale(0.98); }
    .paused-label { font-size: 11px; font-weight: 700; letter-spacing: 1px; color: var(--accent-blue); }
    .paused-match { font-size: 16px; font-weight: 700; margin-top: 4px; }
    .paused-score { font-size: 13px; color: var(--text-secondary); }
    .paused-btn {
      padding: var(--space-sm) var(--space-md);
      background: var(--accent-blue);
      color: #fff;
      font-size: 13px;
      font-weight: 700;
      border: none;
      border-radius: var(--radius-md);
    }

    /* ========================================
       ACTION BUTTONS
       ======================================== */
    .actions-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-md);
      margin-bottom: var(--space-lg);
    }
    .action-card {
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-xl);
      padding: var(--space-lg);
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    .action-card:active { transform: scale(0.97); background: var(--bg-elevated); }
    .action-card.primary {
      background: linear-gradient(135deg, var(--accent-gold) 0%, #e8941a 100%);
      border: none;
    }
    .action-icon { font-size: 36px; margin-bottom: var(--space-sm); }
    .action-label { font-size: 15px; font-weight: 700; }
    .action-card.primary .action-label { color: #000; }

    /* ========================================
       STATS ROW
       ======================================== */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--space-sm);
      margin-bottom: var(--space-lg);
    }
    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
      padding: var(--space-md);
      text-align: center;
    }
    .stat-icon { font-size: 20px; margin-bottom: var(--space-xs); }
    .stat-value { font-size: 28px; font-weight: 900; color: var(--accent-gold); }
    .stat-label { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-top: 2px; }

    /* ========================================
       TABS
       ======================================== */
    .tabs {
      display: flex;
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
      padding: 4px;
      margin-bottom: var(--space-md);
    }
    .tab {
      flex: 1;
      padding: var(--space-sm) var(--space-md);
      text-align: center;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-muted);
      background: transparent;
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s;
    }
    .tab.active {
      background: var(--accent-gold);
      color: #000;
    }

    /* ========================================
       DATA TABLE
       ======================================== */
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    .data-table th {
      padding: var(--space-sm);
      text-align: center;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      background: rgba(255,255,255,0.03);
    }
    .data-table th:first-child { text-align: left; padding-left: var(--space-md); border-radius: var(--radius-md) 0 0 var(--radius-md); }
    .data-table th:last-child { border-radius: 0 var(--radius-md) var(--radius-md) 0; }
    .data-table td {
      padding: var(--space-md) var(--space-sm);
      text-align: center;
      border-bottom: 1px solid var(--border-subtle);
    }
    .data-table td:first-child { text-align: left; padding-left: var(--space-md); font-weight: 600; }
    .data-table tr.leader td { background: rgba(245,166,35,0.08); }
    .data-table .positive { color: var(--accent-green); }
    .data-table .negative { color: var(--accent-red); }

    /* ========================================
       DRAW LIST
       ======================================== */
    .draw-item {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      padding: var(--space-md);
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
      margin-bottom: var(--space-sm);
      cursor: pointer;
      transition: all 0.2s;
    }
    .draw-item:active { background: var(--bg-elevated); }
    .draw-item.done { opacity: 0.5; }
    .draw-item.gf { border-color: #ffd700; background: rgba(255,215,0,0.05); }
    .draw-num {
      width: 36px;
      height: 36px;
      background: var(--bg-elevated);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: 800;
    }
    .draw-item.done .draw-num { background: var(--accent-green); color: #000; }
    .draw-players { flex: 1; font-weight: 600; font-size: 14px; }
    .draw-players .winner { color: var(--accent-green); }
    .draw-score { font-size: 15px; font-weight: 800; color: var(--accent-gold); min-width: 50px; text-align: center; }

    /* ========================================
       BUTTONS
       ======================================== */
    .btn {
      width: 100%;
      padding: var(--space-md);
      border-radius: var(--radius-lg);
      border: none;
      font-family: inherit;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: var(--space-sm);
    }
    .btn:active { transform: scale(0.98); }
    .btn-primary { background: var(--accent-gold); color: #000; }
    .btn-secondary { background: var(--bg-elevated); color: var(--text-primary); border: 1px solid var(--border-medium); }
    .btn-danger { background: rgba(255,71,87,0.15); color: var(--accent-red); border: 1px solid rgba(255,71,87,0.3); }
    .btn-success { background: var(--accent-green); color: #000; }

    /* ========================================
       NAVIGATION
       ======================================== */
    .nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(10,10,18,0.95);
      backdrop-filter: blur(20px);
      border-top: 1px solid var(--border-subtle);
      display: flex;
      padding: var(--space-sm) var(--space-lg);
      padding-bottom: max(var(--space-sm), var(--safe-bottom));
      z-index: 100;
    }
    @media (min-width: 768px) {
      .nav {
        left: 50%;
        transform: translateX(-50%);
        max-width: 480px;
        border-left: 1px solid var(--border-subtle);
        border-right: 1px solid var(--border-subtle);
      }
    }
    .nav-btn {
      flex: 1;
      padding: var(--space-sm) 0;
      text-align: center;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      background: none;
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s;
    }
    .nav-btn.active { color: var(--accent-gold); background: rgba(245,166,35,0.1); }
    .nav-icon { font-size: 24px; display: block; margin-bottom: 2px; }

    /* ========================================
       DART SELECTION SCREEN
       ======================================== */
    .dart-header {
      padding: max(var(--space-lg), var(--safe-top)) var(--space-lg) var(--space-lg);
      background: var(--bg-secondary);
      text-align: center;
      border-bottom: 1px solid var(--border-subtle);
      position: relative;
    }
    .dart-back {
      position: absolute;
      left: var(--space-md);
      top: max(var(--space-lg), var(--safe-top));
      width: 44px;
      height: 44px;
      background: var(--bg-card);
      border: 1px solid var(--border-medium);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      cursor: pointer;
    }
    .dart-step { font-size: 12px; font-weight: 700; letter-spacing: 2px; color: var(--accent-gold); margin-bottom: var(--space-xs); }
    .dart-player { font-size: 28px; font-weight: 800; }
    .dart-subtitle { font-size: 14px; color: var(--text-secondary); margin-top: var(--space-xs); }

    .dart-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-md);
      padding: var(--space-lg);
      overflow-y: auto;
      max-height: calc(100vh - 280px);
    }
    
    /* Landscape: 4 columns */
    @media (orientation: landscape) and (max-height: 500px) {
      .dart-grid {
        grid-template-columns: repeat(4, 1fr);
        gap: var(--space-sm);
        padding: var(--space-md);
        max-height: calc(100vh - 180px);
      }
    }

    .dart-card {
      background: var(--bg-card);
      border: 3px solid var(--border-subtle);
      border-radius: var(--radius-xl);
      padding: var(--space-md);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: var(--space-sm);
      cursor: pointer;
      transition: all 0.2s;
    }
    .dart-card:active { transform: scale(0.97); }
    .dart-card.selected { border-color: var(--accent-gold); box-shadow: 0 0 30px rgba(245,166,35,0.3); }
    .dart-card.disabled { opacity: 0.25; pointer-events: none; }
    
    .dart-visual {
      width: 60px;
      height: 100px;
      position: relative;
    }
    .dart-name { font-size: 12px; font-weight: 700; text-align: center; }

    .dart-footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding: var(--space-lg);
      padding-bottom: max(var(--space-lg), var(--safe-bottom));
      background: linear-gradient(transparent, var(--bg-primary) 30%);
    }
    @media (min-width: 768px) {
      .dart-footer {
        left: 50%;
        transform: translateX(-50%);
        max-width: 480px;
      }
    }

    /* ========================================
       GAMEPLAY SCREEN
       ======================================== */
    #screen-game {
      background: #000;
    }

    .game-header {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      padding: max(var(--space-sm), var(--safe-top)) var(--space-md) var(--space-sm);
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 50;
      background: linear-gradient(180deg, rgba(0,0,0,0.9) 0%, transparent 100%);
    }

    .game-menu-btn {
      width: 48px;
      height: 48px;
      background: rgba(255,255,255,0.1);
      border: none;
      border-radius: var(--radius-md);
      color: #fff;
      font-size: 22px;
      cursor: pointer;
    }

    .game-badges {
      display: flex;
      gap: var(--space-sm);
      align-items: center;
    }
    .game-badge {
      padding: var(--space-sm) var(--space-md);
      background: rgba(0,0,0,0.7);
      border-radius: var(--radius-full);
      font-size: 13px;
      font-weight: 700;
    }
    .game-badge.target { color: var(--accent-gold); }
    .game-badge.gf { background: linear-gradient(135deg, #ffd700, #f59e0b); color: #000; }
    .game-badge.live { background: var(--accent-green); color: #000; display: flex; align-items: center; gap: 6px; }

    /* GAME ARENA - Portrait */
    .game-arena {
      flex: 1;
      display: flex;
      flex-direction: row;
      position: relative;
    }

    /* GAME ARENA - Landscape */
    @media (orientation: landscape) {
      .game-arena {
        flex-direction: row;
      }
    }

    .player-zone {
      flex: 1;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: var(--space-lg) var(--space-md);
      overflow: hidden;
    }

    /* PROGRESS BAR - Horizontal fill */
    .progress-fill {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 0%;
      transition: width 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      z-index: 1;
    }
    .player-zone.left .progress-fill { left: 0; }
    .player-zone.right .progress-fill { right: 0; }

    .player-ui {
      position: relative;
      z-index: 10;
      text-align: center;
      width: 100%;
    }

    .player-header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-sm);
      margin-bottom: var(--space-md);
    }
    .player-dart-icon {
      width: 24px;
      height: 40px;
    }
    .player-name {
      font-size: 16px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .score-controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-sm);
      margin-bottom: var(--space-md);
    }
    .score-adjust {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      border: 3px solid rgba(255,255,255,0.2);
      background: rgba(0,0,0,0.5);
      color: #fff;
      font-size: 28px;
      font-weight: 300;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }
    .score-adjust:active { transform: scale(0.9); background: rgba(255,255,255,0.2); }
    .score-adjust.minus { color: var(--accent-red); border-color: rgba(255,71,87,0.4); }
    .score-adjust.plus { color: var(--accent-green); border-color: rgba(0,214,143,0.4); }

    .score-display {
      font-size: 72px;
      font-weight: 900;
      line-height: 1;
      min-width: 100px;
    }
    @media (max-width: 380px) {
      .score-display { font-size: 56px; }
    }

    .quick-scores {
      display: flex;
      gap: var(--space-xs);
      justify-content: center;
      flex-wrap: wrap;
    }
    .quick-btn {
      width: 48px;
      height: 42px;
      border-radius: var(--radius-md);
      border: 2px solid rgba(255,255,255,0.15);
      background: rgba(0,0,0,0.5);
      color: #fff;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
    }
    .quick-btn:active { transform: scale(0.92); background: rgba(255,255,255,0.15); }

    .game-divider {
      width: 4px;
      background: rgba(255,255,255,0.1);
      position: relative;
      z-index: 20;
    }
    .reset-btn {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 48px;
      height: 48px;
      background: var(--bg-card);
      border: 2px solid var(--border-medium);
      border-radius: 50%;
      color: var(--text-muted);
      font-size: 20px;
      cursor: pointer;
      z-index: 21;
    }

    /* ========================================
       GAME MENU OVERLAY
       ======================================== */
    .game-menu-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.95);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 400;
      padding: var(--space-xl);
      gap: var(--space-md);
    }
    .game-menu-overlay.active { display: flex; }
    .game-menu-overlay h2 { font-size: 24px; margin-bottom: var(--space-lg); }
    .menu-btn {
      width: 280px;
      padding: var(--space-lg);
      border-radius: var(--radius-xl);
      border: none;
      font-size: 17px;
      font-weight: 700;
      cursor: pointer;
      font-family: inherit;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-sm);
    }
    .menu-btn.resume { background: var(--accent-green); color: #000; }
    .menu-btn.cancel { background: var(--accent-red); color: #fff; }
    .menu-btn.save { background: var(--bg-elevated); color: #fff; border: 1px solid var(--border-medium); }

    /* ========================================
       WIN OVERLAY
       ======================================== */
    .win-overlay {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, #0a0a12 0%, #1a1a30 50%, #0d1525 100%);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 500;
      padding: var(--space-xl);
    }
    .win-overlay.active { display: flex; }
    .win-trophy { font-size: 100px; animation: bounce 0.6s infinite alternate; }
    @keyframes bounce { to { transform: translateY(-15px) scale(1.1); } }
    .win-label { font-size: 14px; letter-spacing: 3px; color: var(--accent-gold); margin-top: var(--space-md); }
    .win-name { font-size: 44px; font-weight: 900; margin-top: var(--space-sm); }
    .win-score { font-size: 24px; color: var(--text-secondary); margin-top: var(--space-xs); }
    .win-buttons { display: flex; gap: var(--space-md); margin-top: var(--space-xl); flex-wrap: wrap; justify-content: center; }
    .win-btn {
      padding: var(--space-md) var(--space-xl);
      border-radius: var(--radius-lg);
      border: none;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      font-family: inherit;
    }
    .win-btn.save { background: var(--accent-green); color: #000; }
    .win-btn.again { background: var(--accent-gold); color: #000; }
    .win-btn.exit { background: var(--bg-elevated); color: #fff; }

    .confetti {
      position: fixed;
      width: 10px;
      height: 10px;
      top: -20px;
      animation: fall 3s linear forwards;
      z-index: 501;
      border-radius: 2px;
    }
    @keyframes fall { to { transform: translateY(100vh) rotate(720deg); } }

    /* ========================================
       INPUTS
       ======================================== */
    input, select {
      width: 100%;
      padding: var(--space-md);
      background: var(--bg-elevated);
      border: 1px solid var(--border-medium);
      color: var(--text-primary);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-sm);
      font-family: inherit;
      font-size: 16px;
      -webkit-appearance: none;
    }
    input:focus, select:focus {
      outline: none;
      border-color: var(--accent-gold);
    }

    /* ========================================
       PLAYER LIST
       ======================================== */
    .player-item {
      display: flex;
      align-items: center;
      padding: var(--space-md) 0;
      border-bottom: 1px solid var(--border-subtle);
    }
    .player-avatar {
      width: 44px;
      height: 44px;
      background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 18px;
      margin-right: var(--space-md);
    }
    .player-info { flex: 1; }
    .player-info .name { font-weight: 700; font-size: 15px; }
    .player-info .meta { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
    .player-delete {
      width: 36px;
      height: 36px;
      background: rgba(255,71,87,0.15);
      border: none;
      border-radius: 50%;
      color: var(--accent-red);
      font-size: 18px;
      cursor: pointer;
    }

    /* ========================================
       EMPTY STATE
       ======================================== */
    .empty-state {
      text-align: center;
      padding: var(--space-2xl) var(--space-lg);
      color: var(--text-muted);
    }
    .empty-icon { font-size: 48px; margin-bottom: var(--space-md); opacity: 0.5; }
    .empty-text { font-size: 14px; }

    /* ========================================
       TOAST
       ======================================== */
    .toast {
      position: fixed;
      bottom: 120px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-elevated);
      border: 1px solid var(--border-medium);
      padding: var(--space-md) var(--space-xl);
      border-radius: var(--radius-lg);
      font-size: 14px;
      font-weight: 600;
      z-index: 600;
      opacity: 0;
      transition: opacity 0.3s;
      max-width: 90%;
    }
    .toast.show { opacity: 1; }
    .toast.success { border-left: 4px solid var(--accent-green); }
    .toast.error { border-left: 4px solid var(--accent-red); }

    /* ========================================
       SCROLLBAR (Desktop)
       ======================================== */
    @media (min-width: 768px) {
      ::-webkit-scrollbar { width: 8px; }
      ::-webkit-scrollbar-track { background: var(--bg-primary); }
      ::-webkit-scrollbar-thumb { background: var(--bg-elevated); border-radius: 4px; }
    }
  </style>
</head>
<body>

<!-- ===== HOME SCREEN ===== -->
<div id="screen-home" class="screen active">
  <div class="header">
    <div class="logo">
      <div class="logo-mark">üéØ</div>
      <span class="logo-text">PopDarts</span>
    </div>
    <button class="sync-btn" onclick="doSync()">
      <span class="sync-dot" id="sync-dot"></span>
      <span id="sync-text">Sync</span>
    </button>
  </div>
  
  <div class="content">
    <div id="live-area"></div>
    <div id="paused-area"></div>
    <div id="hero-area"></div>

    <div class="actions-grid">
      <div class="action-card primary" onclick="playNext()">
        <div class="action-icon">‚ñ∂Ô∏è</div>
        <div class="action-label">Play Next</div>
      </div>
      <div class="action-card" onclick="openCustomMatch()">
        <div class="action-icon">üéÆ</div>
        <div class="action-label">Quick Match</div>
      </div>
    </div>

    <div class="stats-row">
      <div class="stat-card">
        <div class="stat-icon">üë•</div>
        <div class="stat-value" id="stat-players">0</div>
        <div class="stat-label">Players</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üéØ</div>
        <div class="stat-value" id="stat-games">0/0</div>
        <div class="stat-label">Games</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üèÜ</div>
        <div class="stat-value" id="stat-target">21</div>
        <div class="stat-label">Target</div>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" onclick="switchTab('draw',this)">üìã Draw</button>
      <button class="tab" onclick="switchTab('standings',this)">üìä Standings</button>
      <button class="tab" onclick="switchTab('alltime',this)">üèÜ All-Time</button>
    </div>

    <div id="tab-draw" class="tab-content"></div>
    <div id="tab-standings" class="tab-content" style="display:none"></div>
    <div id="tab-alltime" class="tab-content" style="display:none"></div>
  </div>
</div>

<!-- ===== CUSTOM MATCH SCREEN ===== -->
<div id="screen-custom" class="screen">
  <div class="header">
    <button class="sync-btn" onclick="showScreen('home')">‚Üê Back</button>
    <span class="logo-text" style="font-size:20px">Quick Match</span>
    <div style="width:70px"></div>
  </div>
  <div class="content">
    <div class="card">
      <div class="card-header">Player 1</div>
      <select id="custom-p1"></select>
    </div>
    <div class="card">
      <div class="card-header">Player 2</div>
      <select id="custom-p2"></select>
    </div>
    <button class="btn btn-primary" onclick="startCustomMatch()">üéÆ Start Match</button>
    <p style="font-size:12px;color:var(--text-muted);text-align:center;margin-top:var(--space-md);">Quick matches don't affect championship stats</p>
  </div>
</div>

<!-- ===== DART SELECTION SCREEN ===== -->
<div id="screen-dart" class="screen">
  <div class="dart-header">
    <button class="dart-back" onclick="cancelDartSelect()">‚Üê</button>
    <div class="dart-step" id="dart-step">STEP 1 OF 2</div>
    <h2 class="dart-player" id="dart-player">Player 1</h2>
    <p class="dart-subtitle">Choose your dart</p>
  </div>
  <div class="dart-grid" id="dart-grid"></div>
  <div class="dart-footer">
    <button class="btn btn-success" id="dart-confirm" onclick="confirmDart()" disabled>Select Dart</button>
  </div>
</div>

<!-- ===== GAMEPLAY SCREEN ===== -->
<div id="screen-game" class="screen">
  <div class="game-header">
    <button class="game-menu-btn" onclick="openGameMenu()">‚ò∞</button>
    <div class="game-badges">
      <div class="game-badge" id="game-label">Game 1</div>
      <div class="game-badge live" id="game-live" style="display:none">
        <span class="live-pulse"></span>LIVE
      </div>
      <div class="game-badge target">To: <span id="game-target">21</span></div>
    </div>
  </div>

  <div class="game-arena">
    <div class="player-zone left" id="zone-1">
      <div class="progress-fill" id="progress-1"></div>
      <div class="player-ui">
        <div class="player-header">
          <svg class="player-dart-icon" id="dart-icon-1" viewBox="0 0 24 40"></svg>
          <span class="player-name" id="player-name-1">Player 1</span>
        </div>
        <div class="score-controls">
          <button class="score-adjust minus" onclick="adjustScore(1,-1)">‚àí</button>
          <div class="score-display" id="score-1">0</div>
          <button class="score-adjust plus" onclick="adjustScore(1,1)">+</button>
        </div>
        <div class="quick-scores">
          <button class="quick-btn" onclick="adjustScore(1,2)">+2</button>
          <button class="quick-btn" onclick="adjustScore(1,3)">+3</button>
          <button class="quick-btn" onclick="adjustScore(1,4)">+4</button>
          <button class="quick-btn" onclick="adjustScore(1,5)">+5</button>
        </div>
      </div>
    </div>

    <div class="game-divider">
      <button class="reset-btn" onclick="resetScores()">‚Ü∫</button>
    </div>

    <div class="player-zone right" id="zone-2">
      <div class="progress-fill" id="progress-2"></div>
      <div class="player-ui">
        <div class="player-header">
          <span class="player-name" id="player-name-2">Player 2</span>
          <svg class="player-dart-icon" id="dart-icon-2" viewBox="0 0 24 40"></svg>
        </div>
        <div class="score-controls">
          <button class="score-adjust minus" onclick="adjustScore(2,-1)">‚àí</button>
          <div class="score-display" id="score-2">0</div>
          <button class="score-adjust plus" onclick="adjustScore(2,1)">+</button>
        </div>
        <div class="quick-scores">
          <button class="quick-btn" onclick="adjustScore(2,2)">+2</button>
          <button class="quick-btn" onclick="adjustScore(2,3)">+3</button>
          <button class="quick-btn" onclick="adjustScore(2,4)">+4</button>
          <button class="quick-btn" onclick="adjustScore(2,5)">+5</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== GAME MENU OVERLAY ===== -->
<div class="game-menu-overlay" id="game-menu">
  <h2>‚è∏Ô∏è Game Paused</h2>
  <button class="menu-btn resume" onclick="closeGameMenu()">‚ñ∂Ô∏è Resume</button>
  <button class="menu-btn cancel" onclick="cancelGame()">‚ùå End Game</button>
  <button class="menu-btn save" onclick="pauseAndExit()">üíæ Save & Exit</button>
</div>

<!-- ===== SETTINGS SCREEN ===== -->
<div id="screen-settings" class="screen">
  <div class="header">
    <div class="logo">
      <div class="logo-mark">‚öôÔ∏è</div>
      <span class="logo-text">Settings</span>
    </div>
  </div>
  <div class="content">
    <div class="card">
      <div class="card-header">‚òÅÔ∏è Live Sync</div>
      <p style="font-size:13px;color:var(--text-secondary);margin-bottom:var(--space-md);">All devices share players, draw, and live game state</p>
      <button class="btn btn-secondary" onclick="doSync()">üîÑ Sync Now</button>
    </div>

    <div class="card">
      <div class="card-header">üë• Players</div>
      <div style="display:flex;gap:var(--space-sm);margin-bottom:var(--space-md);">
        <input type="text" id="new-player" placeholder="Player name..." style="margin:0;flex:1">
        <button class="btn btn-success" style="width:auto;margin:0;padding:var(--space-md) var(--space-lg);" onclick="addPlayer()">+</button>
      </div>
      <div id="player-list"></div>
    </div>

    <div class="card">
      <div class="card-header">üèÜ Championship</div>
      <button class="btn btn-primary" onclick="generateDraw()">üé≤ Generate New Draw</button>
      <button class="btn btn-danger" onclick="clearDraw()">Clear Draw</button>
    </div>

    <div class="card">
      <div class="card-header">üéØ Target Score</div>
      <select id="target-select" onchange="changeTarget()">
        <option value="11">First to 11</option>
        <option value="15">First to 15</option>
        <option value="21" selected>First to 21</option>
        <option value="31">First to 31</option>
      </select>
    </div>
  </div>
</div>

<!-- ===== WIN OVERLAY ===== -->
<div class="win-overlay" id="win-overlay">
  <div class="win-trophy">üèÜ</div>
  <div class="win-label">üéâ WINNER üéâ</div>
  <div class="win-name" id="win-name">Player</div>
  <div class="win-score" id="win-score">21 - 15</div>
  <div class="win-buttons">
    <button class="win-btn save" id="win-save" onclick="saveResult()">üíæ Save</button>
    <button class="win-btn again" onclick="playAgain()">üîÑ Again</button>
    <button class="win-btn exit" onclick="exitGame()">‚úï Exit</button>
  </div>
</div>

<!-- ===== NAVIGATION ===== -->
<nav class="nav" id="main-nav">
  <button class="nav-btn active" data-screen="home">
    <span class="nav-icon">üè†</span>Home
  </button>
  <button class="nav-btn" data-screen="settings">
    <span class="nav-icon">‚öôÔ∏è</span>Settings
  </button>
</nav>

<!-- ===== TOAST ===== -->
<div class="toast" id="toast"></div>

<script>
// =============================================================================
// POPDARTS v5.5 FINAL - Complete Rebuild
// =============================================================================

const API = 'https://script.google.com/macros/s/AKfycbzIsi9Gv3oHzM4xaDL1lLSeme_qG6QDFblu8RmH9roylVYhWOw76v3EFgpsLyWmcF95_Q/exec';

// DART DEFINITIONS - Colors extracted from your actual darts
const DARTS = [
  {
    id: 'black-green',
    name: 'Black & Green',
    colors: ['#1a1a1a', '#22c55e'],
    gradient: 'linear-gradient(135deg, #1a1a1a 0%, #1a1a1a 40%, #22c55e 60%, #1a1a1a 80%, #22c55e 100%)',
    solid: '#22c55e'
  },
  {
    id: 'tropical',
    name: 'Tropical Sunset',
    colors: ['#f97316', '#0891b2', '#ec4899'],
    gradient: 'linear-gradient(135deg, #f97316 0%, #0891b2 35%, #ec4899 65%, #f97316 100%)',
    solid: '#f97316'
  },
  {
    id: 'black-blue',
    name: 'Black & Blue',
    colors: ['#1a1a1a', '#3b82f6'],
    gradient: 'linear-gradient(135deg, #1a1a1a 0%, #1a1a1a 40%, #3b82f6 55%, #1a1a1a 75%, #3b82f6 100%)',
    solid: '#3b82f6'
  },
  {
    id: 'white-purple',
    name: 'White & Purple',
    colors: ['#e5e5e5', '#a855f7'],
    gradient: 'linear-gradient(135deg, #e5e5e5 0%, #a855f7 30%, #e5e5e5 50%, #a855f7 70%, #e5e5e5 100%)',
    solid: '#a855f7'
  },
  {
    id: 'cyan',
    name: 'Solid Cyan',
    colors: ['#06b6d4'],
    gradient: '#06b6d4',
    solid: '#06b6d4'
  },
  {
    id: 'white-teal',
    name: 'White & Teal',
    colors: ['#e5e5e5', '#14b8a6'],
    gradient: 'linear-gradient(135deg, #e5e5e5 0%, #14b8a6 30%, #e5e5e5 55%, #14b8a6 80%, #e5e5e5 100%)',
    solid: '#14b8a6'
  },
  {
    id: 'lime',
    name: 'Neon Lime',
    colors: ['#84cc16'],
    gradient: '#84cc16',
    solid: '#84cc16'
  }
];

// Storage keys
const STORAGE_KEY = 'popdarts_v55_final';
const STATS_KEY = 'popdarts_stats_v55_final';

// App state
let DATA = loadData();
let STATS = loadStats();
let GAME = {};
let syncInterval = null;

function loadData() {
  try {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) return JSON.parse(saved);
  } catch(e) {}
  return { players: [], draw: [], target: 21, paused: null, gfCreated: false, liveGame: null };
}

function loadStats() {
  try {
    const saved = localStorage.getItem(STATS_KEY);
    if (saved) return JSON.parse(saved);
  } catch(e) {}
  return [];
}

function save() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(DATA));
}

function saveStats() {
  localStorage.setItem(STATS_KEY, JSON.stringify(STATS));
}

// =============================================================================
// SVG DART RENDERING
// =============================================================================

function createDartSVG(dart, size = 'normal') {
  const w = size === 'small' ? 24 : 50;
  const h = size === 'small' ? 40 : 85;
  const gradientId = `grad-${dart.id}-${Math.random().toString(36).substr(2,9)}`;
  
  let gradientDef = '';
  if (dart.colors.length > 1) {
    const stops = dart.colors.map((c, i) => 
      `<stop offset="${(i / (dart.colors.length - 1)) * 100}%" stop-color="${c}"/>`
    ).join('');
    gradientDef = `<defs><linearGradient id="${gradientId}" x1="0%" y1="0%" x2="100%" y2="100%">${stops}</linearGradient></defs>`;
  }
  
  const fill = dart.colors.length > 1 ? `url(#${gradientId})` : dart.colors[0];
  
  return `
    <svg viewBox="0 0 ${w} ${h}" width="${w}" height="${h}">
      ${gradientDef}
      <!-- Top suction cup -->
      <ellipse cx="${w/2}" cy="${h*0.08}" rx="${w*0.35}" ry="${h*0.06}" fill="${fill}" opacity="0.9"/>
      <!-- Neck -->
      <path d="M${w*0.35} ${h*0.12} Q${w*0.3} ${h*0.2} ${w*0.35} ${h*0.28} L${w*0.65} ${h*0.28} Q${w*0.7} ${h*0.2} ${w*0.65} ${h*0.12} Z" fill="${fill}"/>
      <!-- Body bulge -->
      <ellipse cx="${w/2}" cy="${h*0.42}" rx="${w*0.38}" ry="${h*0.14}" fill="${fill}"/>
      <!-- Lower neck -->
      <path d="M${w*0.35} ${h*0.55} Q${w*0.3} ${h*0.65} ${w*0.35} ${h*0.75} L${w*0.65} ${h*0.75} Q${w*0.7} ${h*0.65} ${w*0.65} ${h*0.55} Z" fill="${fill}"/>
      <!-- Bottom suction cup -->
      <ellipse cx="${w/2}" cy="${h*0.92}" rx="${w*0.4}" ry="${h*0.07}" fill="${fill}" opacity="0.9"/>
      <!-- Highlight -->
      <ellipse cx="${w*0.38}" cy="${h*0.38}" rx="${w*0.08}" ry="${h*0.06}" fill="rgba(255,255,255,0.3)"/>
    </svg>
  `;
}

// =============================================================================
// SYNC
// =============================================================================

async function doSync() {
  const dot = document.getElementById('sync-dot');
  const txt = document.getElementById('sync-text');
  dot.classList.add('busy');
  txt.textContent = '...';
  
  try {
    // Get players
    const pRes = await fetch(API + '?action=players');
    const pData = await pRes.json();
    if (pData.success && pData.data?.players) {
      pData.data.players.forEach(p => {
        if (p && !DATA.players.includes(p)) DATA.players.push(p);
      });
    }
    
    // Get stats
    const sRes = await fetch(API + '?action=stats');
    const sData = await sRes.json();
    if (sData.success && sData.data?.stats) {
      sData.data.stats.forEach(r => {
        const existing = STATS.find(s => s.name === r.name);
        if (!existing) {
          STATS.push({
            name: r.name,
            gp: r.gamesPlayed || 0,
            w: r.wins || 0,
            l: r.losses || 0,
            pf: r.pointsFor || 0,
            pa: r.pointsAgainst || 0,
            diff: r.pointsDiff || 0,
            champs: r.championships || 0
          });
        }
      });
      saveStats();
    }
    
    // Get live game
    const lgRes = await fetch(API + '?action=liveGame');
    const lgData = await lgRes.json();
    if (lgData.success && lgData.data?.active) {
      DATA.liveGame = lgData.data;
    } else {
      DATA.liveGame = null;
    }
    
    save();
    dot.classList.remove('busy');
    dot.classList.add('ok');
    txt.textContent = 'OK';
    toast('Synced!', 'success');
    renderHome();
  } catch(e) {
    console.error('Sync error:', e);
    dot.classList.remove('busy', 'ok');
    txt.textContent = 'Err';
    toast('Sync failed', 'error');
  }
}

async function pushLiveGame() {
  if (!GAME.p1 || !GAME.isChamp) return;
  try {
    await fetch(API, {
      method: 'POST',
      body: JSON.stringify({
        action: 'updateLiveGame',
        active: true,
        gameId: GAME.idx >= 0 ? DATA.draw[GAME.idx]?.num : 'custom',
        player1: GAME.p1,
        player2: GAME.p2,
        score1: GAME.s1,
        score2: GAME.s2,
        color1: GAME.d1?.id || '',
        color2: GAME.d2?.id || '',
        target: DATA.target,
        isChamp: GAME.isChamp,
        isGF: GAME.isGF
      })
    });
  } catch(e) {}
}

async function clearLiveGame() {
  try {
    await fetch(API, { method: 'POST', body: JSON.stringify({ action: 'clearLiveGame' }) });
  } catch(e) {}
  DATA.liveGame = null;
}

async function fetchLiveGame() {
  try {
    const res = await fetch(API + '?action=liveGame');
    const data = await res.json();
    if (data.success && data.data?.active) {
      if (data.data.score1 !== GAME.s1 || data.data.score2 !== GAME.s2) {
        GAME.s1 = data.data.score1;
        GAME.s2 = data.data.score2;
        updateGameUI();
      }
    }
  } catch(e) {}
}

function startGameSync() {
  stopGameSync();
  if (GAME.isChamp) {
    syncInterval = setInterval(fetchLiveGame, 5000);
  }
}

function stopGameSync() {
  if (syncInterval) {
    clearInterval(syncInterval);
    syncInterval = null;
  }
}

// =============================================================================
// NAVIGATION
// =============================================================================

document.querySelectorAll('.nav-btn').forEach(btn => {
  btn.onclick = () => showScreen(btn.dataset.screen);
});

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('screen-' + id).classList.add('active');
  
  document.querySelectorAll('.nav-btn').forEach(b => 
    b.classList.toggle('active', b.dataset.screen === id)
  );
  
  const nav = document.getElementById('main-nav');
  nav.style.display = ['game', 'dart', 'custom'].includes(id) ? 'none' : 'flex';
  
  if (id === 'home') renderHome();
  if (id === 'settings') {
    document.getElementById('target-select').value = DATA.target;
    renderPlayerList();
  }
}

function switchTab(tab, btn) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
  document.getElementById('tab-' + tab).style.display = 'block';
}

// =============================================================================
// HOME SCREEN
// =============================================================================

function renderHome() {
  const standings = calculateStandings();
  const completed = DATA.draw.filter(g => !g.isGF && g.winner).length;
  const total = DATA.draw.filter(g => !g.isGF).length;
  
  document.getElementById('stat-players').textContent = DATA.players.length;
  document.getElementById('stat-games').textContent = total > 0 ? `${completed}/${total}` : '0';
  document.getElementById('stat-target').textContent = DATA.target;
  
  renderLiveBanner();
  renderPausedBanner();
  renderHero();
  renderDraw();
  renderStandings(standings);
  renderAllTime();
}

function renderLiveBanner() {
  const el = document.getElementById('live-area');
  if (!DATA.liveGame || !DATA.liveGame.active) {
    el.innerHTML = '';
    return;
  }
  const lg = DATA.liveGame;
  el.innerHTML = `
    <div class="live-banner" onclick="joinLiveGame()">
      <div class="live-header">
        <div class="live-badge"><span class="live-pulse"></span>LIVE GAME</div>
        <button class="live-join">Join</button>
      </div>
      <div class="live-match">${lg.player1} vs ${lg.player2}</div>
      <div class="live-score">${lg.score1} - ${lg.score2}</div>
    </div>
  `;
}

function renderPausedBanner() {
  const el = document.getElementById('paused-area');
  if (!DATA.paused) {
    el.innerHTML = '';
    return;
  }
  const p = DATA.paused;
  el.innerHTML = `
    <div class="paused-banner" onclick="resumeGame()">
      <div>
        <div class="paused-label">‚è∏ PAUSED</div>
        <div class="paused-match">${p.p1} vs ${p.p2}</div>
        <div class="paused-score">${p.s1} - ${p.s2}</div>
      </div>
      <button class="paused-btn">Resume</button>
    </div>
  `;
}

function renderHero() {
  const el = document.getElementById('hero-area');
  const next = getNextGame();
  
  if (!next) {
    if (DATA.draw.length === 0) {
      el.innerHTML = `
        <div class="hero-card empty">
          <div class="hero-label">NO CHAMPIONSHIP</div>
          <div class="hero-matchup">Create a draw in Settings</div>
        </div>
      `;
    } else {
      el.innerHTML = `
        <div class="hero-card">
          <div class="hero-label">üéâ CHAMPIONSHIP COMPLETE</div>
          <div class="hero-matchup">All games finished!</div>
        </div>
      `;
    }
    return;
  }
  
  const g = next.game;
  el.innerHTML = `
    <div class="hero-card ${g.isGF ? 'gf' : ''}">
      <div class="hero-label">${g.isGF ? 'üèÜ GRAND FINAL üèÜ' : `GAME ${g.num}`}</div>
      <div class="hero-matchup">
        ${g.p1}
        <span class="hero-vs">vs</span>
        ${g.p2}
      </div>
      <button class="hero-cta" onclick="playNext()">‚ñ∂Ô∏è Play Now</button>
    </div>
  `;
}

function renderDraw() {
  const el = document.getElementById('tab-draw');
  if (DATA.draw.length === 0) {
    el.innerHTML = '<div class="empty-state"><div class="empty-icon">üìã</div><div class="empty-text">No games scheduled</div></div>';
    return;
  }
  
  el.innerHTML = DATA.draw.map((g, i) => {
    const done = !!g.winner;
    return `
      <div class="draw-item ${done ? 'done' : ''} ${g.isGF ? 'gf' : ''}" onclick="${done ? '' : `playDrawGame(${i})`}">
        <div class="draw-num">${g.isGF ? 'üèÜ' : g.num}</div>
        <div class="draw-players">
          <span class="${g.winner === g.p1 ? 'winner' : ''}">${g.p1}</span>
          <span style="color:var(--text-muted)"> vs </span>
          <span class="${g.winner === g.p2 ? 'winner' : ''}">${g.p2}</span>
        </div>
        <div class="draw-score">${done ? `${g.s1}-${g.s2}` : '‚Äî'}</div>
      </div>
    `;
  }).join('');
}

function renderStandings(standings) {
  const el = document.getElementById('tab-standings');
  if (standings.length === 0) {
    el.innerHTML = '<div class="empty-state"><div class="empty-icon">üìä</div><div class="empty-text">No standings yet</div></div>';
    return;
  }
  
  el.innerHTML = `
    <table class="data-table">
      <thead><tr><th>Player</th><th>W</th><th>L</th><th>PF</th><th>PA</th><th>+/-</th></tr></thead>
      <tbody>
        ${standings.map((p, i) => `
          <tr class="${i === 0 ? 'leader' : ''}">
            <td>${i === 0 ? 'üëë ' : ''}${p.name}</td>
            <td>${p.w}</td>
            <td>${p.l}</td>
            <td>${p.pf}</td>
            <td>${p.pa}</td>
            <td class="${p.diff > 0 ? 'positive' : p.diff < 0 ? 'negative' : ''}">${p.diff > 0 ? '+' : ''}${p.diff}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
}

function renderAllTime() {
  const el = document.getElementById('tab-alltime');
  if (STATS.length === 0) {
    el.innerHTML = '<div class="empty-state"><div class="empty-icon">üèÜ</div><div class="empty-text">No all-time stats yet</div></div>';
    return;
  }
  
  const sorted = [...STATS].sort((a, b) => (b.champs || 0) - (a.champs || 0) || b.w - a.w);
  
  el.innerHTML = `
    <table class="data-table">
      <thead><tr><th>Player</th><th>GP</th><th>W</th><th>L</th><th>%</th><th>üèÜ</th></tr></thead>
      <tbody>
        ${sorted.map((s, i) => `
          <tr class="${s.champs > 0 && i === 0 ? 'leader' : ''}">
            <td>${s.name}</td>
            <td>${s.gp}</td>
            <td>${s.w}</td>
            <td>${s.l}</td>
            <td>${s.gp ? Math.round(s.w / s.gp * 100) : 0}%</td>
            <td style="color:${s.champs ? '#ffd700' : 'var(--text-muted)'}; font-weight:900">${s.champs || 0}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
}

function calculateStandings() {
  const map = new Map();
  DATA.players.forEach(p => map.set(p, { name: p, w: 0, l: 0, pf: 0, pa: 0, diff: 0 }));
  
  DATA.draw.forEach(g => {
    if (g.isGF || !g.winner) return;
    const s1 = map.get(g.p1);
    const s2 = map.get(g.p2);
    if (s1) {
      if (g.winner === g.p1) s1.w++; else s1.l++;
      s1.pf += g.s1; s1.pa += g.s2; s1.diff += g.s1 - g.s2;
    }
    if (s2) {
      if (g.winner === g.p2) s2.w++; else s2.l++;
      s2.pf += g.s2; s2.pa += g.s1; s2.diff += g.s2 - g.s1;
    }
  });
  
  return [...map.values()].sort((a, b) => b.w - a.w || b.diff - a.diff);
}

function getNextGame() {
  for (let i = 0; i < DATA.draw.length; i++) {
    if (!DATA.draw[i].isGF && !DATA.draw[i].winner) {
      return { idx: i, game: DATA.draw[i] };
    }
  }
  for (let i = DATA.draw.length - 1; i >= 0; i--) {
    if (DATA.draw[i].isGF && !DATA.draw[i].winner) {
      return { idx: i, game: DATA.draw[i] };
    }
  }
  return null;
}

// =============================================================================
// CUSTOM MATCH
// =============================================================================

function openCustomMatch() {
  if (DATA.players.length < 2) {
    toast('Add at least 2 players first', 'error');
    return;
  }
  
  const opts = DATA.players.map(p => `<option value="${p}">${p}</option>`).join('');
  document.getElementById('custom-p1').innerHTML = opts;
  document.getElementById('custom-p2').innerHTML = opts;
  if (DATA.players.length > 1) {
    document.getElementById('custom-p2').selectedIndex = 1;
  }
  
  showScreen('custom');
}

function startCustomMatch() {
  const p1 = document.getElementById('custom-p1').value;
  const p2 = document.getElementById('custom-p2').value;
  
  if (p1 === p2) {
    toast('Select different players', 'error');
    return;
  }
  
  GAME = { p1, p2, s1: 0, s2: 0, d1: null, d2: null, idx: -1, isChamp: false, isGF: false };
  openDartSelect(1, p1);
}

// =============================================================================
// DART SELECTION
// =============================================================================

function openDartSelect(step, playerName) {
  GAME.dartStep = step;
  GAME.selectedDart = null;
  
  document.getElementById('dart-step').textContent = `STEP ${step} OF 2`;
  document.getElementById('dart-player').textContent = playerName;
  document.getElementById('dart-confirm').disabled = true;
  
  const grid = document.getElementById('dart-grid');
  grid.innerHTML = DARTS.map(dart => {
    const disabled = step === 2 && GAME.d1 && GAME.d1.id === dart.id;
    return `
      <div class="dart-card ${disabled ? 'disabled' : ''}" data-id="${dart.id}" onclick="selectDart('${dart.id}')">
        <div class="dart-visual">${createDartSVG(dart)}</div>
        <div class="dart-name">${dart.name}</div>
      </div>
    `;
  }).join('');
  
  showScreen('dart');
}

function selectDart(id) {
  const dart = DARTS.find(d => d.id === id);
  if (!dart) return;
  
  GAME.selectedDart = dart;
  document.querySelectorAll('.dart-card').forEach(c => 
    c.classList.toggle('selected', c.dataset.id === id)
  );
  document.getElementById('dart-confirm').disabled = false;
}

function confirmDart() {
  if (!GAME.selectedDart) return;
  
  if (GAME.dartStep === 1) {
    GAME.d1 = GAME.selectedDart;
    openDartSelect(2, GAME.p2);
  } else {
    GAME.d2 = GAME.selectedDart;
    startGameplay();
  }
}

function cancelDartSelect() {
  showScreen('home');
}

// =============================================================================
// GAMEPLAY
// =============================================================================

function playNext() {
  const next = getNextGame();
  if (!next) {
    toast(DATA.draw.length ? 'All games complete!' : 'Generate a draw first', 'error');
    return;
  }
  playDrawGame(next.idx);
}

function playDrawGame(idx) {
  const g = DATA.draw[idx];
  if (!g || g.winner) return;
  
  GAME = { p1: g.p1, p2: g.p2, s1: 0, s2: 0, d1: null, d2: null, idx, isChamp: true, isGF: g.isGF };
  openDartSelect(1, g.p1);
}

function joinLiveGame() {
  if (!DATA.liveGame || !DATA.liveGame.active) return;
  
  const lg = DATA.liveGame;
  GAME = {
    p1: lg.player1,
    p2: lg.player2,
    s1: lg.score1,
    s2: lg.score2,
    d1: DARTS.find(d => d.id === lg.color1) || DARTS[0],
    d2: DARTS.find(d => d.id === lg.color2) || DARTS[1],
    idx: -1,
    isChamp: lg.isChamp,
    isGF: lg.isGF
  };
  
  setupGameScreen();
  startGameSync();
  showScreen('game');
}

function startGameplay() {
  GAME.s1 = 0;
  GAME.s2 = 0;
  
  setupGameScreen();
  
  if (GAME.isChamp) {
    pushLiveGame();
    startGameSync();
    document.getElementById('game-live').style.display = 'flex';
  } else {
    document.getElementById('game-live').style.display = 'none';
  }
  
  showScreen('game');
}

function setupGameScreen() {
  document.getElementById('player-name-1').textContent = GAME.p1;
  document.getElementById('player-name-2').textContent = GAME.p2;
  document.getElementById('game-target').textContent = DATA.target;
  
  // Set dart icons
  document.getElementById('dart-icon-1').outerHTML = createDartSVG(GAME.d1, 'small');
  document.getElementById('dart-icon-2').outerHTML = createDartSVG(GAME.d2, 'small');
  
  // Game label
  const label = document.getElementById('game-label');
  if (GAME.isGF) {
    label.textContent = 'üèÜ GRAND FINAL';
    label.classList.add('gf');
  } else if (GAME.isChamp && GAME.idx >= 0) {
    label.textContent = `Game ${DATA.draw[GAME.idx].num}`;
    label.classList.remove('gf');
  } else {
    label.textContent = 'Quick Match';
    label.classList.remove('gf');
  }
  
  updateGameUI();
}

function adjustScore(player, amount) {
  if (player === 1) {
    GAME.s1 = Math.max(0, GAME.s1 + amount);
    if (GAME.s1 >= DATA.target) {
      GAME.s1 = DATA.target;
      updateGameUI();
      declareWinner(GAME.p1);
      return;
    }
  } else {
    GAME.s2 = Math.max(0, GAME.s2 + amount);
    if (GAME.s2 >= DATA.target) {
      GAME.s2 = DATA.target;
      updateGameUI();
      declareWinner(GAME.p2);
      return;
    }
  }
  
  updateGameUI();
  if (GAME.isChamp) pushLiveGame();
}

function updateGameUI() {
  document.getElementById('score-1').textContent = GAME.s1;
  document.getElementById('score-2').textContent = GAME.s2;
  
  const pct1 = Math.min(100, (GAME.s1 / DATA.target) * 100);
  const pct2 = Math.min(100, (GAME.s2 / DATA.target) * 100);
  
  const bar1 = document.getElementById('progress-1');
  const bar2 = document.getElementById('progress-2');
  
  bar1.style.width = pct1 + '%';
  bar1.style.background = GAME.d1.gradient;
  
  bar2.style.width = pct2 + '%';
  bar2.style.background = GAME.d2.gradient;
}

function resetScores() {
  if (!confirm('Reset scores to 0-0?')) return;
  GAME.s1 = 0;
  GAME.s2 = 0;
  updateGameUI();
  if (GAME.isChamp) pushLiveGame();
}

// =============================================================================
// GAME MENU
// =============================================================================

function openGameMenu() {
  document.getElementById('game-menu').classList.add('active');
}

function closeGameMenu() {
  document.getElementById('game-menu').classList.remove('active');
}

function cancelGame() {
  if (!confirm('End game without saving?')) return;
  closeGameMenu();
  stopGameSync();
  clearLiveGame();
  DATA.paused = null;
  save();
  showScreen('home');
  toast('Game ended', 'success');
}

function pauseAndExit() {
  closeGameMenu();
  stopGameSync();
  DATA.paused = {
    p1: GAME.p1, p2: GAME.p2, s1: GAME.s1, s2: GAME.s2,
    d1: GAME.d1, d2: GAME.d2, idx: GAME.idx, isChamp: GAME.isChamp, isGF: GAME.isGF
  };
  save();
  toast('Game saved', 'success');
  showScreen('home');
}

function resumeGame() {
  if (!DATA.paused) return;
  
  const p = DATA.paused;
  GAME = { p1: p.p1, p2: p.p2, s1: p.s1, s2: p.s2, d1: p.d1, d2: p.d2, idx: p.idx, isChamp: p.isChamp, isGF: p.isGF };
  DATA.paused = null;
  save();
  
  setupGameScreen();
  if (GAME.isChamp) {
    pushLiveGame();
    startGameSync();
    document.getElementById('game-live').style.display = 'flex';
  }
  showScreen('game');
}

// =============================================================================
// WIN
// =============================================================================

function declareWinner(name) {
  stopGameSync();
  document.getElementById('win-name').textContent = name;
  document.getElementById('win-score').textContent = `${GAME.s1} - ${GAME.s2}`;
  document.getElementById('win-save').style.display = GAME.isChamp ? 'inline-block' : 'none';
  document.getElementById('win-overlay').classList.add('active');
  launchConfetti();
}

function saveResult() {
  const winner = GAME.s1 >= DATA.target ? GAME.p1 : GAME.p2;
  
  if (GAME.isChamp && GAME.idx >= 0) {
    const g = DATA.draw[GAME.idx];
    g.winner = winner;
    g.s1 = GAME.s1;
    g.s2 = GAME.s2;
    
    updatePlayerStats(GAME.p1, GAME.p2, winner, GAME.s1, GAME.s2, GAME.isGF);
    
    // Push to server
    fetch(API, {
      method: 'POST',
      body: JSON.stringify({
        action: 'submitGame',
        gameId: g.num,
        player1: g.p1,
        player2: g.p2,
        score1: g.s1,
        score2: g.s2
      })
    }).catch(console.error);
    
    if (GAME.isGF) {
      const stat = STATS.find(s => s.name === winner);
      if (stat) stat.champs = (stat.champs || 0) + 1;
      saveStats();
      toast('üèÜ Champion crowned!', 'success');
    } else {
      checkGrandFinal();
      toast('Game saved!', 'success');
    }
  }
  
  clearLiveGame();
  DATA.paused = null;
  save();
  exitGame();
}

function updatePlayerStats(p1, p2, winner, s1, s2, isGF) {
  [p1, p2].forEach(name => {
    let stat = STATS.find(s => s.name === name);
    if (!stat) {
      stat = { name, gp: 0, w: 0, l: 0, pf: 0, pa: 0, diff: 0, champs: 0 };
      STATS.push(stat);
    }
    if (!isGF) stat.gp++;
  });
  
  const st1 = STATS.find(s => s.name === p1);
  const st2 = STATS.find(s => s.name === p2);
  
  if (st1) {
    if (winner === p1) st1.w++; else st1.l++;
    st1.pf += s1; st1.pa += s2; st1.diff += s1 - s2;
  }
  if (st2) {
    if (winner === p2) st2.w++; else st2.l++;
    st2.pf += s2; st2.pa += s1; st2.diff += s2 - s1;
  }
  
  saveStats();
}

function checkGrandFinal() {
  const regular = DATA.draw.filter(g => !g.isGF);
  const incomplete = regular.filter(g => !g.winner);
  
  if (incomplete.length === 0 && !DATA.gfCreated && regular.length > 0) {
    const standings = calculateStandings();
    if (standings.length >= 2) {
      DATA.gfCreated = true;
      DATA.draw.push({
        num: 'GF',
        p1: standings[0].name,
        p2: standings[1].name,
        s1: null,
        s2: null,
        winner: null,
        isGF: true
      });
      save();
      toast('üèÜ Grand Final ready!', 'success');
    }
  }
}

function playAgain() {
  document.getElementById('win-overlay').classList.remove('active');
  GAME.s1 = 0;
  GAME.s2 = 0;
  updateGameUI();
  if (GAME.isChamp) {
    pushLiveGame();
    startGameSync();
  }
}

function exitGame() {
  document.getElementById('win-overlay').classList.remove('active');
  showScreen('home');
}

function launchConfetti() {
  const colors = [GAME.d1?.solid || '#ffd700', GAME.d2?.solid || '#3b82f6', '#22c55e', '#ff4757'];
  for (let i = 0; i < 50; i++) {
    setTimeout(() => {
      const c = document.createElement('div');
      c.className = 'confetti';
      c.style.left = Math.random() * 100 + 'vw';
      c.style.background = colors[Math.floor(Math.random() * colors.length)];
      c.style.animationDuration = (2 + Math.random() * 2) + 's';
      document.body.appendChild(c);
      setTimeout(() => c.remove(), 4000);
    }, i * 30);
  }
}

// =============================================================================
// SETTINGS
// =============================================================================

function renderPlayerList() {
  const el = document.getElementById('player-list');
  if (DATA.players.length === 0) {
    el.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:var(--space-lg);">No players added yet</div>';
    return;
  }
  
  el.innerHTML = DATA.players.map((p, i) => {
    const stat = STATS.find(s => s.name === p) || { gp: 0, w: 0, champs: 0 };
    return `
      <div class="player-item">
        <div class="player-avatar">${p[0].toUpperCase()}</div>
        <div class="player-info">
          <div class="name">${stat.champs ? 'üèÜ ' : ''}${p}</div>
          <div class="meta">${stat.gp} games ‚Ä¢ ${stat.w} wins${stat.champs ? ' ‚Ä¢ ' + stat.champs + 'x champ' : ''}</div>
        </div>
        <button class="player-delete" onclick="deletePlayer(${i})">√ó</button>
      </div>
    `;
  }).join('');
}

function addPlayer() {
  const input = document.getElementById('new-player');
  const name = input.value.trim();
  
  if (!name) return;
  if (DATA.players.some(p => p.toLowerCase() === name.toLowerCase())) {
    toast('Player already exists', 'error');
    return;
  }
  
  DATA.players.push(name);
  save();
  
  // Push to server
  fetch(API, {
    method: 'POST',
    body: JSON.stringify({ action: 'addPlayer', playerName: name })
  }).catch(console.error);
  
  input.value = '';
  renderPlayerList();
  toast('Player added!', 'success');
}

function deletePlayer(i) {
  if (!confirm(`Remove ${DATA.players[i]}?`)) return;
  DATA.players.splice(i, 1);
  save();
  renderPlayerList();
}

document.getElementById('new-player').addEventListener('keypress', e => {
  if (e.key === 'Enter') addPlayer();
});

function generateDraw() {
  if (DATA.players.length < 2) {
    toast('Need at least 2 players', 'error');
    return;
  }
  
  if (DATA.draw.length && !confirm('This will replace the current draw. Continue?')) return;
  
  const pairs = [];
  for (let i = 0; i < DATA.players.length; i++) {
    for (let j = i + 1; j < DATA.players.length; j++) {
      pairs.push([DATA.players[i], DATA.players[j]]);
    }
  }
  
  // Shuffle
  for (let i = pairs.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [pairs[i], pairs[j]] = [pairs[j], pairs[i]];
  }
  
  DATA.draw = pairs.map((pair, i) => ({
    num: i + 1,
    p1: pair[0],
    p2: pair[1],
    s1: null,
    s2: null,
    winner: null,
    isGF: false
  }));
  
  DATA.gfCreated = false;
  DATA.paused = null;
  save();
  
  // Push to server
  fetch(API, { method: 'POST', body: JSON.stringify({ action: 'generateDraw' }) }).catch(console.error);
  
  toast(`${pairs.length} games created!`, 'success');
  showScreen('home');
}

function clearDraw() {
  if (!confirm('Clear the draw? Stats will be kept.')) return;
  DATA.draw = [];
  DATA.gfCreated = false;
  DATA.paused = null;
  save();
  
  fetch(API, { method: 'POST', body: JSON.stringify({ action: 'newEvent' }) }).catch(console.error);
  
  toast('Draw cleared', 'success');
  renderHome();
}

function changeTarget() {
  DATA.target = parseInt(document.getElementById('target-select').value) || 21;
  save();
  toast('Target updated', 'success');
}

// =============================================================================
// UTILITIES
// =============================================================================

function toast(message, type = 'success') {
  const el = document.getElementById('toast');
  el.textContent = message;
  el.className = 'toast show ' + type;
  setTimeout(() => el.classList.remove('show'), 2500);
}

// =============================================================================
// PWA SERVICE WORKER
// =============================================================================

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js').catch(e => console.log('SW error:', e));
}

// =============================================================================
// BACKGROUND SYNC
// =============================================================================

setInterval(() => {
  if (document.getElementById('screen-home').classList.contains('active')) {
    doSync();
  }
}, 30000);

// =============================================================================
// INITIALIZE
// =============================================================================

renderHome();
doSync();
</script>
</body>
</html>
