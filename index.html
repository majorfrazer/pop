<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="PopDarts">
  <meta name="theme-color" content="#0d0d1a">
  <meta name="description" content="PopDarts Championship - Live multi-device dart scoring">
  <title>PopDarts</title>
  <link rel="manifest" href="./manifest.json">
  <link rel="apple-touch-icon" href="./icon-192.png">
  <link rel="icon" type="image/png" sizes="192x192" href="./icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="./icon-512.png">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
    
    :root {
      --bg: #0d0d1a;
      --bg-card: #161625;
      --bg-elevated: #1f1f35;
      --border: rgba(255,255,255,0.08);
      --border-light: rgba(255,255,255,0.15);
      --text: #ffffff;
      --text-dim: #a0a0b8;
      --text-muted: #606078;
      --gold: #f5a623;
      --gold-dark: #c78b15;
      --green: #00d68f;
      --green-dark: #00a870;
      --red: #ff4757;
      --blue: #3b82f6;
      --purple: #a855f7;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-left: env(safe-area-inset-left, 0px);
      --safe-right: env(safe-area-inset-right, 0px);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; -webkit-touch-callout: none; user-select: none; }
    
    html { height: 100%; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100%;
      min-height: 100dvh;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* ========== LAYOUT MODES ========== */
    .mobile-view { display: block; }
    .desktop-view { display: none; }
    
    @media (min-width: 900px) {
      .mobile-view { display: none; }
      .desktop-view { display: grid; grid-template-columns: 280px 1fr 300px; height: 100vh; }
    }

    /* ========== MOBILE SCREENS ========== */
    .screen {
      position: fixed;
      inset: 0;
      display: none;
      flex-direction: column;
      background: var(--bg);
      z-index: 10;
      overflow: hidden;
    }
    .screen.active { display: flex; }

    /* ========== HEADER ========== */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: calc(12px + var(--safe-top)) 16px 12px;
      background: var(--bg);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    .logo { display: flex; align-items: center; gap: 10px; font-size: 22px; font-weight: 800; }
    .logo-emoji { font-size: 26px; }

    /* ========== SYNC BUTTON ========== */
    .sync-pill {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 30px;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-dim);
      cursor: pointer;
      transition: all 0.2s;
    }
    .sync-pill:active { transform: scale(0.95); background: var(--bg-elevated); }
    .sync-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--red);
      transition: background 0.3s;
    }
    .sync-dot.busy { background: var(--gold); animation: blink 0.4s infinite alternate; }
    .sync-dot.ok { background: var(--green); }
    @keyframes blink { to { opacity: 0.3; } }

    /* ========== SCROLLABLE CONTENT ========== */
    .content {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 16px;
      padding-bottom: calc(100px + var(--safe-bottom));
      -webkit-overflow-scrolling: touch;
    }

    /* ========== CARDS ========== */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 16px;
    }
    .card-label {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: var(--text-muted);
      margin-bottom: 14px;
    }

    /* ========== LIVE GAME BANNER ========== */
    .live-card {
      background: linear-gradient(135deg, #0a2a18 0%, #082015 100%);
      border: 2px solid var(--green);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 16px;
      cursor: pointer;
      animation: glow 2s ease-in-out infinite alternate;
    }
    @keyframes glow { from { box-shadow: 0 0 5px rgba(0,214,143,0.2); } to { box-shadow: 0 0 25px rgba(0,214,143,0.4); } }
    .live-card:active { transform: scale(0.98); }
    .live-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .live-badge { display: flex; align-items: center; gap: 8px; font-size: 12px; font-weight: 700; letter-spacing: 1px; color: var(--green); }
    .live-pulse { width: 10px; height: 10px; background: var(--green); border-radius: 50%; animation: pulse 1.5s ease-in-out infinite; }
    @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.3); opacity: 0.5; } }
    .live-join { padding: 10px 20px; background: var(--green); color: #000; font-size: 14px; font-weight: 700; border: none; border-radius: 12px; cursor: pointer; }
    .live-players { font-size: 20px; font-weight: 700; }
    .live-score { font-size: 40px; font-weight: 900; color: var(--gold); margin-top: 4px; }

    /* ========== PAUSED BANNER ========== */
    .paused-card {
      background: linear-gradient(135deg, #152540 0%, #101830 100%);
      border: 2px solid var(--blue);
      border-radius: 20px;
      padding: 16px 20px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
    }
    .paused-card:active { transform: scale(0.98); }
    .paused-info .label { font-size: 11px; font-weight: 700; letter-spacing: 1px; color: var(--blue); }
    .paused-info .players { font-size: 16px; font-weight: 700; margin-top: 4px; }
    .paused-info .score { font-size: 13px; color: var(--text-dim); }
    .paused-btn { padding: 12px 20px; background: var(--blue); color: #fff; font-size: 14px; font-weight: 700; border: none; border-radius: 12px; }

    /* ========== HERO CARD ========== */
    .hero {
      background: linear-gradient(145deg, #1a1a30 0%, #252548 100%);
      border: 1px solid var(--border-light);
      border-radius: 24px;
      padding: 30px 24px;
      margin-bottom: 20px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    .hero::before { content: 'üéØ'; position: absolute; font-size: 120px; opacity: 0.06; right: -20px; top: -20px; pointer-events: none; }
    .hero-tag { font-size: 12px; font-weight: 700; letter-spacing: 2px; color: var(--gold); margin-bottom: 12px; }
    .hero-match { font-size: 26px; font-weight: 800; line-height: 1.3; }
    .hero-vs { display: block; font-size: 14px; color: var(--text-muted); margin: 8px 0; font-weight: 500; }
    .hero-btn {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      margin-top: 20px;
      padding: 16px 40px;
      background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%);
      color: #000;
      font-size: 18px;
      font-weight: 800;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(245, 166, 35, 0.3);
    }
    .hero-btn:active { transform: scale(0.97); }
    .hero.gf { border-color: #ffd700; }
    .hero.gf .hero-tag { color: #ffd700; }

    /* ========== QUICK ACTIONS ========== */
    .actions { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
    .action-btn {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 24px 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.15s;
    }
    .action-btn:active { transform: scale(0.97); background: var(--bg-elevated); }
    .action-btn.gold { background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%); border: none; }
    .action-icon { font-size: 36px; margin-bottom: 10px; }
    .action-text { font-size: 15px; font-weight: 700; }
    .action-btn.gold .action-text { color: #000; }

    /* ========== STATS ROW ========== */
    .stats-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
    .stat-box {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px 8px;
      text-align: center;
    }
    .stat-icon { font-size: 20px; margin-bottom: 6px; }
    .stat-val { font-size: 26px; font-weight: 900; color: var(--gold); }
    .stat-name { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-top: 4px; }

    /* ========== TABS ========== */
    .tabs {
      display: flex;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 4px;
      margin-bottom: 16px;
    }
    .tab-btn {
      flex: 1;
      padding: 12px 6px;
      text-align: center;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      background: none;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }
    .tab-btn.on { background: var(--gold); color: #000; }

    /* ========== DATA TABLE ========== */
    .tbl { width: 100%; border-collapse: collapse; font-size: 13px; }
    .tbl th { padding: 10px 6px; text-align: center; font-size: 10px; font-weight: 700; text-transform: uppercase; color: var(--text-muted); background: rgba(255,255,255,0.03); }
    .tbl th:first-child { text-align: left; padding-left: 12px; border-radius: 10px 0 0 10px; }
    .tbl th:last-child { border-radius: 0 10px 10px 0; }
    .tbl td { padding: 12px 6px; text-align: center; border-bottom: 1px solid var(--border); }
    .tbl td:first-child { text-align: left; padding-left: 12px; font-weight: 600; }
    .tbl tr.top td { background: rgba(245,166,35,0.1); }
    .plus { color: var(--green); }
    .minus { color: var(--red); }

    /* ========== DRAW LIST ========== */
    .draw-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      margin-bottom: 10px;
      cursor: pointer;
    }
    .draw-row:active { background: var(--bg-elevated); }
    .draw-row.done { opacity: 0.5; pointer-events: none; }
    .draw-row.gf { border-color: #ffd700; background: rgba(255,215,0,0.05); }
    .draw-num {
      width: 38px;
      height: 38px;
      background: var(--bg-elevated);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: 800;
      flex-shrink: 0;
    }
    .draw-row.done .draw-num { background: var(--green); color: #000; }
    .draw-players { flex: 1; font-weight: 600; font-size: 14px; }
    .draw-players .win { color: var(--green); }
    .draw-result { font-size: 15px; font-weight: 800; color: var(--gold); min-width: 50px; text-align: center; }

    /* ========== BUTTONS ========== */
    .btn {
      width: 100%;
      padding: 16px;
      border-radius: 14px;
      border: none;
      font-family: inherit;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      margin-bottom: 10px;
      transition: transform 0.1s;
    }
    .btn:active { transform: scale(0.98); }
    .btn-gold { background: var(--gold); color: #000; }
    .btn-gray { background: var(--bg-elevated); color: var(--text); border: 1px solid var(--border); }
    .btn-red { background: rgba(255,71,87,0.15); color: var(--red); border: 1px solid rgba(255,71,87,0.3); }
    .btn-green { background: var(--green); color: #000; }

    /* ========== BOTTOM NAV ========== */
    .nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(13,13,26,0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-top: 1px solid var(--border);
      display: flex;
      padding: 8px 20px;
      padding-bottom: calc(8px + var(--safe-bottom));
      z-index: 100;
    }
    .nav-item {
      flex: 1;
      padding: 10px 0;
      text-align: center;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      background: none;
      border: none;
      border-radius: 12px;
      cursor: pointer;
    }
    .nav-item.on { color: var(--gold); background: rgba(245,166,35,0.1); }
    .nav-icon { font-size: 22px; display: block; margin-bottom: 4px; }

    /* ========== INPUTS ========== */
    input, select {
      width: 100%;
      padding: 14px 16px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 12px;
      font-family: inherit;
      font-size: 16px;
      margin-bottom: 10px;
      -webkit-appearance: none;
      appearance: none;
    }
    input:focus, select:focus { outline: none; border-color: var(--gold); }
    input::placeholder { color: var(--text-muted); }

    /* ========== PLAYER LIST ========== */
    .player-row {
      display: flex;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }
    .player-avatar {
      width: 42px;
      height: 42px;
      background: linear-gradient(135deg, var(--purple), var(--blue));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 18px;
      margin-right: 12px;
      flex-shrink: 0;
    }
    .player-info { flex: 1; }
    .player-info .name { font-weight: 700; font-size: 15px; }
    .player-info .meta { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
    .player-del {
      width: 36px;
      height: 36px;
      background: rgba(255,71,87,0.15);
      border: none;
      border-radius: 50%;
      color: var(--red);
      font-size: 20px;
      cursor: pointer;
    }

    /* ========== EMPTY STATE ========== */
    .empty { text-align: center; padding: 40px 20px; color: var(--text-muted); }
    .empty-icon { font-size: 48px; margin-bottom: 12px; opacity: 0.5; }

    /* ========== TOAST ========== */
    .toast {
      position: fixed;
      bottom: 110px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      padding: 14px 24px;
      border-radius: 14px;
      font-size: 14px;
      font-weight: 600;
      z-index: 700;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
      max-width: 90%;
      text-align: center;
    }
    .toast.show { opacity: 1; }
    .toast.good { border-left: 4px solid var(--green); }
    .toast.bad { border-left: 4px solid var(--red); }

    /* ========== DART SELECTION SCREEN ========== */
    .dart-head {
      padding: calc(20px + var(--safe-top)) 20px 20px;
      background: var(--bg-card);
      text-align: center;
      border-bottom: 1px solid var(--border);
      position: relative;
      flex-shrink: 0;
    }
    .dart-back {
      position: absolute;
      left: 16px;
      top: calc(20px + var(--safe-top));
      width: 44px;
      height: 44px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      cursor: pointer;
      color: var(--text);
    }
    .dart-step { font-size: 12px; font-weight: 700; letter-spacing: 2px; color: var(--gold); margin-bottom: 6px; }
    .dart-name { font-size: 26px; font-weight: 800; }
    .dart-sub { font-size: 14px; color: var(--text-dim); margin-top: 6px; }

    .dart-grid {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 14px;
      padding: 20px;
      overflow-y: auto;
      align-content: start;
    }
    @media (orientation: landscape) and (max-height: 500px) {
      .dart-grid { grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 12px; }
    }

    .dart-opt {
      background: var(--bg-card);
      border: 3px solid var(--border);
      border-radius: 20px;
      padding: 16px 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      transition: all 0.15s;
    }
    .dart-opt:active { transform: scale(0.97); }
    .dart-opt.picked { border-color: var(--gold); box-shadow: 0 0 25px rgba(245,166,35,0.4); }
    .dart-opt.off { opacity: 0.25; pointer-events: none; }
    .dart-shape {
      width: 60px;
      height: 90px;
      border-radius: 30px;
      position: relative;
    }
    .dart-shape::after {
      content: '';
      position: absolute;
      top: 12%;
      left: 18%;
      width: 28%;
      height: 18%;
      background: rgba(255,255,255,0.35);
      border-radius: 50%;
      transform: rotate(-25deg);
    }
    .dart-label { font-size: 12px; font-weight: 700; text-align: center; }

    .dart-foot {
      padding: 20px;
      padding-bottom: calc(20px + var(--safe-bottom));
      background: linear-gradient(transparent, var(--bg) 30%);
      flex-shrink: 0;
    }

    /* ========== GAME SCREEN - VERTICAL SPLIT ========== */
    #screen-game { background: #000; }

    .game-top {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      padding: calc(8px + var(--safe-top)) 12px 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 50;
      background: linear-gradient(180deg, rgba(0,0,0,0.9) 0%, transparent 100%);
    }
    .game-menu-btn {
      width: 50px;
      height: 50px;
      background: rgba(255,255,255,0.1);
      border: none;
      border-radius: 14px;
      color: #fff;
      font-size: 24px;
      cursor: pointer;
    }
    .game-badges { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; justify-content: flex-end; }
    .badge {
      padding: 8px 14px;
      background: rgba(0,0,0,0.7);
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
    }
    .badge.target { color: var(--gold); }
    .badge.gf { background: linear-gradient(135deg, #ffd700, #f59e0b); color: #000; }
    .badge.live { background: var(--green); color: #000; display: flex; align-items: center; gap: 6px; }
    .badge .dot { width: 6px; height: 6px; background: #000; border-radius: 50%; animation: pulse 1s infinite; }

    /* VERTICAL: Player 1 TOP, Player 2 BOTTOM */
    .game-arena {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
    }

    .pzone {
      flex: 1;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      overflow: hidden;
    }
    .pzone.top { padding-top: 80px; }
    .pzone.bot { padding-bottom: calc(20px + var(--safe-bottom)); }

    /* Progress bar - fills from edge */
    .pbar {
      position: absolute;
      left: 0;
      right: 0;
      height: 0%;
      transition: height 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      z-index: 1;
    }
    .pzone.top .pbar { top: 0; }
    .pzone.bot .pbar { bottom: 0; }

    .pui {
      position: relative;
      z-index: 10;
      text-align: center;
      width: 100%;
    }
    .phead {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin-bottom: 12px;
    }
    .pdart {
      width: 28px;
      height: 44px;
      border-radius: 14px;
      flex-shrink: 0;
    }
    .pname {
      font-size: 18px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .score-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin-bottom: 14px;
    }
    .score-btn {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      border: 3px solid rgba(255,255,255,0.2);
      background: rgba(0,0,0,0.5);
      color: #fff;
      font-size: 34px;
      font-weight: 300;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.1s;
    }
    .score-btn:active { transform: scale(0.9); background: rgba(255,255,255,0.2); }
    .score-btn.minus { color: var(--red); border-color: rgba(255,71,87,0.4); }
    .score-btn.plus { color: var(--green); border-color: rgba(0,214,143,0.4); }
    .score-big {
      font-size: 80px;
      font-weight: 900;
      line-height: 1;
      min-width: 120px;
    }
    @media (max-height: 600px) { .score-big { font-size: 60px; } }

    .quick-row {
      display: flex;
      gap: 8px;
      justify-content: center;
    }
    .qbtn {
      width: 50px;
      height: 44px;
      border-radius: 12px;
      border: 2px solid rgba(255,255,255,0.15);
      background: rgba(0,0,0,0.5);
      color: #fff;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
    }
    .qbtn:active { transform: scale(0.92); background: rgba(255,255,255,0.15); }

    .game-mid {
      height: 4px;
      background: rgba(255,255,255,0.1);
      position: relative;
      z-index: 20;
      flex-shrink: 0;
    }
    .reset-btn {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 50px;
      height: 50px;
      background: var(--bg-card);
      border: 2px solid var(--border);
      border-radius: 50%;
      color: var(--text-muted);
      font-size: 22px;
      cursor: pointer;
      z-index: 21;
    }

    /* ========== GAME MENU OVERLAY ========== */
    .gmenu {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.95);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 400;
      padding: 24px;
      gap: 14px;
    }
    .gmenu.on { display: flex; }
    .gmenu h2 { font-size: 26px; margin-bottom: 20px; }
    .gmenu-btn {
      width: 280px;
      padding: 18px;
      border-radius: 16px;
      border: none;
      font-size: 17px;
      font-weight: 700;
      cursor: pointer;
      font-family: inherit;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    .gmenu-btn.resume { background: var(--green); color: #000; }
    .gmenu-btn.end { background: var(--red); color: #fff; }
    .gmenu-btn.save { background: var(--bg-elevated); color: #fff; border: 1px solid var(--border); }

    /* ========== WIN OVERLAY ========== */
    .win {
      position: fixed;
      inset: 0;
      background: linear-gradient(145deg, #0d0d1a 0%, #1a1a35 50%, #0d1520 100%);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 500;
      padding: 24px;
    }
    .win.on { display: flex; }
    .win-trophy { font-size: 100px; animation: bounce 0.6s infinite alternate; }
    @keyframes bounce { to { transform: translateY(-12px) scale(1.05); } }
    .win-tag { font-size: 14px; letter-spacing: 3px; color: var(--gold); margin-top: 16px; }
    .win-name { font-size: 42px; font-weight: 900; margin-top: 8px; text-align: center; }
    .win-score { font-size: 26px; color: var(--text-dim); margin-top: 8px; }
    .win-btns { display: flex; gap: 12px; margin-top: 30px; flex-wrap: wrap; justify-content: center; }
    .win-btn {
      padding: 16px 28px;
      border-radius: 14px;
      border: none;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      font-family: inherit;
    }
    .win-btn.save { background: var(--green); color: #000; }
    .win-btn.again { background: var(--gold); color: #000; }
    .win-btn.exit { background: var(--bg-elevated); color: #fff; }

    .confetti { position: fixed; width: 10px; height: 10px; top: -20px; animation: fall 3s linear forwards; z-index: 501; border-radius: 2px; pointer-events: none; }
    @keyframes fall { to { transform: translateY(100vh) rotate(720deg); } }

    /* ========== DESKTOP CONTROL CENTRE ========== */
    .d-panel {
      background: var(--bg-card);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }
    .d-panel:last-child { border-right: none; border-left: 1px solid var(--border); }

    .d-head {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }
    .d-head h2 { font-size: 16px; font-weight: 800; display: flex; align-items: center; gap: 8px; }
    .d-body { flex: 1; overflow-y: auto; padding: 16px; }

    .d-center {
      background: var(--bg);
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }
    .d-center .d-body { padding: 20px; }

    .d-section { margin-bottom: 20px; }
    .d-section-title { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-muted); margin-bottom: 10px; }

    /* Desktop Hero */
    .d-hero {
      background: linear-gradient(145deg, #1a1a30 0%, #252548 100%);
      border: 1px solid var(--border-light);
      border-radius: 20px;
      padding: 30px;
      text-align: center;
      margin-bottom: 20px;
    }
    .d-hero.gf { border-color: #ffd700; }
    .d-hero .hero-tag { font-size: 13px; }
    .d-hero .hero-match { font-size: 28px; }
    .d-hero .hero-btn { font-size: 16px; padding: 14px 36px; margin-top: 16px; }

    /* Desktop Live Banner */
    .d-live {
      background: linear-gradient(135deg, #0a2a18 0%, #082015 100%);
      border: 2px solid var(--green);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      animation: glow 2s ease-in-out infinite alternate;
      cursor: pointer;
    }
    .d-live:hover { transform: scale(1.01); }
    .d-live .live-info { flex: 1; }
    .d-live .live-players { font-size: 18px; }
    .d-live .live-score { font-size: 36px; }

    /* Desktop Stats */
    .d-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
    .d-stat {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px 10px;
      text-align: center;
    }
    .d-stat .stat-icon { font-size: 18px; }
    .d-stat .stat-val { font-size: 24px; }

    /* Desktop Draw Item */
    .d-draw-row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 12px;
      margin-bottom: 8px;
      cursor: pointer;
      font-size: 13px;
    }
    .d-draw-row:hover { background: var(--bg-card); }
    .d-draw-row.done { opacity: 0.5; }
    .d-draw-row.gf { border-color: #ffd700; }
    .d-draw-num { width: 28px; height: 28px; background: var(--bg-card); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 800; }
    .d-draw-row.done .d-draw-num { background: var(--green); color: #000; }
    .d-draw-players { flex: 1; font-weight: 600; }
    .d-draw-score { font-weight: 800; color: var(--gold); min-width: 40px; text-align: center; }

    /* Debug Panel */
    .debug-panel {
      position: fixed;
      bottom: 120px;
      right: 10px;
      background: rgba(0,0,0,0.9);
      border: 1px solid var(--gold);
      border-radius: 10px;
      padding: 10px;
      font-size: 10px;
      max-width: 200px;
      max-height: 150px;
      overflow-y: auto;
      z-index: 600;
      display: none;
    }
    .debug-panel.show { display: block; }
    .debug-panel pre { white-space: pre-wrap; word-break: break-all; color: var(--green); }
  </style>
</head>
<body>

<!-- ==================== MOBILE VIEW ==================== -->
<div class="mobile-view">

  <!-- HOME -->
  <div id="screen-home" class="screen active">
    <div class="header">
      <div class="logo"><span class="logo-emoji">üéØ</span>PopDarts</div>
      <button class="sync-pill" onclick="doSync()">
        <span class="sync-dot" id="sdot1"></span>
        <span id="stxt1">Sync</span>
      </button>
    </div>
    <div class="content">
      <div id="live-zone"></div>
      <div id="paused-zone"></div>
      <div id="hero-zone"></div>
      <div class="actions">
        <div class="action-btn gold" onclick="playNext()"><div class="action-icon">‚ñ∂Ô∏è</div><div class="action-text">Play Next</div></div>
        <div class="action-btn" onclick="openCustom()"><div class="action-icon">üéÆ</div><div class="action-text">Quick Match</div></div>
      </div>
      <div class="stats-row">
        <div class="stat-box"><div class="stat-icon">üë•</div><div class="stat-val" id="st-players">0</div><div class="stat-name">Players</div></div>
        <div class="stat-box"><div class="stat-icon">üéØ</div><div class="stat-val" id="st-games">0/0</div><div class="stat-name">Games</div></div>
        <div class="stat-box"><div class="stat-icon">üèÜ</div><div class="stat-val" id="st-target">21</div><div class="stat-name">Target</div></div>
      </div>
      <div class="tabs">
        <button class="tab-btn on" onclick="switchTab('draw',this)">üìã Draw</button>
        <button class="tab-btn" onclick="switchTab('standings',this)">üìä Standings</button>
        <button class="tab-btn" onclick="switchTab('alltime',this)">üèÜ All-Time</button>
      </div>
      <div id="tab-draw"></div>
      <div id="tab-standings" style="display:none"></div>
      <div id="tab-alltime" style="display:none"></div>
    </div>
  </div>

  <!-- SETTINGS -->
  <div id="screen-settings" class="screen">
    <div class="header">
      <div class="logo"><span class="logo-emoji">‚öôÔ∏è</span>Settings</div>
      <button class="sync-pill" onclick="doSync()">
        <span class="sync-dot" id="sdot2"></span>
        <span id="stxt2">Sync</span>
      </button>
    </div>
    <div class="content">
      <div class="card">
        <div class="card-label">‚òÅÔ∏è Cloud Sync</div>
        <p style="font-size:13px;color:var(--text-dim);margin-bottom:14px;">All devices share players, draw, and live games</p>
        <button class="btn btn-gray" onclick="doSync()">üîÑ Sync Now</button>
        <div style="font-size:11px;color:var(--text-muted);margin-top:10px;">Last sync: <span id="last-sync">Never</span></div>
      </div>
      <div class="card">
        <div class="card-label">üë• Players</div>
        <div style="display:flex;gap:10px;margin-bottom:14px;">
          <input type="text" id="inp-player" placeholder="Player name..." style="margin:0;flex:1">
          <button class="btn btn-green" style="width:auto;margin:0;padding:14px 20px;" onclick="addPlayer()">+</button>
        </div>
        <div id="player-list"></div>
      </div>
      <div class="card">
        <div class="card-label">üèÜ Championship</div>
        <button class="btn btn-gold" onclick="generateDraw()">üé≤ Generate New Draw</button>
        <button class="btn btn-red" onclick="clearDraw()">Clear Draw</button>
      </div>
      <div class="card">
        <div class="card-label">üéØ Target Score</div>
        <select id="sel-target" onchange="changeTarget()">
          <option value="11">First to 11</option>
          <option value="15">First to 15</option>
          <option value="21" selected>First to 21</option>
          <option value="31">First to 31</option>
        </select>
      </div>
    </div>
  </div>

  <!-- CUSTOM MATCH -->
  <div id="screen-custom" class="screen">
    <div class="header">
      <button class="sync-pill" onclick="showScreen('home')" style="padding:10px 14px;">‚Üê Back</button>
      <div class="logo" style="font-size:18px;">Quick Match</div>
      <div style="width:70px"></div>
    </div>
    <div class="content">
      <div class="card"><div class="card-label">Player 1</div><select id="sel-p1"></select></div>
      <div class="card"><div class="card-label">Player 2</div><select id="sel-p2"></select></div>
      <button class="btn btn-gold" onclick="startCustom()">üéÆ Start Match</button>
      <p style="font-size:12px;color:var(--text-muted);text-align:center;margin-top:14px;">Quick matches don't affect stats</p>
    </div>
  </div>

  <!-- DART SELECTION -->
  <div id="screen-dart" class="screen">
    <div class="dart-head">
      <button class="dart-back" onclick="cancelDart()">‚Üê</button>
      <div class="dart-step" id="dart-step">STEP 1 OF 2</div>
      <h2 class="dart-name" id="dart-player">Player 1</h2>
      <p class="dart-sub">Pick your dart colour</p>
    </div>
    <div class="dart-grid" id="dart-grid"></div>
    <div class="dart-foot">
      <button class="btn btn-green" id="dart-confirm" onclick="confirmDart()" disabled>Select Dart</button>
    </div>
  </div>

  <!-- GAME -->
  <div id="screen-game" class="screen">
    <div class="game-top">
      <button class="game-menu-btn" onclick="openMenu()">‚ò∞</button>
      <div class="game-badges">
        <div class="badge" id="g-label">Game 1</div>
        <div class="badge live" id="g-live" style="display:none"><span class="dot"></span>LIVE</div>
        <div class="badge target">To: <span id="g-target">21</span></div>
      </div>
    </div>
    <div class="game-arena">
      <div class="pzone top" id="zone1">
        <div class="pbar" id="bar1"></div>
        <div class="pui">
          <div class="phead"><div class="pdart" id="dart1"></div><span class="pname" id="name1">Player 1</span></div>
          <div class="score-row">
            <button class="score-btn minus" onclick="adj(1,-1)">‚àí</button>
            <div class="score-big" id="sc1">0</div>
            <button class="score-btn plus" onclick="adj(1,1)">+</button>
          </div>
          <div class="quick-row">
            <button class="qbtn" onclick="adj(1,2)">+2</button>
            <button class="qbtn" onclick="adj(1,3)">+3</button>
            <button class="qbtn" onclick="adj(1,4)">+4</button>
            <button class="qbtn" onclick="adj(1,5)">+5</button>
          </div>
        </div>
      </div>
      <div class="game-mid"><button class="reset-btn" onclick="resetGame()">‚Ü∫</button></div>
      <div class="pzone bot" id="zone2">
        <div class="pbar" id="bar2"></div>
        <div class="pui">
          <div class="phead"><div class="pdart" id="dart2"></div><span class="pname" id="name2">Player 2</span></div>
          <div class="score-row">
            <button class="score-btn minus" onclick="adj(2,-1)">‚àí</button>
            <div class="score-big" id="sc2">0</div>
            <button class="score-btn plus" onclick="adj(2,1)">+</button>
          </div>
          <div class="quick-row">
            <button class="qbtn" onclick="adj(2,2)">+2</button>
            <button class="qbtn" onclick="adj(2,3)">+3</button>
            <button class="qbtn" onclick="adj(2,4)">+4</button>
            <button class="qbtn" onclick="adj(2,5)">+5</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- NAV -->
  <nav class="nav" id="nav">
    <button class="nav-item on" data-s="home"><span class="nav-icon">üè†</span>Home</button>
    <button class="nav-item" data-s="settings"><span class="nav-icon">‚öôÔ∏è</span>Settings</button>
  </nav>
</div>

<!-- ==================== DESKTOP VIEW ==================== -->
<div class="desktop-view">
  <!-- LEFT: Players & Draw -->
  <div class="d-panel">
    <div class="d-head">
      <h2>üéØ PopDarts</h2>
      <button class="sync-pill" onclick="doSync()">
        <span class="sync-dot" id="sdot3"></span>
        <span id="stxt3">Sync</span>
      </button>
    </div>
    <div class="d-body">
      <div class="d-section">
        <div class="d-section-title">üë• Players</div>
        <div style="display:flex;gap:8px;margin-bottom:10px;">
          <input type="text" id="d-inp-player" placeholder="Add player..." style="margin:0;flex:1;padding:10px 12px;font-size:14px;">
          <button class="btn btn-green" style="width:auto;margin:0;padding:10px 16px;font-size:14px;" onclick="addPlayerD()">+</button>
        </div>
        <div id="d-player-list"></div>
      </div>
      <div class="d-section">
        <div class="d-section-title">üìã Draw</div>
        <div id="d-draw"></div>
      </div>
      <div class="d-section">
        <button class="btn btn-gold" style="font-size:14px;padding:12px;" onclick="generateDraw()">üé≤ Generate Draw</button>
        <button class="btn btn-gray" style="font-size:14px;padding:12px;" onclick="clearDraw()">Clear Draw</button>
      </div>
    </div>
  </div>

  <!-- CENTER: Game Arena -->
  <div class="d-center">
    <div class="d-head">
      <h2>üéÆ Game Arena</h2>
      <div style="display:flex;gap:10px;align-items:center;">
        <span style="font-size:12px;color:var(--text-dim);">Target:</span>
        <select id="d-target" onchange="changeTargetD()" style="width:auto;margin:0;padding:8px 12px;font-size:14px;">
          <option value="11">11</option><option value="15">15</option><option value="21" selected>21</option><option value="31">31</option>
        </select>
      </div>
    </div>
    <div class="d-body" id="d-game-area"></div>
  </div>

  <!-- RIGHT: Standings -->
  <div class="d-panel">
    <div class="d-head"><h2>üìä Standings</h2></div>
    <div class="d-body">
      <div class="d-section">
        <div class="d-section-title">Current Championship</div>
        <div id="d-standings"></div>
      </div>
      <div class="d-section">
        <div class="d-section-title">üèÜ All-Time Stats</div>
        <div id="d-alltime"></div>
      </div>
    </div>
  </div>
</div>

<!-- GAME MENU -->
<div class="gmenu" id="gmenu">
  <h2>‚è∏Ô∏è Game Paused</h2>
  <button class="gmenu-btn resume" onclick="closeMenu()">‚ñ∂Ô∏è Resume</button>
  <button class="gmenu-btn end" onclick="endGame()">‚ùå End Game</button>
  <button class="gmenu-btn save" onclick="pauseGame()">üíæ Save & Exit</button>
</div>

<!-- WIN -->
<div class="win" id="win">
  <div class="win-trophy">üèÜ</div>
  <div class="win-tag">üéâ WINNER üéâ</div>
  <div class="win-name" id="win-name">Player</div>
  <div class="win-score" id="win-score">21 - 15</div>
  <div class="win-btns">
    <button class="win-btn save" id="win-save" onclick="saveGame()">üíæ Save</button>
    <button class="win-btn again" onclick="rematch()">üîÑ Again</button>
    <button class="win-btn exit" onclick="exitWin()">‚úï Exit</button>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- DEBUG (triple-tap logo to show) -->
<div class="debug-panel" id="debug"><pre id="debug-log"></pre></div>

<script>
// =============================================================================
// POPDARTS v5.7 - RELIABLE SYNC + VERTICAL GAMEPLAY + DESKTOP CONTROL CENTRE
// =============================================================================

const API = 'https://script.google.com/macros/s/AKfycbzHmXfDS8P3ZzYC1IZh9Q9ZUKKMe3p7ojDe7uYwf89g1Q_5SuGDYsoXFEo1bCSUjX0pEg/exec';

// DARTS - Gradient colours extracted from your real darts
const DARTS = [
  { id: 'black-green', name: 'Black & Green', grad: 'linear-gradient(145deg, #1a1a1a 0%, #22c55e 30%, #1a1a1a 50%, #22c55e 70%, #1a1a1a 100%)', color: '#22c55e' },
  { id: 'tropical', name: 'Tropical', grad: 'linear-gradient(145deg, #f97316 0%, #0891b2 33%, #ec4899 66%, #f97316 100%)', color: '#f97316' },
  { id: 'black-blue', name: 'Black & Blue', grad: 'linear-gradient(145deg, #1a1a1a 0%, #3b82f6 35%, #1a1a1a 65%, #3b82f6 100%)', color: '#3b82f6' },
  { id: 'white-purple', name: 'White & Purple', grad: 'linear-gradient(145deg, #f0f0f0 0%, #a855f7 30%, #f0f0f0 60%, #a855f7 100%)', color: '#a855f7' },
  { id: 'cyan', name: 'Solid Cyan', grad: '#06b6d4', color: '#06b6d4' },
  { id: 'white-teal', name: 'White & Teal', grad: 'linear-gradient(145deg, #f0f0f0 0%, #14b8a6 35%, #f0f0f0 70%, #14b8a6 100%)', color: '#14b8a6' },
  { id: 'lime', name: 'Neon Lime', grad: '#84cc16', color: '#84cc16' }
];

// Storage keys
const KEY_DATA = 'popdarts57_data';
const KEY_STATS = 'popdarts57_stats';

// App State
let D = load(KEY_DATA) || { players: [], draw: [], target: 21, paused: null, gfDone: false };
let S = load(KEY_STATS) || [];
let G = {};
let liveTimer = null;
let debugLog = [];

function load(k) { try { return JSON.parse(localStorage.getItem(k)); } catch { return null; } }
function store(k, v) { localStorage.setItem(k, JSON.stringify(v)); }
function log(msg) { debugLog.push(new Date().toLocaleTimeString() + ': ' + msg); if (debugLog.length > 20) debugLog.shift(); document.getElementById('debug-log').textContent = debugLog.join('\n'); console.log('[PopDarts]', msg); }

// =============================================================================
// SYNC - Cloud First Design
// =============================================================================

async function doSync() {
  setSyncUI('busy');
  log('Sync started...');
  
  try {
    // 1. FETCH PLAYERS
    log('Fetching players...');
    const pRes = await fetch(API + '?action=players', { method: 'GET' });
    const pJson = await pRes.json();
    log('Players response: ' + JSON.stringify(pJson).substring(0, 100));
    
    if (pJson.success && pJson.data && pJson.data.players) {
      // CLOUD IS MASTER - Replace local with cloud
      D.players = pJson.data.players.filter(p => p && p.trim());
      log('Got ' + D.players.length + ' players from cloud');
    }
    
    // 2. FETCH STATS
    log('Fetching stats...');
    const sRes = await fetch(API + '?action=stats', { method: 'GET' });
    const sJson = await sRes.json();
    
    if (sJson.success && sJson.data && sJson.data.stats) {
      S = sJson.data.stats.map(r => ({
        name: r.name,
        gp: r.gamesPlayed || 0,
        w: r.wins || 0,
        l: r.losses || 0,
        pf: r.pointsFor || 0,
        pa: r.pointsAgainst || 0,
        diff: r.pointsDiff || 0,
        champs: r.championships || 0
      }));
      store(KEY_STATS, S);
      log('Got ' + S.length + ' stats from cloud');
    }
    
    // 3. FETCH DRAW
    log('Fetching draw...');
    const dRes = await fetch(API + '?action=draw', { method: 'GET' });
    const dJson = await dRes.json();
    
    if (dJson.success && dJson.data && dJson.data.games) {
      const cloudGames = dJson.data.games;
      log('Got ' + cloudGames.length + ' games from cloud');
      
      // Build draw from cloud
      D.draw = cloudGames.map(g => ({
        num: g.gameNum,
        p1: g.player1,
        p2: g.player2,
        s1: g.score1,
        s2: g.score2,
        winner: g.winner || null,
        isGF: g.gameNum === 'GF'
      }));
      
      // Check for grand final
      if (dJson.data.grandFinal) {
        const gf = dJson.data.grandFinal;
        if (!D.draw.find(x => x.isGF)) {
          D.draw.push({ num: 'GF', p1: gf.player1, p2: gf.player2, s1: gf.score1, s2: gf.score2, winner: gf.winner, isGF: true });
        }
        D.gfDone = true;
      }
      
      // Get target
      if (dJson.data.targetScore) {
        D.target = dJson.data.targetScore;
      }
    }
    
    // 4. FETCH LIVE GAME
    log('Fetching live game...');
    const lgRes = await fetch(API + '?action=liveGame', { method: 'GET' });
    const lgJson = await lgRes.json();
    
    if (lgJson.success && lgJson.data && lgJson.data.active) {
      D.live = lgJson.data;
      log('Live game active: ' + D.live.player1 + ' vs ' + D.live.player2);
    } else {
      D.live = null;
      log('No live game');
    }
    
    // Save locally
    store(KEY_DATA, D);
    
    // Update UI
    setSyncUI('ok');
    document.getElementById('last-sync').textContent = new Date().toLocaleTimeString();
    toast('Synced!', 'good');
    render();
    
    log('Sync complete!');
    
  } catch (err) {
    log('Sync ERROR: ' + err.message);
    setSyncUI('err');
    toast('Sync failed: ' + err.message, 'bad');
  }
}

function setSyncUI(state) {
  ['sdot1', 'sdot2', 'sdot3'].forEach(id => {
    const el = document.getElementById(id);
    if (el) { el.className = 'sync-dot' + (state === 'busy' ? ' busy' : state === 'ok' ? ' ok' : ''); }
  });
  ['stxt1', 'stxt2', 'stxt3'].forEach(id => {
    const el = document.getElementById(id);
    if (el) { el.textContent = state === 'busy' ? '...' : state === 'ok' ? 'OK' : 'Err'; }
  });
}

async function apiPost(action, data) {
  log('POST: ' + action);
  try {
    const res = await fetch(API, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({ action, ...data })
    });
    const json = await res.json();
    log('POST response: ' + JSON.stringify(json).substring(0, 100));
    return json;
  } catch (err) {
    log('POST error: ' + err.message);
    return { success: false, error: err.message };
  }
}

async function pushLive() {
  if (!G.p1) return;
  await apiPost('updateLiveGame', {
    active: true,
    gameId: G.num || 'custom',
    player1: G.p1,
    player2: G.p2,
    score1: G.s1,
    score2: G.s2,
    color1: G.d1?.id || '',
    color2: G.d2?.id || '',
    target: D.target,
    isChamp: G.isChamp,
    isGF: G.isGF
  });
}

async function clearLive() {
  await apiPost('clearLiveGame', {});
  D.live = null;
}

async function pullLive() {
  try {
    const res = await fetch(API + '?action=liveGame');
    const json = await res.json();
    if (json.success && json.data && json.data.active) {
      if (json.data.score1 !== G.s1 || json.data.score2 !== G.s2) {
        G.s1 = json.data.score1;
        G.s2 = json.data.score2;
        updateGameUI();
        log('Live update: ' + G.s1 + '-' + G.s2);
      }
    }
  } catch (e) { log('Pull live error: ' + e.message); }
}

function startLiveSync() {
  stopLiveSync();
  liveTimer = setInterval(pullLive, 3000);
  log('Live sync started (3s interval)');
}

function stopLiveSync() {
  if (liveTimer) { clearInterval(liveTimer); liveTimer = null; log('Live sync stopped'); }
}

// =============================================================================
// NAVIGATION
// =============================================================================

document.querySelectorAll('.nav-item').forEach(btn => {
  btn.onclick = () => showScreen(btn.dataset.s);
});

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('screen-' + id)?.classList.add('active');
  document.querySelectorAll('.nav-item').forEach(b => b.classList.toggle('on', b.dataset.s === id));
  document.getElementById('nav').style.display = ['game', 'dart', 'custom'].includes(id) ? 'none' : 'flex';
  if (id === 'home') render();
  if (id === 'settings') { document.getElementById('sel-target').value = D.target; renderPlayers(); }
}

function switchTab(t, btn) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('on'));
  btn.classList.add('on');
  ['draw', 'standings', 'alltime'].forEach(x => {
    document.getElementById('tab-' + x).style.display = x === t ? 'block' : 'none';
  });
}

// =============================================================================
// RENDER
// =============================================================================

function render() {
  const stand = calcStandings();
  const done = D.draw.filter(g => !g.isGF && g.winner).length;
  const total = D.draw.filter(g => !g.isGF).length;
  
  // Mobile stats
  document.getElementById('st-players').textContent = D.players.length;
  document.getElementById('st-games').textContent = total > 0 ? done + '/' + total : '0';
  document.getElementById('st-target').textContent = D.target;
  
  renderLive();
  renderPaused();
  renderHero();
  renderDraw();
  renderStandings(stand);
  renderAllTime();
  
  // Desktop
  if (window.innerWidth >= 900) renderDesktop(stand);
}

function renderLive() {
  const el = document.getElementById('live-zone');
  if (!D.live || !D.live.active) { el.innerHTML = ''; return; }
  const L = D.live;
  el.innerHTML = `
    <div class="live-card" onclick="joinLive()">
      <div class="live-top">
        <div class="live-badge"><span class="live-pulse"></span>LIVE GAME</div>
        <button class="live-join">Join</button>
      </div>
      <div class="live-players">${L.player1} vs ${L.player2}</div>
      <div class="live-score">${L.score1} - ${L.score2}</div>
    </div>
  `;
}

function renderPaused() {
  const el = document.getElementById('paused-zone');
  if (!D.paused) { el.innerHTML = ''; return; }
  const P = D.paused;
  el.innerHTML = `
    <div class="paused-card" onclick="resumePaused()">
      <div class="paused-info">
        <div class="label">‚è∏ PAUSED</div>
        <div class="players">${P.p1} vs ${P.p2}</div>
        <div class="score">${P.s1} - ${P.s2}</div>
      </div>
      <button class="paused-btn">Resume</button>
    </div>
  `;
}

function renderHero() {
  const el = document.getElementById('hero-zone');
  const next = getNext();
  if (!next) {
    el.innerHTML = D.draw.length === 0
      ? '<div class="hero"><div class="hero-tag" style="color:var(--text-muted)">NO CHAMPIONSHIP</div><div class="hero-match">Add players & generate draw</div></div>'
      : '<div class="hero"><div class="hero-tag">üéâ COMPLETE</div><div class="hero-match">All games finished!</div></div>';
    return;
  }
  const g = next.game;
  el.innerHTML = `
    <div class="hero ${g.isGF ? 'gf' : ''}">
      <div class="hero-tag">${g.isGF ? 'üèÜ GRAND FINAL üèÜ' : 'GAME ' + g.num}</div>
      <div class="hero-match">${g.p1}<span class="hero-vs">vs</span>${g.p2}</div>
      <button class="hero-btn" onclick="playNext()">‚ñ∂Ô∏è Play Now</button>
    </div>
  `;
}

function renderDraw() {
  const el = document.getElementById('tab-draw');
  if (D.draw.length === 0) { el.innerHTML = '<div class="empty"><div class="empty-icon">üìã</div><div>No games yet</div></div>'; return; }
  el.innerHTML = D.draw.map((g, i) => `
    <div class="draw-row ${g.winner ? 'done' : ''} ${g.isGF ? 'gf' : ''}" onclick="${g.winner ? '' : 'playIdx(' + i + ')'}">
      <div class="draw-num">${g.isGF ? 'üèÜ' : g.num}</div>
      <div class="draw-players"><span class="${g.winner === g.p1 ? 'win' : ''}">${g.p1}</span> vs <span class="${g.winner === g.p2 ? 'win' : ''}">${g.p2}</span></div>
      <div class="draw-result">${g.winner ? g.s1 + '-' + g.s2 : '‚Äî'}</div>
    </div>
  `).join('');
}

function renderStandings(stand) {
  const el = document.getElementById('tab-standings');
  if (!stand.length) { el.innerHTML = '<div class="empty"><div class="empty-icon">üìä</div><div>No standings yet</div></div>'; return; }
  el.innerHTML = `<table class="tbl"><thead><tr><th>Player</th><th>W</th><th>L</th><th>+/-</th></tr></thead><tbody>${stand.map((p, i) => `<tr class="${i === 0 ? 'top' : ''}"><td>${i === 0 ? 'üëë ' : ''}${p.name}</td><td>${p.w}</td><td>${p.l}</td><td class="${p.diff > 0 ? 'plus' : p.diff < 0 ? 'minus' : ''}">${p.diff > 0 ? '+' : ''}${p.diff}</td></tr>`).join('')}</tbody></table>`;
}

function renderAllTime() {
  const el = document.getElementById('tab-alltime');
  if (!S.length) { el.innerHTML = '<div class="empty"><div class="empty-icon">üèÜ</div><div>No stats yet</div></div>'; return; }
  const sorted = [...S].sort((a, b) => (b.champs || 0) - (a.champs || 0) || b.w - a.w);
  el.innerHTML = `<table class="tbl"><thead><tr><th>Player</th><th>GP</th><th>W</th><th>%</th><th>üèÜ</th></tr></thead><tbody>${sorted.map((s, i) => `<tr class="${s.champs > 0 && i === 0 ? 'top' : ''}"><td>${s.name}</td><td>${s.gp}</td><td>${s.w}</td><td>${s.gp ? Math.round(s.w / s.gp * 100) : 0}%</td><td style="color:${s.champs ? '#ffd700' : 'var(--text-muted)'};font-weight:900">${s.champs || 0}</td></tr>`).join('')}</tbody></table>`;
}

function renderDesktop(stand) {
  // Players
  document.getElementById('d-player-list').innerHTML = D.players.length === 0 ? '<div class="empty" style="padding:20px 0;">No players</div>' : D.players.map(p => `<div style="padding:8px 0;border-bottom:1px solid var(--border);font-size:13px;font-weight:600;">${p}</div>`).join('');
  
  // Draw
  document.getElementById('d-draw').innerHTML = D.draw.length === 0 ? '<div class="empty" style="padding:20px 0;">No draw</div>' : D.draw.map((g, i) => `<div class="d-draw-row ${g.winner ? 'done' : ''} ${g.isGF ? 'gf' : ''}" onclick="${g.winner ? '' : 'playIdx(' + i + ')'}"><div class="d-draw-num">${g.isGF ? 'üèÜ' : g.num}</div><div class="d-draw-players">${g.p1} vs ${g.p2}</div><div class="d-draw-score">${g.winner ? g.s1 + '-' + g.s2 : '‚Äî'}</div></div>`).join('');
  
  // Standings
  document.getElementById('d-standings').innerHTML = stand.length === 0 ? '<div class="empty">No standings</div>' : `<table class="tbl" style="font-size:12px;"><thead><tr><th>Player</th><th>W</th><th>L</th><th>+/-</th></tr></thead><tbody>${stand.map((p, i) => `<tr class="${i === 0 ? 'top' : ''}"><td>${i === 0 ? 'üëë ' : ''}${p.name}</td><td>${p.w}</td><td>${p.l}</td><td class="${p.diff > 0 ? 'plus' : p.diff < 0 ? 'minus' : ''}">${p.diff > 0 ? '+' : ''}${p.diff}</td></tr>`).join('')}</tbody></table>`;
  
  // All-time
  const sorted = [...S].sort((a, b) => (b.champs || 0) - (a.champs || 0) || b.w - a.w);
  document.getElementById('d-alltime').innerHTML = sorted.length === 0 ? '<div class="empty">No stats</div>' : `<table class="tbl" style="font-size:12px;"><thead><tr><th>Player</th><th>W</th><th>%</th><th>üèÜ</th></tr></thead><tbody>${sorted.map(s => `<tr><td>${s.name}</td><td>${s.w}</td><td>${s.gp ? Math.round(s.w / s.gp * 100) : 0}%</td><td style="color:${s.champs ? '#ffd700' : 'var(--text-muted)'}">${s.champs || 0}</td></tr>`).join('')}</tbody></table>`;
  
  // Game area
  renderDesktopGame();
}

function renderDesktopGame() {
  const el = document.getElementById('d-game-area');
  const next = getNext();
  
  // Live game
  if (D.live && D.live.active) {
    const L = D.live;
    el.innerHTML = `
      <div class="d-live" onclick="joinLive()">
        <div class="live-info">
          <div class="live-badge" style="margin-bottom:8px;"><span class="live-pulse"></span>LIVE GAME IN PROGRESS</div>
          <div class="live-players">${L.player1} vs ${L.player2}</div>
          <div class="live-score">${L.score1} - ${L.score2}</div>
        </div>
        <button class="live-join">üëÅÔ∏è Watch / Join</button>
      </div>
    `;
    return;
  }
  
  // Stats + Hero
  const done = D.draw.filter(g => !g.isGF && g.winner).length;
  const total = D.draw.filter(g => !g.isGF).length;
  const remain = D.draw.filter(g => !g.winner).length;
  
  let heroHTML = '';
  if (!next) {
    heroHTML = D.draw.length === 0
      ? '<div class="d-hero"><div class="hero-tag" style="color:var(--text-muted)">NO CHAMPIONSHIP</div><div class="hero-match">Add players & generate draw</div></div>'
      : '<div class="d-hero"><div class="hero-tag">üéâ CHAMPIONSHIP COMPLETE</div><div class="hero-match">All games played!</div></div>';
  } else {
    const g = next.game;
    heroHTML = `
      <div class="d-hero ${g.isGF ? 'gf' : ''}">
        <div class="hero-tag">${g.isGF ? 'üèÜ GRAND FINAL üèÜ' : 'NEXT UP ‚Ä¢ GAME ' + g.num}</div>
        <div class="hero-match">${g.p1}<span class="hero-vs">vs</span>${g.p2}</div>
        <button class="hero-btn" onclick="playNext()">‚ñ∂Ô∏è Start Game</button>
      </div>
    `;
  }
  
  el.innerHTML = `
    <div class="d-stats">
      <div class="d-stat"><div class="stat-icon">üë•</div><div class="stat-val">${D.players.length}</div><div class="stat-name">Players</div></div>
      <div class="d-stat"><div class="stat-icon">üéØ</div><div class="stat-val">${done}/${total}</div><div class="stat-name">Games</div></div>
      <div class="d-stat"><div class="stat-icon">üèÜ</div><div class="stat-val">${D.target}</div><div class="stat-name">Target</div></div>
      <div class="d-stat"><div class="stat-icon">‚è±Ô∏è</div><div class="stat-val">${remain}</div><div class="stat-name">Remaining</div></div>
    </div>
    ${heroHTML}
  `;
}

function calcStandings() {
  const m = new Map();
  D.players.forEach(p => m.set(p, { name: p, w: 0, l: 0, pf: 0, pa: 0, diff: 0 }));
  D.draw.forEach(g => {
    if (g.isGF || !g.winner) return;
    const a = m.get(g.p1), b = m.get(g.p2);
    if (a) { if (g.winner === g.p1) a.w++; else a.l++; a.pf += g.s1 || 0; a.pa += g.s2 || 0; a.diff += (g.s1 || 0) - (g.s2 || 0); }
    if (b) { if (g.winner === g.p2) b.w++; else b.l++; b.pf += g.s2 || 0; b.pa += g.s1 || 0; b.diff += (g.s2 || 0) - (g.s1 || 0); }
  });
  return [...m.values()].sort((a, b) => b.w - a.w || b.diff - a.diff);
}

function getNext() {
  for (let i = 0; i < D.draw.length; i++) if (!D.draw[i].isGF && !D.draw[i].winner) return { idx: i, game: D.draw[i] };
  for (let i = D.draw.length - 1; i >= 0; i--) if (D.draw[i].isGF && !D.draw[i].winner) return { idx: i, game: D.draw[i] };
  return null;
}

// =============================================================================
// CUSTOM MATCH
// =============================================================================

function openCustom() {
  if (D.players.length < 2) { toast('Add 2+ players first', 'bad'); return; }
  const opts = D.players.map(p => `<option value="${p}">${p}</option>`).join('');
  document.getElementById('sel-p1').innerHTML = opts;
  document.getElementById('sel-p2').innerHTML = opts;
  if (D.players.length > 1) document.getElementById('sel-p2').selectedIndex = 1;
  showScreen('custom');
}

function startCustom() {
  const p1 = document.getElementById('sel-p1').value;
  const p2 = document.getElementById('sel-p2').value;
  if (p1 === p2) { toast('Pick different players', 'bad'); return; }
  G = { p1, p2, s1: 0, s2: 0, d1: null, d2: null, idx: -1, num: null, isChamp: false, isGF: false };
  openDartPick(1, p1);
}

// =============================================================================
// DART SELECTION
// =============================================================================

function openDartPick(step, name) {
  G.step = step;
  G.pick = null;
  document.getElementById('dart-step').textContent = 'STEP ' + step + ' OF 2';
  document.getElementById('dart-player').textContent = name;
  document.getElementById('dart-confirm').disabled = true;
  
  document.getElementById('dart-grid').innerHTML = DARTS.map(d => {
    const off = step === 2 && G.d1 && G.d1.id === d.id;
    return `
      <div class="dart-opt ${off ? 'off' : ''}" data-id="${d.id}" onclick="pickDart('${d.id}')">
        <div class="dart-shape" style="background:${d.grad}"></div>
        <div class="dart-label">${d.name}</div>
      </div>
    `;
  }).join('');
  
  showScreen('dart');
}

function pickDart(id) {
  G.pick = DARTS.find(x => x.id === id);
  document.querySelectorAll('.dart-opt').forEach(el => el.classList.toggle('picked', el.dataset.id === id));
  document.getElementById('dart-confirm').disabled = false;
}

function confirmDart() {
  if (!G.pick) return;
  if (G.step === 1) { G.d1 = G.pick; openDartPick(2, G.p2); }
  else { G.d2 = G.pick; beginGame(); }
}

function cancelDart() { showScreen('home'); }

// =============================================================================
// GAMEPLAY
// =============================================================================

function playNext() {
  const n = getNext();
  if (!n) { toast(D.draw.length ? 'All done!' : 'Generate draw first', 'bad'); return; }
  playIdx(n.idx);
}

function playIdx(i) {
  const g = D.draw[i];
  if (!g || g.winner) return;
  G = { p1: g.p1, p2: g.p2, s1: 0, s2: 0, d1: null, d2: null, idx: i, num: g.num, isChamp: true, isGF: g.isGF };
  openDartPick(1, g.p1);
}

function joinLive() {
  if (!D.live || !D.live.active) return;
  const L = D.live;
  G = {
    p1: L.player1, p2: L.player2, s1: L.score1, s2: L.score2,
    d1: DARTS.find(x => x.id === L.color1) || DARTS[0],
    d2: DARTS.find(x => x.id === L.color2) || DARTS[1],
    idx: -1, num: L.gameId, isChamp: L.isChamp, isGF: L.isGF
  };
  setupGameUI();
  startLiveSync();
  showScreen('game');
}

function beginGame() {
  G.s1 = 0; G.s2 = 0;
  setupGameUI();
  if (G.isChamp) { pushLive(); startLiveSync(); document.getElementById('g-live').style.display = 'flex'; }
  else { document.getElementById('g-live').style.display = 'none'; }
  showScreen('game');
}

function setupGameUI() {
  document.getElementById('name1').textContent = G.p1;
  document.getElementById('name2').textContent = G.p2;
  document.getElementById('dart1').style.background = G.d1.grad;
  document.getElementById('dart2').style.background = G.d2.grad;
  document.getElementById('g-target').textContent = D.target;
  
  const lbl = document.getElementById('g-label');
  if (G.isGF) { lbl.textContent = 'üèÜ GRAND FINAL'; lbl.classList.add('gf'); }
  else if (G.isChamp) { lbl.textContent = 'Game ' + G.num; lbl.classList.remove('gf'); }
  else { lbl.textContent = 'Quick Match'; lbl.classList.remove('gf'); }
  
  updateGameUI();
}

function adj(player, amt) {
  if (player === 1) {
    G.s1 = Math.max(0, G.s1 + amt);
    if (G.s1 >= D.target) { G.s1 = D.target; updateGameUI(); win(G.p1); return; }
  } else {
    G.s2 = Math.max(0, G.s2 + amt);
    if (G.s2 >= D.target) { G.s2 = D.target; updateGameUI(); win(G.p2); return; }
  }
  updateGameUI();
  if (G.isChamp) pushLive();
}

function updateGameUI() {
  document.getElementById('sc1').textContent = G.s1;
  document.getElementById('sc2').textContent = G.s2;
  
  const p1 = Math.min(100, (G.s1 / D.target) * 100);
  const p2 = Math.min(100, (G.s2 / D.target) * 100);
  
  document.getElementById('bar1').style.height = p1 + '%';
  document.getElementById('bar1').style.background = G.d1.grad;
  document.getElementById('bar2').style.height = p2 + '%';
  document.getElementById('bar2').style.background = G.d2.grad;
}

function resetGame() {
  if (!confirm('Reset scores to 0-0?')) return;
  G.s1 = 0; G.s2 = 0; updateGameUI();
  if (G.isChamp) pushLive();
}

// =============================================================================
// GAME MENU
// =============================================================================

function openMenu() { document.getElementById('gmenu').classList.add('on'); }
function closeMenu() { document.getElementById('gmenu').classList.remove('on'); }

function endGame() {
  if (!confirm('End without saving?')) return;
  closeMenu(); stopLiveSync(); clearLive();
  D.paused = null; store(KEY_DATA, D);
  showScreen('home'); toast('Game ended', 'good');
}

function pauseGame() {
  closeMenu(); stopLiveSync();
  D.paused = { p1: G.p1, p2: G.p2, s1: G.s1, s2: G.s2, d1: G.d1, d2: G.d2, idx: G.idx, num: G.num, isChamp: G.isChamp, isGF: G.isGF };
  store(KEY_DATA, D);
  toast('Saved', 'good'); showScreen('home');
}

function resumePaused() {
  if (!D.paused) return;
  const p = D.paused;
  G = { p1: p.p1, p2: p.p2, s1: p.s1, s2: p.s2, d1: p.d1, d2: p.d2, idx: p.idx, num: p.num, isChamp: p.isChamp, isGF: p.isGF };
  D.paused = null; store(KEY_DATA, D);
  setupGameUI();
  if (G.isChamp) { pushLive(); startLiveSync(); document.getElementById('g-live').style.display = 'flex'; }
  showScreen('game');
}

// =============================================================================
// WIN
// =============================================================================

function win(name) {
  stopLiveSync();
  document.getElementById('win-name').textContent = name;
  document.getElementById('win-score').textContent = G.s1 + ' - ' + G.s2;
  document.getElementById('win-save').style.display = G.isChamp ? 'inline-block' : 'none';
  document.getElementById('win').classList.add('on');
  confetti();
}

async function saveGame() {
  const winner = G.s1 >= D.target ? G.p1 : G.p2;
  
  if (G.isChamp && G.idx >= 0) {
    const g = D.draw[G.idx];
    g.winner = winner; g.s1 = G.s1; g.s2 = G.s2;
    
    // Update local stats
    updateStats(G.p1, G.p2, winner, G.s1, G.s2, G.isGF);
    
    // Push to cloud
    await apiPost('submitGame', { gameId: g.num, player1: g.p1, player2: g.p2, score1: g.s1, score2: g.s2 });
    
    if (G.isGF) {
      const st = S.find(x => x.name === winner);
      if (st) st.champs = (st.champs || 0) + 1;
      store(KEY_STATS, S);
      toast('üèÜ Champion!', 'good');
    } else {
      checkGF();
      toast('Saved!', 'good');
    }
  }
  
  clearLive();
  D.paused = null;
  store(KEY_DATA, D);
  exitWin();
}

function updateStats(p1, p2, winner, s1, s2, isGF) {
  [p1, p2].forEach(n => {
    let st = S.find(x => x.name === n);
    if (!st) { st = { name: n, gp: 0, w: 0, l: 0, pf: 0, pa: 0, diff: 0, champs: 0 }; S.push(st); }
    if (!isGF) st.gp++;
  });
  const a = S.find(x => x.name === p1), b = S.find(x => x.name === p2);
  if (a) { if (winner === p1) a.w++; else a.l++; a.pf += s1; a.pa += s2; a.diff += s1 - s2; }
  if (b) { if (winner === p2) b.w++; else b.l++; b.pf += s2; b.pa += s1; b.diff += s2 - s1; }
  store(KEY_STATS, S);
}

function checkGF() {
  const reg = D.draw.filter(g => !g.isGF);
  const left = reg.filter(g => !g.winner);
  if (left.length === 0 && !D.gfDone && reg.length > 0) {
    const st = calcStandings();
    if (st.length >= 2) {
      D.gfDone = true;
      D.draw.push({ num: 'GF', p1: st[0].name, p2: st[1].name, s1: null, s2: null, winner: null, isGF: true });
      store(KEY_DATA, D);
      toast('üèÜ Grand Final!', 'good');
    }
  }
}

function rematch() {
  document.getElementById('win').classList.remove('on');
  G.s1 = 0; G.s2 = 0; updateGameUI();
  if (G.isChamp) { pushLive(); startLiveSync(); }
}

function exitWin() { document.getElementById('win').classList.remove('on'); showScreen('home'); }

function confetti() {
  const cols = [G.d1?.color || '#ffd700', G.d2?.color || '#3b82f6', '#22c55e', '#ff4757'];
  for (let i = 0; i < 50; i++) {
    setTimeout(() => {
      const c = document.createElement('div');
      c.className = 'confetti';
      c.style.left = Math.random() * 100 + 'vw';
      c.style.background = cols[Math.floor(Math.random() * cols.length)];
      c.style.animationDuration = (2 + Math.random() * 2) + 's';
      document.body.appendChild(c);
      setTimeout(() => c.remove(), 4000);
    }, i * 30);
  }
}

// =============================================================================
// SETTINGS
// =============================================================================

function renderPlayers() {
  const el = document.getElementById('player-list');
  if (D.players.length === 0) { el.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:20px;">No players yet</div>'; return; }
  el.innerHTML = D.players.map((p, i) => {
    const st = S.find(x => x.name === p) || { gp: 0, w: 0, champs: 0 };
    return `
      <div class="player-row">
        <div class="player-avatar">${p[0].toUpperCase()}</div>
        <div class="player-info">
          <div class="name">${st.champs ? 'üèÜ ' : ''}${p}</div>
          <div class="meta">${st.gp} GP ‚Ä¢ ${st.w} W${st.champs ? ' ‚Ä¢ ' + st.champs + 'x champ' : ''}</div>
        </div>
        <button class="player-del" onclick="delPlayer(${i})">√ó</button>
      </div>
    `;
  }).join('');
}

async function addPlayer() {
  const inp = document.getElementById('inp-player');
  const name = inp.value.trim();
  if (!name) return;
  if (D.players.some(p => p.toLowerCase() === name.toLowerCase())) { toast('Exists!', 'bad'); return; }
  
  D.players.push(name);
  store(KEY_DATA, D);
  
  // Push to cloud
  await apiPost('addPlayer', { playerName: name });
  
  inp.value = '';
  renderPlayers();
  render();
  toast('Added!', 'good');
}

async function addPlayerD() {
  const inp = document.getElementById('d-inp-player');
  const name = inp.value.trim();
  if (!name) return;
  if (D.players.some(p => p.toLowerCase() === name.toLowerCase())) { toast('Exists!', 'bad'); return; }
  
  D.players.push(name);
  store(KEY_DATA, D);
  await apiPost('addPlayer', { playerName: name });
  
  inp.value = '';
  render();
  toast('Added!', 'good');
}

function delPlayer(i) {
  if (!confirm('Remove ' + D.players[i] + '?')) return;
  D.players.splice(i, 1);
  store(KEY_DATA, D);
  renderPlayers();
  render();
}

document.getElementById('inp-player').addEventListener('keypress', e => { if (e.key === 'Enter') addPlayer(); });
document.getElementById('d-inp-player')?.addEventListener('keypress', e => { if (e.key === 'Enter') addPlayerD(); });

async function generateDraw() {
  if (D.players.length < 2) { toast('Need 2+ players', 'bad'); return; }
  if (D.draw.length && !confirm('Replace draw?')) return;
  
  const pairs = [];
  for (let i = 0; i < D.players.length; i++) {
    for (let j = i + 1; j < D.players.length; j++) {
      pairs.push([D.players[i], D.players[j]]);
    }
  }
  for (let i = pairs.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [pairs[i], pairs[j]] = [pairs[j], pairs[i]]; }
  
  D.draw = pairs.map((p, i) => ({ num: i + 1, p1: p[0], p2: p[1], s1: null, s2: null, winner: null, isGF: false }));
  D.gfDone = false;
  D.paused = null;
  store(KEY_DATA, D);
  
  // Push to cloud
  await apiPost('generateDraw', {});
  
  toast(pairs.length + ' games!', 'good');
  render();
  if (window.innerWidth < 900) showScreen('home');
}

async function clearDraw() {
  if (!confirm('Clear draw?')) return;
  D.draw = []; D.gfDone = false; D.paused = null;
  store(KEY_DATA, D);
  await apiPost('newEvent', {});
  toast('Cleared', 'good');
  render();
}

function changeTarget() {
  D.target = parseInt(document.getElementById('sel-target').value) || 21;
  store(KEY_DATA, D);
  render();
  toast('Target: ' + D.target, 'good');
}

function changeTargetD() {
  D.target = parseInt(document.getElementById('d-target').value) || 21;
  document.getElementById('sel-target').value = D.target;
  store(KEY_DATA, D);
  render();
  toast('Target: ' + D.target, 'good');
}

// =============================================================================
// TOAST
// =============================================================================

function toast(msg, type = 'good') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast show ' + type;
  setTimeout(() => t.classList.remove('show'), 2500);
}

// =============================================================================
// DEBUG (triple-tap logo)
// =============================================================================

let logoTaps = 0;
document.querySelectorAll('.logo').forEach(el => {
  el.onclick = () => {
    logoTaps++;
    if (logoTaps >= 3) { document.getElementById('debug').classList.toggle('show'); logoTaps = 0; }
    setTimeout(() => logoTaps = 0, 500);
  };
});

// =============================================================================
// PWA
// =============================================================================

if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js')
      .then(reg => log('SW registered: ' + reg.scope))
      .catch(err => log('SW error: ' + err.message));
  });
}

// =============================================================================
// INIT
// =============================================================================

window.addEventListener('resize', () => render());

// Auto sync every 30s on home screen
setInterval(() => {
  if (document.getElementById('screen-home')?.classList.contains('active') || window.innerWidth >= 900) {
    doSync();
  }
}, 30000);

// Initial
render();
doSync();

log('PopDarts v5.7 loaded');
</script>
</body>
</html>

