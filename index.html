<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="PopDarts">
  <meta name="theme-color" content="#0d0d1a">
  <meta name="description" content="PopDarts - Live multi-device dart scoring">
  <title>PopDarts</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
    
    :root {
      --bg: #0d0d1a;
      --bg-card: #161625;
      --bg-elevated: #1f1f35;
      --border: rgba(255,255,255,0.08);
      --border-light: rgba(255,255,255,0.15);
      --text: #ffffff;
      --text-dim: #a0a0b8;
      --text-muted: #606078;
      --gold: #f5a623;
      --gold-dark: #c78b15;
      --green: #00d68f;
      --red: #ff4757;
      --blue: #3b82f6;
      --purple: #a855f7;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; user-select: none; }
    html, body { font-family: 'Inter', -apple-system, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; min-height: 100dvh; overflow-x: hidden; -webkit-font-smoothing: antialiased; }

    /* ========== LAYOUT ========== */
    .mobile-view { display: block; }
    .desktop-view { display: none; }
    @media (min-width: 1024px) {
      .mobile-view { display: none; }
      .desktop-view { display: grid; grid-template-columns: 300px 1fr 320px; height: 100vh; }
    }

    /* ========== SCREENS ========== */
    .screen { position: fixed; inset: 0; display: none; flex-direction: column; background: var(--bg); z-index: 10; }
    .screen.active { display: flex; }

    /* ========== HEADER ========== */
    .header {
      display: flex; align-items: center; justify-content: space-between;
      padding: calc(12px + var(--safe-top)) 16px 12px;
      background: var(--bg); border-bottom: 1px solid var(--border);
      position: sticky; top: 0; z-index: 50;
    }
    .logo { display: flex; align-items: center; gap: 10px; font-size: 22px; font-weight: 800; }
    .logo-icon { font-size: 26px; }

    /* ========== SYNC BUTTON ========== */
    .sync-btn {
      display: flex; align-items: center; gap: 8px;
      padding: 10px 16px; background: var(--bg-card); border: 1px solid var(--border);
      border-radius: 25px; font-size: 13px; font-weight: 600; color: var(--text-dim); cursor: pointer;
    }
    .sync-btn:active { transform: scale(0.95); }
    .sync-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--red); }
    .sync-dot.busy { background: var(--gold); animation: blink 0.4s infinite alternate; }
    .sync-dot.ok { background: var(--green); }
    @keyframes blink { to { opacity: 0.3; } }

    /* ========== CONTENT ========== */
    .content { flex: 1; overflow-y: auto; padding: 16px; padding-bottom: calc(100px + var(--safe-bottom)); }

    /* ========== CARDS ========== */
    .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 18px; padding: 18px; margin-bottom: 14px; }
    .card-label { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-muted); margin-bottom: 12px; }

    /* ========== LIVE BANNER ========== */
    .live-card {
      background: linear-gradient(135deg, #0a2a18 0%, #082015 100%);
      border: 2px solid var(--green); border-radius: 18px; padding: 18px;
      margin-bottom: 14px; cursor: pointer; animation: glow 2s infinite alternate;
    }
    @keyframes glow { to { box-shadow: 0 0 25px rgba(0,214,143,0.3); } }
    .live-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .live-badge { display: flex; align-items: center; gap: 8px; font-size: 12px; font-weight: 700; letter-spacing: 1px; color: var(--green); }
    .live-pulse { width: 10px; height: 10px; background: var(--green); border-radius: 50%; animation: pulse 1s infinite; }
    @keyframes pulse { 50% { transform: scale(1.3); opacity: 0.5; } }
    .live-join { padding: 10px 18px; background: var(--green); color: #000; font-size: 13px; font-weight: 700; border: none; border-radius: 10px; }
    .live-players { font-size: 18px; font-weight: 700; }
    .live-score { font-size: 36px; font-weight: 900; color: var(--gold); }

    /* ========== PAUSED BANNER ========== */
    .paused-card {
      background: linear-gradient(135deg, #152540 0%, #101830 100%);
      border: 2px solid var(--blue); border-radius: 18px; padding: 16px;
      margin-bottom: 14px; display: flex; align-items: center; justify-content: space-between; cursor: pointer;
    }
    .paused-info .label { font-size: 11px; font-weight: 700; letter-spacing: 1px; color: var(--blue); }
    .paused-info .players { font-size: 15px; font-weight: 700; margin-top: 4px; }
    .paused-info .score { font-size: 12px; color: var(--text-dim); }
    .paused-btn { padding: 10px 18px; background: var(--blue); color: #fff; font-size: 13px; font-weight: 700; border: none; border-radius: 10px; }

    /* ========== HERO ========== */
    .hero {
      background: linear-gradient(145deg, #1a1a30 0%, #252548 100%);
      border: 1px solid var(--border-light); border-radius: 22px; padding: 26px 20px;
      margin-bottom: 16px; text-align: center; position: relative; overflow: hidden;
    }
    .hero::before { content: 'üéØ'; position: absolute; font-size: 100px; opacity: 0.06; right: -15px; top: -15px; }
    .hero-tag { font-size: 12px; font-weight: 700; letter-spacing: 2px; color: var(--gold); margin-bottom: 10px; }
    .hero-match { font-size: 24px; font-weight: 800; line-height: 1.3; }
    .hero-vs { display: block; font-size: 13px; color: var(--text-muted); margin: 6px 0; }
    .hero-btn {
      display: inline-flex; align-items: center; gap: 8px; margin-top: 16px;
      padding: 14px 32px; background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%);
      color: #000; font-size: 16px; font-weight: 800; border: none; border-radius: 50px; cursor: pointer;
    }
    .hero-btn:active { transform: scale(0.97); }
    .hero.gf { border-color: #ffd700; }
    .hero.gf .hero-tag { color: #ffd700; }

    /* ========== QUICK ACTIONS ========== */
    .actions { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 16px; }
    .action-btn {
      background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px;
      padding: 18px 10px; text-align: center; cursor: pointer;
    }
    .action-btn:active { transform: scale(0.97); background: var(--bg-elevated); }
    .action-btn.gold { background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%); border: none; }
    .action-icon { font-size: 28px; margin-bottom: 6px; }
    .action-text { font-size: 12px; font-weight: 700; }
    .action-btn.gold .action-text { color: #000; }

    /* ========== STATS ROW ========== */
    .stats-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 16px; }
    .stat-box { background: var(--bg-card); border: 1px solid var(--border); border-radius: 14px; padding: 14px 8px; text-align: center; }
    .stat-icon { font-size: 18px; margin-bottom: 4px; }
    .stat-val { font-size: 24px; font-weight: 900; color: var(--gold); }
    .stat-name { font-size: 9px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-top: 2px; }

    /* ========== TABS ========== */
    .tabs { display: flex; background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 4px; margin-bottom: 14px; }
    .tab-btn { flex: 1; padding: 10px 6px; text-align: center; font-size: 11px; font-weight: 600; color: var(--text-muted); background: none; border: none; border-radius: 8px; cursor: pointer; }
    .tab-btn.on { background: var(--gold); color: #000; }

    /* ========== TABLE ========== */
    .tbl { width: 100%; border-collapse: collapse; font-size: 12px; }
    .tbl th { padding: 8px 6px; text-align: center; font-size: 9px; font-weight: 700; text-transform: uppercase; color: var(--text-muted); background: rgba(255,255,255,0.03); }
    .tbl th:first-child { text-align: left; padding-left: 10px; border-radius: 8px 0 0 8px; }
    .tbl th:last-child { border-radius: 0 8px 8px 0; }
    .tbl td { padding: 10px 6px; text-align: center; border-bottom: 1px solid var(--border); }
    .tbl td:first-child { text-align: left; padding-left: 10px; font-weight: 600; }
    .tbl tr.top td { background: rgba(245,166,35,0.1); }
    .plus { color: var(--green); }
    .minus { color: var(--red); }

    /* ========== DRAW LIST ========== */
    .draw-row {
      display: flex; align-items: center; gap: 10px; padding: 12px 14px;
      background: var(--bg-card); border: 1px solid var(--border); border-radius: 14px;
      margin-bottom: 8px; cursor: pointer;
    }
    .draw-row:active { background: var(--bg-elevated); }
    .draw-row.done { opacity: 0.5; }
    .draw-row.gf { border-color: #ffd700; background: rgba(255,215,0,0.05); }
    .draw-num { width: 34px; height: 34px; background: var(--bg-elevated); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 800; }
    .draw-row.done .draw-num { background: var(--green); color: #000; }
    .draw-players { flex: 1; font-weight: 600; font-size: 13px; }
    .draw-players .win { color: var(--green); }
    .draw-result { font-size: 14px; font-weight: 800; color: var(--gold); min-width: 45px; text-align: center; }
    .draw-undo { width: 28px; height: 28px; background: rgba(255,71,87,0.15); border: none; border-radius: 6px; color: var(--red); font-size: 14px; cursor: pointer; }

    /* ========== BUTTONS ========== */
    .btn { width: 100%; padding: 14px; border-radius: 12px; border: none; font-family: inherit; font-size: 15px; font-weight: 700; cursor: pointer; margin-bottom: 8px; }
    .btn:active { transform: scale(0.98); }
    .btn-gold { background: var(--gold); color: #000; }
    .btn-gray { background: var(--bg-elevated); color: var(--text); border: 1px solid var(--border); }
    .btn-red { background: rgba(255,71,87,0.15); color: var(--red); border: 1px solid rgba(255,71,87,0.3); }
    .btn-green { background: var(--green); color: #000; }

    /* ========== NAV ========== */
    .nav {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: rgba(13,13,26,0.95); backdrop-filter: blur(20px);
      border-top: 1px solid var(--border); display: flex;
      padding: 6px 16px calc(6px + var(--safe-bottom)); z-index: 100;
    }
    .nav-item { flex: 1; padding: 8px 0; text-align: center; font-size: 10px; font-weight: 600; color: var(--text-muted); background: none; border: none; border-radius: 10px; cursor: pointer; }
    .nav-item.on { color: var(--gold); background: rgba(245,166,35,0.1); }
    .nav-icon { font-size: 20px; display: block; margin-bottom: 2px; }

    /* ========== INPUTS ========== */
    input, select { width: 100%; padding: 12px 14px; background: var(--bg-elevated); border: 1px solid var(--border); color: var(--text); border-radius: 10px; font-family: inherit; font-size: 15px; margin-bottom: 8px; -webkit-appearance: none; }
    input:focus, select:focus { outline: none; border-color: var(--gold); }

    /* ========== PLAYER LIST ========== */
    .player-row { display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border); }
    .player-avatar { width: 38px; height: 38px; background: linear-gradient(135deg, var(--purple), var(--blue)); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 16px; margin-right: 12px; }
    .player-info { flex: 1; }
    .player-info .name { font-weight: 700; font-size: 14px; }
    .player-info .meta { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
    .player-del { width: 32px; height: 32px; background: rgba(255,71,87,0.15); border: none; border-radius: 50%; color: var(--red); font-size: 16px; cursor: pointer; }

    /* ========== EMPTY ========== */
    .empty { text-align: center; padding: 30px 16px; color: var(--text-muted); }
    .empty-icon { font-size: 40px; margin-bottom: 10px; opacity: 0.5; }

    /* ========== TOAST ========== */
    .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: var(--bg-elevated); border: 1px solid var(--border); padding: 12px 20px; border-radius: 12px; font-size: 13px; font-weight: 600; z-index: 700; opacity: 0; transition: opacity 0.3s; }
    .toast.show { opacity: 1; }
    .toast.good { border-left: 4px solid var(--green); }
    .toast.bad { border-left: 4px solid var(--red); }

    /* ========== DART SELECTION ========== */
    .dart-head { padding: calc(18px + var(--safe-top)) 18px 18px; background: var(--bg-card); text-align: center; border-bottom: 1px solid var(--border); position: relative; }
    .dart-back { position: absolute; left: 14px; top: calc(18px + var(--safe-top)); width: 40px; height: 40px; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; color: var(--text); }
    .dart-step { font-size: 11px; font-weight: 700; letter-spacing: 2px; color: var(--gold); margin-bottom: 6px; }
    .dart-name { font-size: 24px; font-weight: 800; }
    .dart-sub { font-size: 13px; color: var(--text-dim); margin-top: 4px; }

    .dart-grid { flex: 1; display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 16px; overflow-y: auto; align-content: start; }
    .dart-opt { background: var(--bg-card); border: 3px solid var(--border); border-radius: 18px; padding: 14px 10px; display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; }
    .dart-opt:active { transform: scale(0.97); }
    .dart-opt.picked { border-color: var(--gold); box-shadow: 0 0 20px rgba(245,166,35,0.4); }
    .dart-opt.off { opacity: 0.25; pointer-events: none; }
    .dart-shape { width: 50px; height: 80px; border-radius: 25px; }
    .dart-label { font-size: 11px; font-weight: 700; text-align: center; }
    .dart-foot { padding: 16px; padding-bottom: calc(16px + var(--safe-bottom)); background: var(--bg); }

    /* ========== GAME SCREEN ========== */
    #screen-game { background: #000; }

    .game-top {
      position: absolute; top: 0; left: 0; right: 0;
      padding: calc(8px + var(--safe-top)) 12px 8px;
      display: flex; justify-content: space-between; align-items: center; z-index: 50;
      background: linear-gradient(180deg, rgba(0,0,0,0.9) 0%, transparent 100%);
    }
    .game-menu-btn { width: 46px; height: 46px; background: rgba(255,255,255,0.1); border: none; border-radius: 12px; color: #fff; font-size: 22px; cursor: pointer; }
    .game-badges { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; justify-content: flex-end; }
    .badge { padding: 6px 12px; background: rgba(0,0,0,0.7); border-radius: 16px; font-size: 11px; font-weight: 700; }
    .badge.target { color: var(--gold); }
    .badge.gf { background: linear-gradient(135deg, #ffd700, #f59e0b); color: #000; }
    .badge.live { background: var(--green); color: #000; display: flex; align-items: center; gap: 5px; }

    /* GAME LAYOUT: Player1 TOP, Player2 BOTTOM - Progress LEFT to RIGHT */
    .game-arena { position: absolute; inset: 0; display: flex; flex-direction: column; }

    .pzone { flex: 1; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 16px; overflow: hidden; }
    .pzone.top { padding-top: 70px; }
    .pzone.bot { padding-bottom: calc(16px + var(--safe-bottom)); }

    /* HORIZONTAL progress bar - LEFT to RIGHT */
    .pbar { position: absolute; top: 0; bottom: 0; left: 0; width: 0%; transition: width 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); z-index: 1; }

    .pui { position: relative; z-index: 10; text-align: center; width: 100%; }
    .phead { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 10px; }
    .pdart { width: 26px; height: 42px; border-radius: 13px; }
    .pname { font-size: 16px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; }

    .score-row { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 12px; }
    .score-btn { width: 58px; height: 58px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.5); color: #fff; font-size: 30px; font-weight: 300; display: flex; align-items: center; justify-content: center; cursor: pointer; }
    .score-btn:active { transform: scale(0.9); background: rgba(255,255,255,0.2); }
    .score-btn.minus { color: var(--red); border-color: rgba(255,71,87,0.4); }
    .score-btn.plus { color: var(--green); border-color: rgba(0,214,143,0.4); }
    .score-big { font-size: 70px; font-weight: 900; line-height: 1; min-width: 100px; }
    @media (max-height: 600px) { .score-big { font-size: 50px; } }

    .quick-row { display: flex; gap: 6px; justify-content: center; }
    .qbtn { width: 46px; height: 40px; border-radius: 10px; border: 2px solid rgba(255,255,255,0.15); background: rgba(0,0,0,0.5); color: #fff; font-size: 14px; font-weight: 700; cursor: pointer; }
    .qbtn:active { transform: scale(0.92); background: rgba(255,255,255,0.15); }

    .game-mid { height: 4px; background: rgba(255,255,255,0.1); position: relative; z-index: 20; }
    .reset-btn { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); width: 46px; height: 46px; background: var(--bg-card); border: 2px solid var(--border); border-radius: 50%; color: var(--text-muted); font-size: 20px; cursor: pointer; z-index: 21; }

    /* ========== GAME MENU ========== */
    .gmenu { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 400; padding: 24px; gap: 12px; }
    .gmenu.on { display: flex; }
    .gmenu h2 { font-size: 24px; margin-bottom: 16px; }
    .gmenu-btn { width: 260px; padding: 16px; border-radius: 14px; border: none; font-size: 16px; font-weight: 700; cursor: pointer; font-family: inherit; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .gmenu-btn.resume { background: var(--green); color: #000; }
    .gmenu-btn.end { background: var(--red); color: #fff; }
    .gmenu-btn.save { background: var(--bg-elevated); color: #fff; border: 1px solid var(--border); }

    /* ========== WIN ========== */
    .win { position: fixed; inset: 0; background: linear-gradient(145deg, #0d0d1a 0%, #1a1a35 50%, #0d1520 100%); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 500; padding: 24px; }
    .win.on { display: flex; }
    .win-trophy { font-size: 90px; animation: bounce 0.6s infinite alternate; }
    @keyframes bounce { to { transform: translateY(-10px) scale(1.05); } }
    .win-tag { font-size: 13px; letter-spacing: 3px; color: var(--gold); margin-top: 14px; }
    .win-name { font-size: 38px; font-weight: 900; margin-top: 6px; text-align: center; }
    .win-score { font-size: 24px; color: var(--text-dim); margin-top: 6px; }
    .win-btns { display: flex; gap: 10px; margin-top: 24px; flex-wrap: wrap; justify-content: center; }
    .win-btn { padding: 14px 24px; border-radius: 12px; border: none; font-size: 15px; font-weight: 700; cursor: pointer; font-family: inherit; }
    .win-btn.save { background: var(--green); color: #000; }
    .win-btn.again { background: var(--gold); color: #000; }
    .win-btn.exit { background: var(--bg-elevated); color: #fff; }

    .confetti { position: fixed; width: 10px; height: 10px; top: -20px; animation: fall 3s linear forwards; z-index: 501; border-radius: 2px; }
    @keyframes fall { to { transform: translateY(100vh) rotate(720deg); } }

    /* ========== HISTORY MODAL ========== */
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; flex-direction: column; z-index: 450; padding: calc(20px + var(--safe-top)) 16px calc(20px + var(--safe-bottom)); }
    .modal.on { display: flex; }
    .modal-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .modal-title { font-size: 20px; font-weight: 800; }
    .modal-close { width: 40px; height: 40px; background: var(--bg-elevated); border: none; border-radius: 10px; color: var(--text); font-size: 20px; cursor: pointer; }
    .modal-body { flex: 1; overflow-y: auto; }
    .history-item { padding: 12px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 10px; }
    .history-item .time { font-size: 10px; color: var(--text-muted); margin-bottom: 4px; }
    .history-item .action { font-size: 13px; font-weight: 600; }
    .history-item .detail { font-size: 12px; color: var(--text-dim); margin-top: 2px; }
    .history-item .undo-btn { margin-top: 8px; padding: 8px 14px; background: rgba(255,71,87,0.15); border: none; border-radius: 8px; color: var(--red); font-size: 12px; font-weight: 600; cursor: pointer; }

    /* ========== DESKTOP VIEW ========== */
    .d-panel { background: var(--bg-card); border-right: 1px solid var(--border); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
    .d-panel:last-child { border-right: none; border-left: 1px solid var(--border); }
    .d-head { padding: 14px 18px; border-bottom: 1px solid var(--border); background: var(--bg); display: flex; align-items: center; justify-content: space-between; }
    .d-head h2 { font-size: 15px; font-weight: 800; display: flex; align-items: center; gap: 8px; }
    .d-body { flex: 1; overflow-y: auto; padding: 14px; }
    .d-section { margin-bottom: 18px; }
    .d-section-title { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-muted); margin-bottom: 10px; }

    .d-center { background: var(--bg); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

    /* Desktop game area */
    .d-game-container { flex: 1; display: flex; flex-direction: column; background: #000; border-radius: 16px; margin: 14px; overflow: hidden; position: relative; }
    .d-game-header { padding: 14px; background: rgba(0,0,0,0.8); display: flex; justify-content: space-between; align-items: center; position: absolute; top: 0; left: 0; right: 0; z-index: 10; }
    .d-game-arena { flex: 1; display: flex; flex-direction: column; }

    /* Desktop Hero */
    .d-hero { background: linear-gradient(145deg, #1a1a30 0%, #252548 100%); border: 1px solid var(--border-light); border-radius: 18px; padding: 24px; text-align: center; margin-bottom: 16px; }
    .d-hero.gf { border-color: #ffd700; }

    /* Desktop Live */
    .d-live { background: linear-gradient(135deg, #0a2a18 0%, #082015 100%); border: 2px solid var(--green); border-radius: 16px; padding: 18px; margin-bottom: 16px; display: flex; align-items: center; justify-content: space-between; animation: glow 2s infinite alternate; cursor: pointer; }

    /* Desktop Stats */
    .d-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 16px; }
    .d-stat { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 12px 8px; text-align: center; }
    .d-stat .stat-val { font-size: 22px; }

    /* Desktop Draw */
    .d-draw-row { display: flex; align-items: center; gap: 8px; padding: 8px 10px; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 10px; margin-bottom: 6px; cursor: pointer; font-size: 12px; }
    .d-draw-row:hover { background: var(--bg-card); }
    .d-draw-row.done { opacity: 0.5; }
    .d-draw-row.gf { border-color: #ffd700; }
    .d-draw-num { width: 26px; height: 26px; background: var(--bg-card); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 800; }
    .d-draw-row.done .d-draw-num { background: var(--green); color: #000; }
    .d-draw-players { flex: 1; font-weight: 600; }
    .d-draw-score { font-weight: 800; color: var(--gold); min-width: 36px; text-align: center; }
    .d-draw-undo { width: 22px; height: 22px; background: rgba(255,71,87,0.15); border: none; border-radius: 4px; color: var(--red); font-size: 12px; cursor: pointer; }
  </style>
</head>
<body>

<!-- ==================== MOBILE VIEW ==================== -->
<div class="mobile-view">

  <!-- HOME -->
  <div id="screen-home" class="screen active">
    <div class="header">
      <div class="logo"><span class="logo-icon">üéØ</span>PopDarts</div>
      <button class="sync-btn" onclick="doSync()">
        <span class="sync-dot" id="sdot1"></span>
        <span id="stxt1">Sync</span>
      </button>
    </div>
    <div class="content">
      <div id="live-zone"></div>
      <div id="paused-zone"></div>
      <div id="hero-zone"></div>
      
      <div class="actions">
        <div class="action-btn gold" onclick="playNext()"><div class="action-icon">‚ñ∂Ô∏è</div><div class="action-text">Play</div></div>
        <div class="action-btn" onclick="openCustom()"><div class="action-icon">üéÆ</div><div class="action-text">Quick</div></div>
        <div class="action-btn" onclick="generateDraw()"><div class="action-icon">üé≤</div><div class="action-text">Draw</div></div>
      </div>
      
      <div class="stats-row">
        <div class="stat-box"><div class="stat-icon">üë•</div><div class="stat-val" id="st-players">0</div><div class="stat-name">Players</div></div>
        <div class="stat-box"><div class="stat-icon">üéØ</div><div class="stat-val" id="st-games">0/0</div><div class="stat-name">Games</div></div>
        <div class="stat-box"><div class="stat-icon">üèÜ</div><div class="stat-val" id="st-target">21</div><div class="stat-name">Target</div></div>
      </div>
      
      <div class="tabs">
        <button class="tab-btn on" onclick="switchTab('draw',this)">üìã Draw</button>
        <button class="tab-btn" onclick="switchTab('standings',this)">üìä Standings</button>
        <button class="tab-btn" onclick="switchTab('alltime',this)">üèÜ All-Time</button>
      </div>
      <div id="tab-draw"></div>
      <div id="tab-standings" style="display:none"></div>
      <div id="tab-alltime" style="display:none"></div>
    </div>
  </div>

  <!-- SETTINGS -->
  <div id="screen-settings" class="screen">
    <div class="header">
      <div class="logo"><span class="logo-icon">‚öôÔ∏è</span>Settings</div>
      <button class="sync-btn" onclick="doSync()">
        <span class="sync-dot" id="sdot2"></span>
        <span id="stxt2">Sync</span>
      </button>
    </div>
    <div class="content">
      <div class="card">
        <div class="card-label">‚òÅÔ∏è Cloud Sync</div>
        <p style="font-size:12px;color:var(--text-dim);margin-bottom:12px;">All devices share data via Google Sheets</p>
        <button class="btn btn-gray" onclick="doSync()">üîÑ Sync Now</button>
        <div style="font-size:10px;color:var(--text-muted);margin-top:8px;">Last: <span id="last-sync">Never</span></div>
      </div>
      <div class="card">
        <div class="card-label">üë• Players</div>
        <div style="display:flex;gap:8px;margin-bottom:12px;">
          <input type="text" id="inp-player" placeholder="Player name..." style="margin:0;flex:1">
          <button class="btn btn-green" style="width:auto;margin:0;padding:12px 18px;" onclick="addPlayer()">+</button>
        </div>
        <div id="player-list"></div>
      </div>
      <div class="card">
        <div class="card-label">üèÜ Championship</div>
        <button class="btn btn-gold" onclick="generateDraw()">üé≤ Generate New Draw</button>
        <button class="btn btn-red" onclick="clearDraw()">Clear Draw</button>
      </div>
      <div class="card">
        <div class="card-label">üéØ Target Score</div>
        <select id="sel-target" onchange="changeTarget()">
          <option value="11">First to 11</option>
          <option value="15">First to 15</option>
          <option value="21" selected>First to 21</option>
          <option value="31">First to 31</option>
        </select>
      </div>
      <div class="card">
        <div class="card-label">üìú History</div>
        <button class="btn btn-gray" onclick="openHistory()">View Game History</button>
      </div>
    </div>
  </div>

  <!-- CUSTOM -->
  <div id="screen-custom" class="screen">
    <div class="header">
      <button class="sync-btn" onclick="showScreen('home')" style="padding:10px 14px;">‚Üê Back</button>
      <div class="logo" style="font-size:17px;">Quick Match</div>
      <div style="width:70px"></div>
    </div>
    <div class="content">
      <div class="card"><div class="card-label">Player 1</div><select id="sel-p1"></select></div>
      <div class="card"><div class="card-label">Player 2</div><select id="sel-p2"></select></div>
      <button class="btn btn-gold" onclick="startCustom()">üéÆ Start Match</button>
      <p style="font-size:11px;color:var(--text-muted);text-align:center;margin-top:12px;">Quick matches don't affect stats</p>
    </div>
  </div>

  <!-- DART SELECTION -->
  <div id="screen-dart" class="screen">
    <div class="dart-head">
      <button class="dart-back" onclick="cancelDart()">‚Üê</button>
      <div class="dart-step" id="dart-step">STEP 1 OF 2</div>
      <h2 class="dart-name" id="dart-player">Player 1</h2>
      <p class="dart-sub">Pick your dart</p>
    </div>
    <div class="dart-grid" id="dart-grid"></div>
    <div class="dart-foot">
      <button class="btn btn-green" id="dart-confirm" onclick="confirmDart()" disabled>Select Dart</button>
    </div>
  </div>

  <!-- GAME -->
  <div id="screen-game" class="screen">
    <div class="game-top">
      <button class="game-menu-btn" onclick="openMenu()">‚ò∞</button>
      <div class="game-badges">
        <div class="badge" id="g-label">Game 1</div>
        <div class="badge live" id="g-live" style="display:none"><span class="live-pulse" style="width:6px;height:6px;background:#000;"></span>LIVE</div>
        <div class="badge target">To: <span id="g-target">21</span></div>
      </div>
    </div>
    <div class="game-arena">
      <div class="pzone top" id="zone1">
        <div class="pbar" id="bar1"></div>
        <div class="pui">
          <div class="phead"><div class="pdart" id="dart1"></div><span class="pname" id="name1">Player 1</span></div>
          <div class="score-row">
            <button class="score-btn minus" onclick="adj(1,-1)">‚àí</button>
            <div class="score-big" id="sc1">0</div>
            <button class="score-btn plus" onclick="adj(1,1)">+</button>
          </div>
          <div class="quick-row">
            <button class="qbtn" onclick="adj(1,2)">+2</button>
            <button class="qbtn" onclick="adj(1,3)">+3</button>
            <button class="qbtn" onclick="adj(1,4)">+4</button>
            <button class="qbtn" onclick="adj(1,5)">+5</button>
          </div>
        </div>
      </div>
      <div class="game-mid"><button class="reset-btn" onclick="resetGame()">‚Ü∫</button></div>
      <div class="pzone bot" id="zone2">
        <div class="pbar" id="bar2"></div>
        <div class="pui">
          <div class="phead"><div class="pdart" id="dart2"></div><span class="pname" id="name2">Player 2</span></div>
          <div class="score-row">
            <button class="score-btn minus" onclick="adj(2,-1)">‚àí</button>
            <div class="score-big" id="sc2">0</div>
            <button class="score-btn plus" onclick="adj(2,1)">+</button>
          </div>
          <div class="quick-row">
            <button class="qbtn" onclick="adj(2,2)">+2</button>
            <button class="qbtn" onclick="adj(2,3)">+3</button>
            <button class="qbtn" onclick="adj(2,4)">+4</button>
            <button class="qbtn" onclick="adj(2,5)">+5</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- NAV -->
  <nav class="nav" id="nav">
    <button class="nav-item on" data-s="home"><span class="nav-icon">üè†</span>Home</button>
    <button class="nav-item" data-s="settings"><span class="nav-icon">‚öôÔ∏è</span>Settings</button>
  </nav>
</div>

<!-- ==================== DESKTOP VIEW ==================== -->
<div class="desktop-view">
  <!-- LEFT -->
  <div class="d-panel">
    <div class="d-head">
      <h2>üéØ PopDarts</h2>
      <button class="sync-btn" onclick="doSync()" style="padding:8px 12px;font-size:11px;">
        <span class="sync-dot" id="sdot3"></span>
        <span id="stxt3">Sync</span>
      </button>
    </div>
    <div class="d-body">
      <div class="d-section">
        <div class="d-section-title">üë• Players</div>
        <div style="display:flex;gap:6px;margin-bottom:10px;">
          <input type="text" id="d-inp-player" placeholder="Add player..." style="margin:0;flex:1;padding:10px;font-size:13px;">
          <button class="btn btn-green" style="width:auto;margin:0;padding:10px 14px;font-size:13px;" onclick="addPlayerD()">+</button>
        </div>
        <div id="d-player-list"></div>
      </div>
      <div class="d-section">
        <div class="d-section-title">üìã Draw</div>
        <div id="d-draw"></div>
      </div>
      <div class="d-section">
        <button class="btn btn-gold" style="font-size:13px;padding:10px;" onclick="generateDraw()">üé≤ Generate Draw</button>
        <button class="btn btn-gray" style="font-size:13px;padding:10px;" onclick="clearDraw()">Clear Draw</button>
        <button class="btn btn-gray" style="font-size:13px;padding:10px;" onclick="openHistory()">üìú History</button>
      </div>
    </div>
  </div>

  <!-- CENTER - GAME AREA -->
  <div class="d-center">
    <div class="d-head">
      <h2>üéÆ Game Arena</h2>
      <select id="d-target" onchange="changeTargetD()" style="width:auto;margin:0;padding:8px 12px;font-size:13px;">
        <option value="11">To 11</option><option value="15">To 15</option><option value="21" selected>To 21</option><option value="31">To 31</option>
      </select>
    </div>
    <div id="d-game-area" style="flex:1;padding:14px;overflow-y:auto;"></div>
  </div>

  <!-- RIGHT -->
  <div class="d-panel">
    <div class="d-head"><h2>üìä Standings</h2></div>
    <div class="d-body">
      <div class="d-section">
        <div class="d-section-title">Current Championship</div>
        <div id="d-standings"></div>
      </div>
      <div class="d-section">
        <div class="d-section-title">üèÜ All-Time Stats</div>
        <div id="d-alltime"></div>
      </div>
    </div>
  </div>
</div>

<!-- GAME MENU -->
<div class="gmenu" id="gmenu">
  <h2>‚è∏Ô∏è Game Paused</h2>
  <button class="gmenu-btn resume" onclick="closeMenu()">‚ñ∂Ô∏è Resume</button>
  <button class="gmenu-btn end" onclick="endGame()">‚ùå End Game</button>
  <button class="gmenu-btn save" onclick="pauseGame()">üíæ Save & Exit</button>
</div>

<!-- WIN -->
<div class="win" id="win">
  <div class="win-trophy">üèÜ</div>
  <div class="win-tag">üéâ WINNER üéâ</div>
  <div class="win-name" id="win-name">Player</div>
  <div class="win-score" id="win-score">21 - 15</div>
  <div class="win-btns">
    <button class="win-btn save" id="win-save" onclick="saveGame()">üíæ Save</button>
    <button class="win-btn again" onclick="rematch()">üîÑ Again</button>
    <button class="win-btn exit" onclick="exitWin()">‚úï Exit</button>
  </div>
</div>

<!-- HISTORY MODAL -->
<div class="modal" id="history-modal">
  <div class="modal-head">
    <div class="modal-title">üìú Game History</div>
    <button class="modal-close" onclick="closeHistory()">√ó</button>
  </div>
  <div class="modal-body" id="history-list"></div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// =============================================================================
// POPDARTS v5.8 - COMPLETE FIX
// =============================================================================

const API = 'https://script.google.com/macros/s/AKfycbzmdLog_tuyJMAE9hCLvfrsVT67LtwvLUOrrESZhUj0pBcbO6eFeajzKocXWfgQ9_MNTA/exec';

// DARTS
const DARTS = [
  { id: 'black-green', name: 'Black & Green', grad: 'linear-gradient(90deg, #1a1a1a 0%, #22c55e 25%, #1a1a1a 50%, #22c55e 75%, #1a1a1a 100%)', color: '#22c55e' },
  { id: 'tropical', name: 'Tropical', grad: 'linear-gradient(90deg, #f97316 0%, #0891b2 33%, #ec4899 66%, #f97316 100%)', color: '#f97316' },
  { id: 'black-blue', name: 'Black & Blue', grad: 'linear-gradient(90deg, #1a1a1a 0%, #3b82f6 30%, #1a1a1a 60%, #3b82f6 100%)', color: '#3b82f6' },
  { id: 'white-purple', name: 'White & Purple', grad: 'linear-gradient(90deg, #f0f0f0 0%, #a855f7 25%, #f0f0f0 50%, #a855f7 75%, #f0f0f0 100%)', color: '#a855f7' },
  { id: 'cyan', name: 'Solid Cyan', grad: '#06b6d4', color: '#06b6d4' },
  { id: 'white-teal', name: 'White & Teal', grad: 'linear-gradient(90deg, #f0f0f0 0%, #14b8a6 30%, #f0f0f0 60%, #14b8a6 100%)', color: '#14b8a6' },
  { id: 'lime', name: 'Neon Lime', grad: '#84cc16', color: '#84cc16' }
];

// Storage
const KEY = 'popdarts58';
const HKEY = 'popdarts58_history';

// State
let D = load(KEY) || { players: [], draw: [], target: 21, paused: null, gfDone: false, alltime: [] };
let H = load(HKEY) || []; // History
let G = {}; // Current game
let liveTimer = null;
let isDesktop = window.innerWidth >= 1024;

function load(k) { try { return JSON.parse(localStorage.getItem(k)); } catch { return null; } }
function store(k, v) { localStorage.setItem(k, JSON.stringify(v)); }

// =============================================================================
// HISTORY - Track all changes for undo
// =============================================================================

function addHistory(action, detail, undoData) {
  H.unshift({
    time: new Date().toISOString(),
    action,
    detail,
    undo: undoData
  });
  if (H.length > 100) H.pop();
  store(HKEY, H);
}

function undoHistory(idx) {
  const h = H[idx];
  if (!h || !h.undo) return;
  
  if (h.undo.type === 'game') {
    // Restore game to incomplete
    const g = D.draw.find(x => x.num === h.undo.gameNum);
    if (g) {
      g.winner = null;
      g.s1 = null;
      g.s2 = null;
      
      // Revert stats
      if (h.undo.stats) {
        h.undo.stats.forEach(s => {
          const at = D.alltime.find(x => x.name === s.name);
          if (at) {
            at.gp = Math.max(0, at.gp - 1);
            at.w = Math.max(0, at.w - (s.won ? 1 : 0));
            at.l = Math.max(0, at.l - (s.won ? 0 : 1));
            at.pf -= s.pf;
            at.pa -= s.pa;
            at.diff = at.pf - at.pa;
          }
        });
      }
      
      store(KEY, D);
      H.splice(idx, 1);
      store(HKEY, H);
      toast('Game undone!', 'good');
      render();
    }
  }
}

// =============================================================================
// SYNC - Cloud communication
// =============================================================================

async function doSync() {
  setSyncUI('busy');
  
  try {
    // FETCH ALL DATA
    const [pRes, sRes, dRes, lgRes] = await Promise.all([
      fetch(API + '?action=players').then(r => r.json()),
      fetch(API + '?action=stats').then(r => r.json()),
      fetch(API + '?action=draw').then(r => r.json()),
      fetch(API + '?action=liveGame').then(r => r.json())
    ]);
    
    // PLAYERS - Cloud is master
    if (pRes.success && pRes.data?.players) {
      D.players = pRes.data.players.filter(p => p && p.trim());
    }
    
    // STATS - Merge with all-time (keep higher values)
    if (sRes.success && sRes.data?.stats) {
      sRes.data.stats.forEach(cloud => {
        let local = D.alltime.find(x => x.name === cloud.name);
        if (!local) {
          local = { name: cloud.name, gp: 0, w: 0, l: 0, pf: 0, pa: 0, diff: 0, champs: 0 };
          D.alltime.push(local);
        }
        // Take higher values (cloud may have more complete data)
        if ((cloud.gamesPlayed || 0) > local.gp) {
          local.gp = cloud.gamesPlayed || 0;
          local.w = cloud.wins || 0;
          local.l = cloud.losses || 0;
          local.pf = cloud.pointsFor || 0;
          local.pa = cloud.pointsAgainst || 0;
          local.diff = cloud.pointsDiff || 0;
          local.champs = cloud.championships || 0;
        }
      });
    }
    
    // DRAW - Cloud is master
    if (dRes.success && dRes.data?.games) {
      D.draw = dRes.data.games.map(g => ({
        num: g.gameNum,
        p1: g.player1,
        p2: g.player2,
        s1: g.score1,
        s2: g.score2,
        winner: g.winner || null,
        isGF: g.gameNum === 'GF'
      }));
      
      // Add grand final if exists
      if (dRes.data.grandFinal && !D.draw.find(x => x.isGF)) {
        const gf = dRes.data.grandFinal;
        D.draw.push({ num: 'GF', p1: gf.player1, p2: gf.player2, s1: gf.score1, s2: gf.score2, winner: gf.winner, isGF: true });
      }
      
      if (dRes.data.targetScore) D.target = dRes.data.targetScore;
    }
    
    // LIVE GAME
    D.live = (lgRes.success && lgRes.data?.active) ? lgRes.data : null;
    
    store(KEY, D);
    setSyncUI('ok');
    document.getElementById('last-sync').textContent = new Date().toLocaleTimeString();
    toast('Synced!', 'good');
    render();
    
  } catch (err) {
    console.error('Sync error:', err);
    setSyncUI('err');
    toast('Sync failed', 'bad');
  }
}

function setSyncUI(state) {
  ['sdot1', 'sdot2', 'sdot3'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.className = 'sync-dot' + (state === 'busy' ? ' busy' : state === 'ok' ? ' ok' : '');
  });
  ['stxt1', 'stxt2', 'stxt3'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.textContent = state === 'busy' ? '...' : state === 'ok' ? 'OK' : 'Err';
  });
}

async function apiPost(action, data) {
  try {
    const res = await fetch(API, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({ action, ...data })
    });
    return await res.json();
  } catch (err) {
    console.error('API error:', err);
    return { success: false };
  }
}

async function pushLive() {
  if (!G.p1) return;
  await apiPost('updateLiveGame', {
    active: true,
    gameId: G.num || 'custom',
    player1: G.p1,
    player2: G.p2,
    score1: G.s1,
    score2: G.s2,
    color1: G.d1?.id || '',
    color2: G.d2?.id || '',
    target: D.target,
    isChamp: G.isChamp,
    isGF: G.isGF
  });
}

async function clearLive() {
  await apiPost('clearLiveGame', {});
  D.live = null;
}

async function pullLive() {
  try {
    const res = await fetch(API + '?action=liveGame');
    const json = await res.json();
    if (json.success && json.data?.active) {
      if (json.data.score1 !== G.s1 || json.data.score2 !== G.s2) {
        G.s1 = json.data.score1;
        G.s2 = json.data.score2;
        updateGameUI();
      }
    }
  } catch (e) {}
}

function startLiveSync() {
  stopLiveSync();
  liveTimer = setInterval(pullLive, 2000); // 2 second polling
}

function stopLiveSync() {
  if (liveTimer) { clearInterval(liveTimer); liveTimer = null; }
}

// =============================================================================
// NAVIGATION
// =============================================================================

document.querySelectorAll('.nav-item').forEach(btn => {
  btn.onclick = () => showScreen(btn.dataset.s);
});

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('screen-' + id)?.classList.add('active');
  document.querySelectorAll('.nav-item').forEach(b => b.classList.toggle('on', b.dataset.s === id));
  document.getElementById('nav').style.display = ['game', 'dart', 'custom'].includes(id) ? 'none' : 'flex';
  if (id === 'home') render();
  if (id === 'settings') { document.getElementById('sel-target').value = D.target; renderPlayers(); }
}

function switchTab(t, btn) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('on'));
  btn.classList.add('on');
  ['draw', 'standings', 'alltime'].forEach(x => {
    document.getElementById('tab-' + x).style.display = x === t ? 'block' : 'none';
  });
}

// =============================================================================
// RENDER
// =============================================================================

function render() {
  const stand = calcStandings();
  const done = D.draw.filter(g => !g.isGF && g.winner).length;
  const total = D.draw.filter(g => !g.isGF).length;
  
  document.getElementById('st-players').textContent = D.players.length;
  document.getElementById('st-games').textContent = total > 0 ? done + '/' + total : '0';
  document.getElementById('st-target').textContent = D.target;
  
  renderLive();
  renderPaused();
  renderHero();
  renderDraw();
  renderStandings(stand);
  renderAllTime();
  
  if (isDesktop) renderDesktop(stand);
}

function renderLive() {
  const el = document.getElementById('live-zone');
  if (!D.live || !D.live.active) { el.innerHTML = ''; return; }
  const L = D.live;
  el.innerHTML = `
    <div class="live-card" onclick="joinLive()">
      <div class="live-top">
        <div class="live-badge"><span class="live-pulse"></span>LIVE GAME</div>
        <button class="live-join">Join</button>
      </div>
      <div class="live-players">${L.player1} vs ${L.player2}</div>
      <div class="live-score">${L.score1} - ${L.score2}</div>
    </div>
  `;
}

function renderPaused() {
  const el = document.getElementById('paused-zone');
  if (!D.paused) { el.innerHTML = ''; return; }
  const P = D.paused;
  el.innerHTML = `
    <div class="paused-card" onclick="resumePaused()">
      <div class="paused-info">
        <div class="label">‚è∏ PAUSED</div>
        <div class="players">${P.p1} vs ${P.p2}</div>
        <div class="score">${P.s1} - ${P.s2}</div>
      </div>
      <button class="paused-btn">Resume</button>
    </div>
  `;
}

function renderHero() {
  const el = document.getElementById('hero-zone');
  const next = getNext();
  
  // Show empty state only if no draw AND no players
  if (D.draw.length === 0) {
    el.innerHTML = `
      <div class="hero">
        <div class="hero-tag" style="color:var(--text-muted)">NO CHAMPIONSHIP</div>
        <div class="hero-match">${D.players.length < 2 ? 'Add players first' : 'Tap Draw to generate games'}</div>
      </div>
    `;
    return;
  }
  
  if (!next) {
    el.innerHTML = `<div class="hero"><div class="hero-tag">üéâ COMPLETE</div><div class="hero-match">All games finished!</div></div>`;
    return;
  }
  
  const g = next.game;
  el.innerHTML = `
    <div class="hero ${g.isGF ? 'gf' : ''}">
      <div class="hero-tag">${g.isGF ? 'üèÜ GRAND FINAL üèÜ' : 'GAME ' + g.num}</div>
      <div class="hero-match">${g.p1}<span class="hero-vs">vs</span>${g.p2}</div>
      <button class="hero-btn" onclick="playNext()">‚ñ∂Ô∏è Play Now</button>
    </div>
  `;
}

function renderDraw() {
  const el = document.getElementById('tab-draw');
  if (D.draw.length === 0) { el.innerHTML = '<div class="empty"><div class="empty-icon">üìã</div><div>No games yet</div></div>'; return; }
  
  el.innerHTML = D.draw.map((g, i) => `
    <div class="draw-row ${g.winner ? 'done' : ''} ${g.isGF ? 'gf' : ''}" onclick="${g.winner ? '' : 'playIdx(' + i + ')'}">
      <div class="draw-num">${g.isGF ? 'üèÜ' : g.num}</div>
      <div class="draw-players"><span class="${g.winner === g.p1 ? 'win' : ''}">${g.p1}</span> vs <span class="${g.winner === g.p2 ? 'win' : ''}">${g.p2}</span></div>
      <div class="draw-result">${g.winner ? g.s1 + '-' + g.s2 : '‚Äî'}</div>
      ${g.winner ? `<button class="draw-undo" onclick="event.stopPropagation();undoGame(${i})">‚Ü©</button>` : ''}
    </div>
  `).join('');
}

function renderStandings(stand) {
  const el = document.getElementById('tab-standings');
  if (!stand.length) { el.innerHTML = '<div class="empty"><div class="empty-icon">üìä</div><div>No standings yet</div></div>'; return; }
  el.innerHTML = `<table class="tbl"><thead><tr><th>Player</th><th>W</th><th>L</th><th>PF</th><th>PA</th><th>+/-</th></tr></thead><tbody>${stand.map((p, i) => `<tr class="${i === 0 ? 'top' : ''}"><td>${i === 0 ? 'üëë ' : ''}${p.name}</td><td>${p.w}</td><td>${p.l}</td><td>${p.pf}</td><td>${p.pa}</td><td class="${p.diff > 0 ? 'plus' : p.diff < 0 ? 'minus' : ''}">${p.diff > 0 ? '+' : ''}${p.diff}</td></tr>`).join('')}</tbody></table>`;
}

function renderAllTime() {
  const el = document.getElementById('tab-alltime');
  // Combine current standings into all-time view
  const current = calcStandings();
  const combined = new Map();
  
  // Add all-time first
  D.alltime.forEach(a => combined.set(a.name, { ...a }));
  
  // Add/update with current championship (but don't double count completed games)
  // This shows what all-time WILL look like after championship
  
  const sorted = [...combined.values()].sort((a, b) => (b.champs || 0) - (a.champs || 0) || b.w - a.w);
  
  if (!sorted.length) { el.innerHTML = '<div class="empty"><div class="empty-icon">üèÜ</div><div>No stats yet</div></div>'; return; }
  
  el.innerHTML = `<table class="tbl"><thead><tr><th>Player</th><th>GP</th><th>W</th><th>L</th><th>%</th><th>üèÜ</th></tr></thead><tbody>${sorted.map((s, i) => `<tr class="${s.champs > 0 && i === 0 ? 'top' : ''}"><td>${s.name}</td><td>${s.gp}</td><td>${s.w}</td><td>${s.l}</td><td>${s.gp ? Math.round(s.w / s.gp * 100) : 0}%</td><td style="color:${s.champs ? '#ffd700' : 'var(--text-muted)'}">${s.champs || 0}</td></tr>`).join('')}</tbody></table>`;
}

function renderDesktop(stand) {
  // Players
  document.getElementById('d-player-list').innerHTML = D.players.length === 0 
    ? '<div style="color:var(--text-muted);padding:10px 0;font-size:12px;">No players</div>'
    : D.players.map(p => `<div style="padding:6px 0;border-bottom:1px solid var(--border);font-size:12px;font-weight:600;">${p}</div>`).join('');
  
  // Draw with undo buttons
  document.getElementById('d-draw').innerHTML = D.draw.length === 0
    ? '<div style="color:var(--text-muted);padding:10px 0;font-size:12px;">No draw</div>'
    : D.draw.map((g, i) => `
      <div class="d-draw-row ${g.winner ? 'done' : ''} ${g.isGF ? 'gf' : ''}" onclick="${g.winner ? '' : 'playIdx(' + i + ')'}">
        <div class="d-draw-num">${g.isGF ? 'üèÜ' : g.num}</div>
        <div class="d-draw-players">${g.p1} vs ${g.p2}</div>
        <div class="d-draw-score">${g.winner ? g.s1 + '-' + g.s2 : '‚Äî'}</div>
        ${g.winner ? `<button class="d-draw-undo" onclick="event.stopPropagation();undoGame(${i})">‚Ü©</button>` : ''}
      </div>
    `).join('');
  
  // Standings
  document.getElementById('d-standings').innerHTML = stand.length === 0
    ? '<div style="color:var(--text-muted);font-size:12px;">No standings</div>'
    : `<table class="tbl" style="font-size:11px;"><thead><tr><th>Player</th><th>W</th><th>L</th><th>+/-</th></tr></thead><tbody>${stand.map((p, i) => `<tr class="${i === 0 ? 'top' : ''}"><td>${i === 0 ? 'üëë ' : ''}${p.name}</td><td>${p.w}</td><td>${p.l}</td><td class="${p.diff > 0 ? 'plus' : p.diff < 0 ? 'minus' : ''}">${p.diff > 0 ? '+' : ''}${p.diff}</td></tr>`).join('')}</tbody></table>`;
  
  // All-time
  const sorted = [...D.alltime].sort((a, b) => (b.champs || 0) - (a.champs || 0) || b.w - a.w);
  document.getElementById('d-alltime').innerHTML = sorted.length === 0
    ? '<div style="color:var(--text-muted);font-size:12px;">No stats</div>'
    : `<table class="tbl" style="font-size:11px;"><thead><tr><th>Player</th><th>W</th><th>%</th><th>üèÜ</th></tr></thead><tbody>${sorted.map(s => `<tr><td>${s.name}</td><td>${s.w}</td><td>${s.gp ? Math.round(s.w / s.gp * 100) : 0}%</td><td style="color:${s.champs ? '#ffd700' : 'var(--text-muted)'}">${s.champs || 0}</td></tr>`).join('')}</tbody></table>`;
  
  // Game area
  renderDesktopGame();
}

function renderDesktopGame() {
  const el = document.getElementById('d-game-area');
  
  // Show live game if exists
  if (D.live && D.live.active) {
    const L = D.live;
    el.innerHTML = `
      <div class="d-live" onclick="joinLive()">
        <div>
          <div class="live-badge" style="margin-bottom:6px;"><span class="live-pulse"></span>LIVE GAME</div>
          <div class="live-players" style="font-size:16px;">${L.player1} vs ${L.player2}</div>
          <div class="live-score" style="font-size:32px;">${L.score1} - ${L.score2}</div>
        </div>
        <button class="live-join">Join</button>
      </div>
    `;
    return;
  }
  
  // Show hero + stats
  const next = getNext();
  const done = D.draw.filter(g => !g.isGF && g.winner).length;
  const total = D.draw.filter(g => !g.isGF).length;
  
  let heroHTML = '';
  if (D.draw.length === 0) {
    heroHTML = `<div class="d-hero"><div class="hero-tag" style="color:var(--text-muted)">NO CHAMPIONSHIP</div><div class="hero-match">${D.players.length < 2 ? 'Add players first' : 'Click Generate Draw'}</div></div>`;
  } else if (!next) {
    heroHTML = `<div class="d-hero"><div class="hero-tag">üéâ COMPLETE</div><div class="hero-match">All games finished!</div></div>`;
  } else {
    const g = next.game;
    heroHTML = `
      <div class="d-hero ${g.isGF ? 'gf' : ''}">
        <div class="hero-tag">${g.isGF ? 'üèÜ GRAND FINAL üèÜ' : 'GAME ' + g.num}</div>
        <div class="hero-match">${g.p1}<span class="hero-vs">vs</span>${g.p2}</div>
        <button class="hero-btn" onclick="playNext()" style="font-size:14px;padding:12px 28px;">‚ñ∂Ô∏è Play</button>
      </div>
    `;
  }
  
  el.innerHTML = `
    <div class="d-stats">
      <div class="d-stat"><div class="stat-icon">üë•</div><div class="stat-val">${D.players.length}</div><div class="stat-name">Players</div></div>
      <div class="d-stat"><div class="stat-icon">üéØ</div><div class="stat-val">${done}/${total}</div><div class="stat-name">Games</div></div>
      <div class="d-stat"><div class="stat-icon">üèÜ</div><div class="stat-val">${D.target}</div><div class="stat-name">Target</div></div>
      <div class="d-stat"><div class="stat-icon">‚è±Ô∏è</div><div class="stat-val">${D.draw.filter(g => !g.winner).length}</div><div class="stat-name">Left</div></div>
    </div>
    ${heroHTML}
  `;
}

function calcStandings() {
  const m = new Map();
  D.players.forEach(p => m.set(p, { name: p, w: 0, l: 0, pf: 0, pa: 0, diff: 0 }));
  
  // Include ALL games (including GF) in standings
  D.draw.forEach(g => {
    if (!g.winner) return;
    const a = m.get(g.p1), b = m.get(g.p2);
    if (a) { if (g.winner === g.p1) a.w++; else a.l++; a.pf += g.s1 || 0; a.pa += g.s2 || 0; a.diff += (g.s1 || 0) - (g.s2 || 0); }
    if (b) { if (g.winner === g.p2) b.w++; else b.l++; b.pf += g.s2 || 0; b.pa += g.s1 || 0; b.diff += (g.s2 || 0) - (g.s1 || 0); }
  });
  
  return [...m.values()].sort((a, b) => b.w - a.w || b.diff - a.diff);
}

function getNext() {
  // Regular games first
  for (let i = 0; i < D.draw.length; i++) if (!D.draw[i].isGF && !D.draw[i].winner) return { idx: i, game: D.draw[i] };
  // Then grand final
  for (let i = 0; i < D.draw.length; i++) if (D.draw[i].isGF && !D.draw[i].winner) return { idx: i, game: D.draw[i] };
  return null;
}

// =============================================================================
// UNDO GAME
// =============================================================================

function undoGame(idx) {
  const g = D.draw[idx];
  if (!g || !g.winner) return;
  if (!confirm(`Undo ${g.p1} vs ${g.p2} (${g.s1}-${g.s2})?`)) return;
  
  // Save to history
  addHistory('Game Undone', `${g.p1} vs ${g.p2}: ${g.s1}-${g.s2}`, {
    type: 'game',
    gameNum: g.num,
    stats: [
      { name: g.p1, won: g.winner === g.p1, pf: g.s1, pa: g.s2 },
      { name: g.p2, won: g.winner === g.p2, pf: g.s2, pa: g.s1 }
    ]
  });
  
  // Revert all-time stats
  [g.p1, g.p2].forEach(name => {
    const at = D.alltime.find(x => x.name === name);
    if (at) {
      at.gp = Math.max(0, at.gp - 1);
      const isP1 = name === g.p1;
      const won = g.winner === name;
      at.w = Math.max(0, at.w - (won ? 1 : 0));
      at.l = Math.max(0, at.l - (won ? 0 : 1));
      at.pf -= isP1 ? g.s1 : g.s2;
      at.pa -= isP1 ? g.s2 : g.s1;
      at.diff = at.pf - at.pa;
    }
  });
  
  // Clear game result
  g.winner = null;
  g.s1 = null;
  g.s2 = null;
  
  store(KEY, D);
  toast('Game undone', 'good');
  render();
}

// =============================================================================
// HISTORY MODAL
// =============================================================================

function openHistory() {
  const el = document.getElementById('history-list');
  if (H.length === 0) {
    el.innerHTML = '<div class="empty"><div class="empty-icon">üìú</div><div>No history yet</div></div>';
  } else {
    el.innerHTML = H.map((h, i) => `
      <div class="history-item">
        <div class="time">${new Date(h.time).toLocaleString()}</div>
        <div class="action">${h.action}</div>
        <div class="detail">${h.detail}</div>
        ${h.undo ? `<button class="undo-btn" onclick="undoFromHistory(${i})">‚Ü© Undo</button>` : ''}
      </div>
    `).join('');
  }
  document.getElementById('history-modal').classList.add('on');
}

function closeHistory() {
  document.getElementById('history-modal').classList.remove('on');
}

function undoFromHistory(idx) {
  undoHistory(idx);
  closeHistory();
}

// =============================================================================
// CUSTOM MATCH
// =============================================================================

function openCustom() {
  if (D.players.length < 2) { toast('Add 2+ players first', 'bad'); return; }
  const opts = D.players.map(p => `<option value="${p}">${p}</option>`).join('');
  document.getElementById('sel-p1').innerHTML = opts;
  document.getElementById('sel-p2').innerHTML = opts;
  if (D.players.length > 1) document.getElementById('sel-p2').selectedIndex = 1;
  showScreen('custom');
}

function startCustom() {
  const p1 = document.getElementById('sel-p1').value;
  const p2 = document.getElementById('sel-p2').value;
  if (p1 === p2) { toast('Pick different players', 'bad'); return; }
  G = { p1, p2, s1: 0, s2: 0, d1: null, d2: null, idx: -1, num: null, isChamp: false, isGF: false };
  openDartPick(1, p1);
}

// =============================================================================
// DART SELECTION
// =============================================================================

function openDartPick(step, name) {
  G.step = step;
  G.pick = null;
  document.getElementById('dart-step').textContent = 'STEP ' + step + ' OF 2';
  document.getElementById('dart-player').textContent = name;
  document.getElementById('dart-confirm').disabled = true;
  
  document.getElementById('dart-grid').innerHTML = DARTS.map(d => {
    const off = step === 2 && G.d1 && G.d1.id === d.id;
    return `
      <div class="dart-opt ${off ? 'off' : ''}" data-id="${d.id}" onclick="pickDart('${d.id}')">
        <div class="dart-shape" style="background:${d.grad}"></div>
        <div class="dart-label">${d.name}</div>
      </div>
    `;
  }).join('');
  
  showScreen('dart');
}

function pickDart(id) {
  G.pick = DARTS.find(x => x.id === id);
  document.querySelectorAll('.dart-opt').forEach(el => el.classList.toggle('picked', el.dataset.id === id));
  document.getElementById('dart-confirm').disabled = false;
}

function confirmDart() {
  if (!G.pick) return;
  if (G.step === 1) { G.d1 = G.pick; openDartPick(2, G.p2); }
  else { G.d2 = G.pick; beginGame(); }
}

function cancelDart() { showScreen('home'); }

// =============================================================================
// GAMEPLAY
// =============================================================================

function playNext() {
  const n = getNext();
  if (!n) { toast(D.draw.length ? 'All done!' : 'Generate draw first', 'bad'); return; }
  playIdx(n.idx);
}

function playIdx(i) {
  const g = D.draw[i];
  if (!g || g.winner) return;
  G = { p1: g.p1, p2: g.p2, s1: 0, s2: 0, d1: null, d2: null, idx: i, num: g.num, isChamp: true, isGF: g.isGF };
  openDartPick(1, g.p1);
}

function joinLive() {
  if (!D.live || !D.live.active) return;
  const L = D.live;
  G = {
    p1: L.player1, p2: L.player2, s1: L.score1, s2: L.score2,
    d1: DARTS.find(x => x.id === L.color1) || DARTS[0],
    d2: DARTS.find(x => x.id === L.color2) || DARTS[1],
    idx: -1, num: L.gameId, isChamp: L.isChamp, isGF: L.isGF
  };
  setupGameUI();
  startLiveSync();
  showScreen('game');
}

function beginGame() {
  G.s1 = 0; G.s2 = 0;
  setupGameUI();
  if (G.isChamp) { pushLive(); startLiveSync(); document.getElementById('g-live').style.display = 'flex'; }
  else { document.getElementById('g-live').style.display = 'none'; }
  showScreen('game');
}

function setupGameUI() {
  document.getElementById('name1').textContent = G.p1;
  document.getElementById('name2').textContent = G.p2;
  document.getElementById('dart1').style.background = G.d1.grad;
  document.getElementById('dart2').style.background = G.d2.grad;
  document.getElementById('g-target').textContent = D.target;
  
  const lbl = document.getElementById('g-label');
  if (G.isGF) { lbl.textContent = 'üèÜ GRAND FINAL'; lbl.classList.add('gf'); }
  else if (G.isChamp) { lbl.textContent = 'Game ' + G.num; lbl.classList.remove('gf'); }
  else { lbl.textContent = 'Quick Match'; lbl.classList.remove('gf'); }
  
  updateGameUI();
}

function adj(player, amt) {
  if (player === 1) {
    G.s1 = Math.max(0, G.s1 + amt);
    if (G.s1 >= D.target) { G.s1 = D.target; updateGameUI(); win(G.p1); return; }
  } else {
    G.s2 = Math.max(0, G.s2 + amt);
    if (G.s2 >= D.target) { G.s2 = D.target; updateGameUI(); win(G.p2); return; }
  }
  updateGameUI();
  if (G.isChamp) pushLive();
}

function updateGameUI() {
  document.getElementById('sc1').textContent = G.s1;
  document.getElementById('sc2').textContent = G.s2;
  
  // HORIZONTAL progress - LEFT to RIGHT
  const p1 = Math.min(100, (G.s1 / D.target) * 100);
  const p2 = Math.min(100, (G.s2 / D.target) * 100);
  
  document.getElementById('bar1').style.width = p1 + '%';
  document.getElementById('bar1').style.background = G.d1.grad;
  document.getElementById('bar2').style.width = p2 + '%';
  document.getElementById('bar2').style.background = G.d2.grad;
}

function resetGame() {
  if (!confirm('Reset to 0-0?')) return;
  G.s1 = 0; G.s2 = 0; updateGameUI();
  if (G.isChamp) pushLive();
}

// =============================================================================
// GAME MENU
// =============================================================================

function openMenu() { document.getElementById('gmenu').classList.add('on'); }
function closeMenu() { document.getElementById('gmenu').classList.remove('on'); }

function endGame() {
  if (!confirm('End without saving?')) return;
  closeMenu(); stopLiveSync(); clearLive();
  D.paused = null; store(KEY, D);
  showScreen('home'); toast('Game ended', 'good');
}

function pauseGame() {
  closeMenu(); stopLiveSync();
  D.paused = { p1: G.p1, p2: G.p2, s1: G.s1, s2: G.s2, d1: G.d1, d2: G.d2, idx: G.idx, num: G.num, isChamp: G.isChamp, isGF: G.isGF };
  store(KEY, D);
  toast('Saved', 'good'); showScreen('home');
}

function resumePaused() {
  if (!D.paused) return;
  const p = D.paused;
  G = { p1: p.p1, p2: p.p2, s1: p.s1, s2: p.s2, d1: p.d1, d2: p.d2, idx: p.idx, num: p.num, isChamp: p.isChamp, isGF: p.isGF };
  D.paused = null; store(KEY, D);
  setupGameUI();
  if (G.isChamp) { pushLive(); startLiveSync(); document.getElementById('g-live').style.display = 'flex'; }
  showScreen('game');
}

// =============================================================================
// WIN
// =============================================================================

function win(name) {
  stopLiveSync();
  document.getElementById('win-name').textContent = name;
  document.getElementById('win-score').textContent = G.s1 + ' - ' + G.s2;
  document.getElementById('win-save').style.display = G.isChamp ? 'inline-block' : 'none';
  document.getElementById('win').classList.add('on');
  confetti();
}

async function saveGame() {
  const winner = G.s1 >= D.target ? G.p1 : G.p2;
  
  if (G.isChamp && G.idx >= 0) {
    const g = D.draw[G.idx];
    g.winner = winner; g.s1 = G.s1; g.s2 = G.s2;
    
    // Update ALL-TIME stats (including GF!)
    updateAllTime(G.p1, G.p2, winner, G.s1, G.s2, G.isGF);
    
    // Add to history
    addHistory('Game Completed', `${G.p1} ${G.s1} - ${G.s2} ${G.p2}. Winner: ${winner}`, {
      type: 'game',
      gameNum: g.num,
      stats: [
        { name: G.p1, won: winner === G.p1, pf: G.s1, pa: G.s2 },
        { name: G.p2, won: winner === G.p2, pf: G.s2, pa: G.s1 }
      ]
    });
    
    // Push to cloud
    await apiPost('submitGame', { gameId: g.num, player1: g.p1, player2: g.p2, score1: g.s1, score2: g.s2 });
    
    if (G.isGF) {
      // Award championship
      const at = D.alltime.find(x => x.name === winner);
      if (at) at.champs = (at.champs || 0) + 1;
      toast('üèÜ Champion!', 'good');
    } else {
      // Check for grand final
      checkGF();
      toast('Saved!', 'good');
    }
  }
  
  clearLive();
  D.paused = null;
  store(KEY, D);
  exitWin();
}

function updateAllTime(p1, p2, winner, s1, s2, isGF) {
  // Update stats for BOTH regular games AND grand final
  [p1, p2].forEach(name => {
    let at = D.alltime.find(x => x.name === name);
    if (!at) { at = { name, gp: 0, w: 0, l: 0, pf: 0, pa: 0, diff: 0, champs: 0 }; D.alltime.push(at); }
    at.gp++;
  });
  
  const a1 = D.alltime.find(x => x.name === p1);
  const a2 = D.alltime.find(x => x.name === p2);
  
  if (a1) {
    if (winner === p1) a1.w++; else a1.l++;
    a1.pf += s1; a1.pa += s2; a1.diff = a1.pf - a1.pa;
  }
  if (a2) {
    if (winner === p2) a2.w++; else a2.l++;
    a2.pf += s2; a2.pa += s1; a2.diff = a2.pf - a2.pa;
  }
  
  store(KEY, D);
}

function checkGF() {
  const reg = D.draw.filter(g => !g.isGF);
  const left = reg.filter(g => !g.winner);
  if (left.length === 0 && !D.draw.find(g => g.isGF) && reg.length > 0) {
    const st = calcStandings();
    if (st.length >= 2) {
      D.draw.push({ num: 'GF', p1: st[0].name, p2: st[1].name, s1: null, s2: null, winner: null, isGF: true });
      store(KEY, D);
      toast('üèÜ Grand Final!', 'good');
    }
  }
}

function rematch() {
  document.getElementById('win').classList.remove('on');
  G.s1 = 0; G.s2 = 0; updateGameUI();
  if (G.isChamp) { pushLive(); startLiveSync(); }
}

function exitWin() { document.getElementById('win').classList.remove('on'); showScreen('home'); }

function confetti() {
  const cols = [G.d1?.color || '#ffd700', G.d2?.color || '#3b82f6', '#22c55e', '#ff4757'];
  for (let i = 0; i < 40; i++) {
    setTimeout(() => {
      const c = document.createElement('div');
      c.className = 'confetti';
      c.style.left = Math.random() * 100 + 'vw';
      c.style.background = cols[Math.floor(Math.random() * cols.length)];
      c.style.animationDuration = (2 + Math.random() * 2) + 's';
      document.body.appendChild(c);
      setTimeout(() => c.remove(), 4000);
    }, i * 25);
  }
}

// =============================================================================
// SETTINGS
// =============================================================================

function renderPlayers() {
  const el = document.getElementById('player-list');
  if (D.players.length === 0) { el.innerHTML = '<div style="color:var(--text-muted);padding:16px 0;font-size:12px;text-align:center;">No players</div>'; return; }
  el.innerHTML = D.players.map((p, i) => {
    const at = D.alltime.find(x => x.name === p) || { gp: 0, w: 0, champs: 0 };
    return `
      <div class="player-row">
        <div class="player-avatar">${p[0].toUpperCase()}</div>
        <div class="player-info">
          <div class="name">${at.champs ? 'üèÜ ' : ''}${p}</div>
          <div class="meta">${at.gp} GP ‚Ä¢ ${at.w} W${at.champs ? ' ‚Ä¢ ' + at.champs + 'x champ' : ''}</div>
        </div>
        <button class="player-del" onclick="delPlayer(${i})">√ó</button>
      </div>
    `;
  }).join('');
}

async function addPlayer() {
  const inp = document.getElementById('inp-player');
  const name = inp.value.trim();
  if (!name) return;
  if (D.players.some(p => p.toLowerCase() === name.toLowerCase())) { toast('Exists!', 'bad'); return; }
  
  D.players.push(name);
  store(KEY, D);
  await apiPost('addPlayer', { playerName: name });
  inp.value = '';
  renderPlayers(); render();
  toast('Added!', 'good');
}

async function addPlayerD() {
  const inp = document.getElementById('d-inp-player');
  const name = inp.value.trim();
  if (!name) return;
  if (D.players.some(p => p.toLowerCase() === name.toLowerCase())) { toast('Exists!', 'bad'); return; }
  
  D.players.push(name);
  store(KEY, D);
  await apiPost('addPlayer', { playerName: name });
  inp.value = '';
  render();
  toast('Added!', 'good');
}

function delPlayer(i) {
  if (!confirm('Remove ' + D.players[i] + '?')) return;
  D.players.splice(i, 1);
  store(KEY, D);
  renderPlayers(); render();
}

document.getElementById('inp-player').addEventListener('keypress', e => { if (e.key === 'Enter') addPlayer(); });
document.getElementById('d-inp-player')?.addEventListener('keypress', e => { if (e.key === 'Enter') addPlayerD(); });

async function generateDraw() {
  if (D.players.length < 2) { toast('Need 2+ players', 'bad'); return; }
  if (D.draw.length && !confirm('Replace current draw?')) return;
  
  const pairs = [];
  for (let i = 0; i < D.players.length; i++) {
    for (let j = i + 1; j < D.players.length; j++) {
      pairs.push([D.players[i], D.players[j]]);
    }
  }
  for (let i = pairs.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [pairs[i], pairs[j]] = [pairs[j], pairs[i]]; }
  
  D.draw = pairs.map((p, i) => ({ num: i + 1, p1: p[0], p2: p[1], s1: null, s2: null, winner: null, isGF: false }));
  D.paused = null;
  store(KEY, D);
  
  await apiPost('generateDraw', {});
  
  addHistory('Draw Generated', `${pairs.length} games created`);
  toast(pairs.length + ' games!', 'good');
  render();
  if (!isDesktop) showScreen('home');
}

async function clearDraw() {
  if (!confirm('Clear draw?')) return;
  D.draw = []; D.paused = null;
  store(KEY, D);
  await apiPost('newEvent', {});
  addHistory('Draw Cleared', 'All games removed');
  toast('Cleared', 'good');
  render();
}

function changeTarget() {
  D.target = parseInt(document.getElementById('sel-target').value) || 21;
  store(KEY, D);
  render();
  toast('Target: ' + D.target, 'good');
}

function changeTargetD() {
  D.target = parseInt(document.getElementById('d-target').value) || 21;
  document.getElementById('sel-target').value = D.target;
  store(KEY, D);
  render();
  toast('Target: ' + D.target, 'good');
}

// =============================================================================
// TOAST
// =============================================================================

function toast(msg, type = 'good') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast show ' + type;
  setTimeout(() => t.classList.remove('show'), 2500);
}

// =============================================================================
// PWA
// =============================================================================

if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js')
      .then(reg => console.log('SW registered'))
      .catch(err => console.log('SW error:', err));
  });
}

// =============================================================================
// INIT
// =============================================================================

window.addEventListener('resize', () => {
  isDesktop = window.innerWidth >= 1024;
  render();
});

// Auto sync every 20s
setInterval(() => {
  if (document.getElementById('screen-home')?.classList.contains('active') || isDesktop) {
    doSync();
  }
}, 20000);

// Initial
render();
doSync();
</script>
</body>
</html>
