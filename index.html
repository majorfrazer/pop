<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>PopDarts</title>
  <link rel="manifest" href="manifest.json">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
    :root{
      --bg:#0a0a12;--card:#14141f;--elev:#1c1c2e;--border:rgba(255,255,255,.12);
      --text:#fff;--dim:#a0a0b8;--muted:#606078;
      --gold:#ffc107;--gold2:#ff9800;--green:#00e676;--red:#ff5252;--blue:#448aff;
    }
    *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;user-select:none}
    html,body{font-family:'Inter',system-ui,sans-serif;background:var(--bg);color:var(--text);height:100%;overflow:hidden}
    
    .screen{position:fixed;inset:0;display:none;flex-direction:column;background:var(--bg);z-index:10}
    .screen.active{display:flex}
    
    .hdr{display:flex;align-items:center;justify-content:space-between;padding:max(12px,env(safe-area-inset-top)) 16px 12px;border-bottom:1px solid var(--border)}
    .logo{font-size:22px;font-weight:900;color:var(--gold)}
    .sync-ind{display:flex;align-items:center;gap:6px;padding:8px 14px;background:var(--card);border-radius:20px;font-size:11px}
    .sync-dot{width:8px;height:8px;border-radius:50%;background:var(--green)}
    
    .content{flex:1;overflow-y:auto;padding:16px;padding-bottom:100px}
    
    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:18px;margin-bottom:14px}
    .card-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);margin-bottom:14px}
    
    /* Live Banner */
    .live-banner{background:linear-gradient(135deg,#082818,#041510);border:2px solid var(--green);border-radius:20px;padding:24px;margin-bottom:16px;cursor:pointer}
    .live-badge{display:inline-flex;align-items:center;gap:8px;background:var(--green);color:#000;padding:8px 16px;border-radius:20px;font-size:12px;font-weight:800;margin-bottom:12px}
    .live-pulse{width:8px;height:8px;background:#000;border-radius:50%;animation:pulse 1s infinite}
    @keyframes pulse{50%{transform:scale(1.5);opacity:.5}}
    .live-players{font-size:18px;font-weight:800;margin-bottom:8px}
    .live-score{font-size:52px;font-weight:900;color:var(--gold)}
    .live-join{margin-top:14px;padding:14px 28px;background:var(--green);color:#000;font-size:15px;font-weight:800;border:none;border-radius:14px}
    
    /* Next Card */
    .next-card{background:linear-gradient(135deg,#15152a,#1f1f40);border:1px solid var(--border);border-radius:20px;padding:28px;margin-bottom:16px;text-align:center}
    .next-card.gf{border:2px solid var(--gold)}
    .next-tag{font-size:12px;font-weight:800;letter-spacing:3px;color:var(--gold);margin-bottom:10px}
    .next-match{font-size:24px;font-weight:800}
    .next-vs{display:block;font-size:13px;color:var(--muted);margin:6px 0}
    .next-btn{margin-top:18px;padding:16px 36px;background:linear-gradient(135deg,var(--gold),var(--gold2));color:#000;font-size:17px;font-weight:800;border:none;border-radius:30px}
    
    .actions{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px}
    .act{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px;text-align:center;cursor:pointer}
    .act-icon{font-size:32px;margin-bottom:6px}
    .act-text{font-size:13px;font-weight:700}
    
    .stats-row{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px}
    .stat-box{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;text-align:center}
    .stat-val{font-size:26px;font-weight:900;color:var(--gold)}
    .stat-lbl{font-size:9px;font-weight:600;text-transform:uppercase;color:var(--muted);margin-top:4px}
    
    .tabs{display:flex;background:var(--card);border-radius:12px;padding:4px;margin-bottom:14px}
    .tab{flex:1;padding:12px;text-align:center;font-size:12px;font-weight:700;color:var(--muted);background:none;border:none;border-radius:10px;cursor:pointer}
    .tab.on{background:var(--gold);color:#000}
    
    .tbl{width:100%;border-collapse:collapse;font-size:12px}
    .tbl th{padding:10px 5px;text-align:center;font-size:9px;font-weight:700;text-transform:uppercase;color:var(--muted);background:rgba(255,255,255,.03)}
    .tbl th:first-child{text-align:left;padding-left:12px}
    .tbl td{padding:12px 5px;text-align:center;border-bottom:1px solid var(--border)}
    .tbl td:first-child{text-align:left;padding-left:12px;font-weight:600}
    .tbl .top td{background:rgba(255,193,7,.1)}
    .champ{color:var(--gold);font-weight:800}
    .plus{color:var(--green)}.minus{color:var(--red)}
    
    .draw-item{display:flex;align-items:center;gap:12px;padding:14px;background:var(--card);border:1px solid var(--border);border-radius:14px;margin-bottom:8px;cursor:pointer}
    .draw-item.done{opacity:.5}
    .draw-item.gf{border:2px solid var(--gold)}
    .draw-num{width:38px;height:38px;background:var(--elev);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:800}
    .draw-item.done .draw-num{background:var(--green);color:#000}
    .draw-info{flex:1}
    .draw-players{font-size:14px;font-weight:700}
    .draw-result{font-size:15px;font-weight:800;color:var(--gold)}
    
    .btn{width:100%;padding:16px;border-radius:14px;border:none;font-size:16px;font-weight:700;cursor:pointer;margin-bottom:10px}
    .btn-gold{background:linear-gradient(135deg,var(--gold),var(--gold2));color:#000}
    .btn-gray{background:var(--elev);color:var(--text);border:1px solid var(--border)}
    .btn-red{background:rgba(255,82,82,.15);color:var(--red)}
    .btn-green{background:var(--green);color:#000}
    
    .nav{position:fixed;bottom:0;left:0;right:0;background:rgba(10,10,18,.98);border-top:1px solid var(--border);display:flex;padding:10px 20px max(10px,env(safe-area-inset-bottom));z-index:100}
    .nav-btn{flex:1;padding:10px;text-align:center;font-size:10px;font-weight:600;color:var(--muted);background:none;border:none;border-radius:12px;cursor:pointer}
    .nav-btn.on{color:var(--gold);background:rgba(255,193,7,.1)}
    .nav-icon{font-size:22px;display:block;margin-bottom:3px}
    
    input,select{width:100%;padding:14px;background:var(--elev);border:1px solid var(--border);color:var(--text);border-radius:12px;font-size:15px;margin-bottom:8px}
    
    .player-item{display:flex;align-items:center;padding:12px 0;border-bottom:1px solid var(--border)}
    .player-avatar{width:42px;height:42px;background:linear-gradient(135deg,#a855f7,var(--blue));border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:17px;margin-right:14px}
    .player-info{flex:1}
    .player-name{font-weight:700;font-size:15px}
    .player-meta{font-size:12px;color:var(--muted)}
    .player-del{width:38px;height:38px;background:rgba(255,82,82,.15);border:none;border-radius:50%;color:var(--red);font-size:18px;cursor:pointer}
    
    .toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%);background:var(--elev);border:1px solid var(--border);padding:14px 28px;border-radius:14px;font-size:14px;font-weight:600;z-index:900;opacity:0;transition:opacity .3s}
    .toast.show{opacity:1}
    .toast.ok{border-left:4px solid var(--green)}
    .toast.err{border-left:4px solid var(--red)}
    
    /* ========== DART SELECTION ========== */
    #dart-screen{position:fixed;inset:0;background:var(--bg);z-index:200;display:none;flex-direction:column}
    #dart-screen.active{display:flex}
    .dart-hdr{padding:max(20px,env(safe-area-inset-top)) 20px 20px;text-align:center;border-bottom:1px solid var(--border)}
    .dart-step{font-size:11px;font-weight:700;letter-spacing:3px;color:var(--gold)}
    .dart-player{font-size:26px;font-weight:900;margin-top:8px}
    .dart-sub{font-size:13px;color:var(--dim);margin-top:6px}
    .dart-grid{flex:1;display:grid;grid-template-columns:repeat(2,1fr);gap:14px;padding:18px;overflow-y:auto;align-content:start}
    .dart-opt{background:var(--card);border:4px solid var(--border);border-radius:18px;padding:18px;display:flex;flex-direction:column;align-items:center;gap:10px;cursor:pointer}
    .dart-opt.picked{border-color:var(--gold)}
    .dart-opt.off{opacity:.2;pointer-events:none}
    .dart-shape{width:48px;height:80px;border-radius:24px}
    .dart-label{font-size:12px;font-weight:700}
    .dart-foot{padding:18px;padding-bottom:max(18px,env(safe-area-inset-bottom))}
    
    /* ========== GAME SCREEN ========== */
    #game-screen{background:#000;z-index:150}
    .game-hdr{position:absolute;top:0;left:0;right:0;padding:max(12px,env(safe-area-inset-top)) 16px 12px;display:flex;justify-content:space-between;align-items:center;z-index:50;background:linear-gradient(180deg,rgba(0,0,0,.95),transparent)}
    .game-menu-btn{width:52px;height:52px;background:rgba(255,255,255,.12);border:none;border-radius:14px;color:#fff;font-size:26px;cursor:pointer}
    .game-badges{display:flex;gap:8px}
    .game-badge{padding:10px 16px;background:rgba(0,0,0,.7);border:1px solid rgba(255,255,255,.15);border-radius:20px;font-size:12px;font-weight:700}
    .game-badge.live{background:var(--green);color:#000;border:none}
    .game-badge.gf{background:var(--gold);color:#000;border:none}
    
    .game-arena{position:absolute;inset:0;display:flex;flex-direction:column}
    .player-zone{flex:1;position:relative;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:16px;overflow:hidden}
    .player-zone.p1{padding-top:75px}
    .player-zone.p2{padding-bottom:max(16px,env(safe-area-inset-bottom))}
    .progress-bar{position:absolute;top:0;bottom:0;left:0;width:0%;transition:width .4s;z-index:1}
    
    .player-ui{position:relative;z-index:10;text-align:center;width:100%}
    .player-header{display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:10px}
    .player-dart{width:26px;height:44px;border-radius:13px}
    .player-name-txt{font-size:18px;font-weight:800;text-transform:uppercase}
    
    .score-row{display:flex;align-items:center;justify-content:center;gap:14px;margin-bottom:14px}
    
    /* ===== LARGE SCORE BUTTONS ===== */
    .score-btn{
      width:76px;
      height:76px;
      border-radius:50%;
      border:4px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.08);
      color:#fff;
      font-size:42px;
      font-weight:300;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
    }
    .score-btn:active{transform:scale(.9);background:rgba(255,255,255,.2)}
    .score-btn.minus{color:var(--red);border-color:rgba(255,82,82,.5)}
    .score-btn.plus{color:var(--green);border-color:rgba(0,230,118,.5)}
    
    .score-num{font-size:72px;font-weight:900;min-width:100px}
    
    /* ===== LARGE QUICK BUTTONS ===== */
    .quick-row{display:flex;gap:10px;justify-content:center}
    .quick-btn{
      width:72px;
      height:58px;
      border-radius:14px;
      border:3px solid rgba(255,255,255,.2);
      background:rgba(255,255,255,.06);
      color:#fff;
      font-size:20px;
      font-weight:700;
      cursor:pointer;
    }
    .quick-btn:active{transform:scale(.92);background:rgba(255,255,255,.15);border-color:var(--green)}
    
    .game-mid{height:5px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.25),transparent);position:relative;z-index:20}
    .reset-btn{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:52px;height:52px;background:var(--card);border:3px solid var(--border);border-radius:50%;color:var(--muted);font-size:24px;cursor:pointer;z-index:21}
    
    /* Landscape */
    @media(orientation:landscape) and (max-height:500px){
      .player-zone.p1{padding-top:55px}
      .player-name-txt{font-size:14px}
      .score-num{font-size:46px;min-width:70px}
      .score-btn{width:52px;height:52px;font-size:28px}
      .quick-btn{width:52px;height:42px;font-size:16px}
      .score-row{margin-bottom:8px;gap:10px}
    }
    
    /* Game Menu Overlay */
    .game-menu-panel{position:fixed;inset:0;background:rgba(0,0,0,.95);display:none;flex-direction:column;align-items:center;justify-content:center;z-index:400;gap:16px}
    .game-menu-panel.on{display:flex}
    .game-menu-panel h2{font-size:26px;margin-bottom:20px}
    .menu-btn{width:280px;padding:18px;border-radius:16px;border:none;font-size:17px;font-weight:700;cursor:pointer}
    .menu-btn.resume{background:var(--green);color:#000}
    .menu-btn.end{background:var(--red);color:#fff}
    
    /* Win Screen */
    .win-panel{position:fixed;inset:0;background:linear-gradient(135deg,#0a0a12,#15152a,#0a1520);display:none;flex-direction:column;align-items:center;justify-content:center;z-index:500;padding:28px}
    .win-panel.on{display:flex}
    .win-trophy{font-size:100px;animation:bounce .5s infinite alternate}
    @keyframes bounce{to{transform:translateY(-18px) scale(1.05)}}
    .win-label{font-size:16px;letter-spacing:4px;color:var(--gold);margin-top:16px}
    .win-name{font-size:40px;font-weight:900;margin-top:10px;text-align:center}
    .win-score{font-size:28px;color:var(--dim);margin-top:6px}
    .win-btns{display:flex;gap:14px;margin-top:28px;flex-wrap:wrap;justify-content:center}
    .win-btn{padding:16px 32px;border-radius:14px;border:none;font-size:16px;font-weight:700;cursor:pointer}
    .win-btn.primary{background:var(--green);color:#000}
    .win-btn.secondary{background:var(--gold);color:#000}
    
    .confetti{position:fixed;width:10px;height:10px;top:-20px;animation:fall 3s linear forwards;z-index:501}
    @keyframes fall{to{transform:translateY(100vh) rotate(720deg)}}
    
    .empty{text-align:center;padding:40px;color:var(--muted)}
    
    /* ========== DESKTOP ========== */
    @media(min-width:1024px){
      .mobile-only{display:none!important}
      .desktop-layout{display:flex!important;height:100vh}
      
      .d-panel{width:320px;background:var(--card);border-right:1px solid var(--border);display:flex;flex-direction:column}
      .d-panel:last-child{border-right:none;border-left:1px solid var(--border)}
      .d-panel-head{padding:18px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
      .d-panel-head h2{font-size:18px;font-weight:800}
      .d-panel-body{flex:1;overflow-y:auto;padding:16px}
      .d-section{margin-bottom:20px}
      .d-section-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);margin-bottom:12px}
      
      .d-center{flex:1;background:var(--bg);display:flex;flex-direction:column;min-width:0}
      .d-center-head{padding:16px 22px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
      .d-game-wrap{flex:1;padding:20px;display:flex;flex-direction:column}
      
      /* Desktop Game Container */
      .d-game-box{flex:1;background:#000;border-radius:20px;overflow:hidden;position:relative;display:flex;flex-direction:column}
      .d-game-box .game-hdr{position:relative;padding:22px 26px}
      .d-game-box .game-arena{position:relative;flex:1}
      .d-game-box .player-zone{padding:40px}
      .d-game-box .player-zone.p1{padding-top:16px}
      .d-game-box .player-zone.p2{padding-bottom:16px}
      .d-game-box .score-num{font-size:130px}
      .d-game-box .score-btn{width:95px;height:95px;font-size:52px;border-width:5px}
      .d-game-box .quick-btn{width:88px;height:66px;font-size:24px;border-width:4px}
      .d-game-box .player-name-txt{font-size:28px}
      .d-game-box .player-dart{width:34px;height:56px}
      .d-game-box .score-row{gap:22px;margin-bottom:22px}
      .d-game-box .quick-row{gap:12px}
      
      .d-draw-item{display:flex;align-items:center;gap:10px;padding:12px;background:var(--elev);border:1px solid var(--border);border-radius:12px;margin-bottom:8px;font-size:13px;cursor:pointer}
      .d-draw-item:hover{border-color:var(--gold)}
      .d-draw-item.done{opacity:.5}
      .d-draw-item.gf{border-color:var(--gold)}
      .d-draw-num{width:32px;height:32px;background:var(--card);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:800}
      .d-draw-item.done .d-draw-num{background:var(--green);color:#000}
      .d-draw-info{flex:1;font-weight:600}
      .d-draw-score{font-weight:800;color:var(--gold)}
      
      .d-player-item{display:flex;align-items:center;padding:10px 0;border-bottom:1px solid var(--border);font-size:13px}
      .d-player-name{flex:1;font-weight:600}
      .d-player-stat{color:var(--muted);margin-right:10px}
      .d-player-del{width:28px;height:28px;background:rgba(255,82,82,.15);border:none;border-radius:50%;color:var(--red);font-size:14px;cursor:pointer}
    }
    @media(max-width:1023px){.desktop-layout{display:none!important}}
  </style>
</head>
<body>

<!-- ===== MOBILE ===== -->
<div class="mobile-only">
  <div id="home-screen" class="screen active">
    <div class="hdr">
      <div class="logo">üéØ PopDarts</div>
      <div class="sync-ind"><span class="sync-dot"></span><span id="sync-txt">Live</span></div>
    </div>
    <div class="content">
      <div id="live-zone"></div>
      <div id="next-zone"></div>
      <div class="actions">
        <div class="act" onclick="quickMatch()"><div class="act-icon">üéÆ</div><div class="act-text">Quick Match</div></div>
        <div class="act" onclick="generateDraw()"><div class="act-icon">üé≤</div><div class="act-text">New Draw</div></div>
      </div>
      <div class="stats-row">
        <div class="stat-box"><div class="stat-val" id="stat-players">0</div><div class="stat-lbl">Players</div></div>
        <div class="stat-box"><div class="stat-val" id="stat-games">0</div><div class="stat-lbl">Games</div></div>
        <div class="stat-box"><div class="stat-val" id="stat-target">21</div><div class="stat-lbl">Target</div></div>
      </div>
      <div class="tabs">
        <button class="tab on" onclick="showTab('draw',this)">Draw</button>
        <button class="tab" onclick="showTab('standings',this)">Standings</button>
        <button class="tab" onclick="showTab('alltime',this)">All-Time</button>
      </div>
      <div id="tab-draw"></div>
      <div id="tab-standings" style="display:none"></div>
      <div id="tab-alltime" style="display:none"></div>
    </div>
  </div>

  <div id="settings-screen" class="screen">
    <div class="hdr">
      <div class="logo" style="font-size:18px">‚öôÔ∏è Settings</div>
      <div class="sync-ind"><span class="sync-dot"></span>Live</div>
    </div>
    <div class="content">
      <div class="card">
        <div class="card-title">üë• Players</div>
        <div style="display:flex;gap:8px;margin-bottom:14px">
          <input type="text" id="player-input" placeholder="Add player...">
          <button class="btn btn-green" style="width:auto;padding:14px 22px;margin:0" onclick="addPlayer()">+</button>
        </div>
        <div id="player-list"></div>
      </div>
      <div class="card">
        <div class="card-title">üéØ Target Score</div>
        <select id="target-select" onchange="DATA.target=+this.value;render()">
          <option value="11">First to 11</option>
          <option value="15">First to 15</option>
          <option value="21" selected>First to 21</option>
          <option value="31">First to 31</option>
        </select>
      </div>
      <div class="card">
        <div class="card-title">üèÜ Championship</div>
        <button class="btn btn-gold" onclick="generateDraw()">Generate New Draw</button>
        <button class="btn btn-red" onclick="clearDraw()">Clear All Games</button>
      </div>
    </div>
  </div>

  <div id="dart-screen">
    <div class="dart-hdr">
      <div class="dart-step" id="dart-step">STEP 1 OF 2</div>
      <div class="dart-player" id="dart-name">Player</div>
      <div class="dart-sub">Choose your dart color</div>
    </div>
    <div class="dart-grid" id="dart-grid"></div>
    <div class="dart-foot">
      <button class="btn btn-green" id="dart-confirm" onclick="confirmDart()" disabled>Select Dart</button>
      <button class="btn btn-gray" onclick="cancelDart()">Cancel</button>
    </div>
  </div>

  <div id="game-screen" class="screen">
    <div class="game-hdr">
      <button class="game-menu-btn" onclick="showMenu()">‚ò∞</button>
      <div class="game-badges">
        <div class="game-badge" id="game-label">Game 1</div>
        <div class="game-badge live">üî¥ LIVE</div>
      </div>
    </div>
    <div class="game-arena">
      <div class="player-zone p1">
        <div class="progress-bar" id="bar1"></div>
        <div class="player-ui">
          <div class="player-header">
            <div class="player-dart" id="dart1"></div>
            <div class="player-name-txt" id="name1">Player 1</div>
          </div>
          <div class="score-row">
            <button class="score-btn minus" onclick="adj(1,-1)">‚àí</button>
            <div class="score-num" id="score1">0</div>
            <button class="score-btn plus" onclick="adj(1,1)">+</button>
          </div>
          <div class="quick-row">
            <button class="quick-btn" onclick="adj(1,2)">+2</button>
            <button class="quick-btn" onclick="adj(1,3)">+3</button>
            <button class="quick-btn" onclick="adj(1,4)">+4</button>
            <button class="quick-btn" onclick="adj(1,5)">+5</button>
          </div>
        </div>
      </div>
      <div class="game-mid"><button class="reset-btn" onclick="resetScores()">‚Ü∫</button></div>
      <div class="player-zone p2">
        <div class="progress-bar" id="bar2"></div>
        <div class="player-ui">
          <div class="player-header">
            <div class="player-dart" id="dart2"></div>
            <div class="player-name-txt" id="name2">Player 2</div>
          </div>
          <div class="score-row">
            <button class="score-btn minus" onclick="adj(2,-1)">‚àí</button>
            <div class="score-num" id="score2">0</div>
            <button class="score-btn plus" onclick="adj(2,1)">+</button>
          </div>
          <div class="quick-row">
            <button class="quick-btn" onclick="adj(2,2)">+2</button>
            <button class="quick-btn" onclick="adj(2,3)">+3</button>
            <button class="quick-btn" onclick="adj(2,4)">+4</button>
            <button class="quick-btn" onclick="adj(2,5)">+5</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <nav class="nav" id="nav">
    <button class="nav-btn on" onclick="goTo('home')"><span class="nav-icon">üè†</span>Home</button>
    <button class="nav-btn" onclick="goTo('settings')"><span class="nav-icon">‚öôÔ∏è</span>Settings</button>
  </nav>
</div>

<!-- ===== DESKTOP ===== -->
<div class="desktop-layout" style="display:none">
  <div class="d-panel">
    <div class="d-panel-head">
      <h2>üéØ PopDarts</h2>
      <div class="sync-ind"><span class="sync-dot"></span>Live</div>
    </div>
    <div class="d-panel-body">
      <div class="d-section">
        <div class="d-section-title">üë• Players</div>
        <div style="display:flex;gap:6px;margin-bottom:12px">
          <input type="text" id="d-player-input" placeholder="Add player..." style="padding:12px;font-size:13px">
          <button class="btn btn-green" style="width:auto;margin:0;padding:12px 16px" onclick="addPlayerD()">+</button>
        </div>
        <div id="d-player-list"></div>
      </div>
      <div class="d-section">
        <div class="d-section-title">üìã Draw</div>
        <div id="d-draw"></div>
      </div>
      <div class="d-section">
        <button class="btn btn-gold" style="font-size:13px;padding:12px" onclick="generateDraw()">üé≤ Generate Draw</button>
        <button class="btn btn-gray" style="font-size:13px;padding:12px" onclick="clearDraw()">Clear Draw</button>
      </div>
    </div>
  </div>
  
  <div class="d-center">
    <div class="d-center-head">
      <h2>üèüÔ∏è Stadium</h2>
      <select id="d-target-select" onchange="DATA.target=+this.value;render()" style="width:auto;padding:10px 14px;font-size:13px">
        <option value="11">To 11</option>
        <option value="15">To 15</option>
        <option value="21" selected>To 21</option>
        <option value="31">To 31</option>
      </select>
    </div>
    <div class="d-game-wrap" id="d-game-area"></div>
  </div>
  
  <div class="d-panel">
    <div class="d-panel-head"><h2>üìä Stats</h2></div>
    <div class="d-panel-body">
      <div class="d-section">
        <div class="d-section-title">üèÜ Standings</div>
        <div id="d-standings"></div>
      </div>
      <div class="d-section">
        <div class="d-section-title">üìà All-Time</div>
        <div id="d-alltime"></div>
      </div>
    </div>
  </div>
</div>

<!-- Overlays -->
<div class="game-menu-panel" id="menu-panel">
  <h2>‚è∏Ô∏è Paused</h2>
  <button class="menu-btn resume" onclick="hideMenu()">‚ñ∂Ô∏è Resume</button>
  <button class="menu-btn end" onclick="endGame()">üö™ End Game</button>
</div>

<div class="win-panel" id="win-panel">
  <div class="win-trophy">üèÜ</div>
  <div class="win-label">üéâ WINNER üéâ</div>
  <div class="win-name" id="win-name">Player</div>
  <div class="win-score" id="win-score">21 - 15</div>
  <div class="win-btns">
    <button class="win-btn primary" onclick="saveAndExit()">üíæ Save & Exit</button>
    <button class="win-btn secondary" onclick="rematch()">üîÑ Rematch</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ============================================================================
// POPDARTS v7.2 - CLOUD GAME, ALL DEVICES SYNC
// ============================================================================
const API = 'https://script.google.com/macros/s/AKfycbzmdLog_tuyJMAE9hCLvfrsVT67LtwvLUOrrESZhUj0pBcbO6eFeajzKocXWfgQ9_MNTA/exec';

const DARTS = [
  {id:'green',name:'Green',grad:'linear-gradient(180deg,#1a1a1a,#22c55e,#1a1a1a)',color:'#22c55e'},
  {id:'blue',name:'Blue',grad:'linear-gradient(180deg,#1a1a1a,#3b82f6,#1a1a1a)',color:'#3b82f6'},
  {id:'purple',name:'Purple',grad:'linear-gradient(180deg,#e8e8e8,#a855f7,#e8e8e8)',color:'#a855f7'},
  {id:'orange',name:'Orange',grad:'linear-gradient(180deg,#f97316,#ea580c)',color:'#f97316'},
  {id:'cyan',name:'Cyan',grad:'linear-gradient(180deg,#06b6d4,#0891b2)',color:'#06b6d4'},
  {id:'pink',name:'Pink',grad:'linear-gradient(180deg,#ec4899,#db2777)',color:'#ec4899'},
  {id:'red',name:'Red',grad:'linear-gradient(180deg,#ef4444,#dc2626)',color:'#ef4444'},
  {id:'lime',name:'Lime',grad:'linear-gradient(180deg,#84cc16,#65a30d)',color:'#84cc16'}
];

let DATA = { players: [], draw: [], stats: [], target: 21, live: null };
let PENDING = null; // Pending game for dart selection
let DART = { step: 1, d1: null, d2: null, pick: null };
let syncTimer = null;
let busy = false;

// ============================================================================
// SYNC - Fast polling from cloud
// ============================================================================
async function sync() {
  try {
    const [pRes, sRes, dRes, lRes] = await Promise.all([
      fetch(API+'?action=players').then(r=>r.json()),
      fetch(API+'?action=stats').then(r=>r.json()),
      fetch(API+'?action=draw').then(r=>r.json()),
      fetch(API+'?action=liveGame').then(r=>r.json())
    ]);
    
    if (pRes.success) DATA.players = (pRes.data.players||[]).filter(p=>p?.trim());
    if (sRes.success) DATA.stats = sRes.data.stats||[];
    if (dRes.success) {
      DATA.draw = [];
      (dRes.data.games||[]).forEach(g => {
        DATA.draw.push({num:g.gameNum,p1:g.player1,p2:g.player2,s1:g.score1,s2:g.score2,winner:g.winner,isGF:g.gameNum==='GF'});
      });
      if (dRes.data.grandFinal && !DATA.draw.find(x=>x.isGF)) {
        const gf = dRes.data.grandFinal;
        DATA.draw.push({num:'GF',p1:gf.player1,p2:gf.player2,s1:gf.score1,s2:gf.score2,winner:gf.winner,isGF:true});
      }
      if (dRes.data.targetScore) DATA.target = dRes.data.targetScore;
    }
    
    // LIVE GAME - KEY!
    DATA.live = (lRes.success && lRes.data?.active) ? lRes.data : null;
    
    render();
    
    // If live game, update game UI
    if (DATA.live) {
      updateGameUI();
      // Check win
      if (DATA.live.score1 >= DATA.target || DATA.live.score2 >= DATA.target) {
        showWin();
      }
    }
  } catch(e) {
    console.error('Sync error:', e);
  }
}

async function post(action, data) {
  if (busy) return null;
  busy = true;
  try {
    const r = await fetch(API, {
      method: 'POST',
      headers: {'Content-Type':'text/plain'},
      body: JSON.stringify({action, ...data})
    });
    return await r.json();
  } catch(e) {
    return null;
  } finally {
    busy = false;
  }
}

function startSync() {
  stopSync();
  sync();
  syncTimer = setInterval(sync, 700);
}

function stopSync() {
  if (syncTimer) { clearInterval(syncTimer); syncTimer = null; }
}

// ============================================================================
// NAVIGATION
// ============================================================================
function goTo(screen) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(screen + '-screen')?.classList.add('active');
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.toggle('on', b.textContent.toLowerCase().includes(screen)));
  document.getElementById('nav').style.display = (screen === 'game') ? 'none' : 'flex';
  if (screen === 'settings') renderPlayers();
}

function showTab(tab, btn) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('on'));
  btn.classList.add('on');
  ['draw','standings','alltime'].forEach(t => {
    document.getElementById('tab-'+t).style.display = t===tab ? 'block' : 'none';
  });
}

// ============================================================================
// RENDER
// ============================================================================
function render() {
  const done = DATA.draw.filter(g => !g.isGF && g.winner).length;
  const total = DATA.draw.filter(g => !g.isGF).length;
  
  document.getElementById('stat-players').textContent = DATA.players.length;
  document.getElementById('stat-games').textContent = total ? done+'/'+total : '0';
  document.getElementById('stat-target').textContent = DATA.target;
  
  renderLive();
  renderNext();
  renderDraw();
  renderStandings();
  renderAllTime();
  
  if (window.innerWidth >= 1024) renderDesktop();
}

function renderLive() {
  const el = document.getElementById('live-zone');
  if (DATA.live) {
    el.innerHTML = `<div class="live-banner" onclick="joinGame()"><div class="live-badge"><span class="live-pulse"></span>LIVE GAME</div><div class="live-players">${DATA.live.player1} vs ${DATA.live.player2}</div><div class="live-score">${DATA.live.score1} - ${DATA.live.score2}</div><button class="live-join">Tap to Join & Score</button></div>`;
  } else {
    el.innerHTML = '';
  }
}

function renderNext() {
  const el = document.getElementById('next-zone');
  if (DATA.live) { el.innerHTML = ''; return; }
  
  const next = DATA.draw.find(g => !g.winner);
  if (!next) {
    el.innerHTML = DATA.draw.length 
      ? '<div class="next-card"><div class="next-tag">üéâ COMPLETE</div><div class="next-match">All games done!</div></div>'
      : `<div class="next-card"><div class="next-tag" style="color:var(--muted)">NO DRAW</div><div class="next-match">${DATA.players.length<2?'Add 2+ players':'Generate a draw'}</div></div>`;
    return;
  }
  
  el.innerHTML = `<div class="next-card ${next.isGF?'gf':''}"><div class="next-tag">${next.isGF?'üèÜ GRAND FINAL':'NEXT: GAME '+next.num}</div><div class="next-match">${next.p1}<span class="next-vs">vs</span>${next.p2}</div><button class="next-btn" onclick="startGame(${DATA.draw.indexOf(next)})">‚ñ∂Ô∏è Start</button></div>`;
}

function renderDraw() {
  const el = document.getElementById('tab-draw');
  if (!DATA.draw.length) { el.innerHTML = '<div class="empty">No games yet</div>'; return; }
  el.innerHTML = DATA.draw.map((g,i) => `<div class="draw-item ${g.winner?'done':''} ${g.isGF?'gf':''}" ${g.winner?'':`onclick="startGame(${i})"`}><div class="draw-num">${g.isGF?'üèÜ':g.num}</div><div class="draw-info"><div class="draw-players">${g.p1} vs ${g.p2}</div></div><div class="draw-result">${g.winner?g.s1+'-'+g.s2:'‚Äî'}</div></div>`).join('');
}

function renderStandings() {
  const el = document.getElementById('tab-standings');
  const map = {};
  DATA.players.forEach(p => map[p] = {name:p,w:0,l:0,diff:0});
  DATA.draw.forEach(g => {
    if (!g.winner) return;
    if (map[g.p1]) { map[g.p1].w += g.winner===g.p1?1:0; map[g.p1].l += g.winner===g.p1?0:1; map[g.p1].diff += (g.s1||0)-(g.s2||0); }
    if (map[g.p2]) { map[g.p2].w += g.winner===g.p2?1:0; map[g.p2].l += g.winner===g.p2?0:1; map[g.p2].diff += (g.s2||0)-(g.s1||0); }
  });
  const arr = Object.values(map).sort((a,b) => b.w-a.w || b.diff-a.diff);
  if (!arr.length) { el.innerHTML = '<div class="empty">No standings</div>'; return; }
  el.innerHTML = `<table class="tbl"><thead><tr><th>Player</th><th>W</th><th>L</th><th>+/-</th></tr></thead><tbody>${arr.map((p,i) => `<tr class="${i===0?'top':''}"><td>${i===0?'üëë ':''}${p.name}</td><td>${p.w}</td><td>${p.l}</td><td class="${p.diff>0?'plus':p.diff<0?'minus':''}">${p.diff>0?'+':''}${p.diff}</td></tr>`).join('')}</tbody></table>`;
}

function renderAllTime() {
  const el = document.getElementById('tab-alltime');
  if (!DATA.stats.length) { el.innerHTML = '<div class="empty">No stats</div>'; return; }
  const sorted = [...DATA.stats].sort((a,b) => (b.championships||0)-(a.championships||0) || (b.wins||0)-(a.wins||0));
  el.innerHTML = `<table class="tbl"><thead><tr><th>Player</th><th>GP</th><th>W</th><th>L</th><th>%</th><th>F</th><th>A</th><th>D</th><th>üèÜ</th></tr></thead><tbody>${sorted.map(s => {
    const pct = s.gamesPlayed ? Math.round(s.wins/s.gamesPlayed*100) : 0;
    const d = s.pointsDiff||0;
    return `<tr><td>${s.name}</td><td>${s.gamesPlayed||0}</td><td>${s.wins||0}</td><td>${s.losses||0}</td><td>${pct}</td><td>${s.pointsFor||0}</td><td>${s.pointsAgainst||0}</td><td class="${d>0?'plus':d<0?'minus':''}">${d>0?'+':''}${d}</td><td class="${s.championships?'champ':''}">${s.championships||0}</td></tr>`;
  }).join('')}</tbody></table>`;
}

// ============================================================================
// DESKTOP
// ============================================================================
function renderDesktop() {
  // Players
  const pEl = document.getElementById('d-player-list');
  pEl.innerHTML = DATA.players.length ? DATA.players.map(p => {
    const s = DATA.stats.find(x => x.name===p) || {};
    return `<div class="d-player-item"><span class="d-player-name">${s.championships?'üèÜ ':''}${p}</span><span class="d-player-stat">${s.wins||0}W</span><button class="d-player-del" onclick="delPlayer('${p.replace(/'/g,"\\'")}')">√ó</button></div>`;
  }).join('') : '<div style="color:var(--muted);font-size:12px">No players</div>';
  
  // Draw
  const dEl = document.getElementById('d-draw');
  dEl.innerHTML = DATA.draw.length ? DATA.draw.map((g,i) => `<div class="d-draw-item ${g.winner?'done':''} ${g.isGF?'gf':''}" ${g.winner?'':`onclick="startGame(${i})"`}><div class="d-draw-num">${g.isGF?'üèÜ':g.num}</div><div class="d-draw-info">${g.p1} vs ${g.p2}</div><div class="d-draw-score">${g.winner?g.s1+'-'+g.s2:'‚Äî'}</div></div>`).join('') : '<div style="color:var(--muted);font-size:12px">No games</div>';
  
  // Standings
  const map = {};
  DATA.players.forEach(p => map[p] = {name:p,w:0,l:0,diff:0});
  DATA.draw.forEach(g => {
    if (!g.winner) return;
    if (map[g.p1]) { map[g.p1].w += g.winner===g.p1?1:0; map[g.p1].l += g.winner===g.p1?0:1; map[g.p1].diff += (g.s1||0)-(g.s2||0); }
    if (map[g.p2]) { map[g.p2].w += g.winner===g.p2?1:0; map[g.p2].l += g.winner===g.p2?0:1; map[g.p2].diff += (g.s2||0)-(g.s1||0); }
  });
  const arr = Object.values(map).sort((a,b) => b.w-a.w || b.diff-a.diff);
  const sEl = document.getElementById('d-standings');
  sEl.innerHTML = arr.length ? `<table class="tbl" style="font-size:11px"><thead><tr><th>Player</th><th>W</th><th>L</th><th>+/-</th></tr></thead><tbody>${arr.map((p,i) => `<tr class="${i===0?'top':''}"><td>${i===0?'üëë ':''}${p.name}</td><td>${p.w}</td><td>${p.l}</td><td class="${p.diff>0?'plus':p.diff<0?'minus':''}">${p.diff>0?'+':''}${p.diff}</td></tr>`).join('')}</tbody></table>` : '<div style="color:var(--muted);font-size:11px">No standings</div>';
  
  // All-time
  const aEl = document.getElementById('d-alltime');
  const sorted = [...DATA.stats].sort((a,b) => (b.championships||0)-(a.championships||0) || (b.wins||0)-(a.wins||0));
  aEl.innerHTML = sorted.length ? `<table class="tbl" style="font-size:10px"><thead><tr><th>Player</th><th>GP</th><th>W</th><th>L</th><th>%</th><th>F</th><th>A</th><th>D</th><th>üèÜ</th></tr></thead><tbody>${sorted.map(s => {
    const pct = s.gamesPlayed ? Math.round(s.wins/s.gamesPlayed*100) : 0;
    const d = s.pointsDiff||0;
    return `<tr><td>${s.name}</td><td>${s.gamesPlayed||0}</td><td>${s.wins||0}</td><td>${s.losses||0}</td><td>${pct}</td><td>${s.pointsFor||0}</td><td>${s.pointsAgainst||0}</td><td class="${d>0?'plus':d<0?'minus':''}">${d>0?'+':''}${d}</td><td class="${s.championships?'champ':''}">${s.championships||0}</td></tr>`;
  }).join('')}</tbody></table>` : '<div style="color:var(--muted);font-size:10px">No stats</div>';
  
  // Game Area
  renderDesktopGame();
}

function renderDesktopGame() {
  const el = document.getElementById('d-game-area');
  
  if (DATA.live) {
    const d1 = DARTS.find(d => d.id===DATA.live.color1) || DARTS[0];
    const d2 = DARTS.find(d => d.id===DATA.live.color2) || DARTS[1];
    const p1 = Math.min(100, DATA.live.score1/DATA.target*100);
    const p2 = Math.min(100, DATA.live.score2/DATA.target*100);
    
    el.innerHTML = `
      <div class="d-game-box">
        <div class="game-hdr">
          <button class="game-menu-btn" onclick="showMenu()">‚ò∞</button>
          <div class="game-badges">
            <div class="game-badge ${DATA.live.isGF?'gf':''}">${DATA.live.isGF?'üèÜ GRAND FINAL':DATA.live.isChamp?'Game '+DATA.live.gameId:'Quick'}</div>
            <div class="game-badge live">üî¥ LIVE</div>
          </div>
        </div>
        <div class="game-arena">
          <div class="player-zone p1">
            <div class="progress-bar" style="width:${p1}%;background:${d1.grad}"></div>
            <div class="player-ui">
              <div class="player-header"><div class="player-dart" style="background:${d1.grad}"></div><div class="player-name-txt">${DATA.live.player1}</div></div>
              <div class="score-row">
                <button class="score-btn minus" onclick="adj(1,-1)">‚àí</button>
                <div class="score-num">${DATA.live.score1}</div>
                <button class="score-btn plus" onclick="adj(1,1)">+</button>
              </div>
              <div class="quick-row">
                <button class="quick-btn" onclick="adj(1,2)">+2</button>
                <button class="quick-btn" onclick="adj(1,3)">+3</button>
                <button class="quick-btn" onclick="adj(1,4)">+4</button>
                <button class="quick-btn" onclick="adj(1,5)">+5</button>
              </div>
            </div>
          </div>
          <div class="game-mid"><button class="reset-btn" onclick="resetScores()">‚Ü∫</button></div>
          <div class="player-zone p2">
            <div class="progress-bar" style="width:${p2}%;background:${d2.grad}"></div>
            <div class="player-ui">
              <div class="player-header"><div class="player-dart" style="background:${d2.grad}"></div><div class="player-name-txt">${DATA.live.player2}</div></div>
              <div class="score-row">
                <button class="score-btn minus" onclick="adj(2,-1)">‚àí</button>
                <div class="score-num">${DATA.live.score2}</div>
                <button class="score-btn plus" onclick="adj(2,1)">+</button>
              </div>
              <div class="quick-row">
                <button class="quick-btn" onclick="adj(2,2)">+2</button>
                <button class="quick-btn" onclick="adj(2,3)">+3</button>
                <button class="quick-btn" onclick="adj(2,4)">+4</button>
                <button class="quick-btn" onclick="adj(2,5)">+5</button>
              </div>
            </div>
          </div>
        </div>
      </div>`;
    return;
  }
  
  const next = DATA.draw.find(g => !g.winner);
  if (!next) {
    el.innerHTML = `<div style="flex:1;display:flex;align-items:center;justify-content:center"><div class="next-card" style="max-width:480px;padding:40px"><div class="next-tag">${DATA.draw.length?'üéâ COMPLETE':'NO DRAW'}</div><div class="next-match" style="font-size:26px">${DATA.draw.length?'All games done!':DATA.players.length<2?'Add 2+ players':'Generate a draw'}</div></div></div>`;
    return;
  }
  
  const i = DATA.draw.indexOf(next);
  el.innerHTML = `<div style="flex:1;display:flex;align-items:center;justify-content:center"><div class="next-card ${next.isGF?'gf':''}" style="max-width:520px;padding:45px"><div class="next-tag" style="font-size:14px">${next.isGF?'üèÜ GRAND FINAL':'NEXT: GAME '+next.num}</div><div class="next-match" style="font-size:34px">${next.p1}<span class="next-vs" style="font-size:16px">vs</span>${next.p2}</div><button class="next-btn" onclick="startGame(${i})" style="font-size:18px;padding:18px 45px">‚ñ∂Ô∏è Start Game</button></div></div>`;
}

// ============================================================================
// DART SELECTION
// ============================================================================
function openDart(game) {
  PENDING = game;
  DART = { step: 1, d1: null, d2: null, pick: null };
  showDartStep(1, game.p1);
  document.getElementById('dart-screen').classList.add('active');
  document.getElementById('nav').style.display = 'none';
}

function showDartStep(step, name) {
  DART.step = step;
  DART.pick = null;
  document.getElementById('dart-step').textContent = `STEP ${step} OF 2`;
  document.getElementById('dart-name').textContent = name;
  document.getElementById('dart-confirm').disabled = true;
  
  document.getElementById('dart-grid').innerHTML = DARTS.map(d => {
    const off = step===2 && DART.d1?.id===d.id;
    return `<div class="dart-opt ${off?'off':''}" data-id="${d.id}" onclick="pickDart('${d.id}')"><div class="dart-shape" style="background:${d.grad}"></div><div class="dart-label">${d.name}</div></div>`;
  }).join('');
}

function pickDart(id) {
  DART.pick = DARTS.find(d => d.id===id);
  document.querySelectorAll('.dart-opt').forEach(el => el.classList.toggle('picked', el.dataset.id===id));
  document.getElementById('dart-confirm').disabled = false;
}

async function confirmDart() {
  if (!DART.pick) return;
  
  if (DART.step === 1) {
    DART.d1 = DART.pick;
    showDartStep(2, PENDING.p2);
  } else {
    DART.d2 = DART.pick;
    document.getElementById('dart-screen').classList.remove('active');
    
    // CREATE LIVE GAME IN CLOUD
    await post('updateLiveGame', {
      active: true,
      gameId: PENDING.num,
      player1: PENDING.p1,
      player2: PENDING.p2,
      score1: 0,
      score2: 0,
      color1: DART.d1.id,
      color2: DART.d2.id,
      target: DATA.target,
      isChamp: PENDING.isChamp !== false,
      isGF: PENDING.isGF || false
    });
    
    // Wait for sync to pick it up
    await sync();
    
    // Go to game screen on mobile
    if (window.innerWidth < 1024) {
      goTo('game');
    }
    
    PENDING = null;
  }
}

function cancelDart() {
  document.getElementById('dart-screen').classList.remove('active');
  PENDING = null;
  goTo('home');
}

// ============================================================================
// GAME
// ============================================================================
function startGame(idx) {
  const g = DATA.draw[idx];
  if (!g || g.winner) return;
  openDart({...g, isChamp: true});
}

function joinGame() {
  if (!DATA.live) return;
  goTo('game');
}

async function quickMatch() {
  if (DATA.players.length < 2) { toast('Add 2+ players', 'err'); return; }
  const shuffled = [...DATA.players].sort(() => Math.random() - 0.5);
  openDart({ p1: shuffled[0], p2: shuffled[1], num: 'quick', isChamp: false, isGF: false });
}

function updateGameUI() {
  if (!DATA.live) return;
  
  const d1 = DARTS.find(d => d.id===DATA.live.color1) || DARTS[0];
  const d2 = DARTS.find(d => d.id===DATA.live.color2) || DARTS[1];
  const p1 = Math.min(100, DATA.live.score1/DATA.target*100);
  const p2 = Math.min(100, DATA.live.score2/DATA.target*100);
  
  // Mobile
  document.getElementById('name1').textContent = DATA.live.player1;
  document.getElementById('name2').textContent = DATA.live.player2;
  document.getElementById('score1').textContent = DATA.live.score1;
  document.getElementById('score2').textContent = DATA.live.score2;
  document.getElementById('dart1').style.background = d1.grad;
  document.getElementById('dart2').style.background = d2.grad;
  document.getElementById('bar1').style.cssText = `width:${p1}%;background:${d1.grad}`;
  document.getElementById('bar2').style.cssText = `width:${p2}%;background:${d2.grad}`;
  document.getElementById('game-label').textContent = DATA.live.isGF ? 'üèÜ GF' : DATA.live.isChamp ? 'Game ' + DATA.live.gameId : 'Quick';
}

async function adj(player, amt) {
  if (!DATA.live) return;
  
  const s1 = player===1 ? Math.max(0, DATA.live.score1+amt) : DATA.live.score1;
  const s2 = player===2 ? Math.max(0, DATA.live.score2+amt) : DATA.live.score2;
  
  // Optimistic
  DATA.live.score1 = s1;
  DATA.live.score2 = s2;
  updateGameUI();
  if (window.innerWidth >= 1024) renderDesktopGame();
  
  // Push
  await post('updateLiveGame', {
    active: true,
    gameId: DATA.live.gameId,
    player1: DATA.live.player1,
    player2: DATA.live.player2,
    score1: s1,
    score2: s2,
    color1: DATA.live.color1,
    color2: DATA.live.color2,
    target: DATA.target,
    isChamp: DATA.live.isChamp,
    isGF: DATA.live.isGF
  });
  
  if (s1 >= DATA.target || s2 >= DATA.target) showWin();
}

async function resetScores() {
  if (!DATA.live || !confirm('Reset to 0-0?')) return;
  DATA.live.score1 = 0;
  DATA.live.score2 = 0;
  updateGameUI();
  if (window.innerWidth >= 1024) renderDesktopGame();
  await post('updateLiveGame', {...DATA.live, score1:0, score2:0});
}

// ============================================================================
// MENU & WIN
// ============================================================================
function showMenu() { document.getElementById('menu-panel').classList.add('on'); }
function hideMenu() { document.getElementById('menu-panel').classList.remove('on'); }

async function endGame() {
  hideMenu();
  await post('clearLiveGame', {});
  DATA.live = null;
  goTo('home');
  render();
}

function showWin() {
  if (!DATA.live) return;
  const winner = DATA.live.score1 >= DATA.target ? DATA.live.player1 : DATA.live.player2;
  document.getElementById('win-name').textContent = winner;
  document.getElementById('win-score').textContent = DATA.live.score1 + ' - ' + DATA.live.score2;
  document.getElementById('win-panel').classList.add('on');
  confetti();
}

async function saveAndExit() {
  if (DATA.live?.isChamp && DATA.live.gameId !== 'quick') {
    await post('submitGame', {
      gameId: DATA.live.gameId,
      player1: DATA.live.player1,
      player2: DATA.live.player2,
      score1: DATA.live.score1,
      score2: DATA.live.score2
    });
    toast(DATA.live.isGF ? 'üèÜ Champion!' : 'Saved!', 'ok');
  }
  await post('clearLiveGame', {});
  DATA.live = null;
  document.getElementById('win-panel').classList.remove('on');
  goTo('home');
  await sync();
}

async function rematch() {
  if (!DATA.live) return;
  await post('updateLiveGame', {...DATA.live, score1:0, score2:0});
  document.getElementById('win-panel').classList.remove('on');
}

function confetti() {
  const cols = ['#ffc107','#00e676','#ff5252','#448aff','#a855f7'];
  for (let i = 0; i < 50; i++) {
    setTimeout(() => {
      const c = document.createElement('div');
      c.className = 'confetti';
      c.style.left = Math.random()*100+'vw';
      c.style.background = cols[Math.floor(Math.random()*cols.length)];
      c.style.animationDuration = (2+Math.random()*2)+'s';
      document.body.appendChild(c);
      setTimeout(() => c.remove(), 4000);
    }, i*25);
  }
}

// ============================================================================
// PLAYERS
// ============================================================================
function renderPlayers() {
  const el = document.getElementById('player-list');
  el.innerHTML = DATA.players.length ? DATA.players.map(p => {
    const s = DATA.stats.find(x => x.name===p) || {};
    return `<div class="player-item"><div class="player-avatar">${p[0].toUpperCase()}</div><div class="player-info"><div class="player-name">${s.championships?'üèÜ ':''}${p}</div><div class="player-meta">${s.gamesPlayed||0} GP ‚Ä¢ ${s.wins||0} W</div></div><button class="player-del" onclick="delPlayer('${p.replace(/'/g,"\\'")}')">√ó</button></div>`;
  }).join('') : '<div style="text-align:center;color:var(--muted);padding:20px">No players</div>';
}

async function addPlayer() {
  const inp = document.getElementById('player-input');
  const name = inp.value.trim();
  if (!name) return;
  if (DATA.players.some(p => p.toLowerCase()===name.toLowerCase())) { toast('Exists','err'); return; }
  await post('addPlayer', {playerName: name});
  inp.value = '';
  await sync();
  renderPlayers();
  toast('Added!','ok');
}

async function addPlayerD() {
  const inp = document.getElementById('d-player-input');
  const name = inp.value.trim();
  if (!name) return;
  if (DATA.players.some(p => p.toLowerCase()===name.toLowerCase())) { toast('Exists','err'); return; }
  await post('addPlayer', {playerName: name});
  inp.value = '';
  await sync();
  toast('Added!','ok');
}

async function delPlayer(name) {
  if (!confirm(`Remove ${name}? Stats kept.`)) return;
  await post('deletePlayer', {playerName: name});
  await sync();
  renderPlayers();
  toast('Removed','ok');
}

async function generateDraw() {
  if (DATA.players.length < 2) { toast('Need 2+ players','err'); return; }
  if (DATA.draw.length && !confirm('Replace draw?')) return;
  await post('generateDraw', {});
  await sync();
  toast('Draw generated!','ok');
}

async function clearDraw() {
  if (!confirm('Clear all games?')) return;
  await post('newEvent', {});
  await sync();
  toast('Cleared','ok');
}

function toast(msg, type) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = 'toast show ' + (type||'ok');
  setTimeout(() => el.classList.remove('show'), 2500);
}

document.getElementById('player-input')?.addEventListener('keypress', e => { if(e.key==='Enter') addPlayer(); });
document.getElementById('d-player-input')?.addEventListener('keypress', e => { if(e.key==='Enter') addPlayerD(); });

// ============================================================================
// INIT
// ============================================================================
startSync();
console.log('[PopDarts] v7.2 Ready');
</script>
</body>
</html>
